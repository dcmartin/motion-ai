###
# automation/motion/alarm.yaml
###

- id: motion_alarm_notification_dismiss
  alias: motion_alarm_notification_dismiss
  initial_state: on
  mode: queued
  trigger:
  action:
    - service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{ state_attr('binary_sensor.motion_alarm','notification_id') }}

- id: motion_alarm_on
  alias: motion_alarm_on
  initial_state: on
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_alarm
      to: 'on'
  action:
    - alias: 'set binary_sensor.motion_alarm_exist to: on'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_alarm_exist
        status: >-
          {{- states.binary_sensor.motion_alarm.attributes|default(none) -}}
        timestamp: >-
          {{- states.binary_sensor.motion_alarm.last_updated|as_timestamp -}}
        when: >-
          {{- states.binary_sensor.motion_alarm.last_updated|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}
        state: 'on'

- id: motion_alarm_off
  alias: motion_alarm_off
  initial_state: on
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_alarm
      to: 'off'
  action:
    - alias: 'set binary_sensor.motion_alarm_exist to: off'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_alarm_exist
        timestamp_off: >-
          {{ utcnow().timestamp() }}
        state: 'off'
