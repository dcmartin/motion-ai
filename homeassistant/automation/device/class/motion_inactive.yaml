###
# homeassistant/automation/motion/device/motion_inactive.yaml
###

# inactive

- id: motion_device_motion_inactive
  alias: motion_device_motion_inactive
  mode: single
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_motion
      from: 'on'
      to: 'off'
      for:
        hours: >-
          {{ states('input_number.motion_device_motion_inactive')|int(4) }}
  variables:
    title: >-
      {% set title = states('sensor.motion_app') + ': motion inactive' %}
      {{ title }}
    which: >-
      {% set which = none %}
      {% set s = state_attr('binary_sensor.motion_device_motion','status')|selectattr('state','==','off')|sort(attribute='updated',reverse=true)|list %}
      {% if s|lower != 'none' and s|lower != 'null' and not s is string and s is iterable and s|count > 0 %}
        {% set which = s|map(attribute='id')|first  %}
      {%- endif %}
      {{ which }}
    notification_id: >-
      {{ 'device-motion-inactve' }}
    icon: >-
      {% set icon = 'notification-motion-inactive' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
      {{- '<hr>' -}}
    footer: >-
      {{ '<hr>' }}
    body: >-
      Inactivity detected; No motion for past {{ states('input_number.motion_device_motion_inactive') }} hours; last motion: {{ which -}}.
    message: >-
      {{- header -}}
      {{- body -}}
      {{- footer -}}
  action:
    - alias: 'notify motion inactive'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}
