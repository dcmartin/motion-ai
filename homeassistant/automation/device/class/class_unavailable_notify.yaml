###
# homeassistant/automation/device/class/class_unavailable.yaml
###

- id: motion_device_class_unavailable_notify
  alias: motion_device_class_unavailable_notify
  mode: single
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_class_unavailable'
      to: 'on'
  variables:
    ids: >-
      {% set ids = state_attr('binary_sensor.motion_device_class_unavailable','ids') %}
      {{ ids }}
    title: >-
      {% set title = states('sensor.motion_app') + ': sensor(s) unavailable' %}
      {{ title }}
    notification_id: >-
      {{ 'device-unavailable-notify' }}
    icon: >-
      {% set icon = 'notification-device-unavailable' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    action: >-
      {%- set action = 'unavailable-setup' -%}
      {{- action -}}
    url: >-
      {%- set url = '/notify-unavailable' -%}
      {{- url -}}
    footer: >-
      {{- '<br>' -}}
    body: >-
      {{- state_attr('binary_sensor.motion_device_class_unavailable','markdown') -}}
      <p><a href="{{- url -}}"><img src="https://img.shields.io/badge/{{- action -}}-orange.svg"></a>
    message: >-
      {{- header -}}
      {{- '<hr>' -}}
      {{- body -}}
      {{- footer -}}
  action:
    - alias: 'notify unavailable device'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

- id: motion_device_class_unavailable_dismiss
  alias: motion_device_class_unavailable_dismiss
  mode: single
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_class_unavailable'
      to: 'off'
  variables:
    notification_id: >-
      {{ 'device-unavailable-notify' }}
  action:
    - alias: 'dismiss inactive device'
      service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{- notification_id -}}

#      Sensor(s) <a href="/notify-unavailable">unavailable</a> at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}<br>
#      {%- set classes = state_attr('binary_sensor.motion_device_class_unavailable','details') -%}
#      {%- set ids = state_attr('binary_sensor.motion_device_class_unavailable','ids') -%}
#      {{- '<ul>' -}}
#      {%- for i in ids -%}
#        {{- '<li>' -}}
#        {%- set d = state_attr('binary_sensor.motion_device_class','devices') -%}
#        {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
#          {%- set d = d|selectattr('id','==',i)|default(['none'])|first -%}
#          {%- if d|lower != 'none' and 'did' in d -%}
#            <a href="/config/devices/device/{{- d.did -}}">{{- d.friendly_name -}}</a>
#          {%- else -%}{{- i -}}{%- endif -%}
#        {%- else -%}{{- i -}}{%- endif -%}
#        {{- '<ul>' -}}
#        {%- for j in classes|map(attribute='class')|sort|unique|list
#            if state_attr('binary_sensor.motion_device_' + j|string ,'unavailable')|lower != 'none'
#              and state_attr('binary_sensor.motion_device_' + j|string ,'unavailable')|selectattr('id','==',i)|lower != 'none'
#              and state_attr('binary_sensor.motion_device_' + j|string ,'unavailable')|selectattr('id','==',i)|list|count > 0 -%}
#          {%- set u = state_attr('binary_sensor.motion_device_' + j|string ,'unavailable')|selectattr('id','==',i)|list -%}
#          {%- set c = u|count -%}
#          {%- set o = u|map(attribute='updated')|min|as_datetime|relative_time -%}
#          {{- '<li><i>' -}}
#          {{ c|default(0) }} {{ j }} sensor(s); {{ o|default('unknown') }} ago
#          {{- '</i></li>' -}}
#        {%- endfor -%}
#        {{- '</ul>' -}}
#      {%- endfor -%}
#      {{- '</ul>' -}}
