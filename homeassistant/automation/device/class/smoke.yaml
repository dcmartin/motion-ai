###
# homeassistant/automation/motion/device/smoke.yaml
###

- id: motion_device_smoke_automation_enable
  alias: motion_device_smoke_automation_enable
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: group.motion_device_smoke
    attribute: 'entity_id'
  condition:
    - condition: template
      value_template: >-
        {% set s = state_attr('group.motion_device_smoke','entity_id') %}
        {{ s|lower != 'none' and not s is string and s is iterable and s|count > 0 }}
  variables:
    automations: >-
      {% set automations = ['motion_device_smoke_activity','motion_device_smoke_activity_notify','motion_device_smoke_activity_off','motion_device_smoke_activity_on','motion_device_smoke_alarm_activity','motion_device_smoke_alarm_bad_on','motion_device_smoke_alarm_good_on','motion_device_smoke_alarm_high_off','motion_device_smoke_alarm_high_on','motion_device_smoke_alarm_high_spike_off','motion_device_smoke_alarm_high_spike_on','motion_device_smoke_alarm_low_off','motion_device_smoke_alarm_low_on','motion_device_smoke_alarm_low_spike_off','motion_device_smoke_alarm_low_spike_on','motion_device_smoke_alarm_off','motion_device_smoke_alarm_on','motion_device_smoke_bad','motion_device_smoke_bad_notify','motion_device_smoke_bad_off','motion_device_smoke_bad_on','motion_device_smoke_cleared_dismiss','motion_device_smoke_cleared_notify','motion_device_smoke_good','motion_device_smoke_good_notify','motion_device_smoke_good_off','motion_device_smoke_good_on','motion_device_smoke_high','motion_device_smoke_high_dismiss','motion_device_smoke_high_notify','motion_device_smoke_high_off','motion_device_smoke_high_on','motion_device_smoke_high_spike_on','motion_device_smoke_high_spike_off','motion_device_smoke_high_spike','motion_device_smoke_high_spike_dismiss','motion_device_smoke_high_spike_notify','motion_device_smoke_low','motion_device_smoke_low_dismiss','motion_device_smoke_low_notify','motion_device_smoke_low_off','motion_device_smoke_low_on','motion_device_smoke_low_spike','motion_device_smoke_low_spike_on','motion_device_smoke_low_spike_off','motion_device_smoke_low_spike_dismiss','motion_device_smoke_low_spike_notify','motion_device_smoke_mute','motion_device_smoke_required_off','motion_device_smoke_required_on','motion_device_smoke_restart','motion_device_smoke_self_test','motion_device_smoke_status','motion_device_smoke_toggle','motion_device_smoke_turn_off','motion_device_smoke_turn_on','motion_device_smoke_unavailable','motion_device_smoke_unmute','motion_device_smoke_update'] %}
      {{ automations }}
  action:
    - alias: 'enable automations for device_smoke'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = automations[repeat.index-1]|default('') %}
              {{ s|string != '' }}
        sequence:
          - variables:
              automation: >-
                {% set s = automations[repeat.index-1] %}
                {{ 'automation.' + s|string }}
          - condition: template
            value_template: >-
              {{ states(automation)|lower == 'off' }}
          - service: automation.turn_on
            data_template:
              entity_id: >-
                {{ automation }}
          - condition: template
            value_template: >
              {{ states('input_select.motion_log_level') in ['debug'] }}
          - service: persistent_notification.create
            data_template:
              title: >-
                {% set s = automations[repeat.index-1] %}
                DEBUG: enabling {{ s }}
              notification_id: >
                {{- 'debug-automation-smoke' -}}
              message: >-
                Automation enabled: {{ automation }}

- id: motion_device_smoke_automation_disable
  alias: motion_device_smoke_automation_disable
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: group.motion_device_smoke
    attribute: 'entity_id'
  condition:
    - condition: template
      value_template: >-
        {% set s = state_attr('group.motion_device_smoke','entity_id') %}
        {{ s|lower == 'none' or s is string or not s is iterable or not s|count > 0 }}
  variables:
    automations: >-
      {% set automations = ['motion_device_smoke_activity','motion_device_smoke_activity_notify','motion_device_smoke_activity_off','motion_device_smoke_activity_on','motion_device_smoke_alarm_activity','motion_device_smoke_alarm_bad_on','motion_device_smoke_alarm_good_on','motion_device_smoke_alarm_high_off','motion_device_smoke_alarm_high_on','motion_device_smoke_alarm_high_spike_off','motion_device_smoke_alarm_high_spike_on','motion_device_smoke_alarm_low_off','motion_device_smoke_alarm_low_on','motion_device_smoke_alarm_low_spike_off','motion_device_smoke_alarm_low_spike_on','motion_device_smoke_alarm_off','motion_device_smoke_alarm_on','motion_device_smoke_bad','motion_device_smoke_bad_notify','motion_device_smoke_bad_off','motion_device_smoke_bad_on','motion_device_smoke_cleared_dismiss','motion_device_smoke_cleared_notify','motion_device_smoke_good','motion_device_smoke_good_notify','motion_device_smoke_good_off','motion_device_smoke_good_on','motion_device_smoke_high','motion_device_smoke_high_dismiss','motion_device_smoke_high_notify','motion_device_smoke_high_off','motion_device_smoke_high_on','motion_device_smoke_high_spike_on','motion_device_smoke_high_spike_off','motion_device_smoke_high_spike','motion_device_smoke_high_spike_dismiss','motion_device_smoke_high_spike_notify','motion_device_smoke_low','motion_device_smoke_low_dismiss','motion_device_smoke_low_notify','motion_device_smoke_low_off','motion_device_smoke_low_on','motion_device_smoke_low_spike','motion_device_smoke_low_spike_on','motion_device_smoke_low_spike_off','motion_device_smoke_low_spike_dismiss','motion_device_smoke_low_spike_notify','motion_device_smoke_mute','motion_device_smoke_required_off','motion_device_smoke_required_on','motion_device_smoke_restart','motion_device_smoke_self_test','motion_device_smoke_status','motion_device_smoke_toggle','motion_device_smoke_turn_off','motion_device_smoke_turn_on','motion_device_smoke_unavailable','motion_device_smoke_unmute','motion_device_smoke_update'] %}
      {{ automations }}
  action:
    - alias: 'disable automations for device_smoke'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = automations[repeat.index-1]|default('') %}
              {{ s|string != '' }}
        sequence:
          - variables:
              automation: >-
                {% set s = automations[repeat.index-1] %}
                {{ 'automation.' + s|string }}
          - alias: 'test if automation is on'
            condition: template
            value_template: >-
              {{ states(automation)|lower == 'on' }}
          - service: automation.turn_off
            data_template:
              entity_id: >-
                {{ automation }}
          - condition: template
            value_template: >
              {{ states('input_select.motion_log_level') in ['debug'] }}
          - service: persistent_notification.create
            data_template:
              title: >-
                {% set s = automations[repeat.index-1] %}
                DEBUG: disabling {{ s }}
              notification_id: >
                {{- 'debug-automation-smoke' -}}
              message: >-
                Automation disables: {{ automation }}

- id: motion_device_smoke_rescan
  alias: motion_device_smoke_rescan
  mode: single
  max_exceeded: silent
  initial_state: 'on'
  trigger:
    - platform: time_pattern
      minutes: '/5'
    - platform: homeassistant
      event: start
  variables:
    class: >-
      {{- 'smoke' -}}
    all: >-
      [{%- for state in (states.sensor|list + states.binary_sensor|list)
       if 'device_class' in state.attributes and device_id(state.entity_id)|lower != 'none'
        and state.attributes.device_class==class and not '.motion_' in state.entity_id
        and state.attributes.device_class==class and not '.motion_' in state.entity_id -%}
        {%- if not loop.first -%},{% endif -%}
        {%- set s = device_id(state.entity_id) -%}
        {"id":"{{- device_attr(s,'name') -}}","did":"{{- s  -}}"}
      {%- endfor -%}]
    local: >-
      {% set device_trackers = states.device_tracker|map(attribute='entity_id')|map('device_id')|list %}
      [{%- for state in (states.sensor|list + states.binary_sensor|list)
       if 'device_class' in state.attributes and device_id(state.entity_id)|lower != 'none'
        and state.attributes.device_class==class and not '.motion_' in state.entity_id
        and state.attributes.device_class==class and not '.motion_' in state.entity_id
        and device_id(state.entity_id) not in device_trackers -%}
        {%- if not loop.first -%},{% endif -%}
        "{{- device_attr(device_id(state.entity_id),'name') -}}"
      {%- endfor -%}]
    mobile: >-
      {% set device_trackers = states.device_tracker|map(attribute='entity_id')|map('device_id')|list %}
      [{%- for state in (states.sensor|list + states.binary_sensor|list)
       if 'device_class' in state.attributes and device_id(state.entity_id)|lower != 'none'
        and state.attributes.device_class==class and not '.motion_' in state.entity_id
        and state.attributes.device_class==class and not '.motion_' in state.entity_id
        and device_id(state.entity_id) in device_trackers -%}
        {%- if not loop.first -%},{% endif -%}
        "{{- device_attr(device_id(state.entity_id),'name') -}}"
      {%- endfor -%}]
    ids: >-
      {%- if all != [] and all is iterable and all|count > 0 -%}
        {{- all|map(attribute='id')|sort|unique|list -}}
      {% else %}none{% endif %}
    mobiles: >-
      {%- if mobile != [] and mobile is iterable and mobile|count > 0 -%}
        {{- mobile|sort|unique|list -}}
      {% else %}none{% endif %}
    total: >-
      {% set s = ids %}
      {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
        {{ s|count }}
      {%- else -%}0{%- endif %}
    update: >-
      {%- set s = ids %}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
        [{%- for i in s -%}
          {%- set o = loop -%}
          {%- for state in (states.button|list + states.switch|list) if device_attr(state.entity_id, 'name') == i and state.attributes.device_class|default('null')|string == 'update' -%}
            {%- set v = state.state -%}
            {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}"}
            {%- if not loop.last or not o.last -%},{%- endif -%}
          {%- endfor -%}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
    restart: >-
      {%- set s = ids %}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
        [{%- for i in s -%}
          {%- set o = loop -%}
          {%- for state in (states.button|list + states.switch|list) if device_attr(state.entity_id, 'name') == i and state.attributes.device_class|default('null')|string == 'restart' -%}
            {%- set v = state.state -%}
            {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}"}
            {%- if not loop.last or not o.last -%},{%- endif -%}
          {%- endfor -%}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
    controls: >-
      {%- set s = ids -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
        [{%- for i in s -%}
          {%- set o = loop -%}
          {%- for state in (states.button|list + states.switch|list) if device_attr(state.entity_id, 'name') == i and state.attributes.device_class|default('null')|string == 'null' -%}
            {%- set ctl = state_attr(state.entity_id,'friendly_name') -%}
            {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}","name":"{{- ctl -}}"}
            {%- if not loop.last or not o.last -%},{%- endif -%}
          {%- endfor -%}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
    test: >-
      {%- set s = ids -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
        [{%- for i in s -%}
          {%- set o = loop -%}
          {%- for state in states.sensor if device_attr(state.entity_id, 'name') == i and state.attributes.self_test|default('none')|string != 'none' -%}
            {%- if not loop.first or not o.first -%},{%- endif -%}
            {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}","state":"{{- state.state -}}","updated":{{- state.last_updated|as_timestamp(None) -}}}
          {%- endfor -%}
        {%- endfor -%}]
      {%- else -%}null{%- endif %}
    areas: >-
      {%- set s = ids -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
        [{%- for i in s -%}
          {%- set o = loop -%}
          {%- for state in (states.sensor|list + states.binary_sensor|list) if device_attr(state.entity_id, 'name') == i and state.attributes.device_class|default('null')|string == class -%}
            {%- if not o.first or not loop.first -%},{%- endif -%}
            {%- set v = state.state -%}
            {"id":"{{- i -}}","area":"{{- area_id(state.entity_id) -}}","state":"{{- state.state -}}"}
          {%- endfor -%}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
    status: >-
      {%- set s = ids -%}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s is iterable -%}
        [{%- for i in s -%}
          {%- set o = loop -%}
          {%- for state in (states.sensor|list + states.binary_sensor|list)
            if device_attr(state.entity_id, 'name') == i
              and (state.attributes.device_class|default('null')|string == class)  -%}
            {%- if not o.first or not loop.first -%},{%- endif -%}
            {"id":"{{- i -}}","name":"{{- state_attr(state.entity_id,'friendly_name') -}}","entity_id":"{{- state.entity_id -}}","state":"{{- state.state -}}","updated":{{- state.last_updated|as_timestamp(None) -}}}
          {%- else -%}{% if o.first %}None{% endif %}{%- endfor -%}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
    devices: >-
      {%- if ids|lower != 'unknown' and ids|lower != 'none' and not s is string and ids is iterable
             and status|lower != 'none' and not status is string and status is iterable
             and areas|lower != 'none' and not areas is string and areas is iterable -%}
        [{% for i in ids -%}
          {%- set j = status|selectattr('id','==',i)|map(attribute='entity_id')|first -%}
          {%- set k = areas|selectattr('id','==',i)|map(attribute='area')|first -%}
          {%- if not loop.first -%},{%- endif -%}
          {%- set n = device_attr(device_id(j),'name_by_user') -%}
          {%- if n|lower == 'none' -%}{%- set n = device_attr(device_id(j),'name') -%}{%- endif -%}
          {"id":"{{- i -}}", "did":"{{- device_id(j) -}}", "friendly_name":"{{- n -}}", "manufacturer":"{{- device_attr(device_id(j),'manufacturer') -}}", "model":"{{- device_attr(device_id(j),'model') -}}", "sw_version":"{{- device_attr(device_id(j),'sw_version') -}}", "area":"{{- k -}}"}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
  action:
    - alias: 'update binary_sensor.motion_device_smoke ids, etc..'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke
        ids: >-
          {{ ids }}
        mobiles: >-
          {{ mobiles }}
        total: >-
          {{ total }}
        update: >-
          {{ update }}
        restart: >-
          {{ restart }}
        controls: >-
          {%- if controls|lower != 'none' and not controls is string and controls is iterable and controls|count > 0  -%}
            {{ controls|reject('none')|list }}
          {%- else -%}
            {{ controls }}
          {%- endif -%}
        test: >-
          {{ test }}
        areas: >-
          {{ areas }}
        devices: >-
          {{ devices }}
        state: >-
          {{ states('binary_sensor.motion_device_' + class) }}
    - variables:
        entities: >-
          {%- if status|lower != 'null' and not status is string and status is iterable and status|count > 0 -%}
            {{- status|map(attribute='entity_id')|list -}}
          {%- else -%}none{%- endif %}
    - condition: template
      value_template: >
        {{ entities|lower != 'none' }}
    - alias: 'set group.motion_device_smoke sensors'
      service: group.set
      data_template:
        object_id: motion_device_smoke
        entities: >-
          {{ entities }}
    - variables:
        statistics: >-
          {%- set s = ids -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
            [{%- for i in s -%}
              {%- set o = loop -%}
              {%- for state in (states.sensor|list + states.binary_sensor|list)
                if device_attr(state.entity_id, 'name') == i
                  and state.attributes.device_class|default('null')|lower == 'null'
                  and state.attributes.state_class|default('null')|string == 'measurement' -%}
                {%- if not o.first or not loop.first -%},{%- endif -%}
                {"entity_id":"{{- state.entity_id -}}"}
              {%- else -%}{% if o.first %}None{% endif %}{%- endfor -%}
            {%- endfor -%}]
          {%- else -%}[]{%- endif %}
    - alias: 'set group.motion_device_smoke statistics'
      service: group.set
      data_template:
        object_id: motion_device_smoke_statistics
        entities: >-
          {{ statistics|reject('none')|map(attribute='entity_id')|list }}
    - alias: 'trigger temperatus status update'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_status

## update status

- id: motion_device_smoke_status
  alias: motion_device_smoke_status
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
    - platform: time_pattern
      minutes: '/1'
  variables:
    class: >-
      {% set class = 'smoke' %}
      {{ class }}
    ids: >-
      {% set ids = state_attr('binary_sensor.motion_device_smoke','ids') %}
      {{ ids }}
    status: >-
      {%- set s = ids -%}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s is iterable -%}
        [{%- for i in s -%}
          {%- set o = loop -%}
          {%- for state in (states.sensor|list + states.binary_sensor|list)
            if device_attr(state.entity_id, 'name') == i
              and (state.attributes.device_class|default('null')|string == class)  -%}
            {%- if not o.first or not loop.first -%},{%- endif -%}
            {"id":"{{- i -}}","name":"{{- state_attr(state.entity_id,'friendly_name') -}}","entity_id":"{{- state.entity_id -}}","state":"{{- state.state -}}","updated":{{- state.last_updated|as_timestamp(None) -}}}

          {%- else -%}{% if o.first %}None{% endif %}{%- endfor -%}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
    statistics: >-
      {%- set s = ids -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
        [{%- for i in s -%}
          {%- set o = loop -%}
          {%- for state in (states.sensor|list + states.binary_sensor|list)
            if device_attr(state.entity_id, 'name') == i
              and state.attributes.device_class|default('null')|lower == 'null'
              and state.attributes.state_class|default('null')|string == 'measurement' -%}
            {%- if not o.first or not loop.first -%},{%- endif -%}
            {"id":"{{- i -}}","name":"{{- state_attr(state.entity_id,'friendly_name') -}}","state":"{{- state.state }} {{ state.attributes.unit_of_measurement-}}","entity_id":"{{- state.entity_id -}}","updated":{{- state.last_updated|as_timestamp(None) -}}}
          {%- else -%}{% if o.first %}None{% endif %}{%- endfor -%}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
    high: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','high')|float('none') != 'none' -%}
        {% set s = status -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          {% set n = state_attr('binary_sensor.motion_device_smoke_exist','high')|float(0) -%}
          [{% for i in s if 'entity_id' in i and states(i.entity_id)|float(n) > n -%}
            {%- if not loop.first -%},{%- endif -%}
            {"id":"{{- i.id -}}","entity_id":"{{- i.entity_id -}}","state":"{{- i.state -}}","updated":{{- states[i.entity_id].last_updated|as_timestamp(None) -}}}
          {%- endfor -%}]
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif %}
    low: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','low')|float('none') != 'none' -%}
        {%- set s = status -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          {% set n = state_attr('binary_sensor.motion_device_smoke_exist','low')|float(0) -%}
          [{% for i in s if 'entity_id' in i and states(i.entity_id)|float(n) < n -%}
            {%- if not loop.first -%},{%- endif -%}
            {"id":"{{- i.id -}}","entity_id":"{{- i.entity_id -}}","state":"{{- i.state -}}","updated":{{- states[i.entity_id].last_updated|as_timestamp(None) -}}}
          {%- endfor -%}]
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif %}
    good: >-
      {% set good = state_attr('binary_sensor.motion_device_smoke_exist','good') -%}
      {%- if good|lower != 'none' -%}
        {% set s = status -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s if 'entity_id' in i and not i.entity_id is none and is_state(i.entity_id,good) -%}
            {%- if not loop.first -%},{%- endif -%}
            {"id":"{{- i.id -}}","entity_id":"{{- i.entity_id -}}","state":"{{- i.state -}}","updated":{{- states[i.entity_id].last_updated|as_timestamp(None) -}}}
          {%- endfor -%}]
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif %}
    bad: >-
      {% set bad = state_attr('binary_sensor.motion_device_smoke_exist','bad') -%}
      {%- if bad|lower != 'none' -%}
        {% set s = status -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s if 'entity_id' in i and not i.entity_id is none and is_state(i.entity_id,bad) -%}
            {%- if not loop.first -%},{%- endif -%}
            {"id":"{{- i.id -}}","entity_id":"{{- i.entity_id -}}","state":"{{- i.state -}}","updated":{{- states[i.entity_id].last_updated|as_timestamp(None) -}}}
          {%- endfor -%}]
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif %}
    activity: >-
      {% set activity = state_attr('binary_sensor.motion_device_smoke_exist','activity') -%}
      {%- if activity|lower != 'none' -%}
        {% set s = status -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s if 'entity_id' in i and not i.entity_id is none and is_state(i.entity_id,activity) -%}
            {%- if not loop.first -%},{%- endif -%}
            {"id":"{{- i.id -}}","entity_id":"{{- i.entity_id -}}","state":"{{- i.state -}}","updated":{{- states[i.entity_id].last_updated|as_timestamp(None) -}}}
          {%- endfor -%}]
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif %}
    unavailable: >-
      {%- set s = status -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
        [{% for i in s if 'entity_id' in i and not i.entity_id is none and is_state(i.entity_id,'unavailable') -%}
          {%- if not loop.first -%},{%- endif -%}
            {"id":"{{- i.id -}}","entity_id":"{{- i.entity_id -}}","state":"{{- i.state -}}","updated":{{- states[i.entity_id].last_updated|as_timestamp(None) -}}}
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
    high_spike: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','high_spike')|float('none') != 'none' -%}
        {% set s = status -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          {% set n = state_attr('binary_sensor.motion_device_smoke_exist','high_spike')|float(0) -%}
          [{% for i in s if 'entity_id' in i and states(i.entity_id)|float(n) > n -%}
            {%- if not loop.first -%},{%- endif -%}
            {"id":"{{- i.id -}}","entity_id":"{{- i.entity_id -}}","state":"{{- i.state -}}","updated":{{- states[i.entity_id].last_updated|as_timestamp(None) -}}}
          {%- endfor -%}]
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif %}
    low_spike: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','low_spike')|float('none') != 'none' -%}
        {% set s = status -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          {% set n = state_attr('binary_sensor.motion_device_smoke_exist','low_spike')|float(0) -%}
          [{% for i in s if 'entity_id' in i and states(i.entity_id)|float(n) < n -%}
            {%- if not loop.first -%},{%- endif -%}
            {"id":"{{- i.id -}}","entity_id":"{{- i.entity_id -}}","state":"{{- i.state -}}","updated":{{- states[i.entity_id].last_updated|as_timestamp(None) -}}}
          {%- endfor -%}]
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif %}
    values: >-
      {% set g = state_attr('binary_sensor.motion_device_smoke_exist','good') -%}
      {% set b = state_attr('binary_sensor.motion_device_smoke_exist','bad') -%}
      {%- if g|lower != 'none' and b|lower != 'none' -%}
        [{% for i in status if 'entity_id' in i and not i.entity_id is none -%}
          {%- if not loop.first -%},{%- endif -%}
          {% if is_state(i.entity_id,g) %}1{% elif is_state(i.entity_id,b) %}0{% else %}none{% endif -%}
        {%- endfor -%}]
      {%- else -%}
        [{% for i in status if 'entity_id' in i and not i.entity_id is none -%}
          {%- if not loop.first -%},{%- endif -%}
          {{- states(i.entity_id)|float(none) -}}
        {%- endfor -%}]
      {%- endif %}
    value: >-
      {% if bad|lower != 'none' and not bad is string and bad is iterable -%}
        {%- if bad|count > 0 -%}
          {%- set result = 'on' -%}
        {%- else -%}
          {%- set result = 'off' -%}
        {%- endif -%}
      {%- endif -%}
      {%- if low|lower != 'none' and not low is string and low is iterable -%}
        {%- if low|count > 0 -%}
          {%- set result = 'on' -%}
        {%- else -%}
          {%- set result = 'off' -%}
        {%- endif -%}
      {%- endif -%}
      {%- if high|lower != 'none' and not high is string and high is iterable -%}
        {%- if high|count > 0 -%}
          {%- set result = 'on' -%}
        {%- else -%}
          {%- set result = 'off' -%}
        {%- endif -%}
      {%- endif -%}
      {%- if activity|lower != 'none' and not activity is string and activity is iterable -%}
        {%- if activity|count > 0 -%}
          {%- set result = 'on' -%}
        {%- else -%}
          {%- set result = 'off' -%}
        {%- endif -%}
      {%- endif -%}
      {%- if result is defined -%}
        {{- result -}}
      {%- else -%}unknown{%- endif %}
  action:
    - alias: 'update binary_sensor.motion_device_smoke state'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke
        status: >-
          {{ status }}
        statistics: >-
          {{ statistics|reject('none')|list }}
        high: >-
          {{ high }}
        low: >-
          {{ low }}
        good: >-
          {{ good }}
        bad: >-
          {{ bad }}
        high_spike: >-
          {{ high_spike }}
        low_spike: >-
          {{ low_spike }}
        activity: >-
          {{ activity }}
        unavailable: >-
          {{ unavailable }}
        values: >-
          {{ values }}
        state: >-
          {{ value }}

## change smoke class attributes (alarm,required,..)

# required

- id: motion_device_smoke_required_off
  alias: motion_device_smoke_required_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke required not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','sensors') or 'smoke' in state_attr('binary_sensor.motion_device_class','binary_sensors') }}
  variables:
    sensors: >-
      {% set s = state_attr('binary_sensor.motion_device_class','sensors') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set sensors = s -%}
        {%- else -%}
          {% set sensors = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if sensors is defined -%}
        {{ sensors }}
      {%- else -%}none{%- endif %}
    binary_sensors: >-
      {% set s = state_attr('binary_sensor.motion_device_class','binary_sensors') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set binary_sensors = s -%}
        {%- else -%}
          {% set binary_sensors = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if binary_sensors is defined -%}
        {{ binary_sensors }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if required list of device classes is valid'
      condition: template
      value_template: >-
        {{ sensors|lower != 'none' and binary_sensors|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class required attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        sensors: >-
          {{ sensors }}
        binary_sensors: >-
          {{ binary_sensors }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_required_on
  alias: motion_device_smoke_required_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke required not on'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','sensor_list') or 'smoke' in state_attr('binary_sensor.motion_device_class','binary_sensor_list')
            and (not 'smoke' in state_attr('binary_sensor.motion_device_class','sensors') or not 'smoke' in state_attr('binary_sensor.motion_device_class','binary_sensors')) }}
  variables:
    sensors: >-
      {% set s = state_attr('binary_sensor.motion_device_class','sensors') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set sensors = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set sensors = ['smoke'] -%}
      {%- endif %}
      {%- if sensors is defined -%}
        {{ sensors }}
      {%- else -%}none{%- endif %}
    binary_sensors: >-
      {% set s = state_attr('binary_sensor.motion_device_class','binary_sensors') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set binary_sensors = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set binary_sensors = ['smoke'] -%}
      {%- endif %}
      {%- if binary_sensors is defined -%}
        {{ binary_sensors }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if required list of device classes is valid'
      condition: template
      value_template: >-
        {{ sensors|lower != 'none' and binary_sensors|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class required attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        sensors: >-
          {{ sensors }}
        binary_sensors: >-
          {{ binary_sensors }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

## bad

- id: motion_device_smoke_bad
  alias: motion_device_smoke_bad
  mode: restart
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke'
      attribute: 'bad'
  variables:
    details: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','bad')|lower != 'none' %}
        {% set s = state_attr('binary_sensor.motion_device_smoke','bad') %}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- state_attr(i.entity_id,'friendly_name') }} is {{ states(i.entity_id) -}}"
          {%- endfor -%}]
        {%- else -%}none{%- endif %}
      {%- else -%}none{%- endif %}
    state: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','bad') %}
      {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
        {% if s|list|count > 0 %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
    last: >-
      {% if state|lower == 'off' %}
        {{ state_attr('binary_sensor.motion_device_smoke_bad','last') }}
      {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_bad
        last: >-
          {{ last }}
        details: >-
          {{ details }}
        state: >-
          {{ state }}

- id: motion_device_smoke_bad_off
  alias: motion_device_smoke_bad_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke bad not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','bad') }}
  variables:
    bad: >-
      {% set s = state_attr('binary_sensor.motion_device_class','bad') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set bad = s -%}
        {%- else -%}
          {% set bad = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if bad is defined -%}
        {{ bad }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if bad list of device classes is valid'
      condition: template
      value_template: >-
        {{ bad|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class bad attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        bad: >-
          {{ bad }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_bad_on
  alias: motion_device_smoke_bad_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke bad not on'
        condition: template
        value_template: >-
          {{ not 'smoke' in state_attr('binary_sensor.motion_device_class','bad') }}
  variables:
    bad: >-
      {% set s = state_attr('binary_sensor.motion_device_class','bad') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set bad = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set bad = ['smoke'] -%}
      {%- endif %}
      {%- if bad is defined -%}
        {{ bad }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if bad list of device classes is valid'
      condition: template
      value_template: >-
        {{ bad|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class bad attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        bad: >-
          {{ bad }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_alarm_bad_on
  alias: motion_device_smoke_alarm_bad_on
  mode: single
  initial_state: 'off'
  trigger:
    - platform: template
      value_template: >-
        {{ not is_state_attr('binary_sensor.motion_device_smoke_exist','bad','none')
           and is_state_attr('binary_sensor.motion_device_smoke_exist','bad',states('binary_sensor.motion_device_smoke')) }}
  variables:
    devices: >-
      {%- set devices = none -%}
      {% set s = state_attr('binary_sensor.motion_device_smoke','devices') %}
      {% if s|lower != 'none' and s|lower != 'null' and not s is string and s is iterable and s|count > 0 %}
        {% set devices = s %}
      {%- endif %}
      {{ devices }}
    last: >-
      {% set last = none %}
      {% set s = state_attr('binary_sensor.motion_device_smoke','status')|selectattr('state','==',state_attr('binary_sensor.motion_device_smoke_exist','bad'))|sort(attribute='updated',reverse=true)|list %}
      {% if s|lower != 'none' and s|lower != 'null' and not s is string and s is iterable and s|count > 0 %}
        {% set last = s %}
      {%- endif %}
      {{ last  }}
    which: >-
      {% set which = none %}
      {% if last|lower != 'none' %}
        {% set which = last|map(attribute='id')|first %}
      {%- endif %}
      {{ which }}
    did: >-
      {% set did = none %}
      {% if devices|lower != 'none'  and which|lower != 'none' %}
        {% set did = devices|selectattr('id','==',which)|map(attribute='did')|first %}
      {%- endif %}
      {{ did }}
    where: >-
      {% set where = none %}
      {% if devices|lower != 'none'  and which|lower != 'none' %}
        {% set where = devices|selectattr('id','==',which)|map(attribute='area')|first %}
      {%- endif %}
      {{ where }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ which|lower != 'none' and which|lower != 'null' and which|length > 0 }}
  action:
    - variables:
        markdown: >-
          A <a href="/lovelace-primary/smoke">smoke</a> alarm was triggered ({{- state_attr('binary_sensor.motion_device_smoke_exist','bad')|string -}}); sensor: {{ which -}}; where: {{ where -}}; at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}.
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_bad
        markdown: >-
          {{ markdown }}
    - alias: 'update binary_sensor.motion_device_smoke which, where, did'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke
        which: >-
          {{ which }}
        where: >-
          {{ where }}
        did: >-
          {{ did }}
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger motion notification'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_bad_notify

- id: motion_device_smoke_bad_notify
  alias: motion_device_smoke_bad_notify
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    ids: >-
      {% set ids = state_attr('binary_sensor.motion_device_smoke','ids') %}
      {{ ids }}
    which: >-
      {% set which = state_attr('binary_sensor.motion_device_smoke','which') %}
      {{ which }}
    where: >-
      {% set where = state_attr('binary_sensor.motion_device_smoke','where') %}
      {{ where }}
    did: >-
      {% set did = state_attr('binary_sensor.motion_device_smoke','did') %}
      {{ did }}
    url: >-
      {% set url = '/lovelace-primary/' + class %}
      {{ url }}
    action: >-
      {% set action = class + '-alarm' %}
      {{ action }}
    title: >-
      {% set title = states('sensor.motion_app') + ': smoke bad' %}
      {{ title }}
    notification_id: >-
      {{ 'device-smoke-status-' + which|string }}
    icon: >-
      {% set icon = 'notification-smoke-bad' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      {{ state_attr('binary_sensor.motion_device_smoke_bad','markdown') }}
      <p>We have notified <b>{{- state_attr('sensor.motion_role_primary','friendly_name')|replace("'","") -}}</b> about your smoke alarm.
      To inspect and change the alarm click the <b>{{- action -}}</b> button below.
      {{- '<p>' -}}
      <a href="{{- url -}}"><img src="https://img.shields.io/badge/{{- action -}}-yellow.svg"></a>
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify smoke sensor activated'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

## low

- id: motion_device_smoke_low
  alias: motion_device_smoke_low
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke'
      attribute: 'low'
  variables:
    details: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','low')|lower != 'none' %}
        {% set s = state_attr('binary_sensor.motion_device_smoke','low') %}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- state_attr(i.entity_id,'friendly_name') }} is {{ states(i.entity_id)|int('unknown') -}}{{ state_attr(i.entity_id,'unit_of_measurement') -}}"
          {%- endfor -%}]
        {%- else -%}none{%- endif %}
      {%- else -%}none{%- endif %}
    state: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','low') %}
      {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
        {% if s|list|count > 0 %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
    last: >-
      {% if state|lower == 'off' %}
        {{ state_attr('binary_sensor.motion_device_smoke_low','last') }}
      {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_low
        last: >-
          {{ last }}
        details: >-
          {{ details }}
        state: >-
          {{ state }}

- id: motion_device_smoke_low_off
  alias: motion_device_smoke_low_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke low not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','low') }}
  variables:
    low: >-
      {% set s = state_attr('binary_sensor.motion_device_class','low') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set low = s -%}
        {%- else -%}
          {% set low = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if low is defined -%}
        {{ low }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if low list of device classes is valid'
      condition: template
      value_template: >-
        {{ low|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class low attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        low: >-
          {{ low }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_low_on
  alias: motion_device_smoke_low_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke low not on'
        condition: template
        value_template: >-
          {{ not 'smoke' in state_attr('binary_sensor.motion_device_class','low') }}
  variables:
    low: >-
      {% set s = state_attr('binary_sensor.motion_device_class','low') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set low = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set low = ['smoke'] -%}
      {%- endif %}
      {%- if low is defined -%}
        {{ low }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if low list of device classes is valid'
      condition: template
      value_template: >-
        {{ low|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class low attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        low: >-
          {{ low }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_alarm_low_on
  alias: motion_device_smoke_alarm_low_on
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_low'
      to: 'on'
  variables:
    low: >-
      {{ state_attr('binary_sensor.motion_device_smoke','low') }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{- low|lower != 'none' and low|lower != 'unknown' and not low is string and low is iterable and low|count > 0 -}}
  action:
    - variables:
        markdown: >-
          A <a href="/lovelace-primary/smoke">smoke</a> alarm was triggered (below {{ state_attr('binary_sensor.motion_device_smoke_exist','low') -}}) at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}:<br>
          {%- for i in low if 'id' in i and i.id|lower != 'none' -%}
            {%- if loop.first -%}{{- '<ul>' -}}{%- endif -%}
            {%- set d = state_attr('binary_sensor.motion_device_class','devices') -%}
            {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
              {%- set d = d|selectattr('id','==',i.id)|list -%}
              {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
                {%- set d = d|first -%}
                <li><a href="/config/devices/device/{{- d.did -}}">{{- d.friendly_name|replace("'","") -}}</a> is {{ states(low[loop.index-1].entity_id) -}}{{- state_attr(low[loop.index-1].entity_id,'unit_of_measurement') }} in <a href="/config/areas/area/{{- area_id(low[loop.index-1].entity_id) -}}">{{- area_id(low[loop.index-1].entity_id) -}}</a></li>
              {%- else -%}
                <li>{{- i.id }} smoke is {{ states(i.entity_id) -}}{{- state_attr(i.entity_id,'unit_of_measurement') }}</li>
              {%- endif -%}
            {%- else -%}
              {{- '<li>' -}}
              {{- i.id }} smoke is {{ states(i.entity_id) -}}{{- state_attr(i.entity_id,'unit_of_measurement') }}
              {{- '</li>' -}}
            {%- endif -%}
            {%- if loop.last -%}{{- '</ul>' -}}{%- endif -%}
          {%- endfor -%}
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_low
        markdown: >-
          {{ markdown }}
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger motion notification'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_low_notify

- id: motion_device_smoke_alarm_low_off
  alias: motion_device_smoke_alarm_low_off
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_low'
      to: 'off'
  action:
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger smoke low dismiss'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_low_dismiss

- id: motion_device_smoke_low_notify
  alias: motion_device_smoke_low_notify
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    low: >-
      {% set low = state_attr('binary_sensor.motion_device_smoke','low') %}
      {{ low }}
    action: >-
      {% set action = class + '-alarm' %}
      {{ action }}
    url: >-
      {% set url = '/lovelace-primary/' + class %}
      {{ url }}
    title: >-
      {% set title = states('sensor.motion_app') + ': smoke low' %}
      {{ title }}
    notification_id: >-
      {{ 'device-smoke-low' }}
    icon: >-
      {% set icon = 'notification-smoke-low' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      {{ state_attr('binary_sensor.motion_device_smoke_low','markdown') }}
      <p>We have notified <b>{{- state_attr('sensor.motion_role_primary','friendly_name')|replace("'","") -}}</b> about your smoke alarm.
      To inspect and change the alarm click the <b>{{- action -}}</b> button below.
      {{- '<p>' -}}
      <a href="{{- url -}}"><img src="https://img.shields.io/badge/{{- action -}}-yellow.svg"></a>
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify smoke sensor activated'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

- id: motion_device_smoke_low_dismiss
  alias: motion_device_smoke_low_dismiss
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    notification_id: >-
      {{ 'device-smoke-low' }}
  action:
    - alias: 'dismiss smoke low notification'
      service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{ notification_id }}

## high

- id: motion_device_smoke_high
  alias: motion_device_smoke_high
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke'
      attribute: 'high'
  variables:
    details: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','high')|lower != 'none' %}
        {% set s = state_attr('binary_sensor.motion_device_smoke','high') %}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- state_attr(i.entity_id,'friendly_name') }} is {{ states(i.entity_id)|int('unknown') -}}{{ state_attr(i.entity_id,'unit_of_measurement') -}}"
          {%- endfor -%}]
        {%- else -%}none{%- endif %}
      {%- else -%}none{%- endif %}
    state: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','high') %}
      {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
        {% if s|list|count > 0 %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
    last: >-
      {% if state|lower == 'off' %}
        {{ state_attr('binary_sensor.motion_device_smoke_high','last') }}
      {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_high
        last: >-
          {{ last }}
        details: >-
          {{ details }}
        state: >-
          {{ state }}

- id: motion_device_smoke_high_off
  alias: motion_device_smoke_high_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke high not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','high') }}
  variables:
    high: >-
      {% set s = state_attr('binary_sensor.motion_device_class','high') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set high = s -%}
        {%- else -%}
          {% set high = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if high is defined -%}
        {{ high }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if high list of device classes is valid'
      condition: template
      value_template: >-
        {{ high|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class high attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        high: >-
          {{ high }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_high_on
  alias: motion_device_smoke_high_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke high not on'
        condition: template
        value_template: >-
          {{ not 'smoke' in state_attr('binary_sensor.motion_device_class','high') }}
  variables:
    high: >-
      {% set s = state_attr('binary_sensor.motion_device_class','high') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set high = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set high = ['smoke'] -%}
      {%- endif %}
      {%- if high is defined -%}
        {{ high }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if high list of device classes is valid'
      condition: template
      value_template: >-
        {{ high|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class high attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        high: >-
          {{ high }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_alarm_high_on
  alias: motion_device_smoke_alarm_high_on
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_high'
      to: 'on'
  variables:
    high: >-
      {{ state_attr('binary_sensor.motion_device_smoke','high') }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{- high|lower != 'none' and high|lower != 'unknown' and not high is string and high is iterable and high|count > 0 -}}
  action:
    - variables:
        markdown: >-
          A <a href="/lovelace-primary/smoke">smoke</a> alarm was triggered (above {{ state_attr('binary_sensor.motion_device_smoke_exist','high') -}}) at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}:<br>
          {%- for i in high if 'id' in i and i.id|lower != 'none' -%}
            {%- if loop.first -%}{{- '<ul>' -}}{%- endif -%}
            {%- set d = state_attr('binary_sensor.motion_device_class','devices') -%}
            {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
              {%- set d = d|selectattr('id','==',i.id)|list -%}
              {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
                {%- set d = d|first -%}
                <li><a href="/config/devices/device/{{- d.did -}}">{{- d.friendly_name|replace("'","") -}}</a> is {{ states(high[loop.index-1].entity_id) -}}{{- state_attr(high[loop.index-1].entity_id,'unit_of_measurement') }} in <a href="/config/areas/area/{{- area_id(high[loop.index-1].entity_id) -}}">{{- area_id(high[loop.index-1].entity_id) -}}</a></li>
              {%- else -%}
                <li>{{- i.id }} smoke is {{ states(i.entity_id) -}}{{- state_attr(i.entity_id,'unit_of_measurement') }}</li>
              {%- endif -%}
            {%- else -%}
              {{- '<li>' -}}
              {{- i.id }} smoke is {{ states(i.entity_id) -}}{{- state_attr(i.entity_id,'unit_of_measurement') }}
              {{- '</li>' -}}
            {%- endif -%}
            {%- if loop.last -%}{{- '</ul>' -}}{%- endif -%}
          {%- endfor -%}
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_high
        markdown: >-
          {{ markdown }}
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger motion notification'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_high_notify

- id: motion_device_smoke_alarm_high_off
  alias: motion_device_smoke_alarm_high_off
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_high'
      to: 'off'
  action:
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger smoke high dismiss'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_high_dismiss

- id: motion_device_smoke_high_notify
  alias: motion_device_smoke_high_notify
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    high: >-
      {% set high = state_attr('binary_sensor.motion_device_smoke','high') %}
      {{ high }}
    action: >-
      {% set action = class + '-alarm' %}
      {{ action }}
    url: >-
      {% set url = '/lovelace-primary/' + class %}
      {{ url }}
    title: >-
      {% set title = states('sensor.motion_app') + ': ' + class + ' high' %}
      {{ title }}
    notification_id: >-
      {{ 'device-' + class + '-high' }}
    icon: >-
      {% set icon = 'notification-' + class + '-high' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      {{ state_attr('binary_sensor.motion_device_smoke_high','markdown') }}
      <p>We have notified <b>{{- state_attr('sensor.motion_role_primary','friendly_name')|replace("'","") -}}</b> about your smoke alarm.
      To inspect and change the alarm click the <b>{{- action -}}</b> button below.
      {{- '<p>' -}}
      <a href="{{- url -}}"><img src="https://img.shields.io/badge/{{- action -}}-yellow.svg"></a>
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify smoke sensor activated'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

- id: motion_device_smoke_high_dismiss
  alias: motion_device_smoke_high_dismiss
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    notification_id: >-
      {{ 'device-' + class + '-high' }}
  action:
    - alias: 'dismiss smoke high notification'
      service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{ notification_id }}

## good

- id: motion_device_smoke_good
  alias: motion_device_smoke_good
  mode: restart
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke'
      attribute: 'good'
  variables:
    details: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','good')|lower != 'none' %}
        {% set s = state_attr('binary_sensor.motion_device_smoke','good') %}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- state_attr(i.entity_id,'friendly_name') }} is {{ states(i.entity_id) -}}"
          {%- endfor -%}]
        {%- else -%}none{%- endif %}
      {%- else -%}none{%- endif %}
    state: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','good') %}
      {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
        {% if s|list|count > 0 %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
    last: >-
      {% if state|lower == 'off' %}
        {{ state_attr('binary_sensor.motion_device_smoke_good','last') }}
      {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_good
        last: >-
          {{ last }}
        details: >-
          {{ details }}
        state: >-
          {{ state }}

- id: motion_device_smoke_good_off
  alias: motion_device_smoke_good_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke good not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','good') }}
  variables:
    good: >-
      {% set s = state_attr('binary_sensor.motion_device_class','good') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set good = s -%}
        {%- else -%}
          {% set good = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if good is defined -%}
        {{ good }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if good list of device classes is valid'
      condition: template
      value_template: >-
        {{ good|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class good attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        good: >-
          {{ good }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_good_on
  alias: motion_device_smoke_good_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke good not on'
        condition: template
        value_template: >-
          {{ not 'smoke' in state_attr('binary_sensor.motion_device_class','good') }}
  variables:
    good: >-
      {% set s = state_attr('binary_sensor.motion_device_class','good') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set good = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set good = ['smoke'] -%}
      {%- endif %}
      {%- if good is defined -%}
        {{ good }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if good list of device classes is valid'
      condition: template
      value_template: >-
        {{ good|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class good attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        good: >-
          {{ good }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_alarm_good_on
  alias: motion_device_smoke_alarm_good_on
  mode: single
  initial_state: 'off'
  trigger:
    - platform: template
      value_template: >-
        {{ not is_state_attr('binary_sensor.motion_device_smoke_exist','good','none')
           and is_state_attr('binary_sensor.motion_device_smoke_exist','good',states('binary_sensor.motion_device_smoke')) }}
  variables:
    devices: >-
      {% set devices = none %}
      {% set s = state_attr('binary_sensor.motion_device_smoke','devices') %}
      {% if s|lower != 'none' and s|lower != 'null' and not s is string and s is iterable and s|count > 0 %}
        {% set devices = s %}
      {%- endif %}
      {{ devices }}
    last: >-
      {% set last = none %}
      {% set s = state_attr('binary_sensor.motion_device_smoke','status')|selectattr('state','==',state_attr('binary_sensor.motion_device_smoke_exist','good'))|sort(attribute='updated',reverse=true)|list %}
      {% if s|lower != 'none' and s|lower != 'null' and not s is string and s is iterable and s|count > 0 %}
        {% set last = s %}
      {%- endif %}
      {{ last  }}
    which: >-
      {% set which = none %}
      {% if last|lower != 'none' %}
        {% set which = last|map(attribute='id')|first %}
      {%- endif %}
      {{ which }}
    did: >-
      {% set did = none %}
      {% if devices|lower != 'none'  and which|lower != 'none' %}
        {% set did = devices|selectattr('id','==',which)|map(attribute='did')|first %}
      {%- endif %}
      {{ did }}
    where: >-
      {% set where = none %}
      {% if devices|lower != 'none'  and which|lower != 'none' %}
        {% set where = devices|selectattr('id','==',which)|map(attribute='area')|first %}
      {%- endif %}
      {{ where }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ which|lower != 'none' and which|lower != 'null' and which|length > 0 }}
  action:
    - variables:
        markdown: >-
          A <a href="/lovelace-primary/smoke">smoke</a> alarm was triggered ({{- state_attr('binary_sensor.motion_device_smoke_exist','good')|string -}}); sensor: {{ which -}}; where: {{ where -}}; at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}.
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_good
        markdown: >-
          {{ markdown }}
    - alias: 'update binary_sensor.motion_device_smoke which, where, did'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke
        which: >-
          {{ which }}
        where: >-
          {{ where }}
        did: >-
          {{ did }}
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger motion notification'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_good_notify

- id: motion_device_smoke_good_notify
  alias: motion_device_smoke_good_notify
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    ids: >-
      {% set ids = state_attr('binary_sensor.motion_device_smoke','ids') %}
      {{ ids }}
    which: >-
      {% set which = state_attr('binary_sensor.motion_device_smoke','which') %}
      {{ which }}
    where: >-
      {% set where = state_attr('binary_sensor.motion_device_smoke','where') %}
      {{ where }}
    did: >-
      {% set did = state_attr('binary_sensor.motion_device_smoke','did') %}
      {{ did }}
    action: >-
      {% set action = class + '-alarm' %}
      {{ action }}
    url: >-
      {% set url = '/lovelace-primary/' + class %}
      {{ url }}
    title: >-
      {% set title = states('sensor.motion_app') + ': smoke good' %}
      {{ title }}
    notification_id: >-
      {{ 'device-smoke-status-' + which|string }}
    icon: >-
      {% set icon = 'notification-smoke-good' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      {{ state_attr('binary_sensor.motion_device_smoke_good','markdown') }}
      <p>We have notified <b>{{- state_attr('sensor.motion_role_primary','friendly_name')|replace("'","") -}}</b> about your smoke alarm.
      To inspect and change the alarm click the <b>{{- action -}}</b> button below.
      {{- '<p>' -}}
      <a href="{{- url -}}"><img src="https://img.shields.io/badge/{{- action -}}-yellow.svg"></a>
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify smoke sensor activated'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

## activity

- id: motion_device_smoke_activity
  alias: motion_device_smoke_activity
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke'
      attribute: 'activity'
  variables:
    ids: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','activity') %}
      {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
        {{ s|map(attribute='id')|sort|unique|list }}
      {%- else -%}none{%- endif %}
    details: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','activity') %}
      {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
        "{{ s }}"
      {%- else -%}none{%- endif %}
    state: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','activity') %}
      {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
        {% if s|count > 0 %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
    last: >-
      {% if state|lower == 'off' %}
        {{ state_attr('binary_sensor.motion_device_smoke_activity','last') }}
      {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_activity
        last: >-
          {{ last }}
        ids: >-
          {{ ids }}
        details: >-
          {{ details }}
        state: >-
          {{ state }}

- id: motion_device_smoke_activity_off
  alias: motion_device_smoke_activity_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke activity not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','activity') }}
  variables:
    activity: >-
      {% set s = state_attr('binary_sensor.motion_device_class','activity') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set activity = s -%}
        {%- else -%}
          {% set activity = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if activity is defined -%}
        {{ activity }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if activity list of device classes is valid'
      condition: template
      value_template: >-
        {{ activity|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class activity attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        activity: >-
          {{ activity }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_activity_on
  alias: motion_device_smoke_activity_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke activity not on'
        condition: template
        value_template: >-
          {{ not 'smoke' in state_attr('binary_sensor.motion_device_class','activity') }}
  variables:
    activity: >-
      {% set s = state_attr('binary_sensor.motion_device_class','activity') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set activity = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set activity = ['smoke'] -%}
      {%- endif %}
      {%- if activity is defined -%}
        {{ activity }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if activity list of device classes is valid'
      condition: template
      value_template: >-
        {{ activity|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class activity attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        activity: >-
          {{ activity }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_alarm_activity
  alias: motion_device_smoke_alarm_activity
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_activity'
      to: 'on'
  variables:
    activity: >-
      {{ state_attr('binary_sensor.motion_device_smoke','activity') }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ activity|lower != 'none' and activity|lower != 'null' and activity|length > 0 }}
  action:
    - variables:
        markdown: >-
          {%- if activity|lower != 'none' and not activity is string and activity is iterable and activity|count > 0 -%}
            A <a href="/lovelace-primary/smoke">smoke</a> <a href="/notify-activity">activity</a> alarm was triggered at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}:
            {%- for i in activity -%}
              {%- if loop.first -%}{{- '<ul>' -}}{%- endif -%}
              {%- set d = state_attr('binary_sensor.motion_device_class','devices') -%}
              {%- if d|lower != 'none' and d|lower != 'unknown' and not d is string and d is iterable and d|count > 0 -%}
                {%- set d = d|selectattr('id','==',i.id)|list -%}
                {%- if d|lower != 'none' and d|lower != 'unknown' and not d is string and d is iterable and d|count > 0 -%}
                  {%- set d = d|first -%}
                  <li><a href="/config/devices/device/{{- d.did -}}">{{- d.friendly_name|replace("'","") -}}</a> in <a href="/config/areas/area/{{- area_id(activity[loop.index-1].entity_id) -}})">{{- area_id(activity[loop.index-1].entity_id) -}}</a></li>
                {%- else -%}
                  <li>{{- i.id -}} is {{ states(i.entity_id) -}}</li>
                {%- endif -%}
              {%- else -%}
                <li>{{- i.id -}} is {{ states(i.entity_id) -}}</li>
              {%- endif -%}
              {%- if loop.last -%}{{- '</ul>' -}}{%- endif -%}
            {%- endfor -%}
          {%- else -%}
            {{- '<b>No smoke activity</b>' -}}
          {%- endif -%}
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_activity
        markdown: >-
          {{ markdown }}
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger motion notification'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_activity_notify

- id: motion_device_smoke_activity_notify
  alias: motion_device_smoke_activity_notify
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    activity: >-
      {% set activity = state_attr('binary_sensor.motion_device_smoke','activity') %}
      {{ activity }}
    action: >-
      {% set action = class + '-alarm' %}
      {{ action }}
    url: >-
      {% set url = '/notify-activity/' %}
      {{ url }}
    title: >-
      {% set title = states('sensor.motion_app') + ': smoke activity alarm' %}
      {{ title }}
    notification_id: >-
      {{ 'device-smoke-activity' }}
    icon: >-
      {% set icon = 'notification-smoke-activity' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      {{ state_attr('binary_sensor.motion_device_class_smoke_activity','markdown') }}
      <p>We have notified <b>{{- state_attr('sensor.motion_role_primary','friendly_name')|replace("'","") -}}</b> about your smoke alarm.
      To inspect and change the alarm click the <b>{{- action -}}</b> button below.
      {{- '<p>' -}}
      <a href="{{- url -}}"><img src="https://img.shields.io/badge/{{- action -}}-yellow.svg"></a>
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify smoke sensor activated'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

## alarm

- id: motion_device_smoke_alarm_off
  alias: motion_device_smoke_alarm_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke alarm not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','alarm') }}
  variables:
    alarm: >-
      {% set s = state_attr('binary_sensor.motion_device_class','alarm') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set alarm = s -%}
        {%- else -%}
          {% set alarm = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if alarm is defined -%}
        {{ alarm }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if alarm list of device classes is valid'
      condition: template
      value_template: >-
        {{ alarm|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class alarm attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        alarm: >-
          {{ alarm }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_alarm_on
  alias: motion_device_smoke_alarm_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke alarm not on'
        condition: template
        value_template: >-
          {{ not 'smoke' in state_attr('binary_sensor.motion_device_class','alarm') }}
  variables:
    alarm: >-
      {% set s = state_attr('binary_sensor.motion_device_class','alarm') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set alarm = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set alarm = ['smoke'] -%}
      {%- endif %}
      {%- if alarm is defined -%}
        {{ alarm }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if alarm list of device classes is valid'
      condition: template
      value_template: >-
        {{ alarm|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class alarm attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        alarm: >-
          {{ alarm }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

## toggle

- id: motion_device_smoke_turn_on
  alias: motion_device_smoke_turn_on
  mode: single
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_smoke_turn_on','on') }}
  variables:
    entity_ids: >-
      {{ state_attr('binary_sensor.motion_device_smoke_turn_on','entity_ids') }}
  action:
    - alias: 'turn_on smoke sensors'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = entity_ids[repeat.index - 1]|default('unknown') -%}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - service: switch.turn_on
            data_template:
              entity_id: >-
                {{ entity_ids[repeat.index - 1] }}

- id: motion_device_smoke_turn_off
  alias: motion_device_smoke_turn_off
  mode: single
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_smoke_turn_off','on') }}
  variables:
    entity_ids: >-
      {{ state_attr('binary_sensor.motion_device_smoke_turn_off','entity_ids') }}
  action:
    - alias: 'turn_off smoke sensors'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = entity_ids[repeat.index - 1]|default('unknown') -%}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - service: switch.turn_off
            data_template:
              entity_id: >-
                {{ entity_ids[repeat.index - 1] }}

- id: motion_device_smoke_toggle
  alias: motion_device_smoke_toggle
  mode: single
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_smoke_toggle','on') }}
  variables:
    entity_ids: >-
      {{ state_attr('binary_sensor.motion_device_smoke_toggle','entity_ids') }}
  action:
    - alias: 'toggle smoke sensors'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = entity_ids[repeat.index - 1]|default('unknown') -%}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - service: switch.toggle
            data_template:
              entity_id: >-
                {{ entity_ids[repeat.index - 1] }}

## update, restart, and other contols

- id: motion_device_smoke_self_test
  alias: motion_device_smoke_self_test
  mode: single
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test if self_test is on'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_smoke_self_test','on') }}
  variables:
    entity_ids: >-
      {{ state_attr('binary_sensor.motion_device_smoke_self_test','entity_ids') }}
  action:
    - alias: 'test smoke sensors'
      repeat:
        while:
          - alias: 'test if not done'
            condition: template
            value_template: >-
              {% set s = entity_ids[repeat.index - 1]|default('unknown') -%}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - alias: 'pressing button'
            service: button.press
            data_template:
              entity_id: >-
                {{ entity_ids[repeat.index - 1] }}

- id: motion_device_smoke_mute
  alias: motion_device_smoke_mute
  mode: single
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_smoke_mute','on') }}
  variables:
    entity_ids: >-
      {{ state_attr('binary_sensor.motion_device_smoke_mute','entity_ids') }}
  action:
    - alias: 'mute smoke sensors'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = entity_ids[repeat.index - 1]|default('unknown') -%}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - service: button.press
            data_template:
              entity_id: >-
                {{ entity_ids[repeat.index - 1] }}

- id: motion_device_smoke_unmute
  alias: motion_device_smoke_unmute
  mode: single
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_smoke_unmute','on') }}
  variables:
    entity_ids: >-
      {{ state_attr('binary_sensor.motion_device_smoke_unmute','entity_ids') }}
  action:
    - alias: 'unmute smoke sensors'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = entity_ids[repeat.index - 1]|default('unknown') -%}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - service: button.press
            data_template:
              entity_id: >-
                {{ entity_ids[repeat.index - 1] }}

- id: motion_device_smoke_restart
  alias: motion_device_smoke_restart
  mode: single
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_smoke_restart','on') }}
  variables:
    entity_ids: >-
      {{ state_attr('binary_sensor.motion_device_smoke_restart','entity_ids') }}
  action:
    - alias: 'restart smoke sensors'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = entity_ids[repeat.index - 1]|default('unknown') -%}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - service: button.press
            data_template:
              entity_id: >-
                {{ entity_ids[repeat.index - 1] }}

- id: motion_device_smoke_update
  alias: motion_device_smoke_update
  mode: single
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_smoke_update','on') }}
  variables:
    entity_ids: >-
      {{ state_attr('binary_sensor.motion_device_smoke_update','entity_ids') }}
  action:
    - alias: 'update smoke sensors'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = entity_ids[repeat.index - 1]|default('unknown') -%}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - service: button.press
            data_template:
              entity_id: >-
                {{ entity_ids[repeat.index - 1] }}

## notifications

# found

- id: motion_device_smoke_found
  alias: motion_device_smoke_found
  mode: single
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_smoke_exist
      to: 'on'
  variables:
    class: >-
      {{- 'smoke' -}}
    ids: >-
      {% set ids = state_attr('binary_sensor.motion_device_smoke','ids') -%}
      {{ ids }}
    devices: >-
      {% set devices = state_attr('binary_sensor.motion_device_smoke','devices') -%}
      {{ devices }}
    title: >-
      {% set title = states('sensor.motion_app') + ': smoke sensor found' -%}
      {{ title }}
    notification_id: >-
      {{ 'device-' + class|string + '-notify' }}
    icon: >-
      {% set icon = 'notification-' + class|string + '-found' -%}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      {%- if devices|lower != 'none' -%}
        Sensor(s) for smoke found at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}
        {%- for i in devices -%}
         {%- if loop.first -%}<ul>{%- endif -%}
          <li><a href="/config/devices/device/{{- i.did -}}">{{- i.friendly_name|replace("'","") -}}</a> in <a href="/config/areas/area/{{- i.area -}}">{{- i.area -}}</a></li>
         {%- if loop.last -%}</ul>{%- endif -%}
        {%- endfor -%}
      {%- else -%}
        <b>INVALID</b>: no devices with smoke sensors at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
      {%- endif -%}
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify found smoke sensor'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

- id: motion_device_smoke_found_dismiss
  alias: motion_device_smoke_found_dismiss
  mode: single
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_smoke_exist
      to: 'on'
      for:
        minutes: >-
          {{ states('input_number.motion_device_class_dismiss')|int(5) }}
  variables:
    notification_id: >-
      {{ 'device-smoke-notify' }}
  action:
    - alias: 'dismiss smoke found notification'
      service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{ notification_id }}

# cleared notify

- id: motion_device_smoke_cleared_notify
  alias: motion_device_smoke_cleared_notify
  mode: single
  initial_state: 'off'
  trigger:
    - platform: template
      value_template: >-
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','good',states('binary_sensor.motion_device_smoke')) }}
  variables:
    class: >-
      {{- 'smoke' -}}
    which: >-
      {% set which = none %}
      {% set s = state_attr('binary_sensor.motion_device_smoke','status')|selectattr('state','==','off')|sort(attribute='updated',reverse=true)|list %}
      {% if s|lower != 'none' and s|lower != 'null' and not s is string and s is iterable and s|count > 0 %}
        {% set which = s|map(attribute='id')|first  %}
      {%- endif %}
      {{ which }}
    notification_id: >-
      {{ 'device-smoke-status-' + which|string }}
    icon: >-
      {% set icon = 'notification-smoke-good' %}
      {{ icon }}
    title: >-
      {% set title = states('sensor.motion_app') + ': smoke good (' + state_attr('binary_sensor.motion_device_smoke_exist','good')|string + ')' %}
      {{ title }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      The <a href="/notify-devices/smoke">smoke</a> alarm has cleared; sensor: {{ which -}}.
    message: >-
      {{- header -}}{<hr>{- body -}}{{- footer -}}
  action:
    - condition: template
      value_template: >
        {{ which|lower != 'none' and is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'notify smoke sensor activated'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

# cleared dismissed

- id: motion_device_smoke_cleared_dismiss
  alias: motion_device_smoke_cleared_dismiss
  mode: single
  initial_state: 'off'
  trigger:
    - platform: template
      value_template: >-
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','good',states('binary_sensor.motion_device_smoke')) }}
      for:
        minutes: >-
          {{ states('input_number.motion_device_class_dismiss')|int(5) }}
  variables:
    ids: >-
      {%- set ids = state_attr('binary_sensor.motion_device_smoke','ids') -%}
      {%- if ids|lower != 'none' and not ids is string and ids is iterable and ids|count > 0 -%}
        [{%- for i in ids -%}
          {%- if not loop.first -%},{%- endif -%}
          "{{- 'device-smoke-status-' + i|string -}}"
        {%- endfor -%}]
      {%- else -%}none{%- endif %}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ ids|lower != 'none' and ids is iterable and ids|count > 0 }}
  action:
    - alias: 'dismiss smoke status'
      repeat:
        while:
          - alias: 'test if not done'
            condition: template
            value_template: >-
              {%- set s = ids[repeat.index - 1]|default('unknown') %}
              {{ s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|string|length > 0 }}
        sequence:
          - alias: 'dismissing persistent notification'
            service: persistent_notification.dismiss
            data_template:
              notification_id: >-
                {{ ids[repeat.index - 1] }}

# activity,unavailable

- id: motion_device_smoke_unavailable
  alias: motion_device_smoke_unavailable
  mode: restart
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke'
      attribute: 'unavailable'
  variables:
    ids: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','unavailable') %}
      {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
        {{ s|map(attribute='id')|sort|unique|list }}
      {%- else -%}none{%- endif %}
    details: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','unavailable') -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          { {%- for i in s|map(attribute='id')|sort|unique -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{ i }}":
            [{%- for j in s|selectattr('id','==',i)|map(attribute='entity_id') -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- state_attr(j,'friendly_name') -}}"
            {%- endfor -%}]
          {% endfor %} }
        {%- else -%}none{%- endif %}
    state: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','unavailable') %}
      {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
        {% if s|count > 0 %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
    last: >-
      {% if state|lower == 'off' %}
        {{ state_attr('binary_sensor.motion_device_smoke_unavailable','last') }}
      {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
    markdown: >-
      {%- if details|lower != 'none' -%}
        {%- for i in details -%}
          {%- if loop.first -%}<ul>{%- endif -%}
          {{- '<li>' -}}
          {%- set e = state_attr('binary_sensor.motion_device_smoke','status') -%}
          {%- if e|lower != 'none' and not e is string and e is iterable and e|count > 0 -%}
            {%- set e = e|selectattr('id','==',i)|list -%}
            {%- if e|lower != 'none' and not e is string and e is iterable and e|count > 0 -%}
              {%- set e = e|first -%}
              {%- set did = device_id(e.entity_id) -%}
              <a href="/config/devices/device/{{- did -}}"><b>{{- device_attr(device_id(e.entity_id),'name') -}}</b></a><br><i>Last updated</i>: {{- e.updated|as_datetime|relative_time }} ago
              {%- for j in details[i] -%}
                {%- if loop.first -%}<ul>{%- endif -%}
                <li>{{- j -}}</li>
                {%- if loop.last %}</ul>{% endif -%}
              {%- endfor -%}
              {{- '</li>' -}}
              {%- if loop.last %}</ul>{% endif -%}
            {%- else -%}
              <li>{{ i }} is {{ states(i.entity_id) }}</li>
            {%- endif -%}
          {%- else -%}
            <li>{{ i }} is {{ states(i.entity_id) }}</li>
          {%- endif -%}
        {%- endfor -%}
      {%- else -%}
        <b>No unavailable smoke sensors</b> at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}
      {%- endif %}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_unavailable
        last: >-
          {{ last }}
        ids: >-
          {{ ids }}
        details: >-
          {{ details }}
        markdown: >-
          {{ markdown }}
        state: >-
          {{ state }}

# missing

- id: motion_device_smoke_missing
  alias: motion_device_smoke_missing
  mode: restart
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_smoke_exist
    - platform: template
      value_template: >-
        {{ is_state_attr('automation.motion_device_smoke_rescan','current',0)
           and is_state_attr('binary_sensor.motion_device_smoke_exist','required','on') }}
  variables:
    state: >-
      {% set state = 'off' %}
      {% if is_state('binary_sensor.motion_device_smoke_exist','off')
       and is_state_attr('automation.motion_device_smoke_rescan','current',0)
       and is_state_attr('binary_sensor.motion_device_smoke_exist','required','on') %}
        {% set state = 'on' %}
      {% endif %}
      {{ state }}
    last: >-
      {% set last = state_attr('binary_sensor.motion_device_smoke_missing','last') %}
      {% if state|lower == 'off' or last|lower == 'none' %}
        {% set last = utcnow().timestamp() %}
      {% endif %}
      {{ last }}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_missing
        last: >-
          {{ last }}
        markdown: >-
          No smoke sensors have been found.
          At {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}};
          for {{ last|as_datetime|relative_time -}};
          please setup the integration by clicking [here](/config/integrations).
        state: >-
          {{ state }}

- id: motion_device_smoke_missing_notify
  alias: motion_device_smoke_missing_notify
  mode: single
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_smoke_missing
      to: 'on'
  variables:
    class: >-
      {{ 'smoke' }}
    ip: >-
      {{ none }}
    latitude: >-
      {{ none }}
    longitude: >-
      {{ none }}
    notification_id: >-
      {{ 'device-smoke-missing' }}
    icon: >-
      {% set icon = 'notification-smoke-missing' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    title: >-
      {% set title = states('sensor.motion_app') + ': smoke sensor missing' %}
      {{ title }}
    body: >-
      {{ state_attr('binary_sensor.motion_device_smoke_missing','markdown') }}
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify missing smoke sensor'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

## high_spike

- id: motion_device_smoke_high_spike
  alias: motion_device_smoke_high_spike
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke'
      attribute: 'high_spike'
  variables:
    details: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','high_spike')|lower != 'none' %}
        {% set s = state_attr('binary_sensor.motion_device_smoke','high_spike') %}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- state_attr(i.entity_id,'friendly_name') }} is {{ states(i.entity_id)|int('unknown') -}}{{ state_attr(i.entity_id,'unit_of_measurement') -}}"
          {%- endfor -%}]
        {%- else -%}none{%- endif %}
      {%- else -%}none{%- endif %}
    state: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','high_spike') %}
      {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
        {% if s|list|count > 0 %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
    last: >-
      {% if state|lower == 'off' %}
        {{ state_attr('binary_sensor.motion_device_smoke_high_spike','last') }}
      {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_high_spike
        last: >-
          {{ last }}
        details: >-
          {{ details }}
        state: >-
          {{ state }}

- id: motion_device_smoke_high_spike_off
  alias: motion_device_smoke_high_spike_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke high_spike not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','high_spike') }}
  variables:
    high_spike: >-
      {% set s = state_attr('binary_sensor.motion_device_class','high_spike') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set high_spike = s -%}
        {%- else -%}
          {% set high_spike = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if high_spike is defined -%}
        {{ high_spike }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if high_spike list of device classes is valid'
      condition: template
      value_template: >-
        {{ high_spike|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class high_spike attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        high_spike: >-
          {{ high_spike }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_high_spike_on
  alias: motion_device_smoke_high_spike_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke high_spike not on'
        condition: template
        value_template: >-
          {{ not 'smoke' in state_attr('binary_sensor.motion_device_class','high_spike') }}
  variables:
    high_spike: >-
      {% set s = state_attr('binary_sensor.motion_device_class','high_spike') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set high_spike = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set high_spike = ['smoke'] -%}
      {%- endif %}
      {%- if high_spike is defined -%}
        {{ high_spike }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if high_spike list of device classes is valid'
      condition: template
      value_template: >-
        {{ high_spike|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class high_spike attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        high_spike: >-
          {{ high_spike }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_alarm_high_spike_on
  alias: motion_device_smoke_alarm_high_spike_on
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_high_spike'
      to: 'on'
  variables:
    high_spike: >-
      {{ state_attr('binary_sensor.motion_device_smoke','high_spike') }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{- high_spike|lower != 'none' and high_spike|lower != 'unknown' and not high_spike is string and high_spike is iterable and high_spike|count > 0 -}}
  action:
    - variables:
        markdown: >-
          The <a href="/lovelace-primary/smoke">smoke</a> spike alarm was triggered (above {{ state_attr('sensor.motion_device_smoke_high_spike','limit') -}}) at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}:<br>
          {%- for i in high_spike if 'id' in i and i.id|lower != 'none' -%}
            {%- if loop.first -%}{{- '<ul>' -}}{%- endif -%}
            {%- set d = state_attr('binary_sensor.motion_device_class','devices') -%}
            {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
              {%- set d = d|selectattr('id','==',i.id)|list -%}
              {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
                {%- set d = d|first -%}
                <li><a href="/config/devices/device/{{- d.did -}}">{{- d.friendly_name|replace("'","") -}}</a> is {{ states(high_spike[loop.index-1].entity_id) -}}{{- state_attr(high_spike[loop.index-1].entity_id,'unit_of_measurement') }} in <a href="/config/areas/area/{{- area_id(high_spike[loop.index-1].entity_id) -}}">{{- area_id(high_spike[loop.index-1].entity_id) -}}</a></li>
              {%- else -%}
                <li>{{- i.id }} smoke is {{ states(i.entity_id) -}}{{- state_attr(i.entity_id,'unit_of_measurement') }}</li>
              {%- endif -%}
            {%- else -%}
              {{- '<li>' -}}
              {{- i.id }} smoke is {{ states(i.entity_id) -}}{{- state_attr(i.entity_id,'unit_of_measurement') }}
              {{- '</li>' -}}
            {%- endif -%}
            {%- if loop.last -%}{{- '</ul>' -}}{%- endif -%}
          {%- endfor -%}
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_high_spike
        markdown: >-
          {{ markdown }}
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger motion notification'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_high_spike_notify

- id: motion_device_smoke_alarm_high_spike_off
  alias: motion_device_smoke_alarm_high_spike_off
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_high_spike'
      to: 'off'
  action:
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger smoke high_spike dismiss'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_high_spike_dismiss

- id: motion_device_smoke_high_spike_notify
  alias: motion_device_smoke_high_spike_notify
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    high_spike: >-
      {% set high_spike = state_attr('binary_sensor.motion_device_smoke','high_spike') %}
      {{ high_spike }}
    action: >-
      {% set action = class + '-alarm' %}
      {{ action }}
    url: >-
      {% set url = '/lovelace-primary/' + class %}
      {{ url }}
    title: >-
      {% set title = states('sensor.motion_app') + ': ' + class + ' high_spike' %}
      {{ title }}
    notification_id: >-
      {{ 'device-' + class + '-high_spike' }}
    icon: >-
      {% set icon = 'notification-' + class + '-high_spike' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      {{ state_attr('binary_sensor.motion_device_smoke_high_spike','markdown') }}
      <p>We have notified <b>{{- state_attr('sensor.motion_role_primary','friendly_name')|replace("'","") -}}</b> about your smoke alarm.
      To inspect and change the alarm click the <b>{{- action -}}</b> button below.
      {{- '<p>' -}}
      <a href="{{- url -}}"><img src="https://img.shields.io/badge/{{- action -}}-yellow.svg"></a>
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify smoke sensor activated'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

- id: motion_device_smoke_high_spike_dismiss
  alias: motion_device_smoke_high_spike_dismiss
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    notification_id: >-
      {{ 'device-' + class + '-high_spike' }}
  action:
    - alias: 'dismiss smoke high_spike notification'
      service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{ notification_id }}

## low_spike

- id: motion_device_smoke_low_spike
  alias: motion_device_smoke_low_spike
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke'
      attribute: 'low_spike'
  variables:
    details: >-
      {% if state_attr('binary_sensor.motion_device_smoke_exist','low_spike')|lower != 'none' %}
        {% set s = state_attr('binary_sensor.motion_device_smoke','low_spike') %}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s is iterable -%}
          [{% for i in s -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- state_attr(i.entity_id,'friendly_name') }} is {{ states(i.entity_id)|int('unknown') -}}{{ state_attr(i.entity_id,'unit_of_measurement') -}}"
          {%- endfor -%}]
        {%- else -%}none{%- endif %}
      {%- else -%}none{%- endif %}
    state: >-
      {% set s = state_attr('binary_sensor.motion_device_smoke','low_spike') %}
      {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
        {% if s|list|count > 0 %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
    last: >-
      {% if state|lower == 'off' %}
        {{ state_attr('binary_sensor.motion_device_smoke_low_spike','last') }}
      {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
  condition:
    - condition: template
      value_template: >
        {{ state|lower != 'unknown' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_low_spike
        last: >-
          {{ last }}
        details: >-
          {{ details }}
        state: >-
          {{ state }}

- id: motion_device_smoke_low_spike_off
  alias: motion_device_smoke_low_spike_off
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke low_spike not off'
        condition: template
        value_template: >-
          {{ 'smoke' in state_attr('binary_sensor.motion_device_class','low_spike') }}
  variables:
    low_spike: >-
      {% set s = state_attr('binary_sensor.motion_device_class','low_spike') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|reject('==','smoke')|list -%}
        {%- if not s is string and s is iterable and s|count > 0 -%}
          {% set low_spike = s -%}
        {%- else -%}
          {% set low_spike = [] -%}
        {%- endif %}
      {%- endif %}
      {%- if low_spike is defined -%}
        {{ low_spike }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if low_spike list of device classes is valid'
      condition: template
      value_template: >-
        {{ low_spike|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class low_spike attribute; remove: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        low_spike: >-
          {{ low_spike }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_low_spike_on
  alias: motion_device_smoke_low_spike_on
  mode: single
  max_exceeded: silent
  initial_state: 'off'
  trigger:
  condition:
    condition: and
    conditions:
      - alias: 'test setup complete'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_device_class','on') }}
      - alias: 'smoke low_spike not on'
        condition: template
        value_template: >-
          {{ not 'smoke' in state_attr('binary_sensor.motion_device_class','low_spike') }}
  variables:
    low_spike: >-
      {% set s = state_attr('binary_sensor.motion_device_class','low_spike') -%}
      {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set low_spike = (s|list + ['smoke'])|sort|unique|list -%}
      {%- else -%}
        {%- set low_spike = ['smoke'] -%}
      {%- endif %}
      {%- if low_spike is defined -%}
        {{ low_spike }}
      {%- else -%}none{%- endif %}
  action:
    - alias: 'test if low_spike list of device classes is valid'
      condition: template
      value_template: >-
        {{ low_spike|lower != 'none' }}
    - alias: 'update binary_sensor.motion_device_class low_spike attribute; add: smoke'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        low_spike: >-
          {{ low_spike }}
    - alias: 'update binary_sensor.motion_device_smoke_exist'
      service: homeassistant.update_entity
      entity_id: binary_sensor.motion_device_smoke_exist

- id: motion_device_smoke_alarm_low_spike_on
  alias: motion_device_smoke_alarm_low_spike_on
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_low_spike'
      to: 'on'
  variables:
    low_spike: >-
      {{ state_attr('binary_sensor.motion_device_smoke','low_spike') }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{- low_spike|lower != 'none' and low_spike|lower != 'unknown' and not low_spike is string and low_spike is iterable and low_spike|count > 0 -}}
  action:
    - variables:
        markdown: >-
          The <a href="/lovelace-primary/smoke">smoke</a> spike alarm was triggered (below {{ state_attr('sensor.motion_device_smoke_low_spike','limit') -}}) at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}:<br>
          {%- for i in low_spike if 'id' in i and i.id|lower != 'none' -%}
            {%- if loop.first -%}{{- '<ul>' -}}{%- endif -%}
            {%- set d = state_attr('binary_sensor.motion_device_class','devices') -%}
            {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
              {%- set d = d|selectattr('id','==',i.id)|list -%}
              {%- if d|lower != 'none' and not d is string and d is iterable and d|count > 0 -%}
                {%- set d = d|first -%}
                <li><a href="/config/devices/device/{{- d.did -}}">{{- d.friendly_name|replace("'","") -}}</a> is {{ states(low_spike[loop.index-1].entity_id) -}}{{- state_attr(low_spike[loop.index-1].entity_id,'unit_of_measurement') }} in <a href="/config/areas/area/{{- area_id(low_spike[loop.index-1].entity_id) -}}">{{- area_id(low_spike[loop.index-1].entity_id) -}}</a></li>
              {%- else -%}
                <li>{{- i.id }} smoke is {{ states(i.entity_id) -}}{{- state_attr(i.entity_id,'unit_of_measurement') }}</li>
              {%- endif -%}
            {%- else -%}
              {{- '<li>' -}}
              {{- i.id }} smoke is {{ states(i.entity_id) -}}{{- state_attr(i.entity_id,'unit_of_measurement') }}
              {{- '</li>' -}}
            {%- endif -%}
            {%- if loop.last -%}{{- '</ul>' -}}{%- endif -%}
          {%- endfor -%}
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_smoke_low_spike
        markdown: >-
          {{ markdown }}
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger motion notification'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_low_spike_notify

- id: motion_device_smoke_alarm_low_spike_off
  alias: motion_device_smoke_alarm_low_spike_off
  mode: single
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_smoke_low_spike'
      to: 'off'
  action:
    - condition: template
      value_template: >
        {{ is_state_attr('binary_sensor.motion_device_smoke_exist','alarm','on') }}
    - alias: 'trigger smoke low_spike dismiss'
      service: automation.trigger
      data_template:
        entity_id: automation.motion_device_smoke_low_spike_dismiss

- id: motion_device_smoke_low_spike_notify
  alias: motion_device_smoke_low_spike_notify
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    low_spike: >-
      {% set low_spike = state_attr('binary_sensor.motion_device_smoke','low_spike') %}
      {{ low_spike }}
    action: >-
      {% set action = class + '-alarm' %}
      {{ action }}
    url: >-
      {% set url = '/lovelace-primary/' + class %}
      {{ url }}
    title: >-
      {% set title = states('sensor.motion_app') + ': ' + class + ' low_spike' %}
      {{ title }}
    notification_id: >-
      {{ 'device-' + class + '-low_spike' }}
    icon: >-
      {% set icon = 'notification-' + class + '-low_spike' %}
      {{ icon }}
    header: >-
      {{- '<img src="/local/images/icons/' + icon + '.png?v1">' -}}
    footer: >-
      <br><a href="/notify-devices/{{- class -}}"><img src="https://img.shields.io/badge/{{- class -}}-device-cyan.svg"></a>
      {%- if did is defined and did|lower != 'none' and did|lower != 'null' -%}
         <br><a href="/config/devices/device/{{- did -}}"><img src="https://img.shields.io/badge/{{- class -}}-config-blue.svg"></a>
      {%- endif -%}
    body: >-
      {{ state_attr('binary_sensor.motion_device_smoke_low_spike','markdown') }}
      <p>We have notified <b>{{- state_attr('sensor.motion_role_primary','friendly_name')|replace("'","") -}}</b> about your smoke alarm.
      To inspect and change the alarm click the <b>{{- action -}}</b> button below.
      {{- '<p>' -}}
      <a href="{{- url -}}"><img src="https://img.shields.io/badge/{{- action -}}-yellow.svg"></a>
    message: >-
      {{- header -}}<hr>{{- body -}}{{- footer -}}
  action:
    - alias: 'notify smoke sensor activated'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

- id: motion_device_smoke_low_spike_dismiss
  alias: motion_device_smoke_low_spike_dismiss
  mode: single
  initial_state: 'off'
  trigger:
  variables:
    class: >-
      {{ 'smoke' }}
    notification_id: >-
      {{ 'device-' + class + '-low_spike' }}
  action:
    - alias: 'dismiss smoke low_spike notification'
      service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{ notification_id }}
