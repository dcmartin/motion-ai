###
# homeassistant/automation/motion/device/class.yaml
###

## rescan_all

- id: motion_device_class_rescan_all
  alias: motion_device_class_rescan_all
  mode: 'restart'
  max_exceeded: 'warn'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_class'
      attribute: 'sensors'
    - platform: state
      entity_id: 'binary_sensor.motion_device_class'
      attribute: 'binary_sensors'
  variables:
    classes: >-
      {{- state_attr('binary_sensor.motion_device_class','categorys') -}}
  action:
    - repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = classes[repeat.index-1]|default('') %}
              {{ s|string != '' }}
        sequence:
          - variables:
              automation: >-
                {% set s = classes[repeat.index-1] %}
                {{ 'automation.motion_device_' + s|string + '_rescan' }}
          - alias: 'test if class rescan automation is ON and NOT running'
            condition: template
            value_template: >-
              {{ is_state(automation,'on') and is_state_attr(automation,'current',0) }}
          - alias: 'trigger automation motion_device_<class>_rescan'
            service: automation.trigger
            data_template:
              entity_id: >-
                {{ automation }}
    - alias: 'trigger automation class_rescan'
      service: automation.trigger
      data_template:
        entity_id: >-
          {{ 'automation.motion_device_class_rescan' }}

## rescan

- id: motion_device_class_rescan_watchdog
  alias: motion_device_class_rescan_watchdog
  mode: 'restart'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: 'group.motion_devices'
    - platform: time_pattern
      minutes: '/5'
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {{ states('sensor.motion_log_level') in state_attr('sensor.motion_log_level','debug') }}
            - condition: template
              value_template: >
                {{ trigger.platform == 'time_pattern' }}
            - condition: template
              value_template: >-
                {{ is_state_attr('automation.motion_device_class_rescan', 'current', 0) }}
          sequence:
            - service: persistent_notification.create
              data_template:
                title: >-
                  DEBUG: class rescan watchdog
                notification_id: >
                  {{- 'debug-class-rescan' -}}
                message: >-
                  Trigger platform: {{ trigger.platform }}
    - service: automation.trigger
      data_template:
        entity_id: automation.motion_device_class_rescan

- id: motion_device_class_rescan
  alias: motion_device_class_rescan
  mode: 'restart'
  initial_state: 'on'
  trigger:
  variables:
    sensor_ids: >-
      {% set s = state_attr('binary_sensor.motion_device_class','sensor_list') %}
      {%- if s|lower != 'none' -%}
        [{%- for i in s if not state_attr('binary_sensor.motion_device_' + i,'ids') is string and state_attr('binary_sensor.motion_device_' + i,'ids')|lower != 'none' -%}
          {% set r = state_attr('binary_sensor.motion_device_' + i,'ids') %}
          {%- for j in r -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- j -}}"
          {%- endfor -%}
          {%- if not loop.last -%},{%- endif -%}
        {%- endfor -%}]
      {% else %}none{% endif %}
    binary_sensor_ids: >-
      {% set s = state_attr('binary_sensor.motion_device_class','binary_sensor_list') %}
      {%- if s|lower != 'none' -%}
        [{%- for i in s if not state_attr('binary_sensor.motion_device_' + i,'ids') is string and state_attr('binary_sensor.motion_device_' + i,'ids')|lower != 'none' -%}
          {% set r = state_attr('binary_sensor.motion_device_' + i,'ids') %}
          {%- for j in r -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- j -}}"
          {%- endfor -%}
          {%- if not loop.last -%},{%- endif -%}
        {%- endfor -%}]
      {% else %}none{% endif %}
    ids: >-
      {% set ids = [] -%}
      {%- if sensor_ids|lower != 'none' and sensor_ids is iterable and sensor_ids|count > 0 -%}
        {%- set ids = ids + sensor_ids|list -%}
      {%- endif -%}
      {%- if binary_sensor_ids|lower != 'none' and binary_sensor_ids is iterable and binary_sensor_ids|count > 0 -%}
        {%- set ids = ids + binary_sensor_ids|list -%}
      {%- endif -%}
      {%- if not ids is iterable or not ids|count > 0 -%}
        {%- set ids = none -%}
      {%- else -%}
        {%- set ids = ids|sort|unique|list -%}
      {%- endif -%}
      {{- ids }}
    total: >-
      {% set total = 0 -%}
      {%- if ids|lower != 'none' and ids is iterable -%}
        {%- set total = ids|count -%}
      {%- endif -%}
      {{- total }}
    sensor_mobiles: >-
      {% set s = state_attr('binary_sensor.motion_device_class','sensor_list') %}
      {%- if s|lower != 'none' -%}
        [{%- for i in s if not state_attr('binary_sensor.motion_device_' + i,'mobiles') is string and state_attr('binary_sensor.motion_device_' + i,'mobiles')|lower != 'none' -%}
          {% set r = state_attr('binary_sensor.motion_device_' + i,'mobiles') %}
          {%- for j in r -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- j -}}"
          {%- endfor -%}
          {%- if not loop.last -%},{%- endif -%}
        {%- endfor -%}]
      {% else %}none{% endif %}
    binary_sensor_mobiles: >-
      {% set s = state_attr('binary_sensor.motion_device_class','binary_sensor_list') %}
      {%- if s|lower != 'none' -%}
        [{%- for i in s if not state_attr('binary_sensor.motion_device_' + i,'mobiles') is string and state_attr('binary_sensor.motion_device_' + i,'mobiles')|lower != 'none' -%}
          {% set r = state_attr('binary_sensor.motion_device_' + i,'mobiles') %}
          {%- for j in r -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- j -}}"
          {%- endfor -%}
          {%- if not loop.last -%},{%- endif -%}
        {%- endfor -%}]
      {% else %}none{% endif %}
    mobiles: >-
      {% set mobiles = [] -%}
      {%- if sensor_mobiles|lower != 'none' and sensor_mobiles is iterable and sensor_mobiles|count > 0 -%}
        {%- set mobiles = mobiles + sensor_mobiles|list -%}
      {%- endif -%}
      {%- if binary_sensor_mobiles|lower != 'none' and binary_sensor_mobiles is iterable and binary_sensor_mobiles|count > 0 -%}
        {%- set mobiles = mobiles + binary_sensor_mobiles|list -%}
      {%- endif -%}
      {%- if not mobiles is iterable or not mobiles|count > 0 -%}
        {%- set mobiles = none -%}
      {%- else -%}
        {%- set mobiles = mobiles|sort|unique|list -%}
      {%- endif -%}
      {{- mobiles }}
    button_list: >-
      {% if ids|lower != 'none' -%}
        [{%- for i in ids %}
          {%- if not loop.first -%},{%- endif -%}
          [{%- for state in states.button if device_id(state.entity_id)|lower != 'none' and i == device_attr(device_id(state.entity_id),'name') and not 'sensor.motion_' in state.entity_id -%}
            {%- if not loop.first -%},{%- endif -%}
            {"did":"{{- device_id(state.entity_id) -}}","name":"{{- i -}}","entity_id":"{{- state.entity_id -}}","area":"{{- area_id(state.entity_id) -}}"}
          {%- endfor -%}]
        {%- endfor %}]
      {%- else -%}none{%- endif %}
    buttons: >-
      {% if button_list|lower != 'none' and button_list|count > 0 -%}
        {%- set s = button_list|reject('==',[])|list -%}
        {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
          [{%- for i in s|list -%}
          {%- if not loop.first -%},{%- endif -%}
            {%- for j in i -%}
              {%- if not loop.first -%},{%- endif -%}
              {{ j }}
            {%- endfor -%}
          {%- endfor -%}]
        {%- else %}null{%- endif -%}
      {%- else -%}null{%- endif %}
    light_list: >-
      {% if ids|lower != 'none' -%}
      [{%- for i in ids %}
        {%- if not loop.first -%},{%- endif -%}
        [{%- for state in states.light if device_id(state.entity_id)|lower != 'none' and i == device_attr(device_id(state.entity_id),'name') and not 'sensor.motion_' in state.entity_id -%}
          {%- if not loop.first -%},{%- endif -%}
          {"did":"{{- device_id(state.entity_id) -}}","name":"{{- i -}}","entity_id":"{{- state.entity_id -}}","area":"{{- area_id(state.entity_id) -}}"}
        {%- endfor -%}]
      {%- endfor %}]
      {% else %}[]{% endif %}
    lights: >-
      {% if light_list|lower != 'none' and light_list|count > 0 -%}
        {%- set s = light_list|reject('==',[])|list -%}
        {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
          [{%- for i in s|list -%}
          {%- if not loop.first -%},{%- endif -%}
            {%- for j in i -%}
              {%- if not loop.first -%},{%- endif -%}
              {{ j }}
            {%- endfor -%}
          {%- endfor -%}]
        {%- else %}null{%- endif -%}
      {%- else -%}null{%- endif %}
    media_player_list: >-
      {% if ids|lower != 'none' -%}
        [{%- for i in ids %}
          {%- if not loop.first -%},{%- endif -%}
          [{%- for state in states.media_player if device_id(state.entity_id)|lower != 'none' and i == device_attr(device_id(state.entity_id),'name') and not 'sensor.motion_' in state.entity_id -%}
            {%- if not loop.first -%},{%- endif -%}
            {"did":"{{- device_id(state.entity_id) -}}","name":"{{- i -}}","entity_id":"{{- state.entity_id -}}","area":"{{- area_id(state.entity_id) -}}"}
          {%- endfor -%}]
        {%- endfor %}]
      {% else %}[]{% endif %}
    media_players: >-
      {% if media_player_list|lower != 'none' and media_player_list|count > 0 -%}
        {%- set s = media_player_list|reject('==',[])|list -%}
        {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
          [{%- for i in s|list -%}
          {%- if not loop.first -%},{%- endif -%}
            {%- for j in i -%}
              {%- if not loop.first -%},{%- endif -%}
              {{ j }}
            {%- endfor -%}
          {%- endfor -%}]
        {%- else %}null{%- endif -%}
      {%- else -%}null{%- endif %}
    switch_list: >-
      {% if ids|lower != 'none' -%}
        [{%- for i in ids %}
        {%- if not loop.first -%},{%- endif -%}
          [{%- for state in states.switch if device_id(state.entity_id)|lower != 'none' and i == device_attr(device_id(state.entity_id),'name') and not 'sensor.motion_' in state.entity_id -%}
          {%- if not loop.first -%},{%- endif -%}
          {"did":"{{- device_id(state.entity_id) -}}","name":"{{- i -}}","entity_id":"{{- state.entity_id -}}","area":"{{- area_id(state.entity_id) -}}"}
          {%- endfor -%}]
        {%- endfor %}]
      {% else %}[]{% endif %}
    switchs: >-
      {% if switch_list|lower != 'none' and switch_list|count > 0 -%}
        {%- set s = switch_list|reject('==',[])|list -%}
        {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
          [{%- for i in s|list -%}
          {%- if not loop.first -%},{%- endif -%}
            {%- for j in i -%}
              {%- if not loop.first -%},{%- endif -%}
              {{ j }}
            {%- endfor -%}
          {%- endfor -%}]
        {%- else %}null{%- endif -%}
      {%- else -%}null{%- endif %}
    statistics: >-
      {%- set list = [] -%}
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list') -%}
      {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set list = list + s|list -%}
      {%- endif -%}
      {%- set s = state_attr('binary_sensor.motion_device_class','binary_sensor_list') -%}
      {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set list = list + s|list -%}
      {%- endif -%}
      {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        { {%- for i in s if state_attr('binary_sensor.motion_device_' + i|string,'statistics')|lower != 'none' and state_attr('binary_sensor.motion_device_' + i|string,'statistics')|string != '[]' %}
          {%- if not loop.first -%},{%- endif -%}
          {%- set e = 'binary_sensor.motion_device_' + i|string %}
          {%- set n = state_attr(e,'statistics') %}
          {%- if n|lower != 'none' -%}{%- set n = n|count -%}{%- else -%}{%- set n = 0 -%}{%- endif -%}
          "{{- i -}}":{{- n -}}
        {%- endfor -%} }
      {%- else -%}none{%- endif %}
    measurement: >-
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list') -%}
      {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        { {%- for i in s if
          states('sensor.motion_device_' + i|string)|lower != 'null'
          and states('sensor.motion_device_' + i|string)|lower != 'unknown'
          and state_attr('binary_sensor.motion_device_' + i|string,'ids')|lower != 'none'
          and state_attr('binary_sensor.motion_device_' + i|string,'ids')|lower != 'unknown'
          and states('sensor.motion_device_' + i|string)|lower != 'none' -%}
          {%- if not loop.first -%},{%- endif -%}
          {%- set e = 'sensor.motion_device_' + i|string -%}
          {%- set n = state_attr(e,'ids') -%}
          {%- if n|lower != 'none' -%}{%- set n = n|count -%}{%- else -%}{%- set n = 0 -%}{%- endif -%}
          "{{- i -}}":{{- n -}}
        {%- endfor -%} }
      {%- else -%}none{%- endif -%}
    status: >-
      {%- set s = state_attr('binary_sensor.motion_device_class','binary_sensor_list') -%}
      {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        { {%- for i in state_attr('binary_sensor.motion_device_class','binary_sensor_list') if
          states('binary_sensor.motion_device_' + i|string)|lower != 'null'
          and states('binary_sensor.motion_device_' + i|string)|lower != 'unknown'
          and state_attr('binary_sensor.motion_device_' + i|string,'ids')|lower != 'none'
          and state_attr('binary_sensor.motion_device_' + i|string,'ids')|lower != 'unknown'
          and states('binary_sensor.motion_device_' + i|string)|lower != 'none' -%}
          {%- if not loop.first -%},{%- endif -%}
          {%- set e = 'binary_sensor.motion_device_' + i|string -%}
          {%- set n = state_attr(e,'ids') -%}
          {%- if n|lower != 'none' -%}{%- set n = n|count -%}{%- else -%}{%- set n = 0 -%}{%- endif -%}
          "{{- i -}}":{{- n -}}
        {%- endfor -%} }
      {%- else -%}none{%- endif -%}
    dids: >-
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list -%}
      [{%- for i in s|sort|unique if not is_state_attr('binary_sensor.motion_device_' + i|string,'devices','none') -%}
        {%- if not loop.first -%},{%- endif -%}
        {%- set e = 'binary_sensor.motion_device_' + i|string -%}
        {%- set devices = state_attr(e, 'devices') -%}
        {%- for j in devices|map(attribute='did')|list -%}
          {%- if not loop.first -%},{%- endif -%}
          {"class":"{{- i -}}","did":"{{- j -}}","area":"{{ devices|selectattr('did','==',j)|map(attribute='area')|list|first }}"}
        {% else %}{{ none }}{%- endfor -%}
      {%- endfor -%}]
    devices: >-
      {%- if dids|lower != 'none' and not dids is string and dids is iterable and dids|count > 0 -%}
       {%- set dids = dids|reject('undefined')|list -%}
        {%- if dids|lower != 'none' and not dids is string and dids is iterable and dids|count > 0 -%}
          {%- set dids = dids|selectattr('did','defined')|list -%}
          {%- if dids|lower != 'none' and not dids is string and dids is iterable and dids|count > 0 -%}
          [{%- for i in dids|map(attribute='did')|sort|unique|list -%}
            {%- if not loop.first -%},{%- endif -%}
            {%- set did = i -%}
            {%- set c = dids|selectattr('did','==',did)|map(attribute='class')|sort|unique|list -%}
            {%- set a = dids|selectattr('did','==',did)|map(attribute='area')|first %}
            {%- set n = device_attr(did,'name_by_user') -%}
            {%- if n|lower == 'none' -%}{%- set n = device_attr(did,'name') -%}{%- endif -%}
            {"name":"{{- device_attr(did,'name') -}}","did":"{{- did -}}","friendly_name":"{{- n -}}","manufacturer":"{{- device_attr(did,'manufacturer') -}}","model":"{{- device_attr(did,'model') -}}","sw_version":"{{- device_attr(did,'sw_version') -}}","class":{{- c|default(none) -}},"area":"{{- a|default(none) -}}"}
          {%- endfor -%}]
          {%- else -%}none{%- endif -%}
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif -%}
    areas: >-
      {% set s = devices %}
      {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
        {%- set s = s|map(attribute='area')|reject('==','None')|list -%}
        {%- if s|lower != 'null' and not s is string and s is iterable and s|count > 0 -%}
          {{ s|sort|unique|list }}
        {%- else -%}null{%- endif %}
      {%- else -%}null{%- endif %}
    categorys: >-
      {%- set categorys = (state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list)|sort|unique|list -%}
      {{- categorys -}}
    required: >-
      {%- set required = (state_attr('binary_sensor.motion_device_class','sensors')|list + state_attr('binary_sensor.motion_device_class','binary_sensors')|list)|sort|unique|list -%}
      {{- required -}}
    found: >-
      {%- if categorys is iterable -%}
      [{%- for i in categorys if is_state('binary_sensor.motion_device_' + i + '_exist','on') -%}
        {%- if not loop.first -%},{%- endif -%}
        "{{- i -}}"
      {%- endfor -%}]
      {%- else -%}[]{%- endif -%}
    automations: >-
      {%- if categorys is iterable -%}
      [{%- for i in categorys|sort|unique if is_state_attr('binary_sensor.motion_device_' + i|string,'automations','on') -%}
        {%- if not loop.first -%},{%- endif -%}
        "{{- i -}}"
      {%- endfor -%}]
      {%- else -%}[]{%- endif -%}
    missing: >-
      {%- if categorys is iterable -%}
      [{%- for i in categorys if is_state_attr('binary_sensor.motion_device_' + i|string + '_exist','required','on') and not is_state('binary_sensor.motion_device_temperature_exist','on') -%}
        {%- if not loop.first -%},{%- endif -%}
        "{{- i -}}"
      {%- endfor -%}]
      {%- else -%}[]{%- endif -%}
    state: >-
      {%- if required is iterable and required|count > 0 and missing is iterable and missing|count > 0 -%}
        {%- for m in missing if m in required -%}
          {%- if loop.first -%}off{%- endif -%}
        {%- else -%}on{%- endfor -%}
      {%- elif required is iterable and required|count > 0 and missing|lower == 'none' or (missing is iterable and missing|count == 0) -%}on
      {%- elif required|lower == 'none' or (required is iterable and required|count == 0) -%}on
      {%- else -%}unknown{%- endif -%} 
    markdown: >-
      {%- if state|lower == 'unknown' -%}
        <h2>Setup initializing</h2>
      {%- elif state|lower == 'on' -%}
        <h2>Setup complete</h2>
        {%- if not found is string and found is iterable and found|count > 0 -%}
          <ol>{%- for i in found -%}<li><a href="/notify-devices/{{- i -}}">{{- i|upper -}}</a></li>{%- endfor -%}</ol>
        {%- endif -%}
      {%- elif state|lower == 'off' -%}
        {%- if required|lower != 'none' and not required is string and required is iterable and required|count > 0 -%}
          <h2>Setup in-complete</h2>
          {%- if missing is string or not missing is iterable -%}
            <h3>Missing pending</h3>
          {%- elif missing|count > 0 -%}
            <h3>Missing devices</h3>
            {%- for i in missing -%}
              {%- if loop.first -%}<ul><li><a href="/notify-missing/">Missing</a>:<ol>{%- endif -%}
              <li><a href="/notify-devices/{{- i -}}">{{- i|upper -}}</a></li>
              {%- if loop.last -%}</ol></li></ul>{%- endif -%}
            {%- endfor -%}
          {%- elif missing|count == 0 -%}
            <h3>No missing devices</h3>
          {%- endif -%}
          {%- if automations is string or not automations is iterable -%}
            <h3>Automations pending</h3>
          {%- elif automations|count < required|count -%}
            <h3>Enabling automations</h3>
          {%- else -%}
            <h3>Automations enabled</h3>
          {%- endif -%}
          {%- if automations is iterable and automations|count > 0 -%}
            {%- for i in automations -%}
              {%- if loop.first -%}<ul><li><a href="/notify-devices/all">Completed</a>:<ol>{%- endif -%}
              <li><a href="/notify-devices/{{- i -}}">{{- i|upper -}}</a></li>
              {%- if loop.last -%}</ol></li></ul>{%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {%- if found is iterable and found|count > 0 -%}
            {%- for i in found if not i in automations -%}
              {%- if loop.first -%}<ul><li><a href="/notify-devices/all">Enabling</a>:<ol>{%- endif -%}
              <li><a href="/notify-devices/{{- i -}}">{{- i|upper -}}</a></li>
              {%- if loop.last -%}</ol></li></ul>{%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        {%- else -%}
          <h2>No required devices</h2>
        {%- endif -%}
      {%- else -%}
        <h2>Device status pending</h2>
      {%- endif -%}
      <br><a href="/config/integrations">All integrations</a>
      <br><i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
    summary: >-
      {% if state|lower == 'on' -%}
        {{- 'complete' -}}
      {%- else -%}
        {{- 'pending' -}}
        {%- if automations|lower != 'none' and automations is iterable -%}
          {{- '; complete: ' -}}{{ automations|count }}
        {%- endif -%}
        {%- if missing|lower != 'none' and missing is iterable and missing|count > 0 -%}
          {%- for i in missing -%}
            {%- if loop.first -%}{{- '; missing: ' -}} {%- endif -%}
            {%- if not loop.first -%}{{- ', ' -}} {%- endif -%}
            {{- i -}}
          {%- endfor -%}
        {%- endif -%}
      {%- endif %}
  action:
    - alias: 'update binary_sensor.motion_device_class: scan,ids,dids,devices,..'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        automations: >-
          {{ automations }}
        required: >-
          {{ required }}
        categorys: >-
          {{ categorys }}
        missing: >-
          {{ missing }}
        found: >-
          {{ found }}
        scan: >-
          {{ utcnow().timestamp() }}
        ids: >-
          {{ ids }}
        dids: >-
          {{ dids }}
        total: >-
          {{ total }}
        mobiles: >-
          {{ mobiles }}
        status: >-
          {{ status }}
        measurement: >-
          {{ measurement }}
        statistics: >-
          {{ statistics }}
        devices: >-
          {{ devices }}
        buttons: >-
          {{ buttons }}
        lights: >-
          {{ lights }}
        media_players: >-
          {{ media_players }}
        switchs: >-
          {{ switchs }}
        areas: >-
          {{ areas }}
        markdown: >-
          {{ markdown }}
        summary: >-
          {{ summary }}
        state: >-
          {{ state }}
    - alias: 'trigger automation class_unavailable_group_set'
      service: automation.trigger
      data_template:
        entity_id: >-
          {{ 'automation.motion_device_class_unavailable_group_set' }}
    - alias: 'trigger automation class_missing_group_set'
      service: automation.trigger
      data_template:
        entity_id: >-
          {{ 'automation.motion_device_class_missing_group_set' }}
    - alias: 'trigger automation class_activity_group_set'
      service: automation.trigger
      data_template:
        entity_id: >-
          {{ 'automation.motion_device_class_activity_group_set' }}
    - alias: 'trigger automation class_rescan_unavailable'
      service: automation.trigger
      data_template:
        entity_id: >-
          {{ 'automation.motion_device_class_rescan_unavailable' }}

- id: motion_device_class_unavailable_group_set
  alias: motion_device_class_unavailable_group_set
  mode: 'restart'
  max_exceeded: 'warn'
  initial_state: 'on'
  trigger:
  variables:
    entities: >-
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list -%}
      [{%- for i in s|sort|unique if is_state_attr('binary_sensor.motion_device_' + i + '_exist','required','on') -%}
        {%- if not loop.first -%},{%- endif -%}
        "{{- 'binary_sensor.motion_device_' + i|string + '_unavailable' -}}"
      {%- endfor -%}]
  condition:
    - alias: 'test if entities'
      condition: template
      value_template: >-
        {{ entities is iterable and entities|count > 0 }}
  action:
    - alias: 'set group.motion_device_class_unavailable sensors'
      service: group.set
      data_template:
        object_id: motion_device_class_unavailable
        entities: >-
          {{ entities }}

- id: motion_device_class_missing_group_set
  alias: motion_device_class_missing_group_set
  mode: 'restart'
  max_exceeded: 'warn'
  initial_state: 'on'
  trigger:
  variables:
    entities: >-
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list -%}
      [{%- for i in s|sort|unique if is_state_attr('binary_sensor.motion_device_' + i + '_exist','required','on') -%}
        {%- if not loop.first -%},{%- endif -%}
        "{{- 'binary_sensor.motion_device_' + i|string + '_missing' -}}"
      {%- endfor -%}]
  condition:
    - alias: 'test if entities'
      condition: template
      value_template: >-
        {{ entities is iterable and entities|count > 0 }}
  action:
    - alias: 'set group.motion_device_class_missing sensors'
      service: group.set
      data_template:
        object_id: motion_device_class_missing
        entities: >-
          {{ entities }}

- id: motion_device_class_activity_group_set
  alias: motion_device_class_activity_group_set
  mode: 'restart'
  max_exceeded: 'warn'
  initial_state: 'on'
  trigger:
    - platform: 'state'
      entity_id: 'group.motion_device_class_activity'
      to: 'on'
  variables:
    entities: >-
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list -%}
      [{%- for i in s|sort|unique if is_state_attr('binary_sensor.motion_device_' + i + '_exist','activity','on') -%}
        {%- if not loop.first -%},{%- endif -%}
        "{{- 'binary_sensor.motion_device_' + i|string + '_activity' -}}"
      {%- endfor -%}]
  condition:
    - alias: 'test if entities'
      condition: template
      value_template: >-
        {{ entities is iterable and entities|count > 0 }}
  action:
    - alias: 'set group.motion_device_class_activity sensors'
      service: group.set
      data_template:
        object_id: motion_device_class_activity
        entities: >-
          {{ entities }}

## rescan_unavailable

- id: motion_device_class_rescan_unavailable
  alias: motion_device_class_rescan_unavailable
  mode: 'restart'
  max_exceeded: 'warn'
  initial_state: 'on'
  trigger:
    - platform: 'state'
      entity_id: 'group.motion_device_class_unavailable'
      to: 'on'
  variables:
    unavailable: >-
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list -%}
      [{%- for i in s|sort|unique if is_state('binary_sensor.motion_device_' + i + '_unavailable','on') -%}
        {%- if not loop.first -%},{%- endif -%}
        {%- for j in state_attr('binary_sensor.motion_device_' + i,'unavailable') -%}
          {%- if not loop.first -%},{%- endif -%}
          {"did":"{{- device_id(j.entity_id) -}}","entity_id":"{{- j.entity_id -}}","id":"{{- j.id -}}","class":"{{- i -}}"}
        {%- endfor -%}
      {%- endfor -%}]
    ids: >-
      {% set ids = none %}
      {% if not unavailable is string and unavailable is iterable and unavailable|count > 0 %}
        {% set ids = unavailable|map(attribute='id')|sort|unique|list %}
      {% endif %}
      {{ ids }}
    dids: >-
      {% set dids = none %}
      {% if not unavailable is string and unavailable is iterable and unavailable|count > 0 %}
        {% set dids = unavailable|map(attribute='did')|sort|unique|list %}
      {% endif %}
      {{ dids }}
    count: >-
      {% if not dids is string and dids is iterable and dids|count > 0 %}
        {{ dids|count }}
      {% else %}null{% endif %}
    last: >-
      {% set last = state_attr('binary_sensor.motion_device_class_unavailable','last') %}
      {% if count|int(0) > 0 %}{{ last }}{% else %}{{ utcnow().timestamp() }}{% endif %}
    state: >-
      {% if count|int(0) > 0 %}on{% else %}off{% endif %}
    markdown: >-
      {% set s = dids -%}
      {%- if s|lower != 'none' and not s is string and s is iterable -%}
        <a href="/notify-unavailable/"><h2>Unavailable devices</h2></a>
        {%- for i in s -%}
          {%- set k = state_attr('binary_sensor.motion_device_class','devices')|selectattr('did','==',i)|list -%}
          {%- if k|lower != 'none' and not k is string and k is iterable and k|count > 0 -%}
            {%- set k = k|first -%}
            {%- set area = state_attr('sensor.motion_areas','areas')|selectattr('id','==',k.area)|list -%}
            {%- if area|lower != 'none' and not area is string and area is iterable and area|count > 0 -%}
              {%- set area = area|map(attribute='name')|first -%}
            {%- else -%}
              {%- set area = 'unknown' -%}
            {%- endif -%}
            {%- if loop.first -%}<ul>{%- endif -%}
            <li>The <a href="/config/devices/device/{{- k.did -}}">{{- k.friendly_name -}}</a> device ({{- k.manufacturer }} {{ k.model -}}) in <a href="/config/areas/area/{{- k.area -}}">{{ area }}</a> has unavailable sensors in the following categories:
            {%- for c in k.class if is_state('binary_sensor.motion_device_' + c|string + '_unavailable','on') -%}
              {%- if loop.first -%}<ol>{%- endif -%}
              <li><a href="/notify-devices/{{- c -}}">{{- c -}}</a></li>
              {%- if loop.last -%}</ol>{%- endif -%}
            {%- endfor -%}
            </li>
          {%- endif -%}
          {%- if loop.last -%}</ul>{%- endif -%}
        {%- endfor -%}
      {%- else -%}<h2>No unavailable devices</h2>{%- endif -%}
      <br><b>Alarms enabled</b>: <code>{{- state_attr('binary_sensor.motion_device_class_unavailable_exist','alarm')|lower == 'on' }}</code>
      <br><b>Outstanding alarms</b>: <code>{{- state_attr('binary_sensor.motion_device_class_unavailable','count')|int(0) > 0 }}</code>
      <br><i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
  action:
    - alias: 'update binary_sensor.motion_device_class_unavailable'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class_unavailable
        last: >-
          {{ last }}
        dids: >-
          {{ dids }}
        ids: >-
          {{ ids }}
        count: >-
          {{ count }}
        markdown: >-
          {{ markdown }}
        details: >-
          {{ unavailable }}
        state: >-
          {{ state }}
    - alias: 'update binary_sensor.motion_device_class: unavailable'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class
        unavailable: >-
          {{ ids }}

## rescan_missing

#- id: motion_device_class_rescan_missing
#  alias: motion_device_class_rescan_missing
#  mode: 'restart'
#  max_exceeded: 'warn'
#  initial_state: 'on'
#  trigger:
#    - platform: 'state'
#      entity_id: 'group.motion_device_class_missing'
#      to: 'on'
#  variables:
#    missing: >-
#      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list -%}
#      [{%- for i in s|sort|unique if is_state('binary_sensor.motion_device_' + i + '_missing','on') -%}
#        {%- set k = state_attr('binary_sensor.motion_device_' + i,'missing') -%}
#        {%- if k|lower != 'none' and k is iterable and k|count > 0 -%}
#          {%- if not loop.first -%},{%- endif -%}
#          {%- for j in k -%}
#            {%- if not loop.first -%},{%- endif -%}
#            {"did":"{{- device_id(j.entity_id) -}}","entity_id":"{{- j.entity_id -}}","id":"{{- j.id -}}","class":"{{- i -}}"}
#          {%- endfor -%}
#        {%- endif -%}
#      {%- endfor -%}]
#    ids: >-
#      {% set ids = none %}
#      {% if not missing is string and missing is iterable and missing|count > 0 %}
#        {% set ids = missing|map(attribute='id')|sort|unique|list %}
#      {% endif %}
#      {{ ids }}
#    dids: >-
#      {% set dids = none %}
#      {% if not missing is string and missing is iterable and missing|count > 0 %}
#        {% set dids = missing|map(attribute='did')|sort|unique|list %}
#      {% endif %}
#      {{ dids }}
#    count: >-
#      {% if not dids is string and dids is iterable and dids|count > 0 %}
#        {{ dids|count }}
#      {% else %}null{% endif %}
#    last: >-
#      {% set last = state_attr('binary_sensor.motion_device_class_missing','last') %}
#      {% if count|int(0) > 0 %}{{ last }}{% else %}{{ utcnow().timestamp() }}{% endif %}
#    state: >-
#      {% if count|int(0) > 0 %}on{% else %}off{% endif %}
#    markdown: >-
#      {% set s = dids -%}
#      {%- if s|lower != 'none' and not s is string and s is iterable -%}
#        <a href="/notify-missing/"><h2>Unavailable devices</h2></a>
#        {%- for i in s -%}
#          {%- set k = state_attr('binary_sensor.motion_device_class','devices')|selectattr('did','==',i)|list -%}
#          {%- if k|lower != 'none' and not k is string and k is iterable and k|count > 0 -%}
#            {%- set k = k|first -%}
#            {%- set area = state_attr('sensor.motion_areas','areas')|selectattr('id','==',k.area)|list -%}
#            {%- if area|lower != 'none' and not area is string and area is iterable and area|count > 0 -%}
#              {%- set area = area|map(attribute='name')|first -%}
#            {%- else -%}
#              {%- set area = 'unknown' -%}
#            {%- endif -%}
#            {%- if loop.first -%}<ul>{%- endif -%}
#            <li>The <a href="/config/devices/device/{{- k.did -}}">{{- k.friendly_name -}}</a> device ({{- k.manufacturer }} {{ k.model -}}) in <a href="/config/areas/area/{{- k.area -}}">{{ area }}</a> has missing sensors in the following categories:
#            {%- for c in k.class if is_state('binary_sensor.motion_device_' + c|string + '_missing','on') -%}
#              {%- if loop.first -%}<ol>{%- endif -%}
#              <li><a href="/notify-devices/{{- c -}}">{{- c -}}</a></li>
#              {%- if loop.last -%}</ol>{%- endif -%}
#            {%- endfor -%}
#            </li>
#          {%- endif -%}
#          {%- if loop.last -%}</ul>{%- endif -%}
#        {%- endfor -%}
#      {%- else -%}<h2>No missing devices</h2>{%- endif -%}
#      <br><b>Alarms enabled</b>: <code>{{- state_attr('binary_sensor.motion_device_class_missing_exist','alarm')|lower == 'on' }}</code>
#      <br><b>Outstanding alarms</b>: <code>{{- state_attr('binary_sensor.motion_device_class_missing','count')|int(0) > 0 }}</code>
#      <br><i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
#  action:
#    - alias: 'update binary_sensor.motion_device_class_missing'
#      service: python_script.set_state
#      data_template:
#        entity_id: binary_sensor.motion_device_class_missing
#        last: >-
#          {{ last }}
#        dids: >-
#          {{ dids }}
#        ids: >-
#          {{ ids }}
#        count: >-
#          {{ count }}
#        markdown: >-
#          {{ markdown }}
#        details: >-
#          {{ missing }}
#        state: >-
#          {{ state }}
#    - alias: 'update binary_sensor.motion_device_class: missing'
#      service: python_script.set_state
#      data_template:
#        entity_id: binary_sensor.motion_device_class
#        missing: >-
#          {{ ids }}
