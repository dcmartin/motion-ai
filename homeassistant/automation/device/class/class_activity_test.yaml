###
# homeassistant/automation/device/class/class_activity.yaml
###

- id: motion_device_class_activity_test
  alias: motion_device_class_activity_test
  mode: single
  initial_state: 'off'
  trigger:
#    - platform: time_pattern
#      seconds: '/30'
    - platform: state
      entity_id: 'group.motion_device_class_activity'
      attribute: 'entity_id'
    - platform: state
      entity_id: 'group.motion_device_class_activity'
      to: 'on'
  variables:
    details: >-
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list -%}
      [{%- for i in s|sort|unique if is_state('binary_sensor.motion_device_' + i + '_activity','on') -%}
        {%- if not loop.first -%},{%- endif -%}
        {%- for j in state_attr('binary_sensor.motion_device_' + i + '_activity','ids') -%}
          {%- if not loop .first -%},{%- endif -%}
          {"id":"{{- j -}}","class":"{{- i -}}","updated":{{- (states.binary_sensor['motion_device_' + i + '_activity'].last_updated)|as_timestamp(0) -}},"when":"{{- (states.binary_sensor['motion_device_' + i + '_activity'].last_updated)|as_timestamp|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}"}
        {%- endfor -%}
      {%- endfor -%}]
    ids: >-
      {% set ids = details|map(attribute='id')|sort|unique|list %}
      {{ ids }}
    markdown: >-
        {%- set devices = state_attr('binary_sensor.motion_device_class','devices') -%}
        {%- if ids|lower != 'none' and  devices|lower != 'none' and not devices is string and devices is iterable -%}
          {%- for i in ids if i|lower != 'none' -%}
            {%- if loop.first -%}{{- '<ul>' -}}{%- endif -%}
            {%- set s = devices|selectattr('id','==',i)|list -%}
            {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
              {%- set s = s|first -%}
              <li><a href="/config/devices/device/{{- s.did -}}">{{- s.friendly_name -}}</a> in <a href="/config/areas/area/{{- s.area -}}">{{- s.area -}}</a></li>
            {%- endif -%}
            {%- if loop.last -%}{{- '</ul>' -}}{%- endif -%}
          {%- endfor -%}
        {%- else -%}<b>No activity</b>{%- endif %}
    last: >-
      {{ state_attr('binary_sensor.motion_device_class_activity','last') }}
    active: >-
      {{ details|count|int(0) > 0 }}
  action:
    - alias: 'update binary_sensor.motion_device_class_activity'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_class_activity
        last: >-
          {% if active|lower == 'true' %}{{ utcnow().timestamp() }}{% else %}{{ last }}{% endif %}
        ids: >-
          {{ ids }}
        markdown: >-
          {{ markdown }}
        details: >-
          {{ details }}
        state: >-
          {% if active|lower == 'true' %}on{% else %}off{% endif %}
