###
# homeassistant/automation/motion/smartphone_notify.yaml
###

- id: motion_smartphone_location_notify
  alias: motion_smartphone_location_unknown_notify
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_smartphone_location
      to: 'unknown'
    - platform: time_pattern
      minutes: '/15'
    - platform: homeassistant
      event: start
  condition:
    - condition: template
      value_template: >
        {{ is_state('sensor.motion_smartphone_location','unknown') }}
  variables:
    name: >-
      {% set s = state_attr('sensor.motion_person','sensor') -%}
      {%- if s|lower != 'none' -%}
        {%- set s = state_attr(s,'friendly_name') -%}
        {%- if s|lower == 'none' -%}
          {%- set s = states('sensor.motion_person') -%}
        {%- endif -%}
      {%- endif -%}
      {{- s }}
    title: >-
      ALERT: {{ name -}}'s smartphone location
    message: >-
      {{ name -}}'s smartphone {{ states('sensor.motion_person_device') }} location is unknown;
      at {{ utcnow().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}};
      last update: {{ (utcnow().timestamp() - states('sensor.motion_person_ago')|float(0))|as_datetime|relative_time }} ago
  action:
    - condition: template
      value_template: >
        {{ states('input_select.motion_log_level') in ['debug','info','notice','alert'] }}
    - alias: 'notify'
      service: persistent_notification.create
      data_template:
        title: >-
          {{ title }}
        notification_id: >-
          {{ 'motion_smartphone_location-' + states('sensor.motion_person_device') }}
        message: >-
          {{ message }}

- id: motion_smartphone_location_dismiss
  alias: motion_smartphone_location_unknown_dismiss
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_smartphone_location
      from: 'unknown'
  condition:
    - condition: template
      value_template: >
        {{ not is_state('sensor.motion_smartphone_location','unknown') }}
  action:
    - alias: 'dismiss'
      service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{ 'motion_smartphone_location-' + states('sensor.motion_person_device') }}
