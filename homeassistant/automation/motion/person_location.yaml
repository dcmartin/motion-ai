###
# homeassistant/automation/motion/person_location.yaml
###

- id: motion_person_location_previous
  alias: motion_person_location_previous
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_person_location
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {% set s = states('sensor.motion_person_location') %}
          {{ s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'pending' }}
  variables:
    movement: >-
      {% set s = states('sensor.motion_person_location_previous') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set s = state_attr('sensor.motion_person_location_previous','latitude') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set plat = s|float(0.0) %}
          {% set s = state_attr('sensor.motion_person_location_previous','longitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {% set plng = s|float(0.0) %}
            {% set s = state_attr('sensor.motion_person_location','latitude') %}
            {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
              {% set clat = s|float(0.0) %}
              {% set s = state_attr('sensor.motion_person_location','longitude') %}
              {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
                {% set clng = s|float(0.0) %}
                {% set d = distance(plat, plng, clat, clng) %}
                {% if d is number and d|int(0) > 0 and d|int(0) < 40075 %}
                  {{- '%0.2f'|format(d|float(0.0) * 1000) -}}
                {% else %}
                  {{ range(0,state_attr('sensor.motion_person_location','gps_accuracy'))|random }}
                {% endif %}
              {% else %}null{% endif %}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    interval: >-
      {% set t = state_attr('sensor.motion_person_location_previous','timestamp') %}
      {% if t|float(0.0) > 0 %}
        {{ utcnow().timestamp() - t|float }}
      {% else %}null{% endif %}
    velocity: >-
      {% if interval|float(0.0) > 0 and movement|float(0.0) > 0 %}
        {{- '%0.2f'|format(movement|float / interval|float) -}}
      {% else %}null{% endif %}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_location_previous
        movement: >-
          {{ movement }}
        interval: >-
          {{ interval }}
        velocity: >-
          {{ velocity }}
        timestamp: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ utcnow().timestamp() }}
          {% else %}null{% endif %}
        latitude: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','latitude') }}
          {% else %}null{% endif %}
        longitude: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','longitude') }}
          {% else %}null{% endif %}
        confidence: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','confidence') }}
          {% else %}null{% endif %}
        distance: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','distance') }}
          {% else %}null{% endif %}
        sensor: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','sensor') }}
          {% else %}null{% endif %}
        zone: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','zone') }}
          {% else %}null{% endif %}
        state: >-
          {{ states('sensor.motion_person_location') }}

- id: motion_person_location
  alias: motion_person_location
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_person_location_derived
    - platform: time_pattern
      minutes: '/5'
  variables:
    person: >-
      {% set s = state_attr('sensor.motion_person_location_derived','sensor') %}
      {% if s|lower != 'null' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
        {{ s }}
      {% else %}null{% endif %}
    latitude: >-
      {% if person|lower != 'null' %}
        {{ state_attr(person,'latitude') }}
      {% else %}null{% endif %}
    longitude: >-
      {% if person|lower != 'null' %}
        {{ state_attr(person,'longitude') }}
      {% else %}null{% endif %}
    sensor: >-
      {% if person|lower != 'null' %}
        {{ state_attr(person,'source') }}
      {% else %}null{% endif %}
    zone: >-
      {%- if latitude|lower != 'null' and longitude|lower != 'null' and is_state('binary_sensor.motion_person_zones','on') -%}
        {%- set zones = state_attr('binary_sensor.motion_person_zones','zones') -%}
        {%- if zones|lower != 'unknown' and zones|lower != 'none' and zones|lower != 'unavailable' and zones is iterable and zones|length > 0 -%}
          {%- set s = closest(latitude,longitude,zones) -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- set d = distance(latitude, longitude, s) -%}
            {%- if d|lower != 'none' and d|lower != 'null' and d|lower != 'unknown' and d|lower != 'unavailable' and d|int(0) is number and d|int(0) < 40075 -%}
              {%- set d = '%0.2f'|format(d|float(0.0) * 1000) -%}
            {%- else -%}{%- set d = null -%}{%- endif -%}
            {%- set r = s.attributes.radius -%}
            {{- '{"name":"' + s.attributes.friendly_name + '","radius":' + r|string + ',"entity_id":"' + s.entity_id + '","inside":' + (d|int(0) < r|int(0))|lower + ',"distance":' + d|string + '}' -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}none{%- endif -%}
      {%- else -%}unknown{%- endif -%}
    distance: >-
      {% if latitude|lower != 'null' and longitude|lower != 'null' %}
        {% set s = distance('zone.home', latitude, longitude) %}
        {% if s|lower != 'none' and s|lower != 'null' and s|lower != 'unknown' and s|lower != 'unavailable' and s|int(0) is number and s|int(0) < 40075 %}
          {{- '%0.2f'|format(s|float(0.0) * 1000) -}}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    gps_accuracy: >-
      {% if person|lower != 'null' %}
        {{ state_attr(person,'gps_accuracy') }}
      {% else %}null{% endif %}
    confidence: >-
      {% if person|lower != 'null' %}
        {% set a = state_attr(person,'gps_accuracy')|float(0.0) %}
        {% set am = states('sensor.motion_person_location_accuracy_mean_1d')|float(0.0) %}
        {% set as = states('sensor.motion_person_location_accuracy_stdev_1d')|float(0.0) %}
        {% set v = state_attr('sensor.motion_person_location_previous','velocity')|float(0.0) %}
        {% set vm = states('sensor.motion_person_location_velocity_mean_1d')|float(0.0) %}
        {% set vs = states('sensor.motion_person_location_velocity_stdev_1d')|float(0.0) %}
        {{ a, am, as, v, vm, vs }}
      {% else %}null{% endif %}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {% set s = states('sensor.motion_person_location_derived') %}
          {{ s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'pending' }}
      - condition: template
        value_template: >
          {{ latitude|lower != 'null' and longitude|lower != 'null' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_location
        person: >-
          {{ person }}
        zone: >-
          {{ zone }}
        latitude: >-
          {{ latitude }}
        longitude: >-
          {{ longitude }}
        sensor: >-
          {{ sensor }}
        distance: >-
          {{ distance }}
        confidence: >-
          {{ confidence }}
        gps_accuracy: >-
          {{ gps_accuracy }}
        timestamp: >-
          {{ utcnow().timestamp() }}
        state: >-
          {{ states(person) }}
