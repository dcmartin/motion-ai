###
# homeassistant/automation/motion/person_location.yaml
###

- id: motion_person_location_previous
  alias: motion_person_location_previous
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_person_location
  variables:
    movement: >-
      {% set s = states('sensor.motion_person_location_previous') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set s = state_attr('sensor.motion_person_location_previous','latitude') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set plat = s|float %}
          {% set s = state_attr('sensor.motion_person_location_previous','longitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {% set plng = s|float %}
            {% set s = state_attr('sensor.motion_person_location','latitude') %}
            {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
              {% set clat = s|float %}
              {% set s = state_attr('sensor.motion_person_location','longitude') %}
              {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
                {% set clng = s|float %}
                {% set d = distance(plat, plng, clat, clng) %}
                {% if d|lower != 'none' and d|lower != 'null' and d|lower != 'unknown' and d|lower != 'unavailable' and d|int is number and d|int < 40075 %}
                  {{- '%0.2f'|format(d|float * 1000) -}}
                {% else %}null{% endif %}
              {% else %}null{% endif %}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    velocity: >-
  action:
    - service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_location_previous
        movement: >-
          {{ movement }}
        velocity: >-
          {% set d = movement %}
          {% if d|lower != 'none' and d|lower != 'null' and d|lower != 'unknown' and d|lower != 'unavailable' and d|int is number and d|int < 40075 %}
            {% set t = state_attr('sensor.motion_person_location_previous','timestamp') %}
            {% if t|lower != 'none' and t|lower != 'unknown' and t|lower != 'unavailable' and t|lower != 'null' and t|float is number and t|float > 0 %}
              {% set t = utcnow().timestamp() - t|float %}
              {{- '%0.2f'|format((d|float * 1000)/t|float) -}}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        timestamp: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ utcnow().timestamp() }}
          {% else %}null{% endif %}
        latitude: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','latitude') }}
          {% else %}null{% endif %}
        longitude: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','longitude') }}
          {% else %}null{% endif %}
        distance: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','distance') }}
          {% else %}null{% endif %}
        source: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','source') }}
          {% else %}null{% endif %}
        zone: >-
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location','zone') }}
          {% else %}null{% endif %}
        state: >-
          {{ states('sensor.motion_person_location') }}

