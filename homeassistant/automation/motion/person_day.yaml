###
# automation/motion/person_day.yaml
###

- id: motion_person_day_begin
  alias: motion_person_day_begin
  mode: single
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_schedule_wakeup_detected
  variables:
    begin: >-
      {{- state_attr('sensor.motion_schedule_wakeup_detected','timestamp')|float(0) -}}
    end: >-
      {{ states('sensor.motion_schedule_bedtime_end')|float(0) + utcnow().replace(hour=0).replace(minute=0).replace(second=0)|as_timestamp }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ not is_state('binary_sensor.motion_schedule_bedtime_detected','unknown') }}
  action:
    - alias: 'set binary_sensor.motion_person_day ON - begin,end'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_day
        begin: >-
          {{- begin -}}
        end: >-
          {{- end -}}
        state: >-
          {{- 'on' -}}
    - alias: 'update active count day'
      service: homeassistant.update_entity
      entity_id: sensor.motion_person_day_active_count
    - alias: 'update active time day'
      service: homeassistant.update_entity
      entity_id: sensor.motion_person_day_active_time

- id: motion_person_day_end
  alias: motion_person_day_end
  mode: single
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_schedule_bedtime_detected
  variables:
    count: >-
      {% set s = states('sensor.motion_person_day_active_count') %}
      {% if s|lower != 'none' and s|int(-1) > 0 %}
        {{ s|int(0) }}
      {% else %}null{% endif %}
    time: >-
      {% set s = states('sensor.motion_person_day_active_time') %}
      {% if s|lower != 'none' and s|int(-1) > 0 %}
        {{ s|int(0) }}
      {% else %}null{% endif %}
    when: >-
      {%- set s = state_attr('binary_sensor.motion_person_day','end') -%}
      {%- if s|lower != 'none' and s|float(-1) > 0 -%}
        {%- set s = s|timestamp_custom('%a %b %d %I:%M %p %Z',true,'unknown') -%}
      {%- endif -%}
      {{- s -}}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ not is_state('binary_sensor.motion_schedule_bedtime_detected','unknown') }}
  action:
    - alias: 'set binary_sensor.motion_person_day off'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_day
        end: >-
          {{- end -}}
        count: >-
          {{- count -}}
        time: >-
          {{- time -}}
        when: >-
          {{- when -}}
        state: >-
          {{- 'off' -}}

- alias: motion_person_active_last_day
  initial_state: on
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_person_night
      to: 'on'
  action:
    - alias: 'set sensor.motion_person_active last_day'
      service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_active
        last_day: >-
          {
            "timestamp": {{- states.sensor.motion_person_day_active_count.last_changed|as_timestamp(default='null') -}},
            "when":"{{- states.sensor.motion_person_day_active_count.last_changed|as_timestamp(0)|timestamp_custom('%a %b %d %I:%M %p %Z',true) -}}",
            "count":{{- states('sensor.motion_person_day_active_count')|int(0) -}},
            "time":{{- states('sensor.motion_person_day_active_time')|float(0) -}}
          }

