###
# homeassistant/automation/motion/addon.yaml
###

- id: motion_addon_config_update
  alias: motion_addon_config_update
  mode: single
  initial_state: on
  trigger:
    - platform: time_pattern
      minutes: '/5'
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: sensor.motion_addon_config_api
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ states('sensor.motion_addon_config_api')|lower != 'none' }}
      - condition: template
        value_template: >-
          {% if trigger.platform == 'time_pattern' %}
            {% set s = state_attr('sensor.motion_addon_config','timestamp') -%}
            {{ s|lower == 'none' or utcnow().timestamp() - s|as_timestamp > states('input_number.motion_addon_status_ago')|int }}
          {% else %}true{% endif %}
  action:
    - alias: 'update sensor.motion_addon_config'
      service: homeassistant.update_entity
      entity_id: sensor.motion_addon_config
    - alias: 'update sensor.motion_addon_storage'
      service: homeassistant.update_entity
      entity_id: sensor.motion_addon_storage

- id: motion_addon_status_update
  alias: motion_addon_status_update
  mode: single
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_addon_status
      to: 'off'
    - platform: time_pattern
      minutes: '/5'
    - platform: state
      entity_id: sensor.motion_addon_status_api
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ states('sensor.motion_addon_status_api')|lower != 'none' }}
      - condition: template
        value_template: >-
          {% if trigger.platform == 'time_pattern' %}
            {% set s = state_attr('sensor.motion_addon_status','timestamp') -%}
            {{ s|lower == 'none' or utcnow().timestamp() - s|as_timestamp > states('input_number.motion_addon_status_ago')|int }}
          {% else %}true{% endif %}
  action:
    - alias: 'update sensor.motion_addon_status'
      service: homeassistant.update_entity
      entity_id: sensor.motion_addon_status
