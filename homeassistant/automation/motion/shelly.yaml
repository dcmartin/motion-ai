###
# homeassistant/automation/motion/shelly.yaml
###

- id: motion_detector_shelly_counter
  alias: motion_detector_shelly_counter
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_detector_shelly
    to: 'on'
    from: 'off'
  action:
    - service: counter.increment
      entity_id: counter.motion_detector_shelly

- id: motion_detector_shelly_start
  alias: motion_detector_shelly_start
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_detector_shelly
    to: 'on'
    from: 'off'
  action:
    - alias: 'set start to timestamp'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'sensor.motion_detector_shelly_start' -}}
        state: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','timestamp') }}
    - alias: 'set end to null'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'sensor.motion_detector_shelly_end' -}}
        state: >-
          {{- 'null' -}}

- id: motion_detector_shelly_end
  alias: motion_detector_shelly_end
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_detector_shelly
    to: 'off'
    from: 'on'
  action:
    - alias: 'set end to timestamp'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'sensor.motion_detector_shelly_end' -}}
        state: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','timestamp') }}
    - alias: 'set last to timestamp'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'sensor.motion_detector_shelly_last' -}}
        state: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','timestamp') }}

- id: motion_detector_shelly_announce
  alias: motion_detector_shelly_announce
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_detector_shelly_announce
      to: 'unavailable'
    - platform: time_pattern
      minutes: /5
    - platform: event
      event_type: homeassistant_start
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {% set s = states('sensor.motion_detector_shelly_announce') %}
          {{ s|lower == 'unavailable' or s|lower == 'unknown' }}
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_detector_shelly_announce','on') }}
  action:
    - alias: 'motion_detector_shelly_announce: publish command'
      service_template: mqtt.publish
      data_template:
        topic: >-
          {{- 'shellies/command' -}}
        payload_template: >-
          {{- 'announce' -}}
        qos: 2
        retain: false

- id: motion_detector_shellies
  alias: motion_detector_shellies
  initial_state: on
  mode: queued
  trigger:
    - platform: state
      entity_id: sensor.motion_detector_shelly_settings
    - platform: state
      entity_id: sensor.motion_detector_shelly_status
    - platform: state
      entity_id: sensor.motion_detector_shelly_info
    - platform: time_pattern
      minutes: /1
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {# all mac addresses match #}
          {% set s = states('sensor.motion_detector_shelly_settings') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {% set s = state_attr('sensor.motion_detector_shelly_settings','device') %}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
              {% set settings = s.mac|string %}
              {% set s = states('sensor.motion_detector_shelly_update') %}
              {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
                {% set s = state_attr('sensor.motion_detector_shelly_update','mac') %}
                {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
                  {% set update = s|string %}
                  {% set s = states('sensor.motion_detector_shelly_info') %}
                  {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
                    {% set s = state_attr('sensor.motion_detector_shelly_info','mac') %}
                    {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
                      {% set info = s|string %}
                      {{ info == update and info == settings }}
                    {% else %}false{% endif %}
                  {% else %}false{% endif %}
                {% else %}false{% endif %}
              {% else %}false{% endif %}
            {% else %}false{% endif %}
          {% else %}false{% endif %}
  variables:
    ip: >-
      {% set s = states('sensor.motion_detector_shelly_info') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_info','wifi_sta') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s.ip }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    id: >-
      {% set s = states('sensor.motion_detector_shelly_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_settings','mqtt') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {% set s = s.id|replace('-','_') %}
        {% endif %}
        {%- if s|lower == 'none' or s|lower == 'unknown' or s|lower == 'unavailable' or s|lower == 'null' -%}
          {% set s = state_attr('sensor.motion_detector_shelly_settings','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {% set s = s.hostname %}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
              {{ s|replace('-','_') }}
            {% else %}
              {{- 'unknown' -}}
            {% endif %}
          {% else %}
            {{- 'unknown' -}}
          {% endif %}
        {% else %}
          {{ s|replace('-','_') }}
        {% endif %}
      {% else %}
        {{- 'unknown' -}}
      {% endif %}
    attributes: >-
      {% set s = states('sensor.motion_detector_shelly_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_settings.attributes }}
      {% else %}null{% endif %}
    ids: >-
      {% set s = states('sensor.motion_detector_shelly_settings') %}
      [{%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {%- set prior = state_attr('sensor.motion_detector_shellies','ids') -%}
        {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
          {% set prior = prior|string|from_json %}
          {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
            {% if prior is iterable %}
              {% if prior|length > 0 -%}
                {%- for p in prior -%}
                  {%- if loop.first -%}{%- else -%},{% endif -%}
                  "{{- p -}}"
                {%- endfor -%}
              {%- else -%}{%- set prior = null -%}{%- endif -%}
            {%- else -%}{%- set prior = null -%}{%- endif -%}
          {%- else -%}{%- set prior = null -%}{%- endif -%}
        {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- if prior != null -%},{%- endif -%}
      "{{- id -}}"]
    last: >-
      {% set s = states('sensor.motion_detector_shelly_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_settings.last_updated|as_timestamp|int }}
      {% else %}null{% endif %}
    update: >-
      {% set s = states('sensor.motion_detector_shelly_update') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_update.attributes }}
      {% else %}null{% endif %}
  action:
    - alias: 'motion_detector_shellies: test if id != unknown'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ id|lower != 'unknown' }}
    - alias: 'motion_detector_shellies: test if attributes is not none'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ attributes|lower != 'none' }}
#    - alias: 'motion_detector_shellies: test if <id> not in list'
#      condition: and
#      conditions:
#        - condition: template
#          value_template: >
#            {% set s = state_attr('sensor.motion_detector_shellies','ids') %}
#            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
#              {{ not id in s|string|from_json -}}
#            {% else %}true{% endif %}
    - alias: 'motion_detector_shellies: create/update binary_sensor.motion_detector_shelly_<id>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'binary_sensor.motion_detector_shelly_' + id|string -}}
        ip: >-
          {{ ip }}
        last: >-
          {{ last }}
        mqtt: >-
          {{ attributes.mqtt }}
        login: >-
          {{ attributes.login }}
        motion: >-
          {{ attributes.motion }}
        wifi: >-
          {{ attributes.wifi_sta }}
        device: >-
          {{ attributes.device }}
        timezone: >-
          {{ attributes.timezone }}
        update: >-
          {{ update }}
        state: >-
          {{ states('sensor.motion_detector_shelly_settings')|lower == 'true' }}
    - alias: 'create/update sensor.motion_detector_shellies: list'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'sensor.motion_detector_shellies' -}}
        update: >-
          {{ update }}
        last: >-
          {{ last }}
        when: >-
          {{ last|timestamp_custom("%a %b %d %I:%M:%S %p %Z") -}}
        ip: >-
          {{- ip -}}
        count: >-
          {{- ids|string|from_json|list|count -}}
        ids: >-
          {{ ids|string|from_json|list|unique|list|to_json|string }}
        state: >-
          True
