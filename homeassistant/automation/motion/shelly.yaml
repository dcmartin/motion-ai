###
# homeassistant/automation/motion/shelly.yaml
###

- id: motion_detector_shelly_counter
  alias: motion_detector_shelly_counter
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_detector_shelly
    to: 'on'
    from: 'off'
  action:
    - service: counter.increment
      entity_id: counter.motion_detector_shelly

## update on MQTT status payload

- id: motion_detector_shellies_mqtt
  alias: motion_detector_shellies_mqtt
  initial_state: on
  trigger:
    - platform: mqtt
      topic: 'shellies/+/status'
  variables:
    topic: >-
      {{ trigger.topic }}
    id: >-
      {{ topic|replace('shellies/','')|replace('/status','') }}
    mac: >-
      {% if id|lower != 'none' and id|lower != 'unavailable' and id|lower != 'unknown' and id|lower != 'null' and id|length > 0 %}
        {% set s = states('group.motion_detector_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_detector_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% for i in s if state_attr(i,'id') == id %}
              {% if loop.first %}{{ state_attr(i,'mac') }}{% endif %}
            {% endfor %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
  action:
    - alias: 'test id is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ id|lower != 'unavailable' and id|lower != 'unknown' and id|lower != 'null' and id|lower != 'none' }}
    - alias: 'set binary_sensor.motion_detector_shelly'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{ 'binary_sensor.motion_detector_shelly' }}
        id: >-
          {{ id }}
        timestamp: >-
          {{ trigger.payload_json.timestamp }}
        motion: >-
          {{ trigger.payload_json.motion }}
        active: >-
          {{ trigger.payload_json.active}}
        vibration: >-
          {{ trigger.payload_json.vibration}}
        lux: >-
          {{ trigger.payload_json.lux }}
        bat: >-
          {{ trigger.payload_json.bat }}
        state: >-
          {% set s = trigger.payload_json.motion %}
          {% if s|lower == 'true' %}on{% else %}off{% endif %}
    - alias: 'test mac is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null' and mac|lower != 'none' }}
    - alias: 'set binary_sensor.motion_detector_shelly.mac'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'binary_sensor.motion_detector_shelly' -}}
        mac: >-
          {{ mac }}
    - alias: 'set binary_sensor.motion_detector_shelly_<mac>'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{ 'binary_sensor.motion_detector_shelly_' + mac|string }}
        id: >-
          {{ id }}
        timestamp: >-
          {{ trigger.payload_json.timestamp }}
        motion: >-
          {{ trigger.payload_json.motion }}
        active: >-
          {{ trigger.payload_json.active}}
        vibration: >-
          {{ trigger.payload_json.vibration}}
        lux: >-
          {{ trigger.payload_json.lux }}
        bat: >-
          {{ trigger.payload_json.bat }}
        state: >-
          {% set s = trigger.payload_json.motion %}
          {% if s|lower == 'true' %}on{% else %}off{% endif %}

# update on motion start

- id: motion_detector_shelly_start
  alias: motion_detector_shelly_start
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_detector_shelly
    to: 'on'
    from: 'off'
  variables:
    sensor: >-
      {% set s = state_attr('binary_sensor.motion_detector_shelly','mac') %}
      {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
        {% set s = states('binary_sensor.motion_detector_shelly_' + s) %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ 'binary_sensor.motion_detector_shelly_' + s|string }}
        {% else %}null{% endif %}
      {% else %}
        {% set s = states('group.motion_detector_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_detector_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|count == 1 %}
            {{ s|first }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% endif %}
  action:
    - alias: 'set start to timestamp and end to null'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'binary_sensor.motion_detector_shelly' -}}
        when: >-
          {{- 'Now' -}}
        start: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','timestamp') }}
        end: >-
          {{- 'null' -}}
    - alias: 'test sensor is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' and sensor|lower != 'none' }}
    - alias: 'set binary_sensor.motion_detector_shelly_<mac>: on'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- sensor -}}
        when: >-
          {{- 'Now' -}}
        start: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','timestamp') }}
        end: >-
          {{- 'null' -}}
        state: >-
          {{- 'on' -}}

- id: motion_detector_shelly_end
  alias: motion_detector_shelly_end
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_detector_shelly
    from: 'on'
    to: 'off'
  variables:
    sensor: >-
      {% set s = state_attr('binary_sensor.motion_detector_shelly','mac') %}
      {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
        {{- 'binary_sensor.motion_detector_shelly_' + s|string -}}
      {% else %}
        {% set s = states('group.motion_detector_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_detector_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|count == 1 %}
            {{ s|first }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% endif %}
  action:
    - alias: 'set binary_sensor.motion_detector_shelly'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'binary_sensor.motion_detector_shelly' -}}
        last: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','timestamp') }}
        end: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','timestamp') }}
        duration: >-
          {% set s = state_attr('binary_sensor.motion_detector_shelly','start') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|int > 0 %}
            {% set e = state_attr('binary_sensor.motion_detector_shelly','timestamp') %}
            {% if e|lower != 'none' and e|lower != 'unavailable' and e|lower != 'unknown' and e|lower != 'null' and e|int > 0 %}
              {{ e|int - s|int }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        when: >-
          {% set s = state_attr('binary_sensor.motion_detector_shelly','timestamp') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|int > 0 %}
            {{ s|int|timestamp_custom("%a %b %d %I:%M:%S %p %Z") }}
          {% else %}Pending{% endif %}
        state: >-
          {{- 'off' -}}
    - alias: 'test sensor is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' and sensor|lower != 'none' }}
    - alias: 'set binary_sensor.motion_detector_shelly_<mac>: off'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- sensor -}}
        last: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','last') }}
        end: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','end') }}
        duration: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','duration') }}
        when: >-
          {{ state_attr('binary_sensor.motion_detector_shelly','when') }}
        state: >-
          {{- 'off' -}}

- id: motion_detector_shellies_publish
  alias: motion_detector_shellies_publish
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_detector_shelly_announce
    - platform: time_pattern
      minutes: /15
    - platform: event
      event_type: homeassistant_start
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {% set s = states('sensor.motion_detector_shelly_announce') %}
          {{ s|lower == 'unavailable' or s|lower == 'unknown' }}
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_detector_shellies_publish','on') }}
  action:
    - alias: 'publish command'
      service_template: mqtt.publish
      data_template:
        topic: >-
          {{- 'shellies/command' -}}
        payload_template: >-
          {{- 'announce' -}}
        qos: 2
        retain: false

- id: motion_detector_shellies_settings
  alias: motion_detector_shellies_settings
  initial_state: on
  mode: queued
  trigger:
    - platform: state
      entity_id: sensor.motion_detector_shelly_settings
  variables:
    mac: >-
      {% set s = states('sensor.motion_detector_shelly_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_settings','device') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s.mac }}
        {% else %}{{- 'unknown' -}}{% endif %}
      {% else %}{{- 'unknown' -}}{% endif %}
    macs: >-
      {% set s = states('sensor.motion_detector_shellies') %}
      [{%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {%- set prior = state_attr('sensor.motion_detector_shellies','macs') -%}
        {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
          {% set prior = prior|string|from_json %}
          {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
            {% if prior is iterable %}
              {% if prior|length > 0 -%}
                {%- for p in prior if p|length > 0 -%}
                  {%- if loop.first -%}{%- else -%},{% endif -%}
                  "{{- p -}}"
                {%- endfor -%}
              {%- else -%}{%- set prior = null -%}{%- endif -%}
            {%- else -%}{%- set prior = null -%}{%- endif -%}
          {%- else -%}{%- set prior = null -%}{%- endif -%}
        {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- if prior != null -%},{%- endif -%}
      "{{- mac -}}"]
    settings: >-
      {% set s = states('sensor.motion_detector_shelly_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_settings.attributes }}
      {% else %}null{% endif %}
    updated: >-
      {% set s = states('sensor.motion_detector_shelly_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_settings.last_updated|as_timestamp|int }}
      {% else %}null{% endif %}
  action:
    - alias: 'test if mac != unknown'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ mac|lower != 'unknown' }}
    - alias: 'update binary_sensor.motion_detector_shelly_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'binary_sensor.motion_detector_shelly_' + mac|string -}}
        mac: >-
          {{ mac }}
        settings: >-
          {{ settings }}
        state: >-
          {% if is_state('binary_sensor.motion_detector_shelly_' + mac|string,'on') -%}on{% else %}off{% endif %}
    - alias: 'update sensor.motion_detector_shellies'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'sensor.motion_detector_shellies' -}}
        count: >-
          {{- macs|string|from_json|list|unique|list|count -}}
        macs: >-
          {{ macs|string|from_json|list|unique|list|to_json|string }}
        state: >-
          {{ updated }}
    - alias: 'update group.motion_detector_shellies'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'group.motion_detector_shellies' -}}
        friendly_name: 'Shellies'
        entity_ids: >-
          {% set s = states('sensor.motion_detector_shelly_entity_ids') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{ s|from_json }}
          {% else %}null{% endif %}
        updated: >-
          {{ updated }}
        state: >-
          {{ 'on' }}

## update on REST sensor '<username>:<password>@<ip>/shellies/<id>/status'

- id: motion_detector_shellies_update
  alias: motion_detector_shellies_update
  initial_state: on
  mode: queued
  trigger:
    - platform: state
      entity_id: sensor.motion_detector_shelly_update
  variables:
    mac: >-
      {% set s = states('sensor.motion_detector_shelly_update') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_update','mac') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s }}
        {% else %}{{- 'unknown' -}}{% endif %}
      {% else %}{{- 'unknown' -}}{% endif %}
    updated: >-
      {% set s = states('sensor.motion_detector_shelly_update') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_update','unixtime') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|int > 0 -%}
          {{ s }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    status: >-
      {% set s = states('sensor.motion_detector_shelly_update') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_update.attributes }}
      {% else %}null{% endif %}
  action:
    - alias: 'test if mac != unknown'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ mac|lower != 'unknown' }}
    - alias: 'test if status is not none'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ status|lower != 'none' }}
    - alias: 'update binary_sensor.motion_detector_shelly_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'binary_sensor.motion_detector_shelly_' + mac|string -}}
        status: >-
          {{ status }}
        vibration: >-
          {{ status.sensor.vibration }}
        active: >-
          {{ status.sensor.active }}
        timestamp: >-
          {{ status.sensor.timestamp }}
        updated: >-
          {{ updated }}
        state: >-
          {% if status != null %}
            {% if status.sensor.motion|lower == 'true' %}on{% else %}off{% endif %}
          {% else %}off{% endif %}

## update on MQTT payload 'shellies/+/info'

- id: motion_detector_shellies_info
  alias: motion_detector_shellies_info
  initial_state: on
  mode: queued
  trigger:
    - platform: state
      entity_id: sensor.motion_detector_shelly_info
  variables:
    mac: >-
      {% set s = states('sensor.motion_detector_shelly_info') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_info','mac') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s }}
        {% else %}{{- 'unknown' -}}{% endif %}
      {% else %}{{- 'unknown' -}}{% endif %}
    updated: >-
      {% set s = states('sensor.motion_detector_shelly_info') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_info','unixtime') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|int > 0 -%}
          {{ s }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    status: >-
      {% set s = states('sensor.motion_detector_shelly_info') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_info.attributes }}
      {% else %}null{% endif %}
  action:
    - alias: 'test if mac != unknown'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ mac|lower != 'unknown' }}
    - alias: 'test if status is not none'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ status|lower != 'none' }}
    - alias: 'update binary_sensor.motion_detector_shelly_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'binary_sensor.motion_detector_shelly_' + mac|string -}}
        status: >-
          {{ status }}
        updated: >-
          {{ updated }}

## update on MQTT payload 'shellies/+/announce'

- id: motion_detector_shelly_announce
  alias: motion_detector_shelly_announce
  initial_state: on
  mode: queued
  trigger:
    - platform: state
      entity_id: sensor.motion_detector_shelly_announce
  variables:
    id: >-
      {% set s = states('sensor.motion_detector_shelly_announce') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_announce','id') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s }}
        {% else %}{{- 'unknown' -}}{% endif %}
      {% else %}{{- 'unknown' -}}{% endif %}
    ids: >-
      {% set s = states('sensor.motion_detector_shellies') %}
      [{%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {%- set prior = state_attr('sensor.motion_detector_shellies','ids') -%}
        {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
          {% set prior = prior|string|from_json %}
          {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
            {% if prior is iterable %}
              {% if prior|length > 0 -%}
                {%- for p in prior if p|length > 0 -%}
                  {%- if loop.first -%}{%- else -%},{% endif -%}
                  "{{- p -}}"
                {%- endfor -%}
              {%- else -%}{%- set prior = null -%}{%- endif -%}
            {%- else -%}{%- set prior = null -%}{%- endif -%}
          {%- else -%}{%- set prior = null -%}{%- endif -%}
        {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- if prior != null -%},{%- endif -%}
      "{{- id -}}"]
    ip: >-
      {% set s = states('sensor.motion_detector_shelly_announce') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_announce','ip') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s }}
        {% else %}{{- 'unknown' -}}{% endif %}
      {% else %}{{- 'unknown' -}}{% endif %}
    mac: >-
      {% set s = states('sensor.motion_detector_shelly_announce') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_detector_shelly_announce','mac') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s }}
        {% else %}{{- 'unknown' -}}{% endif %}
      {% else %}{{- 'unknown' -}}{% endif %}
    macs: >-
      {% set s = states('sensor.motion_detector_shellies') %}
      [{%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {%- set prior = state_attr('sensor.motion_detector_shellies','macs') -%}
        {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
          {% set prior = prior|string|from_json %}
          {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
            {% if prior is iterable %}
              {% if prior|length > 0 -%}
                {%- for p in prior if p|length > 0 -%}
                  {%- if loop.first -%}{%- else -%},{% endif -%}
                  "{{- p -}}"
                {%- endfor -%}
              {%- else -%}{%- set prior = null -%}{%- endif -%}
            {%- else -%}{%- set prior = null -%}{%- endif -%}
          {%- else -%}{%- set prior = null -%}{%- endif -%}
        {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- if prior != null -%},{%- endif -%}
      "{{- mac -}}"]
    updated: >-
      {% set s = states('sensor.motion_detector_shelly_announce') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_announce.last_updated|as_timestamp|int }}
      {% else %}null{% endif %}
    announce: >-
      {% set s = states('sensor.motion_detector_shelly_announce') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_detector_shelly_announce.attributes }}
      {% else %}null{% endif %}
  action:
    - alias: 'test if mac is not unknown'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ mac|lower != 'unknown' }}
    - alias: 'test if announce is not none'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ announce|lower != 'none' }}
    - alias: 'update sensor.motion_detector_shellies'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'sensor.motion_detector_shellies' -}}
        count: >-
          {{- macs|string|from_json|list|unique|list|count -}}
        macs: >-
          {{ macs|string|from_json|list|unique|list|to_json|string }}
        ids: >-
          {{ ids|string|from_json|list|unique|list|to_json|string }}
        state: >-
          {{ updated }}
    - alias: 'update binary_sensor.motion_detector_shelly_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'binary_sensor.motion_detector_shelly_' + mac|string -}}
        friendly_name: >-
          {{- 'Motion in ' + id|string -}}
        ip: >-
          {{ ip }}
        id: >-
          {{ id }}
        mac: >-
          {{ mac }}
        announce: >-
          {{ announce }}
        updated: >-
          {{ updated }}
        state: >-
          {% if is_state('binary_sensor.motion_detector_shelly_' + mac|string,'on') -%}on{% else %}off{% endif %}
    - alias: 'update group.motion_detector_shellies'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'group.motion_detector_shellies' -}}
        friendly_name: 'Shellies'
        entity_ids: >-
          {% set s = states('sensor.motion_detector_shelly_entity_ids') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{ s|from_json }}
          {% else %}null{% endif %}
        updated: >-
          {{ updated }}
        state: >-
          {{ 'on' }}
    - alias: 'update sensor.motion_detector_shelly_settings'
      service: homeassistant.update_entity
      entity_id: sensor.motion_detector_shelly_settings
