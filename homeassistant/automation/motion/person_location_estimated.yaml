###
# homeassistant/automation/motion/person_location_estimated.yaml
###

- id: motion_person_location_estimated_previous
  alias: motion_person_location_estimated_previous
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_person_location_estimated
  variables:
    movement: >-
      {% set s = states('sensor.motion_person_location_estimated_previous') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set s = state_attr('sensor.motion_person_location_estimated_previous','latitude') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set plat = s|float %}
          {% set s = state_attr('sensor.motion_person_location_estimated_previous','longitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {% set plng = s|float %}
            {% set s = state_attr('sensor.motion_person_location_estimated','latitude') %}
            {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
              {% set clat = s|float %}
              {% set s = state_attr('sensor.motion_person_location_estimated','longitude') %}
              {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
                {% set clng = s|float %}
                {% set d = distance(plat, plng, clat, clng) %}
                {% if d|lower != 'none' and d|lower != 'null' and d|lower != 'unknown' and d|lower != 'unavailable' and d|int is number and d|int < 40075 %}
                  {{- '%0.2f'|format(d * 1000) -}}
                {% else %}null{% endif %}
              {% else %}null{% endif %}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    interval: >-
      {% set t = state_attr('sensor.motion_person_location_estimated_previous','timestamp') %}
      {% if t|lower != 'none' and t|lower != 'unknown' and t|lower != 'unavailable' and t|lower != 'null' and t|float is number and t|float > 0 %}
        {{ utcnow().timestamp() - t|float }}
      {% else %}null{% endif %}
    velocity: >-
      {% set d = movement %}
      {% if d|lower != 'null' and d|int is number and d|int < 40075 %}
        {% set t = interval %}
        {% if t|lower != 'null' and t|float is number and t|float > 0 %}
          {{- '%0.2f'|format(d|float/t|float) -}}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_location_estimated_previous
        movement: >-
          {{ movement }}
        interval: >-
          {{ interval }}
        velocity: >-
          {{ velocity }}
        timestamp: >-
          {% set s = states('sensor.motion_person_location_estimated') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ utcnow().timestamp() }}
          {% else %}null{% endif %}
        latitude: >-
          {% set s = states('sensor.motion_person_location_estimated') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location_estimated','latitude') }}
          {% else %}null{% endif %}
        longitude: >-
          {% set s = states('sensor.motion_person_location_estimated') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location_estimated','longitude') }}
          {% else %}null{% endif %}
        confidence: >-
          {% set s = states('sensor.motion_person_location_estimated') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location_estimated','confidence') }}
          {% else %}null{% endif %}
        distance: >-
          {% set s = states('sensor.motion_person_location_estimated') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location_estimated','distance') }}
          {% else %}null{% endif %}
        source: >-
          {% set s = states('sensor.motion_person_location_estimated') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location_estimated','source') }}
          {% else %}null{% endif %}
        zone: >-
          {% set s = states('sensor.motion_person_location_estimated') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ state_attr('sensor.motion_person_location_estimated','zone') }}
          {% else %}null{% endif %}
        state: >-
          {{ states('sensor.motion_person_location_estimated') }}

- id: motion_person_location_estimated
  alias: motion_person_location_estimated
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_detected_person
  variables:
    location: >-
      {% set s = states('sensor.motion_person_location') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {{ s }}
      {% else %}null{% endif %}
    camera: >-
      {{ states('sensor.motion_detected_person_camera') }}
    confidence: >-
      {% set s = states('sensor.motion_' + camera|string + '_detected_person') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {{ states('sensor.motion_' + camera|string + '_detected_person_confidence') }}
      {% else %}null{% endif %}
    source: >-
      {% set s = states('camera.motion_' + camera|string + '_detected_person') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {{ 'camera.motion_' + camera|string + '_detected_person' }}
      {% else %}
        {{ 'camera.motion_detected_person' }}
      {% endif %}
    area: >-
      {% set s = states('binary_sensor.motion_' + camera|string + '_detected_person') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set s = state_attr('binary_sensor.motion_' + camera|string + '_detected_person','area') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set p = s %}
        {% endif %}
      {% endif %}
      {% if p is defined %}
        {{ p }}
      {% else %}
        {{ camera }}
      {% endif %}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ trigger.to_state.state|lower == 'on' }}
      - condition: template
        value_template: >-
          {{ location|lower == 'home' }}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_location_estimated
        source: >-
          {{ source }}
        ago: >-
          {% set s = state_attr('sensor.motion_' + camera|string + '_camera_detected_person_status','ago') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ s }}
          {% else %}
            {{ states('sensor.motion_detected_person_ago') }}
          {% endif %}
        latitude: >-
          {% set s = state_attr('sensor.motion_' + camera|string + '_camera_detected_person_status','latitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ s }}
          {% else %}null{% endif %}
        longitude: >-
          {% set s = state_attr('sensor.motion_' + camera|string + '_camera_detected_person_status','longitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ s }}
          {% else %}null{% endif %}
        gps_accuracy: >-
          {% set s = state_attr('sensor.motion_' + camera|string + '_camera_detected_person_status','gps_accuracy') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {{ s }}
          {% else %}null{% endif %}
        distance: >-
          {% set clat = state_attr('sensor.motion_' + camera|string + '_camera_detected_person_status','latitude') %}
          {% set clng = state_attr('sensor.motion_' + camera|string + '_camera_detected_person_status','longitude') %}
          {% set s = distance('zone.home', clat, clng) %}
          {% if s|lower != 'none' and s|lower != 'null' and s|lower != 'unknown' and s|lower != 'unavailable' and s|int is number and s|int < 40075 %}
            {{- '%0.2f'|format(s|float * 1000) -}}
          {% else %}null{% endif %}
        confidence: >-
          {{ confidence }}
        state: >-
          {{ area }}
