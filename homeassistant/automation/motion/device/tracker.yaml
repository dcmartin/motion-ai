###
# homeassistant/automation/motion/device/tracker.yaml
###

- id: motion_device_tracker_automation_enable
  alias: motion_device_tracker_automation_enable
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_device_tracker_exist
    to: 'on'
  variables:
    automations: >-
      {% set automations = ['motion_device_tracker_activity_test','motion_device_tracker_activity_notify','motion_device_tracker_activity_dismiss'] %}
      {{ automations }}
  action:
    - alias: 'enable automations for device_tracker'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = automations[repeat.index-1]|default('') %}
              {{ s|string != '' }}
        sequence:
          - variables:
              automation: >-
                {% set s = automations[repeat.index-1] %}
                {{ 'automation.' + s|string }}
          - condition: template
            value_template: >-
              {{ states(automation)|lower == 'off' }}
          - alias: 'enable automation'
            service: automation.turn_on
            data_template:
              entity_id: >-
                {{ automation }}

- id: motion_device_tracker_automation_disable
  alias: motion_device_tracker_automation_disable
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_device_tracker_exist
    to: 'off'
  variables:
    automations: >-
      {% set automations = ['motion_device_tracker_activity_test','motion_device_tracker_activity_notify','motion_device_tracker_activity_dismiss'] %}
      {{ automations }}
  action:
    - alias: 'disable automations for device_tracker'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = automations[repeat.index-1]|default('') %}
              {{ s|string != '' }}
        sequence:
          - variables:
              automation: >-
                {% set s = automations[repeat.index-1] %}
                {{ 'automation.' + s|string }}
          - condition: template
            value_template: >-
              {{ states(automation)|lower == 'on' }}
          - alias: 'disable automation'
            service: automation.turn_off
            data_template:
              entity_id: >-
                {{ automation }}

- id: motion_device_tracker_rescan
  alias: motion_device_tracker_rescan
  mode: restart
  initial_state: on
  trigger:
    - platform: time_pattern
      minutes: '/1'
    - platform: homeassistant
      event: start
  variables:
    ids: >-
      {{ state_attr('binary_sensor.motion_device_tracker_exist','ids') }}
    total: >-
      {% set total = 0 -%}
      {%- if ids|lower != 'none' and ids is iterable -%}
        {%- set total = ids|count -%}
      {%- endif -%}
      {{- total }}
    dids: >-
      {%- set device_trackers = states.device_tracker|map(attribute='entity_id')|map('device_id')|list -%}
      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class','binary_sensor_list')|list -%}
      [{%- for i in s|sort|unique if i|lower != 'none' and not is_state_attr('binary_sensor.motion_device_' + i|string,'devices','none') -%}
        {%- if not loop.first -%},{%- endif -%}
        {%- set e = 'binary_sensor.motion_device_' + i|string -%}
        {%- set devices = state_attr(e, 'devices') -%}
        {%- for j in devices|map(attribute='did')|list if j|lower != 'none' and j in device_trackers -%}
          {%- if not loop.first -%},{%- endif -%}
          {%- set t = states.person|selectattr('attributes.source', 'defined')|map(attribute='attributes.source')|first|default(none) -%}
          {%- if t|lower != 'none' and j == device_id(t) -%}
            {%- set id = devices|selectattr('did','==',j)|map(attribute='id')|first -%}
            {%- set p = states.person|selectattr('attributes.source', 'defined')|selectattr('attributes.source','==','device_tracker.'+id|string)|map(attribute='entity_id')|first -%}
          {%- endif -%} 
          {"class":"{{- i -}}","did":"{{- j -}}","person":"{{- p|default(none)|replace('person.','') -}}"}
        {%- else -%}{{ none }}{%- endfor -%}
      {%- endfor -%}]
    devices: >-
      {%- if dids|lower != 'none' and not dids is string and dids is iterable and dids|count > 0 -%}
       {%- set dids = dids|reject('undefined')|list -%}
        {%- if dids|lower != 'none' and not dids is string and dids is iterable and dids|count > 0 -%}
          {%- set dids = dids|selectattr('did','defined')|list -%}
          {%- if dids|lower != 'none' and not dids is string and dids is iterable and dids|count > 0 -%}
          [{%- for i in dids|map(attribute='did')|sort|unique|list -%}
            {%- if not loop.first -%},{%- endif -%}
            {%- set n = device_attr(i,'name_by_user') -%}
            {%- if n|lower == 'none' -%}
              {%- set n = device_attr(i,'name') -%}
            {%- endif -%}
            {%- set c = dids|selectattr('did','==',i)|map(attribute='class')|list -%}
            {%- set p = dids|selectattr('did','==',i)|map(attribute='person')|first -%}
            {"id":"{{- device_attr(i,'name') -}}","did":"{{- i -}}","friendly_name":"{{- n -}}","manufacturer":"{{- device_attr(i,'manufacturer') -}}","model":"{{- device_attr(i,'model') -}}","sw_version":"{{- device_attr(i,'sw_version') -}}","class":{{- c|default(none) -}},"person":"{{- p|default(none) -}}"}
          {%- endfor -%}]
          {%- else -%}none{%- endif -%}
        {%- else -%}none{%- endif -%}
      {%- else -%}none{%- endif -%}
  action:
    - alias: 'update binary_sensor.motion_device_tracker ids,total,devices'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_tracker
        ids: >-
          {{ ids }}
        total: >-
          {{ total }}
        devices: >-
          {{ devices }}
        state: >-
          {% if total|int(0) > 0 %}on{% else %}off{% endif %}
