###
# homeassistant/automation/motion/device/tracker.yaml
###

- id: motion_device_tracker_automation_enable
  alias: motion_device_tracker_automation_enable
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_device_tracker_exist
    to: 'on'
  variables:
    automations: >-
      {% set automations = ['motion_device_tracker_activity_test','motion_device_tracker_activity_notify','motion_device_tracker_activity_dismiss'] %}
      {{ automations }}
  action:
    - alias: 'enable automations for device_tracker'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = automations[repeat.index-1]|default('') %}
              {{ s|string != '' }}
        sequence:
          - variables:
              automation: >-
                {% set s = automations[repeat.index-1] %}
                {{ 'automation.' + s|string }}
          - condition: template
            value_template: >-
              {{ states(automation)|lower == 'off' }}
          - alias: 'enable automation'
            service: automation.turn_on
            data_template:
              entity_id: >-
                {{ automation }}

- id: motion_device_tracker_automation_disable
  alias: motion_device_tracker_automation_disable
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_device_tracker_exist
    to: 'off'
  variables:
    automations: >-
      {% set automations = ['motion_device_tracker_activity_test','motion_device_tracker_activity_notify','motion_device_tracker_activity_dismiss'] %}
      {{ automations }}
  action:
    - alias: 'disable automations for device_tracker'
      repeat:
        while:
          - condition: template
            value_template: >-
              {% set s = automations[repeat.index-1]|default('') %}
              {{ s|string != '' }}
        sequence:
          - variables:
              automation: >-
                {% set s = automations[repeat.index-1] %}
                {{ 'automation.' + s|string }}
          - condition: template
            value_template: >-
              {{ states(automation)|lower == 'on' }}
          - alias: 'disable automation'
            service: automation.turn_off
            data_template:
              entity_id: >-
                {{ automation }}

- id: motion_device_tracker_rescan
  alias: motion_device_tracker_rescan
  mode: restart
  initial_state: on
  trigger:
    - platform: time_pattern
      minutes: '/2'
    - platform: homeassistant
      event: start
  variables:
    ids: >-
      {{ state_attr('binary_sensor.motion_device_tracker_exist','ids') }}
    total: >-
      {% set total = 0 -%}
      {%- if ids|lower != 'none' and ids is iterable -%}
        {%- set total = ids|count -%}
      {%- endif -%}
      {{- total }}
#    measurement: >-
#      {% set s = state_attr('binary_sensor.motion_device_class','sensor_list') %}
#      {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
#        { {%- for i in s if
#          states('sensor.motion_device_' + i|string)|lower != 'null'
#          and states('sensor.motion_device_' + i|string)|lower != 'unknown'
#          and state_attr('binary_sensor.motion_device_' + i|string,'ids')|lower != 'none'
#          and state_attr('binary_sensor.motion_device_' + i|string,'ids')|lower != 'unknown'
#          and states('sensor.motion_device_' + i|string)|lower != 'none' %}
#          {%- if not loop.first -%},{%- endif -%}
#          {%- set e = 'sensor.motion_device_' + i|string %}
#          {%- set n = state_attr(e,'ids') %}
#          {% if n|lower != 'none' %}{% set n = n|count %}{% else %}{% set n = 0 %}{% endif %}
#          "{{- i -}}":{{- n -}}
#        {%- endfor -%} }
#      {%- else -%}null{%- endif %}
#    status: >-
#      {% set s = state_attr('binary_sensor.motion_device_class'.'binary_sensor_list') %}
#      {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
#        { {%- for i in state_attr('binary_sensor.motion_device_class'.'binary_sensor_list') if
#          states('binary_sensor.motion_device_' + i|string)|lower != 'null'
#          and states('binary_sensor.motion_device_' + i|string)|lower != 'unknown'
#          and state_attr('binary_sensor.motion_device_' + i|string,'ids')|lower != 'none'
#          and state_attr('binary_sensor.motion_device_' + i|string,'ids')|lower != 'unknown'
#          and states('binary_sensor.motion_device_' + i|string)|lower != 'none' %}
#          {%- if not loop.first -%},{%- endif -%}
#          {%- set e = 'binary_sensor.motion_device_' + i|string %}
#          {%- set n = state_attr(e,'ids') %}
#          {% if n|lower != 'none' %}{% set n = n|count %}{% else %}{% set n = 0 %}{% endif %}
#          "{{- i -}}":{{- n -}}
#        {%- endfor -%} }
#      {%- else -%}null{%- endif %}
#    entities: >-
#      {%- if ids|lower != 'none' and not ids is string and ids is iterable and ids|count > 0 -%}
#        [{%- for i in ids -%}
#          {%- set o = loop -%}
#          {%- for state in states if device_attr(state.entity_id, 'name') == i and state.attributes.device_class|default('null')|string != 'null' -%}
#            {%- if not o.first or not loop.first -%},{%- endif -%}
#            {%- set v = state.state -%}
#            {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}","did":"{{- device_id(state.entity_id) -}}","area":"{{- area_id(state.entity_id) -}}"}
#          {%- else -%}{% if not loop.last %}none{% endif %}{%- endfor -%}
#        {%- endfor -%}]
#      {%- else -%}null{%- endif %}
#    devices: >-
#      {%- if entities|lower != 'null' and not entities is string and entities is iterable and entities|count > 0 -%}
#        [{%- for i in entities|map(attribute='id')|sort|unique -%}
#          {%- if not loop.first -%},{%- endif -%}
#          {
#           "id":"{{- i -}}",
#           "area":"{{- entities|selectattr('id','==',i)|map(attribute='area')|sort|unique|first -}}",
#           "did":"{{- entities|selectattr('id','==',i)|map(attribute='did')|sort|unique|first -}}"
#          }
#        {%- endfor -%}]
#      {%- else -%}null{%- endif %}
#    missing: >-
#      {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class'.'binary_sensor_list')|list -%}
#      [{%- for i in s|sort|unique if is_state('binary_sensor.motion_device_' + i + '_missing','on') -%}
#        {%- if not loop.first -%},{%- endif -%}
#        "{{- i -}}"
#      {%- endfor -%}]
  action:
    - alias: 'update sensor.motion_device_tracker ids'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_device_tracker
        ids: >-
          {{ ids }}
        total: >-
          {{ total }}
#        measurement: >-
#          {{ measurement }}
#        missing: >-
#          {{ missing }}
#        status: >-
#          {{ status }}
#        devices: >-
#          {{ devices }}
        state: >-
          {% if total|int(0) > 0 %}on{% else %}off{% endif %}
#    - variables:
#        entities: >-
#          {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class'.'binary_sensor_list')|list -%}
#          [{%- for i in s|sort|unique if is_state_attr('binary_sensor.motion_device_' + i + '_exist','activity','on') -%}
#            {%- if not loop.first -%},{%- endif -%}
#            "{{- 'binary_sensor.motion_device_' + i|string + '_activity' -}}"
#          {%- endfor -%}]
#    - alias: 'set group.motion_device_tracker_activity sensors'
#      service: group.set
#      data_template:
#        object_id: motion_device_tracker_activity
#        entities: >-
#          {{ entities }}
#    - variables:
#        unavailable: >-
#          {%- set s = state_attr('binary_sensor.motion_device_class','sensor_list')|list + state_attr('binary_sensor.motion_device_class'.'binary_sensor_list')|list -%}
#          [{%- for i in s|sort|unique if is_state('binary_sensor.motion_device_' + i + '_unavailable','on') -%}
#            {%- if not loop.first -%},{%- endif -%}
#            {%- for j in state_attr('binary_sensor.motion_device_' + i + '_unavailable','ids') -%}
#              {%- if not loop.first -%},{%- endif -%}
#              {"id":"{{- j -}}","class":"{{- i -}}"}
#            {%- endfor -%}
#          {%- endfor -%}]
#        ids: >-
#          {% if unavailable|lower != 'none' and not unavailable is string and unavailable is iterable and unavailable|count > 0 %}
#            {{ unavailable|map(attribute='id')|sort|unique|list }}
#          {% else %}null{% endif %}
#        count: >-
#          {% if ids|lower != 'none' and not ids is string and ids is iterable and ids|count > 0 %}
#            {{ ids|count }}
#          {% else %}null{% endif %}
#        last: >-
#          {% set last = state_attr('binary_sensor.motion_device_tracker_unavailable','last') %}
#          {% if count|int(0) > 0 %}{{ last }}{% else %}{{ utcnow().timestamp() }}{% endif %}
#        state: >-
#          {% if count|int(0) > 0 %}on{% else %}off{% endif %}
#    - alias: 'update binary_sensor.motion_device_tracker_unavailable'
#      service: python_script.set_state
#      data_template:
#        entity_id: binary_sensor.motion_device_tracker_unavailable
#        last: >-
#          {{ last }}
#        ids: >-
#          {{ ids }}
#        count: >-
#          {{ count }}
#        details: >-
#          {{ unavailable }}
#        state: >-
#          {{ state }}
#    - alias: 'update binary_sensor.motion_device_tracker: unavailable'
#      service: python_script.set_state
#      data_template:
#        entity_id: binary_sensor.motion_device_tracker
#        unavailable: >-
#          {{ ids }}
