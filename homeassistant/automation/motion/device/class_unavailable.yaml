###
# homeassistant/automation/motion/device/class.yaml
###

- id: motion_device_class_unavailable_notify
  alias: motion_device_class_unavailable_notify
  mode: single
  initial_state: on
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_class_unavailable'
      to: 'on'
  variables:
    ids: >-
      {% set ids = state_attr('binary_sensor.motion_device_class_unavailable','ids') %}
      {{ ids }}
    title: >-
      {% set title = states('input_text.motion_app') + ': sensor(s) unavailable' %}
      {{ title }}
    notification_id: >-
      {{ 'device-unavailable-notify' }}
    icon: >-
      {% set icon = 'notification-device-unavailable' %}
      {{ icon }}
    header: >-
      {{- '[![](/local/images/icons/' + icon + '.png)]()' -}}
      {{- '<hr>' -}}
    action: >-
      {% set action = 'unavailable-okay' %}
      {{ action }}
    footer: >-
      {{- '<hr>' -}}
    body: >-
      Sensor(s) unavailable at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}:
      {% for i in state_attr('binary_sensor.motion_device_class_unavailable','details') -%}
        {%- set class = i.class -%}
        {%- set e = 'binary_sensor.motion_device_' + class|string -%}
        {%- set u = state_attr(e,'unavailable') %}
        {{- '<ul>' -}}
        {%- for p in u -%}
          {%- set d = state_attr('binary_sensor.motion_device_' + class|string,'devices')|selectattr('id','==',p.id)|first -%}
          {%- set f = state_attr('binary_sensor.motion_device_' + class|string + '_unavailable','details') -%}
          {{- '<li>' -}}
          [{{- p.id -}}](/config/devices/device/{{- d.did -}}) sensor <i>{{- f[p.id][loop.index-1] -}}</i> ({{- class -}}); {{ p.updated|as_datetime|relative_time }} ago
          {{- '</li>' -}}
        {% endfor -%}
        {{- '</ul>' -}}
      {% endfor %}
      {{- '<p>' -}}
      {{-  '[![](https://img.shields.io/badge/' + action + '-green.svg)](' + url + ')' -}}
    message: >-
      {{ header }}
      {{ body }}
      {{ footer }}
  action:
    - alias: 'notify unavailable device'
      service: persistent_notification.create
      data_template:
        title: >-
          {{- title -}}
        notification_id: >-
          {{- notification_id -}}
        message: >-
          {{- message -}}

- id: motion_device_class_unavailable_dismiss
  alias: motion_device_class_unavailable_dismiss
  mode: single
  initial_state: on
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_class_unavailable'
      to: 'off'
  variables:
    notification_id: >-
      {{ 'device-unavailable-notify' }}
  action:
    - alias: 'dismiss inactive device'
      service: persistent_notification.dismiss
      data_template:
        notification_id: >-
          {{- notification_id -}}
