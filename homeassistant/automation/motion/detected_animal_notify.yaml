###
# homeassistant/automation/motion/detected_animal_notify.yaml
###

## notify

- id: motion_detected_animal_notify
  alias: motion_detected_animal_notify
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_detected_animal
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state and trigger.to_state.state|lower == 'on' }}
      - condition: template
        value_template: >
          {%- set c = states('sensor.motion_detected_animal_camera') -%}
          {{ c|lower != 'none' and c|lower != 'unknown' and c|lower != 'none' and c|lower != 'null' and c|lower != 'pending' }}
      - condition: template
        value_template: >
          {%- set c = states('sensor.motion_detected_animal_camera') -%}
          {%- set s = states('input_boolean.motion_' + c|string + '_detected_animal_notify') -%}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'null' %}
            {{ is_state('input_boolean.motion_' + c|string + '_detected_animal_notify','on') }}
          {% else %}
            {{ is_state('input_boolean.motion_detected_animal_notify','on') }}
          {% endif %}
      - condition: template
        value_template: >
          {%- set c = states('sensor.motion_detected_animal_camera') -%}
          {%- set s = states('binary_sensor.motion_' + c|string + '_detected_animal') -%}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'null' %}
            {{ is_state('binary_sensor.motion_' + c|string + '_detected_animal','on') }}
          {% else %}
            {{ is_state('binary_sensor.motion_detected_animal','on') }}
          {% endif %}
      - condition: template
        value_template: >
          {%- set c = states('sensor.motion_detected_animal_camera') -%}
          {%- set s = states('sensor.motion_' + c|string + '_detected_animal_count') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'null' %}
            {{ s|int > 0 }}
          {% else %}
            {{ states('sensor.motion_detected_animal_count')|int > 0 }}
          {% endif %}
      - condition: template
        value_template: >
          {%- set c = states('sensor.motion_detected_animal_camera') -%}
          {%- set s = states('input_boolean.motion_' + c|string + '_detect_animal_confirmed') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'null' %}
            {{ is_state('binary_sensor.motion_' + c|string + '_detected_animal_confirmed','on') }}
          {% elif is_state('input_boolean.motion_detect_animal_confirmed','on') %}
            {{ is_state('binary_sensor.motion_detected_animal_confirmed','on') }}
          {% else %}true{% endif %}
  variables:
    message: >-
      {%- set c = states('sensor.motion_detected_animal_camera') -%}
      {%- set d = states('sensor.motion_detected_animal_device') -%}
      {%- set l = state_attr('sensor.motion_' + c|string + '_detected_animal','list') -%}
      {%- if l|lower == 'none' or l|lower == 'unknown' or l|lower == 'unavailable' or l|lower == 'null' -%}
        {%- set l = state_attr('sensor.motion_detected_animal','list') -%}
      {%- endif -%}
      {%- if l|lower != 'none' and l|lower != 'unknown' and l|lower != 'unavailable' and l|lower != 'null' and l is iterable and l|length > 0 -%}
        {%- set u = '&results=' + l|to_json|string|urlencode -%}
      {%- else -%}
        {%- set u = '' -%}
        {%- set l = null -%}
      {%- endif -%}
      {%- set e = states('sensor.motion_' + c|string + '_detected_animal_event') -%}
      {%- if e|lower == 'none' or e|lower == 'unknown' or e|lower == 'unavailable' or e|lower == 'null' -%}
        {%- set e = states('sensor.motion_detected_animal_event') -%}
      {%- endif -%}
      {%- set count = states('sensor.motion_' + c|string + '_detected_animal_count') -%}
      {%- if count|lower == 'none' or count|lower == 'unknown' or count|lower == 'unavailable' or count|lower == 'null' -%}
        {%- set count = states('sensor.motion_detected_animal_count') -%}
      {%- endif -%}
      {%- set when = states('sensor.motion_' + c|string + '_detected_animal_when') -%}
      {%- if when|lower == 'none' or when|lower == 'unknown' or when|lower == 'unavailable' or when|lower == 'null' -%}
        {%- set when = states('sensor.motion_detected_animal_when') -%}
      {%- endif -%}
      {% if is_state('input_boolean.motion_media_mask','on') %}
      {{- '[![]('
         + '/local/images/motion/'
         + c
         + '/detected_animal_animated_mask'
         + '.gif?e='
         + e
         + ')]('
         + '/local/images/motion/'
         + c
         + '/detected_animal'
         + '.jpg?e='
         + e
         + ')' }}
      {%- else -%}
      {{- '[![]('
         + '/local/images/motion/'
         + c
         + '/detected_animal'
         + '.jpg?e='
         + e
         + ')]('
         + '/local/images/motion/'
         + c
         + '/detected_animal_animated'
         + '.gif?e='
         + e
         + ')' }}
      {%- endif -%}
      {{- '<br>' + 'Camera '
         + c|string
         + ' detected ' + count|string
         + ' animal(s) at ' + when|string -}}
      {%- if is_state('input_boolean.motion_media_mask','off') -%}
        {%- if l is iterable and l|length > 0 -%}
          {%- for i in l|map(attribute="e")|unique|list -%}
          {{- '<br>[![](https://img.shields.io/badge/' + i + '-yes-green.svg)]('
            + states('sensor.motion_detected_animal_api')
            + '/cgi-bin/predict.yes?entity=' + i
            + '&camera=' + c
            + '&event=' + e
            + u
            + ')' -}}
          {{- '[![](https://img.shields.io/badge/' + i + '-no-red.svg)]('
            + states('sensor.motion_detected_animal_api')
            + '/cgi-bin/predict.no?entity=' + i
            + '&camera=' + c
            + '&event=' + e
            + u
            + ')' -}}
          {%- endfor -%}
        {%- endif %}
      {%- endif %}
  action:
    - service: persistent_notification.create
      data_template:
        title: >-
          {%- set count = states('sensor.motion_' + c|string + '_detected_animal_count') -%}
          {%- if count|lower == 'none' or count|lower == 'unknown' or count|lower == 'unavailable' or count|lower == 'null' -%}
            {%- set count = states('sensor.motion_detected_animal_count') -%}
          {%- endif -%}
          NOTICE: Detected {{ count }} animal(s)
        notification_id: >
          motion_detected_animal-{{- states('sensor.motion_detected_animal_camera') -}}
        message: >-
          {{ message }}

# ago low/high counters

- id: motion_detected_animal_ago_low_counter
  alias: motion_detected_animal_ago_low_counter
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_low
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_low','on') }}
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
  action:
    - service: counter.increment
      entity_id: counter.motion_detected_animal_ago_low_counter

- id: motion_detected_animal_ago_high_counter
  alias: motion_detected_animal_ago_high_counter
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_high
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_high','on') }}
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
      - condition: template
        value_template: >
          {{ states('sensor.intranet_test')|lower != 'none' }}
  action:
    - service: counter.increment
      entity_id: counter.motion_detected_animal_ago_high_counter

## notify

- id: motion_detected_animal_ago_low_notify
  alias: motion_detected_animal_ago_low_notify
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_low
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_low','on') }}
      - condition: template
        value_template: >
          {{ states('sensor.intranet_test')|lower != 'none' and state_attr('sensor.intranet_test','date')|lower != 'none' }}
  variables:
    message: >-
      Current: {{ state_attr('sensor.motion_detected_animal','status') -}};
      average {{ states('sensor.motion_detected_animal_ago_mean') }} animal(s);
      stdev {{ state_attr('sensor.motion_detected_animal_ago_stdev_statistics') }} animal(s)
  action:
    - service: persistent_notification.create
      data_template:
        title: >-
          WARN: Animal ago low at {{ now().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z") }}
        notification_id: motion_detected_animal_ago_low
        message: >-
          {{ message }}

- id: motion_detected_animal_ago_low_dismiss
  alias: motion_detected_animal_ago_low_dismiss
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_low
  condition:
    - condition: template
      value_template: >
        {{ is_state('binary_sensor.detected_animal_ago_low','off') }}
  action:
    - service: persistent_notification.dismiss
      data_template:
        notification_id: motion_detected_animal_ago_low

- id: motion_detected_animal_ago_low_persistent
  alias: motion_detected_animal_ago_low_persistent
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_low_persistent
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_low_persistent','on') }}
      - condition: template
        value_template: >
          {{ states('sensor.intranet_test')|lower != 'none' }}
  variables:
    message: >-
      Current: {{ state_attr('sensor.motion_detected_animal','status') -}};
      average {{ states('sensor.motion_detected_animal_ago_mean') }} animal(s);
      stdev {{ state_attr('sensor.motion_detected_animal_ago_stdev_statistics') }} animal(s)
  action:
    - service: persistent_notification.create
      data_template:
        title: >-
          ALERT: Animal ago persistently low at {{ now().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z") }}
        notification_id: motion_detected_animal_ago_low
        message: >-
          {{ message }}

- id: motion_detected_animal_ago_high_notify
  alias: motion_detected_animal_ago_high_notify
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_high
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_high','on') }}
  variables:
    message: >-
      Current: {{ state_attr('sensor.motion_detected_animal','status') -}};
      average {{ states('sensor.motion_detected_animal_ago_mean') }} animal(s);
      stdev {{ state_attr('sensor.motion_detected_animal_ago_stdev_statistics') }} animal(s)
  action:
    - service: persistent_notification.create
      data_template:
        title: >-
          INFO: Animal ago high at {{ now().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z") }}
        notification_id: motion_detected_animal_ago_high
        message: >-
          {{ message }}

- id: motion_detected_animal_ago_high_dismiss
  alias: motion_detected_animal_ago_high_dismiss
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_high
  condition:
    - condition: template
      value_template: >
        {{ is_state('binary_sensor.detected_animal_ago_high','off') }}
  action:
    - service: persistent_notification.dismiss
      data_template:
        notification_id: motion_detected_animal_ago_high

- id: motion_detected_animal_ago_high_persistent
  alias: motion_detected_animal_ago_high_persistent
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_high_persistent
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_high_persistent','on') }}
  variables:
    message: >-
      Current: {{ state_attr('sensor.motion_detected_animal','status') -}};
      average {{ states('sensor.motion_detected_animal_ago_mean') }} animal(s);
      stdev {{ state_attr('sensor.motion_detected_animal_ago_stdev_statistics') }} animal(s)
  action:
    - service: persistent_notification.create
      data_template:
        title: >-
          INFO: Animal ago high at {{ now().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z") }}
        notification_id: motion_detected_animal_ago_high
        message: >-
          {{ message }}
