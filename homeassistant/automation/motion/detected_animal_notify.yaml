###
# homeassistant/automation/motion/detected_animal_notify.yaml
###

## notify

- id: motion_detected_animal_notify
  alias: motion_detected_animal_notify
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_detected_animal
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.motion_detected_animal','on') }}
      - condition: template
        value_template: >
          {{ is_state('input_boolean.motion_detected_animal_notify','on') }}
      - condition: template
        value_template: >
          {{ states('sensor.motion_detected_animal_count')|int > 0 }}
  action:
    - service: persistent_notification.create
      data_template:
        title: >-
          Detected {{ states('sensor.motion_detected_animal_count') }} animal(s)
          from {{ states('sensor.motion_detected_animal_camera') }}
        notification_id: >
          motion_detected_animal-{{- states('sensor.motion_detected_animal_camera') -}}
        message: >-
          {{ '[![]('
             + states('sensor.motion_base_url')
             + '/local/images/motion_detected_animal-'
             + states('sensor.motion_detected_animal_camera')
             + '.jpg?e='
             + states('sensor.motion_detected_animal_event_' + states('sensor.motion_detected_animal_camera'))
             + ')]('
             + states('sensor.motion_base_url')
             + '/local/images/motion_detected_animal_animated-'
             + states('sensor.motion_detected_animal_camera')
             + '.gif?e='
             + states('sensor.motion_detected_animal_event_' + states('sensor.motion_detected_animal_camera'))
             + ')' }}
          Detected {{ states('sensor.motion_detected_animal_count') }} animal(s)
          for {{ states('sensor.motion_detected_animal_elapsed') }} seconds
          at {{ states('sensor.motion_detected_animal_when') }}

- id: motion_detected_animal_notify_smartphone
  alias: motion_detected_animal_notify_smartphone
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_detected_animal
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.motion_detected_animal','on') }}
      - condition: template
        value_template: >
          {{ is_state('input_boolean.motion_detected_animal_notify','on') }}
      - condition: template
        value_template: >
          {{ states('sensor.motion_detected_animal_count')|int > 0 }}
      - condition: template
        value_template: >
          {% set s = states('input_select.motion_smartphone_name') %}
          {{ s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'all' }}
      - condition: template
        value_template: >
          {% set s = state_attr('input_select.motion_smartphone_name','options') %}
          {{ s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|length > 0 }}
  action:
    - service_template: >-
        {%- set s = states('input_select.motion_smartphone_name') -%}
        {%- if s == 'all' -%}{%- set s = 'MOTION_NOTIFY_SMARTPHONE_ALL' -%}{%- endif -%}
        {{- 'notify.mobile_app_' + s -}}
      data_template:
        title: >-
          Detected {{ states('sensor.motion_detected_animal_count') }} animal(s)
          from {{ states('sensor.motion_detected_animal_camera') }}
        message: >-
          Detected {{ states('sensor.motion_detected_animal_count') }} animal(s)
          for {{ states('sensor.motion_detected_animal_elapsed') }} seconds
          at {{ states('sensor.motion_detected_animal_when') }}
        apns_headers:
          apns-collapse-id: >-
            motion_detected_animal_{{- states('sensor.motion_detected_animal_camera') -}}_{{- states('sensor.motion_detected_animal_event') -}}

# ago low/high counters

- id: motion_detected_animal_ago_low_counter
  alias: motion_detected_animal_ago_low_counter
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_low
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_low','on') }}
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
  action:
    - service: agoer.increment
      entity_id: agoer.motion_detected_animal_ago_low_counter

- id: motion_detected_animal_ago_high_counter
  alias: motion_detected_animal_ago_high_counter
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_high
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_high','on') }}
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
      - condition: template
        value_template: >
          {{ states('sensor.intranet_test') is not none }}
  action:
    - service: agoer.increment
      entity_id: agoer.motion_detected_animal_ago_high_counter

## notify

- id: motion_detected_animal_ago_low_notify
  alias: motion_detected_animal_ago_low_notify
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_low
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_low','on') }}
      - condition: template
        value_template: >
          {{ states('sensor.intranet_test') is not none and state_attr('sensor.intranet_test','date') is not none }}
  action:
    - service: persistent_notification.create
      data_template:
        title: >
          Animal ago low at
          {{ now().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z") }}
        notification_id: motion_detected_animal_ago_low
        message: >
          Current: {{ states('sensor.motion_detected_animal_status') -}}; 
          average {{ states('sensor.motion_detected_animal_ago_mean') }} animal(s);
          stdev {{ state_attr('sensor.motion_detected_animal_ago_stdev_statistics') }} animal(s)

- id: motion_detected_animal_ago_low_dismiss
  alias: motion_detected_animal_ago_low_dismiss
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_low
  condition:
    - condition: template
      value_template: >
        {{ is_state('binary_sensor.detected_animal_ago_low','off') }}
  action:
    - service: persistent_notification.dismiss
      data_template:
        notification_id: motion_detected_animal_ago_low

- id: motion_detected_animal_ago_low_persistent
  alias: motion_detected_animal_ago_low_persistent
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_low_persistent
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_low_persistent','on') }}
      - condition: template
        value_template: >
          {{ states('sensor.intranet_test') is not none }}
  action:
    - service: persistent_notification.create
      data_template:
        title: >
          Animal ago persistently low at
          {{ now().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z") }}
        notification_id: motion_detected_animal_ago_low
        message: >-
          Current: {{ states('sensor.motion_detected_animal_status') -}}; 
          average {{ states('sensor.motion_detected_animal_ago_mean') }} animal(s);
          stdev {{ state_attr('sensor.motion_detected_animal_ago_stdev_statistics') }} animal(s)

- id: motion_detected_animal_ago_high_notify
  alias: motion_detected_animal_ago_high_notify
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_high
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_high','on') }}
  action:
    - service: persistent_notification.create
      data_template:
        title: >
          Animal ago high at
          {{ now().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z") }}
        notification_id: motion_detected_animal_ago_high
        message: >
          Current: {{ states('sensor.motion_detected_animal_status') -}}; 
          average {{ states('sensor.motion_detected_animal_ago_mean') }} animal(s);
          stdev {{ state_attr('sensor.motion_detected_animal_ago_stdev_statistics') }} animal(s)

- id: motion_detected_animal_ago_high_dismiss
  alias: motion_detected_animal_ago_high_dismiss
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_high
  condition:
    - condition: template
      value_template: >
        {{ is_state('binary_sensor.detected_animal_ago_high','off') }}
  action:
    - service: persistent_notification.dismiss
      data_template:
        notification_id: motion_detected_animal_ago_high

- id: motion_detected_animal_ago_high_persistent
  alias: motion_detected_animal_ago_high_persistent
  initial_state: !secret detected-animal-ago-notifications
  trigger:
    platform: state
    entity_id: binary_sensor.detected_animal_ago_high_persistent
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.detected_animal_ago_high_persistent','on') }}
  action:
    - service: persistent_notification.create
      data_template:
        title: >
          Animal ago high at
          {{ now().timestamp()|int|timestamp_custom("%a %b %d %I:%M %p %Z") }}
        notification_id: motion_detected_animal_ago_high
        message: >
          Current: {{ states('sensor.motion_detected_animal_status') -}}; 
          average {{ states('sensor.motion_detected_animal_ago_mean') }} animal(s);
          stdev {{ state_attr('sensor.motion_detected_animal_ago_stdev_statistics') }} animal(s)
