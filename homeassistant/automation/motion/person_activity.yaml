###
# homeassistant/automation/motion/person_activity.yaml
###

- id: motion_person_active_probability_threshold
  alias: motion_person_active_probability_threshold
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_person_active
  variables:
    threshold: >-
      {% set s = states('sensor.motion_person_active_probability_statistics_1d') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set mn = s|float %}
        {% set sd = state_attr('sensor.motion_person_active_probability_statistics_1d','standard_deviation')|float %}
        {{ ((mn + sd) + (mn - sd))/2 }}
      {% else %}
        {{ state_attr('binary_sensor.motion_person_active','probability_threshold') }}
      {% endif %}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_active
        probability_threshold: >-
          {{ threshold }}
        state: >-
          {{ states('binary_sensor.motion_person_active') }}

# detected

- id: motion_person_detected_active_probability_threshold
  alias: motion_person_detected_active_probability_threshold
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_person_detected_active
  variables:
    threshold: >-
      {% set s = states('sensor.motion_person_detected_active_probability_statistics_1d') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set mn = s|float %}
        {% set sd = state_attr('sensor.motion_person_detected_active_probability_statistics_1d','standard_deviation')|float %}
        {{ ((mn + sd) + (mn - sd))/2 }}
      {% else %}
        {{ state_attr('binary_sensor.motion_person_detected_active','probability_threshold') }}
      {% endif %}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_detected_active
        probability_threshold: >-
          {{ threshold }}
        state: >-
          {{ states('binary_sensor.motion_person_detected_active') }}

# estimated

- id: motion_person_location_estimated_active_probability_threshold
  alias: motion_person_location_estimated_active_probability_threshold
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_person_location_estimated_active
  variables:
    threshold: >-
      {% set s = states('sensor.motion_person_location_estimated_active_probability_statistics_1d') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set mn = s|float %}
        {% set sd = state_attr('sensor.motion_person_location_estimated_active_probability_statistics_1d','standard_deviation')|float %}
        {{ ((mn + sd) + (mn - sd))/2 }}
      {% else %}
        {{ state_attr('binary_sensor.motion_person_location_estimated_active','probability_threshold') }}
      {% endif %}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_location_estimated_active
        probability_threshold: >-
          {{ threshold }}
        state: >-
          {{ states('binary_sensor.motion_person_location_estimated_active') }}

# smartphone

- id: motion_person_location_active_probability_threshold
  alias: motion_person_location_active_probability_threshold
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_person_location_active
  variables:
    threshold: >-
      {% set s = states('sensor.motion_person_location_active_probability_statistics_1d') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set mn = s|float %}
        {% set sd = state_attr('sensor.motion_person_location_active_probability_statistics_1d','standard_deviation')|float %}
        {{ ((mn + sd) + (mn - sd))/2 }}
      {% else %}
        {{ state_attr('binary_sensor.motion_person_location_active','probability_threshold') }}
      {% endif %}
  action:
    - service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_location_active
        probability_threshold: >-
          {{ threshold }}
        state: >-
          {{ states('binary_sensor.motion_person_location_active') }}
