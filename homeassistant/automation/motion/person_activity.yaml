###
# homeassistant/automation/motion/person_activity.yaml
###

- id: motion_person_active_probability_threshold
  alias: motion_person_active_probability_threshold
  initial_state: on
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.motion_person_active
        - input_number.motion_person_active_probability_threshold
  variables:
    threshold: >-
      {% if 'input_number' in trigger.entity_id %}
        {{ states(trigger.entity_id) }}
      {% else %}
        {% set s = states('sensor.motion_person_active_probability_statistics_1w') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set mn = s|float %}
          {% set sd = state_attr('sensor.motion_person_active_probability_statistics_1w','standard_deviation')|float %}
          {% set d = states('input_number.motion_person_active_probability_threshold_deviation')|float %}
          {{ mn + sd * d }}
        {% else %}
          {{ state_attr('binary_sensor.motion_person_active','probability_threshold') }}
        {% endif %}
      {% endif %}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ not 'input_number' in trigger.entity_id and state_attr(trigger.entity_id,'probability_threshold')|float != threshold|float or true }}
  action:
    - alias: 'set motion_person_active.probability_threshold'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_active
        probability_threshold: >-
          {{ threshold }}
        state: >-
          {{ states('binary_sensor.motion_person_active') }}

# detected

- id: motion_person_detected_active_probability_threshold
  alias: motion_person_detected_active_probability_threshold
  initial_state: on
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.motion_person_detected_active
        - input_number.motion_person_detected_active_probability_threshold
  variables:
    threshold: >-
      {% if 'input_number' in trigger.entity_id %}
        {{ states(trigger.entity_id) }}
      {% else %}
        {% set s = states('sensor.motion_person_detected_active_probability_statistics_1w') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set mn = s|float %}
          {% set sd = state_attr('sensor.motion_person_detected_active_probability_statistics_1w','standard_deviation')|float %}
          {% set d = states('input_number.motion_person_detected_active_probability_threshold_deviation')|float %}
          {{ mn + sd * d }}
        {% else %}
          {{ state_attr('binary_sensor.motion_person_detected_active','probability_threshold') }}
        {% endif %}
      {% endif %}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ not 'input_number' in trigger.entity_id and state_attr(trigger.entity_id,'probability_threshold')|float != threshold|float or true }}
  action:
    - alias: 'set motion_person_detected_active.probability_threshold'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_detected_active
        probability_threshold: >-
          {{ threshold }}
        state: >-
          {{ states('binary_sensor.motion_person_detected_active') }}

# occupancy

- id: motion_person_occupancy_active_probability_threshold
  alias: motion_person_occupancy_active_probability_threshold
  initial_state: on
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.motion_person_occupancy_active
        - input_number.motion_person_occupancy_active_probability_threshold
  variables:
    threshold: >-
      {% if 'input_number' in trigger.entity_id %}
        {{ states(trigger.entity_id) }}
      {% else %}
        {% set s = states('sensor.motion_person_occupancy_active_probability_statistics_1w') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set mn = s|float %}
          {% set sd = state_attr('sensor.motion_person_occupancy_active_probability_statistics_1w','standard_deviation')|float %}
          {% set d = states('input_number.motion_person_occupancy_active_probability_threshold_deviation')|float %}
          {{ mn + sd * d }}
        {% else %}
          {{ state_attr('binary_sensor.motion_person_occupancy_active','probability_threshold') }}
        {% endif %}
      {% endif %}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ not 'input_number' in trigger.entity_id and state_attr(trigger.entity_id,'probability_threshold')|float != threshold|float or true }}
  action:
    - alias: 'set motion_person_occupancy_active.probability_threshold'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_occupancy_active
        probability_threshold: >-
          {{ threshold }}
        state: >-
          {{ states('binary_sensor.motion_person_occupancy_active') }}

# smartphone

- id: motion_person_location_active_probability_threshold
  alias: motion_person_location_active_probability_threshold
  initial_state: on
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.motion_person_location_active
        - input_number.motion_person_location_active_probability_threshold
  variables:
    threshold: >-
      {% if 'input_number' in trigger.entity_id %}
        {{ states(trigger.entity_id) }}
      {% else %}
        {% set s = states('sensor.motion_person_location_active_probability_statistics_1w') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set mn = s|float %}
          {% set sd = state_attr('sensor.motion_person_location_active_probability_statistics_1w','standard_deviation')|float %}
          {% set d = states('input_number.motion_person_location_active_probability_threshold_deviation')|float %}
          {{ mn + sd * d }}
        {% else %}
          {{ state_attr('binary_sensor.motion_person_location_active','probability_threshold') }}
        {% endif %}
      {% endif %}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ not 'input_number' in trigger.entity_id and state_attr(trigger.entity_id,'probability_threshold')|float != threshold|float or true }}
  action:
    - alias: 'set motion_person_location_active.probability_threshold'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_person_location_active
        probability_threshold: >-
          {{ threshold }}
        state: >-
          {{ states('binary_sensor.motion_person_location_active') }}
