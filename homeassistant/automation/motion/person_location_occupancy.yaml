###
# homeassistant/automation/motion/person_location_occupancy.yaml
###

- id: motion_person_location_occupancy_previous
  alias: motion_person_location_occupancy_previous
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_person_location_occupancy
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {% set s = states('sensor.motion_person_location_occupancy') %}
          {{ s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' }}
  variables:
    latitude: >-
      {% set s = state_attr('sensor.motion_person_location_occupancy','latitude') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {{ s }}
      {% else %}null{% endif %}
    longitude: >-
      {% set s = state_attr('sensor.motion_person_location_occupancy','longitude') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {{ s }}
      {% else %}null{% endif %}
    movement: >-
      {% set s = states('sensor.motion_person_location_occupancy_previous') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {% set s = state_attr('sensor.motion_person_location_occupancy_previous','latitude') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set plat = s|float %}
          {% set s = state_attr('sensor.motion_person_location_occupancy_previous','longitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {% set plng = s|float %}
            {% set s = state_attr('sensor.motion_person_location_occupancy','latitude') %}
            {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
              {% set clat = s|float %}
              {% set s = state_attr('sensor.motion_person_location_occupancy','longitude') %}
              {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
                {% set clng = s|float %}
                {% set d = distance(plat, plng, clat, clng) %}
                {% if d|lower != 'none' and d|lower != 'null' and d|lower != 'unknown' and d|lower != 'unavailable' and d|int is number and d|int < 40075 %}
                  {{- '%0.2f'|format(d * 1000) -}}
                {% else %}null{% endif %}
              {% else %}null{% endif %}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    interval: >-
      {% set t = state_attr('sensor.motion_person_location_occupancy_previous','timestamp') %}
      {% if t|lower != 'none' and t|lower != 'unknown' and t|lower != 'unavailable' and t|lower != 'null' and t|float is number and t|float > 0 %}
        {{ utcnow().timestamp() - t|float }}
      {% else %}null{% endif %}
    velocity: >-
      {% set d = movement %}
      {% if d|lower != 'null' and d|int is number and d|int < 40075 %}
        {% set t = interval %}
        {% if t|lower != 'null' and t|float is number and t|float > 0 %}
          {{- '%0.2f'|format(d|float/t|float) -}}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
  action:
    - alias: 'location good?'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ latitude|lower != 'null' and longitude|lower != 'null' }}
    - alias: 'set sensor.motion_person_location_occupancy_previous'
      service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_location_occupancy_previous
        latitude: >-
          {{ latitude }}
        longitude: >-
          {{ longitude }}
        movement: >-
          {{ movement }}
        interval: >-
          {{ interval }}
        velocity: >-
          {{ velocity }}
        timestamp: >-
          {{ utcnow().timestamp() }}
        distance: >-
          {{ state_attr('sensor.motion_person_location_occupancy','distance') }}
        source: >-
          {{ state_attr('sensor.motion_person_location_occupancy','source') }}
        area: >-
          {{ state_attr('sensor.motion_person_location_occupancy','area') }}
        state: >-
          {{ states('sensor.motion_person_location_occupancy') }}

- id: motion_person_location_occupancy
  alias: motion_person_location_occupancy
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_shellies_occupancy
      to: 'on'
  variables:
    location: >-
      {% set s = states('sensor.motion_person_location') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {{ s }}
      {% else %}null{% endif %}
    source: >-
      {% set s = state_attr('binary_sensor.motion_shellies_occupancy','sensor') %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {{ s }}
      {% else %}null{% endif %}
    id: >-
      {% if source|lower != 'null' %}
        {% set s = state_attr(source,'id') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ s }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    ago: >-
      {% if source|lower != 'null' %}
        {% set s = state_attr(source,'last') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ utcnow().timestamp()|int - s|int }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    duration: >-
      {% if source|lower != 'null' %}
        {% set s = state_attr(source,'duration') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ s|int }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    latitude: >-
      {% if source|lower != 'null' %}
        {% set s = state_attr(source,'latitude') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ s|float }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    longitude: >-
      {% if source|lower != 'null' %}
        {% set s = state_attr(source,'longitude') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ s|float }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    distance: >-
      {% if latitude|lower != 'null' and longitude|lower != 'null' %}
        {% set s = distance('zone.home', longitude, latitude) %}
        {% if s|lower != 'none' and s|lower != 'null' and s|lower != 'unknown' and s|lower != 'unavailable' and s|int is number and s|int < 40075 %}
          {{- '%0.2f'|format(s|float * 1000) -}}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    gps: >-
      {% if latitude|lower != 'null' and longitude|lower != 'null' %}
        {% set s = state_attr('zone.home','radius') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|int > 0 %}
          {{ latitude|lower != 'null' and longitude|lower != 'null' and distance|int < s|int }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    area: >-
      {% set s = area_name(source) %}
      {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
        {{ s }}
      {% else %}null{% endif %}
    probability: >-
      {{ state_attr('binary_sensor.motion_person_occupancy_active','probability') }}
  action:
    - alias: 'choose: notify on id or gps'
      choose:
        - alias: 'condition: id unknown or gps null?'
          conditions:
            - condition: template
              value_template: >
                {{ id|lower == 'null' or gps|lower == 'null' }}
          sequence:
            - alias: 'notify id or gps bad'
              service: persistent_notification.create
              data_template:
                title: >-
                  NOTICE: Occupancy source
                notification_id: >-
                  {{ source|string + '_person_location_occupancy' }}
                message: >-
                  Source location or id invalid; id: {{ id -}}; GPS: {{ latitude,longitude -}}; distance: {{ distance }} 
    - alias: 'location good?'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ gps|lower != 'null' }}
    - service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_location_occupancy
        location: >-
          {{ location }}
        id: >-
          {{ id }}
        source: >-
          {{ source }}
        area: >-
          {{ area }}
        ago: >-
          {{ ago }}
        latitude: >-
          {{ latitude }}
        longitude: >-
          {{ longitude  }}
        distance: >-
          {{ distance }}
        probability: >-
          {{ probability }}
        state: >-
          {{ id }}

- id: motion_person_location_occupancy_off
  alias: motion_person_location_occupancy_off
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_shellies_occupancy
      to: 'off'
  action:
    - service: python_script.set_state
      data_template:
        entity_id: sensor.motion_person_location_occupancy
        state: >-
          {{ 'none' }}
