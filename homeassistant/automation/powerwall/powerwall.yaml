###
# homeassistant/automation/motion/powerwall.yaml
###

- id: motion_powerwall_load_spike_begin
  alias: motion_powerwall_load_spike_begin
  initial_state: 'on'
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_powerwall_load_spike_problem
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_powerwall','on') }}
  action:
    - alias: 'powerwall spike begin'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ 'binary_sensor.motion_powerwall_load_spike' }}
        start: >-
          {{ utcnow().timestamp() }}
        load: >-
          {{ states('sensor.motion_powerwall_load_now') }}
        state: >-
          {{ 'on' }}

- id: motion_powerwall_load_spike_end
  alias: motion_powerwall_load_spike_end
  initial_state: 'on'
  mode: single
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_powerwall_load_spike_problem
      to: 'off'
  variables:
    load: >-
      {% set s = state_attr('binary_sensor.motion_powerwall_load_spike','load') %}
      {% if s|lower != 'none' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' %}
        {{ s|float(0.0) }}
      {% else %}None{% endif %}
    start: >-
      {% set s = state_attr('binary_sensor.motion_powerwall_load_spike','start') %}
      {% if s|lower != 'none' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' %}
        {{ s|float(0.0) }}
      {% else %}None{% endif %}
    end: >-
      {% set s = state_attr('binary_sensor.motion_powerwall_load_spike','end') %}
      {% if s|lower != 'none' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' %}
        {{ s|float(0.0) }}
      {% else %}None{% endif %}
    now: >-
      {{ utcnow().timestamp() }}
    ago: >-
      {% if end|lower != 'none' %}
        {{ '%0.2f'|format(now - end|float(0.0)) }}
      {% else %}None{% endif %}
    duration: >-
      {% if start|lower != 'none' %}
        {{ now - start|float(0.0) }}
      {% else %}None{% endif %}
    mean: >-
      {% set s = states('sensor.motion_powerwall_load_mean') %}
      {% if s|lower != 'none' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' %}
        {{ s|float(0.0) }}
      {% else %}None{% endif %}
    energy: >-
      {% if load|lower != 'none' and duration|lower != 'none' and mean|lower != 'none' %}
        {{ (load|float(0.0) - mean|float(0.0)) * duration|float(0.0) / 3600 }}
      {% else %}None{% endif %}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_powerwall','on') }}
      - condition: template
        value_template: >-
          {{ start|lower != 'none' }}
  action:
    - alias: 'powerwall spike end'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ 'binary_sensor.motion_powerwall_load_spike' }}
        end: >-
          {{ now }}
        ago: >-
          {{ ago }}
        duration: >-
          {{ duration }}
        mean: >-
          {{ mean }}
        energy: >-
          {{ energy }}
        state: >-
          {{ 'off' }}
    - condition: template
      value_template: >
        {{ states('sensor.motion_log_level') in state_attr('sensor.motion_log_level','info') }}
    - alias: 'powerwall spike notification'
      service: persistent_notification.create
      data_template:
        title: >-
          INFO: Powerwall load spike
        notification_id: >-
          {{ 'load_spike' }}
        message: >-
          Load power spiked  to {{ load }} kW; mean: {{ mean -}}; {{ start|int|timestamp_custom("%a %b %d @ %I:%M %p",true,'unknown') -}};
          duration: {{ '%0.2f'|format(duration|float(0.0)) -}}s;
          energy: {{ '%0.2f'|format(energy|float(0.0)) -}} kWh
