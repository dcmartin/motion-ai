###
# homeassistant/automation/reload.yaml
###

- id: motion_reload
  alias: motion_reload
  mode: single
  initial_state: off
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_reload
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
      - condition: template
        value_template: >
         {{ is_state('binary_sensor.motion_reload','on') }}
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_reloading','off') }}
  action:
    - alias: 'set state binary_sensor.motion_reloading: on'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_reloading
        state: 'on'
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ is_state('binary_sensor.motion_addon_update','on') }}
        sequence:
          - choose:
            - conditions:
                - condition: template
                  value_template: >
                    {{ states('input_select.motion_log_level') in ['debug','info','notice','alert'] }}
              sequence:
                - service: persistent_notification.create
                  data_template:
                    title: >-
                      ALERT: Updating add-on
                    notification_id: >-
                      {{ 'motion-addon-update' }}
                    message: >-
                      Updating add-on at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}
          - alias: 'update add-on'
            service: automation.trigger
            entity_id: automation.motion_addon_update
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ states('input_select.motion_log_level') in ['debug','info','notice','alert'] }}
        sequence:
          - service: persistent_notification.create
            data_template:
              title: >-
                ALERT: System restarting
              notification_id: >-
                {{ 'motion-reload-restart' }}
              message: >-
                System restarting in 30 seconds at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}
    - alias: 'wait 30 seconds'
      delay:
        seconds: 30
    - alias: 'restart home-assistant'
      service: homeassistant.restart

- id: motion_reloaded
  alias: motion_reloaded
  mode: single
  initial_state: on
  trigger:
    - platform: event
      event_type: homeassistant_start
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.motion_reloading','on') }}
  action:
    - alias: 'set state binary_sensor.motion_reloading: off'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_reloading
        state: 'off'
    - alias: 'set state binary_sensor.motion_reloaded: on'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_reloaded
        state: 'on'
    - alias: 'set state binary_sensor.motion_reload: off'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_reload
        state: 'off'
