###
# homeassistant/automation/reload.yaml
###

- id: motion_reload_notification
  alias: motion_reload_notification
  initial_state: on
  mode: restart
  trigger:
    - platform: state
      entity_id: sensor.motion_reload_notify
      to: 'request'
  variables:
    device_id: >-
      {% set s = state_attr('sensor.motion_person','device') %}
      {% if s|lower != 'none' %}
        {{ device_id(s) }}
      {% else %}none{% endif %}
    tracker: >-
      {% set s = state_attr('sensor.motion_person','device') %}
      {% if s|lower != 'none' %}
        {{ s|replace('device_tracker.','') }}
      {% else %}none{% endif %}
    service: >-
      {% if tracker|lower != 'none' %}
        {{ 'notify.mobile_app_' + tracker }}
      {% else %}none{% endif %}
    channel: >-
      {{ states('sensor.motion_name') }}
    id: >-
      {{ 'reload-notification' }}
    group: >-
      {{ 'system-health' }}
    interval: >-
      {{ 5 }}
    notification_icon: >-
      {% set s = state_attr('sensor.motion_name','icon') %}
      {% if s|lower != 'none' %}
        {{ s }}
      {% else %}{{ 'mdi:home-assistant' }}{% endif %}
    icon_url: >-
      {% set s = state_attr('sensor.motion_name','entity_picture') %}
      {% if s|lower != 'none' %}
        {{ s }}
      {% else %}{{ '/local/images/icon.png' }}{% endif %}
    image: >-
      {{ icon_url }}
    title: >-
      {% set s = state_attr('sensor.motion_name','title') %}
      {% if s|lower == 'none' %}
        {% set s = 'Home Assistant' %}
      {% endif %}
      {{ s -}}: alarm
    subtitle: >-
      {{- 'System restart requested' -}}
    message: >-
      The system requires a restart to process software updates.
      Press and hold this notification to select a response to approve, wait, or deny this request.
    actions: >-
      {% set s = [ 
        {'action':'reload-notification-approve','icon':'sfsymbols:hand.thumbsup','title':'Approve system restart','destructive':false},
        {'action':'reload-notification-wait','icon':'sfsymbols:timer','title':'Ask again in ' + interval|string + ' minutes','destructive':false},
        {'action':'reload-notification-deny','icon':'sfsymbols:hand.thumbsdown.fill','title':'Deny system restart','destructive':true}
        ] %}
      {{ s }}
    persistent: >-
      {{ 'true' }}
    tag: >-
      {{ 'persistent' }}
    critical: >-
      {{ 0  }}
    interruption_level: >-
      {# 'passive','active','time-sensitive','critical' #}
      {{ 'critical' }}
    volume: >-
      {{ 1.0 }}
    sound: >-
      {{ 'default' }}
    timeout: >-
      {{ interval|int * 60 }}
  action:
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ states('input_select.motion_log_level') in ['debug'] }}
        sequence:
          - alias: 'debug reload notification'
            service: persistent_notification.create
            data:
              title: >-
                DEBUG: Reload notification start
              notification_id: >-
                {{ 'debug-reload-notification' }}
              message: >-
                Reload notification start at <i>{{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}</i>
                <ul>
                <li>id: "{{ id }}"</li>
                <li>device_id: "{{ device_id }}"</li>
                <li>tracker: "{{ tracker }}"</li>
                <li>channel: "{{ channel }}"</li>
                <li>group: "{{ group }}"</li>
                <li>tag: "{{ tag }}"</li>
                <li>image: "{{ image }}"</li>
                <li>icon_url: "{{ icon_url }}"</li>
                <li>notification_icon: "{{ notification_icon }}"</li>
                <li>title: "{{ title }}"</li>
                <li>message: "{{ message }}"</li>
                <li>interval: "{{ interval }}"</li>
                <li>interruption_level: "{{ interruption_level }}"</li>
                <li>persistent: "{{ persistent }}"</li>
                <li>critical: "{{ critical }}"</li>
                <li>volume: "{{ volume }}"</li>
                <li>sound: "{{ sound }}"</li>
                <li>timeout: "{{ timeout }}"</li>
                <li>service: "{{ service }}"</li>
                <li>actions: "{{ actions|string }}"</li>
                </ul>
    - alias: 'test if notification service is defined'
      condition:
        - condition: template
          value_template: >-
            {{ service|lower != 'none' and service is string and service|length > 0 }}
    - repeat:
        sequence:
          - alias: 'send reload_notification to motion_person.device'
            service: "{{ service }}"
            data: 
              title: >-
                {{ title }}
              message: >-
               {{ message }}
              data:
                actions: >-
                  {{ actions }}
                channel: >-
                  {{ channel }}
                group: >-
                  {{ group }}
                tag: >-
                  {{ tag }}
                notification_icon: >-
                  {{ notification_icon }}
                icon_url: >-
                  {{ icon_url }}
                image: >-
                  {{ image }}
                push:
                  interruption_level: >-
                    {{ interruption_level }}
                  sound: >-
                    {{ sound }}
                  badge: >-
                    {{ 5 }}
                  persistent: >-
                    {{ persistent }}
          - wait_for_trigger:
            - platform: event
              event_type: mobile_app_notification_action
              event_data:
                action: >-
                 {# first action - approve #}
                 {{ actions[0].action }}
            - platform: event
              event_type: mobile_app_notification_action
              event_data:
                action: >-
                 {# third action - deny #}
                 {{ actions[2].action }}
            timeout:
              minutes: >-
                {{ interval }}
          - choose:
            - conditions:
                - condition: template
                  value_template: >
                    {{ states('input_select.motion_log_level') in ['debug'] }}
              sequence:
                - alias: 'debug reload notification'
                  service: persistent_notification.create
                  data_template:
                    title: >-
                      DEBUG: Reload notification timeout
                    notification_id: >-
                      {{ 'debug-reload-notification' }}
                    message: >-
                      {{ 'Reload notification timeout' }}
        until: >-
          {{ wait.remaining > 0 }}
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ states('input_select.motion_log_level') in ['debug'] }}
        sequence:
          - alias: 'debug reload notification'
            service: persistent_notification.create
            data_template:
              title: >-
                DEBUG: Reload notification
              notification_id: >-
                {{ 'debug-reload-notification' }}
              message: >-
                {{ 'Reload notification complete' }}

- id: motion_reload_notification_response
  alias: motion_reload_notification_response
  mode: queued
  initial_state: on
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "reload-notification-deny"
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "reload-notification-approve"
  variables:
    origin: >-
      {{ trigger.event.origin }}
    time_fired: >-
      {{ trigger.event.time_fired }}
    context: >-
      {{ trigger.event.context }}
    response: >-
      {{ trigger.event.data.action|default('')|replace('reload-notification-','') }}
  action:
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ states('input_select.motion_log_level') in ['debug'] }}
        sequence:
          - alias: 'notification response'
            service: persistent_notification.create
            data_template:
              title: >-
                DEBUG: Reload notification response
              notification_id: >-
                {{ 'debug-reload-notification' }}
              message: >-
                Reload notification response received: "{{ response -}}"
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ response|lower in state_attr('sensor.motion_reload_notify','states') }}
        sequence:
          - variables:
              delay: >-
                {{ state_attr('binary_sensor.motion_restarting','delay') }}
              timestamp: >-
                {{ (utcnow() + timedelta(seconds=delay))|as_timestamp }}
              when: >-
                {{ timestamp|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
          - alias: 'change state for sensor.motion_reload_notify'
            service: python_script.set_state
            data_template:
              entity_id: sensor.motion_reload_notify
              timestamp: >-
                {{ timestamp }}
              when: >-
                {{ when }}
              state: >- 
                {{ response }}

- id: motion_restart
  alias: motion_restart
  mode: single
  initial_state: on
  trigger:
    - platform: state
      entity_id: input_boolean.motion_restart
      to: 'on'
    - platform: state
      entity_id: sensor.motion_reload_notify
      to: 'approve'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
  action:
    - variables:
        delay: >-
          {{ state_attr('binary_sensor.motion_restarting','delay') }}
        timestamp: >-
          {{ (utcnow() + timedelta(seconds=delay))|as_timestamp }}
        when: >-
          {{ timestamp|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
    - alias: 'wait for delay'
      delay:
        seconds: >-
          {{ delay }}
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ states('input_select.motion_log_level') in ['debug','info','notice','alert'] }}
        sequence:
          - alias: 'notify homeassistant restart'
            service: persistent_notification.create
            data_template:
              title: >-
                ALERT: System restarting
              notification_id: >-
                {{ 'motion-reload-restart' }}
              message: >-
                System restarting at {{ when }}
    - alias: 'restart home assistant core'
      service: homeassistant.restart

- id: motion_reboot
  alias: motion_reboot
  mode: single
  initial_state: on
  trigger:
    - platform: state
      entity_id: input_boolean.motion_reboot
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
  action:
    - variables:
        delay: >-
          {{ state_attr('binary_sensor.motion_restarting','delay') }}
        timestamp: >-
          {{ (utcnow() + timedelta(seconds=delay))|as_timestamp }}
        when: >-
          {{ timestamp|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
    - alias: 'wait for delay'
      delay:
        seconds: >-
          {{ delay }}
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ states('input_select.motion_log_level') in ['debug','info','notice','alert','critical'] }}
        sequence:
          - alias: 'notify system reboot'
            service: persistent_notification.create
            data_template:
              title: >-
                CRITICAL: System rebooting
              notification_id: >-
                {{ 'motion-reboot' }}
              message: >-
                System rebooting at {{ when }}
    - alias: 'reboot host'
      service: hassio.host_reboot

- id: motion_reload
  alias: motion_reload
  mode: single
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_reload
    - platform: state
      entity_id: binary_sensor.motion_reload_enabled
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
      - alias: 'test if binary_sensor.motion_reload_enabled is on'
        condition: template
        value_template: >
         {{ is_state('binary_sensor.motion_reload_enabled','on') }}
      - alias: 'test if binary_sensor.motion_reload is on'
        condition: template
        value_template: >
         {{ is_state('binary_sensor.motion_reload','on') }}
      - alias: 'test if binary_sensor.motion_restarting is off'
        condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_restarting','off') }}
  action:
    - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ is_state('binary_sensor.motion_addon_update','on') }}
        sequence:
          - choose:
            - conditions:
                - condition: template
                  value_template: >
                    {{ states('input_select.motion_log_level') in ['debug','info','notice','alert'] }}
              sequence:
                - alias: 'notify add-on update'
                  service: persistent_notification.create
                  data_template:
                    title: >-
                      ALERT: Updating add-on
                    notification_id: >-
                      {{ 'motion-addon-update' }}
                    message: >-
                      Updating add-on at {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}
          - alias: 'update add-on'
            service: automation.trigger
            entity_id: automation.motion_addon_update
          - alias: 'wait for add-on update'
            wait_for_trigger:
              - platform: state
                entity_id: binary_sensor.motion_addon_reload
                to: 'on'
          - alias: 'dismiss add-on update'
            service: persistent_notification.dismiss
            data_template:
              notification_id: >-
                {{ 'motion-addon-update' }}
    - variables:
        delay: >-
          {{ state_attr('binary_sensor.motion_restarting','delay') }}
        timestamp: >-
          {{ (utcnow() + timedelta(seconds=delay))|as_timestamp }}
        when: >-
          {{ timestamp|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
    - alias: 'set state binary_sensor.motion_restarting: on'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_restarting
        timestamp: >-
          {{ timestamp }}
        when: >-
          {{ when }}
        state: 'on'
    - alias: 'trigger automation.motion_restart'
      service: automation.trigger
      entity_id: automation.motion_restart

- id: motion_reloaded
  alias: motion_reloaded
  mode: single
  initial_state: on
  trigger:
    - platform: event
      event_type: homeassistant_start
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ is_state('binary_sensor.motion_restarting','on') }}
  action:
    - alias: 'set state binary_sensor.motion_restarting: off'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_restarting
        state: 'off'
    - alias: 'set state binary_sensor.motion_reloaded: on'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_reloaded
        state: 'on'
    - alias: 'set state binary_sensor.motion_reload: off'
      service: python_script.set_state
      data_template:
        entity_id: binary_sensor.motion_reload
        state: 'off'
