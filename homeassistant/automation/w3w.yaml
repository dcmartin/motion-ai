###
# homeassistant/automation/w3w.yaml
###

- id: what3words_location_update
  alias: what3words_location_update
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: sensor.what3words_location
      attribute: 'apikey'
    - platform: state
      entity_id: sensor.what3words_location
      attribute: 'words'
    - platform: state
      entity_id: binary_sensor.what3words_location
      to:
        - 'off'
        - 'unknown'
      for:
        seconds: >-
          {# half the timeout #}
          {{- (state_attr('binary_sensor.what3words_location','timeout')|int(300)/2)|int(150) -}}
  condition:
    - condition: template
      value_template: >
        {% set s = state_attr('sensor.what3words_location','apikey') %}
        {{ s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' and s|string|length != 0 and s|string != 'APIKEY4U' }}
    - condition: template
      value_template: >
        {% set s = state_attr('sensor.what3words_location','words') %}
        {{ s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' and s|string|length != 0 and s|string != '///what.three.words' }}
  action:
    - alias: 'update w3w location'
      service: homeassistant.update_entity
      entity_id: 'sensor.what3words_location_rest'
