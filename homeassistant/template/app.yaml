###
# homeassistant/template/app.yaml
###

- unique_id: motion_power_status
  trigger:
    - platform: state
      entity_id: 'binary_sensor.rpi_power_status'
    - platform: time_pattern
      minutes: /1
  binary_sensor:
    - name: 'motion_power_status'
      device_class: 'problem'
      attributes:
        friendly_name: 'Power status'
        icon: >-
          {% if is_state('binary_sensor.rpi_power_status','on') %}
            {{- 'mdi:alert' -}}
          {%- else %}
            {{- 'mdi:hand-okay' -}}
          {%- endif %}
        age: >-
          {{ (now().replace(hour=0).replace(minute=0).replace(second=0) - timedelta(days=7))|as_timestamp }}
        ratio: >-
          [{{ state_attr('sensor.motion_power_status_today','ratio') }},{{ state_attr('sensor.motion_power_status_week','ratio') }}]
        time: >-
          [{{ state_attr('sensor.motion_power_status_today','time') }},{{ state_attr('sensor.motion_power_status_week','time') }}]
        count: >-
          [{{ state_attr('sensor.motion_power_status_ratio_week','total') }},{{ state_attr('sensor.motion_power_status_time_week','total') }}]
        oldest: >-
          {{- state_attr('sensor.motion_power_status_week','oldest') -}}
        today: >-
          [{{ state_attr('sensor.motion_power_status_today','ratio') }},{{ state_attr('sensor.motion_power_status_today','time') }}]
        week: >-
          [{{ state_attr('sensor.motion_power_status_week','ratio') }},{{ state_attr('sensor.motion_power_status_week','time') }}]
      state: >-
        {% set s = states('binary_sensor.rpi_power_status') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' %}
          {{ s }}
        {% else %}unknown{% endif %}
