###
## sensor/systemmonitor.yaml
###

## storage

- unique_id: motion_sysmon_disk
  trigger:
    - platform: time_pattern
      minutes: /30
  sensor:
    - name: 'motion_sysmon_disk'
      unique_id: 'motion_sysmon_disk'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      attributes:
        friendly_name: 'System Disk Monitor'
        icon: 'mdi:harddisk'
        time: >-
          {% set s = states('sensor.motion_sysmon_disk_change_second') %}
          {% if s|float(0) != 0 %}
            {% set change = s|float(0) %}
            {%- set s = states('sensor.disk_free') -%}
            {%- if s|float(-1) != -1 -%}
              {% set free = s|float(0) %}
              {% set s = free / change %}
              {{ (utcnow().timestamp() - s)|as_datetime|relative_time }}
            {% else %}Unknown{% endif %}
          {% else %}Pending{% endif %}
        used: >-
          {%- set s = states('sensor.disk_use') -%}
          {%- if s|lower != 'none' and s|float(-1) > 0 -%}
            {{ s|float }} {{ state_attr('sensor.disk_use','unit_of_measurement') }}
          {% else %}null{% endif %}
        free: >-
          {%- set s = states('sensor.disk_free') -%}
          {%- if s|lower != 'none' and s|float(-1) > 0 -%}
            {{ s|float }} {{ state_attr('sensor.disk_free','unit_of_measurement') }}
          {% else %}null{% endif %}
        total: >-
          {{ '%0.1f'|format(states('sensor.disk_free')|float(0) + states('sensor.disk_use')|float(0)) }} {{ state_attr('sensor.disk_free','unit_of_measurement') }}
        min: >-
          {{ states('sensor.motion_sysmon_disk_min')|default('null') }}
        max: >-
          {{ states('sensor.motion_sysmon_disk_max')|default('null') }}
        mean: >-
          {{ states('sensor.motion_sysmon_disk_mean')|default('null') }}
        stdev: >-
          {{ states('sensor.motion_sysmon_disk_stdev')|default('null') }}
        oldest: >-
          {{ states('sensor.motion_sysmon_disk_oldest') }}
        coverage: >-
         {{ state_attr('sensor.motion_sysmon_disk_oldest','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_sysmon_disk_oldest','buffer_usage_ratio')|float(0) * 100 }}
        relative: >-
          {%- set s = states('sensor.motion_sysmon_disk_oldest') -%}
          {%- if s|as_timestamp(0) > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}null{%- endif -%}
      state: >-
        {%- set s = states('sensor.disk_use_percent') -%}
        {%- if s|lower != 'none' and s|float(-1) > 0 -%}
          {{- s -}}
        {% else %}null{% endif %}

## load

- unique_id: motion_sysmon_load
  trigger:
    - platform: time_pattern
      seconds: /30
  sensor:
    - name: 'motion_sysmon_load'
      unique_id: 'motion_sysmon_load'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      attributes:
        friendly_name: 'System Load Monitor'
        icon: 'mdi:chip'
        1m: >-
          {%- set s = states('sensor.load_1m') -%}
          {%- if s|lower != 'none' and s|float(-1) > 0 -%}
            {{ s|float }}
          {% else %}null{% endif %}
        5m: >-
          {%- set s = states('sensor.load_5m') -%}
          {%- if s|lower != 'none' and s|float(-1) > 0 -%}
            {{ s|float }}
          {% else %}null{% endif %}
        15m: >-
          {%- set s = states('sensor.load_15m') -%}
          {%- if s|lower != 'none' and s|float(-1) > 0 -%}
            {{ s|float }}
          {% else %}null{% endif %}
        min: >-
          {{ states('sensor.motion_sysmon_load_min')|default('null') }}
        max: >-
          {{ states('sensor.motion_sysmon_load_max')|default('null') }}
        mean: >-
          {{ states('sensor.motion_sysmon_load_mean')|default('null') }}
        stdev: >-
          {{ states('sensor.motion_sysmon_load_stdev')|default('null') }}
        oldest: >-
          {{ states('sensor.motion_sysmon_load_oldest') }}
        coverage: >-
         {{ state_attr('sensor.motion_sysmon_load_oldest','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_sysmon_load_oldest','buffer_usage_ratio')|float(0) * 100 }}
        relative: >-
          {%- set s = states('sensor.motion_sysmon_load_oldest') -%}
          {%- if s|as_timestamp(0) > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}null{%- endif -%}
      state: >-
        {%- set s = states('sensor.processor_use') -%}
        {%- if s|lower != 'none' and s|float(-1) > 0 -%}
          {{- s -}}
        {% else %}null{% endif %}
