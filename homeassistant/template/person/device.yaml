###
# homeassistant/template/person/device.yaml
###

- unique_id: motion_person_device_distance_measurement
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_person_device'
      attribute: 'latitude'
    - platform: state
      entity_id: 'binary_sensor.motion_person_device'
      attribute: 'longitude'
    - platform: state
      entity_id: 'zone.home'
      attribute: 'latitude'
    - platform: state
      entity_id: 'zone.home'
      attribute: 'longitude'
  sensor:
    - name: 'motion_person_device_distance_measurement'
      state_class: 'measurement'
      device_class: 'distance'
      unit_of_measurement: 'm'
      attributes:
        latitude: >-
          {{ state_attr('binary_sensor.motion_person_device','latitude') }}
        longitude: >-
          {{ state_attr('binary_sensor.motion_person_device','longitude') }}
        timestamp: >-
          {{ utcnow().timestamp() }}
      state: >-
        {% set s = state_attr('sensor.motion_person','device') %}
        {% if s|lower != 'none' and is_state('binary_sensor.motion_person_device','on') and not is_state('zone.home','unknown') %}
          {% set s = distance('zone.home',s)|default(none) %}
          {% if s|lower != 'none' and s|float(-1) > 0 %}
            {% set distance = s|float * 1000 %}
          {% endif %}
        {% endif %}
        {% if distance is defined %}
          {{ distance }}
        {% else %}none{% endif %}

- unique_id: motion_primary_device_distance_measurement
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_primary_device'
      attribute: 'latitude'
    - platform: state
      entity_id: 'binary_sensor.motion_primary_device'
      attribute: 'longitude'
    - platform: state
      entity_id: 'zone.home'
      attribute: 'latitude'
    - platform: state
      entity_id: 'zone.home'
      attribute: 'longitude'
  sensor:
    - name: 'motion_primary_device_distance_measurement'
      state_class: 'measurement'
      device_class: 'distance'
      unit_of_measurement: 'm'
      attributes:
        latitude: >-
          {{ state_attr('binary_sensor.motion_primary_device','latitude') }}
        longitude: >-
          {{ state_attr('binary_sensor.motion_primary_device','longitude') }}
        timestamp: >-
          {{ utcnow().timestamp() }}
      state: >-
        {% set s = state_attr('sensor.motion_primary','device') %}
        {% if s|lower != 'none' and is_state('binary_sensor.motion_primary_device','on') and not is_state('zone.home','unknown') %}
          {% set d = distance('zone.home',s)|default(none) %}
          {% if d|lower != 'none' and d|float(-1) > 0 %}
            {% set distance = d|float * 1000 %}
          {% endif %}
        {% endif %}
        {% if distance is defined %}
          {{ distance }}
        {% else %}none{% endif %}
