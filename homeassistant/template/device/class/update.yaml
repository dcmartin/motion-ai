###
# homeassistant/template/device/class/update.yaml
###

- unique_id: motion_device_update_high_spike
  trigger:
    - platform: state
      entity_id: sensor.motion_device_update_1w_max
  sensor:
    - name: 'motion_device_update_high_spike'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      attributes:
        limit: >-
          {% set mean = state_attr('sensor.motion_device_update_max','mean') %}
          {% set stdev = state_attr('sensor.motion_device_update_max','stdev') %}
          {%- if mean|lower != 'none' and mean is number and stdev|lower != 'none' and stdev is number -%}
            {% set max = state_attr('sensor.motion_device_update_max','max') %}
            {% set s = mean|float(0) + stdev|float(0) * states('input_number.motion_device_update_stdev')|float(1) %}
            {%- if s > max|float(s) -%}{{ max }}{%- else -%}{{ s }}{%- endif -%}
          {%- else -%}none{%- endif -%}
        factor: >-
          {% set mean = state_attr('sensor.motion_device_update_max','mean') %}
          {% set stdev = state_attr('sensor.motion_device_update_max','stdev') %}
          {%- if mean|lower != 'none' and mean is number and stdev|lower != 'none' and stdev is number and mean|float(0) > 0 -%}
            {{ (mean|float(0) + stdev|float(0)) / mean|float(1) * 100 }}
          {%- else -%}none{%- endif -%}
        spike: >-
         {{ states.sensor.motion_device_update_max.attributes }}
      state: >-
        {{- state_attr('sensor.motion_device_update','max') -}}

- unique_id: motion_device_update_low_spike
  trigger:
    - platform: state
      entity_id: sensor.motion_device_update_1w_min
  sensor:
    - name: 'motion_device_update_low_spike'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      attributes:
        limit: >-
          {% set mean = state_attr('sensor.motion_device_update_min','mean') %}
          {% set stdev = state_attr('sensor.motion_device_update_min','stdev') %}
          {%- if mean|lower != 'none' and mean is number and stdev|lower != 'none' and stdev is number -%}
            {% set min = state_attr('sensor.motion_device_update_min','min') %}
            {% set s = mean|float(0) + stdev|float(0) * states('input_number.motion_device_update_stdev')|float(1) %}
            {%- if s < min|float(s) -%}{{ min }}{%- else -%}{{ s }}{%- endif -%}
          {%- else -%}none{%- endif -%}
        factor: >-
          {% set mean = state_attr('sensor.motion_device_update_min','mean') %}
          {% set stdev = state_attr('sensor.motion_device_update_min','stdev') %}
          {%- if mean|lower != 'none' and mean is number and stdev|lower != 'none' and stdev is number and mean|float(0) > 0 -%}
            {{ (mean|float(0) - stdev|float(0)) / mean|float(1) * 100 }}
          {%- else -%}none{%- endif -%}
        spike: >-
         {{ states.sensor.motion_device_update_min.attributes }}
      state: >-
        {{- state_attr('sensor.motion_device_update','min') -}}

- unique_id: motion_device_update_alarm
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_update_alarm_exist
  binary_sensor:
    - name: 'motion_device_update_alarm'
      device_class: problem
      attributes:
        status: >-
          {{ '{' -}}
          {%- for i in state_attr('binary_sensor.motion_device_class','alarms') -%}
            {%- if not loop.first -%},{%- endif -%}
            {{- '"' + i|string + '":"' ~ states('binary_sensor.motion_device_update_' + i) ~ '"' -}}
          {%- endfor -%}
          {{- '}' }}
        markdown: >-
          {%- for i in state_attr('binary_sensor.motion_device_class','alarms') if is_state('binary_sensor.motion_device_update_' + i|string,'on') -%}
            {%- if loop.first -%}<ul>{%- endif -%}
            {%- if states('binary_sensor.motion_device_update_' + i|string) -%}
              {%- set s = state_attr('binary_sensor.motion_device_update_' + i|string,'markdown') -%}
               <li>The update alarm is: <b>{{- i|upper -}}</b>{%- if s|lower != 'none' -%}<br>{{- s -}}</br>{%- endif -%}</li>
            {%- endif -%}
            {%- if loop.last -%}</ul>{%- endif -%}
          {%- endfor -%}
      state: >-
        {%- set s = state_attr('binary_sensor.motion_device_class','alarms') -%}
        {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
          {%- for i in s if states('binary_sensor.motion_device_update_' + i)|lower == 'on' -%}
            {%- if loop.first -%}on{%- endif -%}
          {% else %}off{%- endfor -%}
        {%- else -%}unknown{%- endif -%}

- unique_id: motion_device_update_rescan
  trigger:
    - platform: state
      entity_id: sensor.motion_domain_sensor_count
    - platform: state
      entity_id: automation.motion_device_update_rescan
      attribute: 'last_triggered'
  binary_sensor:
    - name: motion_device_update_rescan
      attributes:
        all: >-
          {%- set class = 'update' -%}
          [{%- for state in (states.sensor|list + states.binary_sensor|list)
           if 'device_class' in state.attributes and device_id(state.entity_id)|lower != 'none'
            and state.attributes.device_class==class and not '.motion_' in state.entity_id -%}
            {%- if not loop.first -%},{% endif -%}
            {%- set did = device_id(state.entity_id) -%}
            {%- set n = device_attr(did,'name_by_user') -%}
            {%- if n|lower == 'none' -%}{%- set n = device_attr(did,'name') -%}{%- endif -%}
            {% set n = n|replace('&','_')|replace(' ','_')|replace('\'','')|replace('-','_')|lower -%}
            {"id":"{{- n -}}","did":"{{- did  -}}"}
          {%- endfor -%}]
        mobile: >-
          {%- set class = 'update' -%}
          {%- set device_trackers = states.device_tracker|map(attribute='entity_id')|map('device_id')|list -%}
          [{%- for state in (states.sensor|list + states.binary_sensor|list)
           if 'device_class' in state.attributes and device_id(state.entity_id)|lower != 'none'
            and state.attributes.device_class==class and not '.motion_' in state.entity_id
            and device_id(state.entity_id) in device_trackers -%}
            {%- if not loop.first -%},{% endif -%}
            {%- set n = device_attr(device_id(state.entity_id),'name_by_user') -%}
            {%- if n|lower == 'none' -%}{%- set n = device_attr(device_id(state.entity_id),'name') -%}{%- endif -%}
            {% set n = n|replace('&','_')|replace(' ','_')|replace('\'','')|replace('-','_')|lower -%}
            "{{- n -}}"
          {%- endfor -%}]
      state: >-
        {{ states.sensor.motion_device_update_count.last_updated|as_timestamp(0) >
           states.automation.motion_device_update_rescan.attributes.last_triggered|as_timestamp(0) }}

- unique_id: motion_device_update_count
  trigger:
    - platform: state
      entity_id: sensor.motion_domain_sensor_count
      for:
        minutes: 1
    - platform: state
      entity_id: sensor.motion_domain_binary_sensor_count
      for:
        minutes: 1
  sensor:
    - name: 'motion_device_update_count'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {{ (states.sensor|list + states.binary_sensor|list)|rejectattr('entity_id','search','.motion_')|map(attribute='attributes.device_class')|select('defined')|select('==','update')|list|count }}

- unique_id: motion_device_update_alarm_exist
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_update_exist
      attribute: alarm
      to: 'on'
  binary_sensor:
    - name: motion_device_update_alarm_exist
      device_class: 'problem'
      attributes:
        friendly_name: 'Alarm exists: update'
        actions: >-
          {%- set group = 'device-update' -%}
          {%- set interval = 300 -%}
          {%- set all = [] -%}
          {#- bad -#}
          {%- set id = group|string + '-bad' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_bad','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_bad','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- good -#}
          {%- set id = group|string + '-good' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_good','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_good','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- high -#}
          {%- set id = group|string + '-high' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_high','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_high','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- low -#}
          {%- set id = group|string + '-low' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_low','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_low','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- high-spike -#}
          {%- set id = group|string + '-high_spike' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_high_spike','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_high_spike','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- low-spike -#}
          {%- set id = group|string + '-low_spike' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_low_spike','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_low_spike','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- missing -#}
          {%- set id = group|string + '-missing' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_missing','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_missing','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- unavailable -#}
          {%- set id = group|string + '-unavailable' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_unavailable','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_unavailable','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- activity -#}
          {%- set id = group|string + '-activity' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_activity','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_activity','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- found -#}
          {%- set id = group|string + '-found' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_update_found','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_update_found','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {{- all -}}
        good: >-
          {{ not is_state_attr('binary_sensor.motion_device_update_exist','good','none') and is_state('binary_sensor.motion_device_update_good','on') }}
        bad: >-
          {{ not is_state_attr('binary_sensor.motion_device_update_exist','bad','none') and is_state('binary_sensor.motion_device_update_bad','on') }}
        activity: >-
          {{ not is_state_attr('binary_sensor.motion_device_update_exist','activity','none') and is_state('binary_sensor.motion_device_update_activity','on') }}
        low: >-
          {{ not is_state_attr('binary_sensor.motion_device_update_exist','low','none') and is_state('binary_sensor.motion_device_update_low','on') }}
        high: >-
          {{ not is_state_attr('binary_sensor.motion_device_update_exist','high','none') and is_state('binary_sensor.motion_device_update_high','on') }}
        low_spike: >-
          {{ not is_state_attr('binary_sensor.motion_device_update_exist','low_spike','none') and is_state('binary_sensor.motion_device_update_low_spike','on') }}
        high_spike: >-
          {{ not is_state_attr('binary_sensor.motion_device_update_exist','high_spike','none') and is_state('binary_sensor.motion_device_update_high_spike','on') }}
        missing: >-
          {{ not is_state_attr('binary_sensor.motion_device_update_exist','required','none') and not is_state('binary_sensor.motion_device_update_missing','off') }}
        unavailable: >-
          {{ is_state('binary_sensor.motion_device_update_unavailable','on') }}
        found: >-
          {{ is_state('binary_sensor.motion_device_update_exist','on') }}
        active: >-
          {%- set s = state_attr('binary_sensor.motion_device_update_alarm','status') -%}
          {% if s|lower != 'none' and not s is string and s is iterable and s|count > 0 %}
            {%- if s.values()|reject('==','off')|list|count > 0 -%}on{%- else -%}off{%- endif -%}
          {% else %}unknown{% endif %}
        markdown: >-
          {%- set s = states('binary_sensor.motion_device_update_alarm') -%}
          <h2>The <a href="/notify-devices/update">update</a> alarm is: <i>{{- s|upper -}}</i></h2>
          {%- if s|lower == 'on' -%}
            {{- state_attr('binary_sensor.motion_device_update_alarm','markdown') -}}
          {%- endif -%}
      state: >-
        {{ is_state_attr('binary_sensor.motion_device_update_exist','alarm','on') and is_state('binary_sensor.motion_device_update_alarm','on') }}

- unique_id: motion_device_update_exist
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_update
      for:
        minutes: 1
  binary_sensor:
    - name: motion_device_update_exist
      device_class: 'running'
      attributes:
        friendly_name: Existing update sensor(s)
        unit_of_measurement: >-
          {% set s = state_attr('sensor.motion_device_update','measurement')
             |select('defined')
             |selectattr('entity_id','defined')
             |map(attribute='entity_id')
             |map('state_attr','unit_of_measurement')|reject('none')|sort|unique|list %}
          {% if s is iterable and s|count > 0 %}{{ s|first }}{% else %}none{% endif %}
        good: >-
          {% set g = state_attr('binary_sensor.motion_device_class','good') -%}
          {%- set b = state_attr('binary_sensor.motion_device_class','bad') -%}
          {%- if g|lower != 'none' and b|lower != 'none' -%}
            {%- if 'update' in g -%}on{%- elif 'update' in b -%}off{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        bad: >-
          {% set g = state_attr('binary_sensor.motion_device_class','good') -%}
          {%- set b = state_attr('binary_sensor.motion_device_class','bad') -%}
          {%- if g|lower != 'none' and b|lower != 'none' -%}
            {%- if 'update' in b -%}on{%- elif 'update' in g -%}off{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        alarm: >-
          {% set s = state_attr('binary_sensor.motion_device_class','alarm') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        activity: >-
          {% set s = state_attr('binary_sensor.motion_device_class','activity') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        required: >-
          {% set s = state_attr('binary_sensor.motion_device_class','sensors') -%}
          {% set b = state_attr('binary_sensor.motion_device_class','binary_sensors') -%}
          {%- if s|lower != 'none' and b|lower != 'none' -%}
            {% set required = (s|list + b|list)|sort|unique %}
            {%- if 'update' in required -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        low: >-
          {% set s = state_attr('binary_sensor.motion_device_class','low') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}
              {{ states('input_number.motion_device_update_low') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        high: >-
          {% set s = state_attr('binary_sensor.motion_device_class','high') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}
              {{ states('input_number.motion_device_update_high') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        low_spike: >-
          {% set s = state_attr('binary_sensor.motion_device_class','low_spike') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}
              {%- set s = state_attr('sensor.motion_device_update_low_spike','limit') -%}
              {%- if s|lower != 'none' and s is number -%}
                {{ '%0.2f'|format(s) }}
              {%- else -%}none{%- endif -%}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        high_spike: >-
          {% set s = state_attr('binary_sensor.motion_device_class','high_spike') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}
              {%- set s = state_attr('sensor.motion_device_update_high_spike','limit') -%}
              {%- if s|lower != 'none' and s is number -%}
                {{ '%0.2f'|format(s) }}
              {%- else -%}none{%- endif -%}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        measurement: >-
          {% set s = state_attr('binary_sensor.motion_device_class','sensor_list') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        status: >-
          {% set s = state_attr('binary_sensor.motion_device_class','binary_sensor_list') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        markdown: >-
          {% set c = 'update' -%}
          {%- set alarms = ['required','alarm'] -%}
          <h1>{{ c|upper }}</h1>
          {%- set s = state_attr('binary_sensor.motion_device_class','alarms') -%}
          {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            {%- set alarms = alarms + s|sort|unique|list -%}
          {%- endif -%}
          {%- for i in alarms if state_attr('binary_sensor.motion_device_update_exist',i)|lower != 'none' -%}
            {%- if loop.first -%}<ul>{%- endif -%}
            <li>{{- i|upper -}}: {{ state_attr('binary_sensor.motion_device_update_exist',i) -}}</li>
            {%- if loop.last -%}</ul>{%- endif -%}
          {%- endfor -%}
          {%- set s = state_attr('binary_sensor.motion_device_update_status','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_update_measurement','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_update_statistics','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_update_controls','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_update_activity','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_update_unavailable','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
      state: >-
        {% set s = state_attr('binary_sensor.motion_device_update','total') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s|int(0) > 0 }}
        {% else %}unknown{% endif %}
