###
# homeassistant/template/device/class/class_activity.yaml
###

- unique_id: motion_device_class_activity_detect
  trigger:
    - platform: time_pattern
      minutes: /1
    - platform: state
      entity_id: 'binary_sensor.motion_device_class'
      attribute: 'categorys'
      for:
        minutes: 1
    - platform: state
      entity_id: 'group.motion_device_class_activity'
      to:
        - 'on'
        - 'off'
  binary_sensor:
    - name: 'motion_device_class_activity_detect'
      friendly_name: 'Activity detected from devices'
      attributes:
        status: >-
          {# activity is direct from device sensors; not indirect through category as is unavailable #}
          {%- set s = state_attr('group.motion_device_class_activity','entity_id') -%}
          [{%- for j in s if states(j)|lower == 'on' -%}
            {%- set did = device_id(j) -%}
            {%- set id = device_attr(did,'name_by_user') -%}{%- if id|lower == 'none' -%}{%- set id = device_attr(did,'name') -%}{%- endif -%}
            {% set id = id|replace('&','_')|replace(' ','_')|replace('\'','')|replace('-','_')|lower -%}
            {"did":"{{- did -}}","id":"{{- id -}}","entity_id":"{{- j -}}","state":"{{- states(j) -}}","class":"{{- state_attr(j,'device_class') -}}","updated":{{- (states[j].last_updated)|as_timestamp(0) -}},"when":"{{- (states[j].last_updated)|as_timestamp|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') -}}"}
            {%- if not loop.last -%},{%- endif -%}
          {%- endfor -%}]
        markdown: >-
          {%- set s = state_attr('group.motion_device_class_activity','entity_id') -%}
          {%- if s|lower != 'none' and s is iterable and s|count > 0 %}
            {%- set categorys = s|map('state_attr','device_class')|reject('none')|sort|unique|list %}
            {%- for i in categorys if is_state_attr('binary_sensor.motion_device_' + i + '_exist','activity','on') and states('group.motion_device_' + i)|lower == 'on' and state_attr('group.motion_device_' + i,'entity_id')|lower != 'none' -%}
              {%- if loop.first -%}{{- '<h2>Activity</h2>' -}}{%- endif -%}
              {%- set l = loop %}
              {%- for j in state_attr('group.motion_device_' + i,'entity_id') if states(j)|lower == 'on' -%}
                {%- set lo = loop %}
                {%- for k in state_attr('group.motion_device_' + i,'entity_id')|map('device_id')|reject('none')|sort|unique if device_id(j) == k -%}
                  {%- set did = device_id(j) -%}
                  {%- if lo.first -%}{{- '<ul>' -}}{%- endif -%}
                  {%- if loop.first -%}<li><a href="/config/devices/device/{{- did -}}">{{- device_attr(did,'name') -}}</a> in <a href="/config/areas/area/{{- area_id(j) -}}">{{- area_id(j) -}}</a></li>{%- endif -%}
                  {%- if loop.first -%}<ul>{%- endif -%}
                  {{- '<li>' -}}
                  <code>{{ i -}}</code>: <i>{{- state_attr(j,'friendly_name') -}}</i> at {{ states[j].last_updated|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
                  {{- '</li>' -}}
                  {%- if loop.last -%}</ul>{%- endif -%}
                  {%- if lo.last -%}{{- '</ul>' -}}{%- endif -%}
                {%- endfor -%}
              {%- endfor -%}
            {%- else -%}<h2>No activity; sensors: {{ state_attr('group.motion_device_class_activity','entity_id')|count }}</h2>{%- endfor -%}
          {%- else -%}<h2>No sensors monitoring activity</h2>{%- endif -%}
          <br><b>Alarms enabled</b>: <code>{{- state_attr('binary_sensor.motion_device_class_activity_exist','alarm')|lower == 'on' }}</code>
          <br><i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
      state: >-
        {{ states('group.motion_device_class_activity')|lower == 'on' }}

- unique_id: motion_device_class_activity_inactive_on
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_class_activity
      from: 'on'
      to: 'off'
      for:
        hours: >-
          {{ states('input_number.motion_device_class_activity_high')|int(4) }}
  binary_sensor:
    - name: 'motion_device_class_activity_inactive'
      friendly_name: 'Activity inactive'
      attributes:
        hours: >-
          {{ states('input_number.motion_device_class_activity_high')|int(4) }}
        markdown: >-
          There has been no activity detected for the past {{ states('input_number.motion_device_class_activity_high')|int(4) }} hours.
          {%- set id = state_attr('binary_sensor.motion_device_class_inactivity','id') -%}
          {%- set timestamp = state_attr('binary_sensor.motion_device_class_inactivity','timestamp') -%}
          {%- if id|lower != 'none' and timestamp|int(0) > 0 -%}
            {%- set ago = timestamp|as_datetime|relative_time -%}
            <ul><li>Last activity detected {{ ago }} ago by sensor <b>{{- id -}}</b></li></ul>
          {%- else -%}
            <b>No prior activity</b><p>
          {%- endif -%}
          <i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
      state: >-
        {{- 'on' -}}

#- unique_id: motion_device_class_activity_inactive_off
#  trigger:
#    - platform: state
#      entity_id: binary_sensor.motion_device_class_activity
#      to: 'on'
#  binary_sensor:
#    - name: 'motion_device_class_activity_inactive'
#      friendly_name: 'Activity inactive'
#      attributes:
#        id: >-
#          {% set id = none %}
#          {% set s = state_attr('binary_sensor.motion_device_class_activity','status')|sort(attribute='updated',reverse=true)|list %}
#          {% if s|lower != 'none' and s|lower != 'null' and not s is string and s is iterable and s|count > 0 %}
#            {% set id = s|map(attribute='id')|first  %}
#          {%- endif %}
#          {{ id }}
#        timestamp: >-
#          {% set timestamp = none %}
#          {% set s = state_attr('binary_sensor.motion_device_class_activity','status')|sort(attribute='updated',reverse=true)|list %}
#          {% if s|lower != 'none' and s|lower != 'null' and not s is string and s is iterable and s|count > 0 %}
#            {% set timestamp = s|map(attribute='updated')|first  %}
#          {%- endif %}
#          {{ timestamp }}
#      state: >-
#        {{- 'off' -}}

- unique_id: motion_device_class_activity_alarm
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_device_class_activity_alarm_exist
  binary_sensor:
    - name: 'motion_device_class_activity_alarm'
      friendly_name: 'Activity alarm'
      device_class: problem
      attributes:
        status: >-
          {{ '{' -}}
          {%- for i in state_attr('binary_sensor.motion_device_class','activity') -%}
            {%- if not loop.first -%},{%- endif -%}
            {{- '"' + i|string + '":"' ~ states('binary_sensor.motion_device_' + i + '_activity') ~ '"' -}}
          {%- endfor -%}
          {{- '}' }}
        markdown: >-
          {%- for i in state_attr('binary_sensor.motion_device_class','activity') if is_state('binary_sensor.motion_device_' + i + '_activity','on') -%}
            {%- if loop.first -%}<ul>{%- endif -%}
            {%- if states('binary_sensor.motion_device_' + i + '_activity') -%}
              {%- set s = state_attr('binary_sensor.motion_device_' + i + 'activity','markdown') -%}
               <li>The activity alarm is: <b>{{- i|upper -}}</b>{%- if s|lower != 'none' -%}<br>{{- s -}}</br>{%- endif -%}</li>
            {%- endif -%}
            {%- if loop.last -%}</ul>{%- endif -%}
          {%- endfor -%}
      state: >-
        {%- set s = state_attr('binary_sensor.motion_device_class','activity') -%}
        {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
          {%- for i in s if states('binary_sensor.motion_device_' + i + '_activity')|lower == 'on' -%}
            {%- if loop.first -%}on{%- endif -%}
          {% else %}off{%- endfor -%}
        {%- else -%}unknown{%- endif -%}
