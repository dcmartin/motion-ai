###
# homeassistant/template/device/class/precipitation.yaml
###

- unique_id: motion_device_precipitation_exist
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_class'
      for:
        minutes: 1
    - platform: state
      entity_id: 'group.motion_device_precipitation'
      attribute: 'entity_id'
      for:
        seconds: 15
    - platform: state
      entity_id: 'sensor.motion_device_precipitation_low_spike'
      attribute: 'limit'
    - platform: state
      entity_id: 'sensor.motion_device_precipitation_high_spike'
      attribute: 'limit'
    - platform: state
      entity_id: 'input_number.motion_device_precipitation_low'
    - platform: state
      entity_id: 'input_number.motion_device_precipitation_high'
  binary_sensor:
    - name: 'motion_device_precipitation_exist'
      device_class: 'running'
      attributes:
        friendly_name: 'Existing precipitation'
        unit: >-
          {% set unit = state_attr('binary_sensor.motion_device_precipitation','unit') -%}
          {{ unit }}
        good: >-
          {% set g = state_attr('binary_sensor.motion_device_class','good') -%}
          {%- set b = state_attr('binary_sensor.motion_device_class','bad') -%}
          {%- if g|lower != 'none' and b|lower != 'none' -%}
            {%- if 'precipitation' in g -%}on{%- elif 'precipitation' in b -%}off{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        bad: >-
          {% set g = state_attr('binary_sensor.motion_device_class','good') -%}
          {%- set b = state_attr('binary_sensor.motion_device_class','bad') -%}
          {%- if g|lower != 'none' and b|lower != 'none' -%}
            {%- if 'precipitation' in b -%}on{%- elif 'precipitation' in g -%}off{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        alarm: >-
          {% set s = state_attr('binary_sensor.motion_device_class','alarm') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        unavailable: >-
          {% set s = state_attr('binary_sensor.motion_device_class','automations') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        activity: >-
          {% set s = state_attr('binary_sensor.motion_device_class','activity') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        required: >-
          {% set s = state_attr('binary_sensor.motion_device_class','sensors') -%}
          {% set b = state_attr('binary_sensor.motion_device_class','binary_sensors') -%}
          {%- if s|lower != 'none' and b|lower != 'none' -%}
            {% set required = (s|list + b|list)|sort|unique %}
            {%- if 'precipitation' in required -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        low: >-
          {% set s = state_attr('binary_sensor.motion_device_class','low') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}
              {{ states('input_number.motion_device_precipitation_low') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        high: >-
          {% set s = state_attr('binary_sensor.motion_device_class','high') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}
              {{ states('input_number.motion_device_precipitation_high') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        low_spike: >-
          {% set s = state_attr('sensor.motion_device_class','low_spike') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}
              {%- set s = state_attr('sensor.motion_device_precipitation_low_spike','limit') -%}
              {%- if s|lower != 'none' and s is number -%}
                {{ '%0.2f'|format(s) }}
              {%- else -%}none{%- endif -%}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        high_spike: >- 
          {% set s = state_attr('sensor.motion_device_class','high_spike') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}
              {%- set s = state_attr('sensor.motion_device_precipitation_high_spike','limit') -%}
              {%- if s|lower!= 'none' and s is number -%}
                {{ '%0.2f'|format(s) }} 
              {%- else -%}none{%- endif -%}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        measurement: >-
          {% set s = state_attr('binary_sensor.motion_device_class','sensor_list') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        status: >-
          {% set s = state_attr('binary_sensor.motion_device_class','binary_sensor_list') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'precipitation' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        markdown: >-
          {% set c = 'precipitation' -%}
          {%- set alarms = ['required','alarm'] -%}
          <h1>{{ c|upper }}</h1>
          {%- set s = state_attr('binary_sensor.motion_device_class','alarms') -%}
          {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            {%- set alarms = alarms + s|sort|unique|list -%}
          {%- endif -%}
          {%- for i in alarms if state_attr('binary_sensor.motion_device_precipitation_exist',i)|lower != 'none' -%}
            {%- if loop.first -%}<ul>{%- endif -%}
            <li>{{- i|upper -}}: {{ state_attr('binary_sensor.motion_device_precipitation_exist',i) -}}</li>
            {%- if loop.last -%}</ul>{%- endif -%}
          {%- endfor -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation_status','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation_measurement','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation_statistics','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation_controls','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation_activity','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation_unavailable','markdown') -%} {%- if s|lower != 'none' -%}{{- s -}}{%- endif -%}
      state: >-
        {%- set s = state_attr('group.motion_device_precipitation','entity_id') -%}
        {%- if s|lower != 'none' and s is iterable and s|count > 0 -%}on{%- else -%}off{%- endif -%}

- unique_id: motion_device_precipitation_unavailable
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_precipitation'
      attribute: 'unavailable'
    - platform: state
      entity_id: 'group.motion_device_precipitation'
      attribute: 'entity_id'
  binary_sensor:
    - name: 'motion_device_precipitation_unavailable'
      device_class: 'problem'
      attributes:
        friendly_name: 'Unavailable precipitation'
        markdown: >-
          {%- set class = 'precipitation' -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation','unavailable') -%}
          {%- if s|lower != 'none' and s is iterable and s|count > 0 %}
            {%- set s = s|selectattr('entity_id','defined')|map(attribute='entity_id')|list -%}
            {%- set categorys = s|map('state_attr','device_class')|sort|unique|list -%}
            {%- for i in categorys -%}
              {%- if loop.first -%}{{- '<h2>Unavailable</h2>' -}}{%- endif -%}
              {%- set l = loop -%}
              {%- for j in state_attr('group.motion_device_' + i,'entity_id') if states(j)|lower in ['unavailable','unknown'] -%}
                {%- set lo = loop %}
                {%- for k in state_attr('group.motion_device_' + i,'entity_id')|map('device_id')|reject('none')|sort|unique if device_id(j) == k -%}
                  {%- set did = device_id(j) -%}
                  {%- if lo.first -%}{{- '<ul>' -}}{%- endif -%}
                  {%- if loop.first -%}<li><a href="/config/devices/device/{{- did -}}">{{- device_attr(did,'name') -}}</a> in <a href="/config/areas/area/{{- area_id(j) -}}">{{- area_id(j) -}}</a></li>{%- endif -%}
                  {%- if loop.first -%}{{- '<ul>' -}}{%- endif -%}
                  {{- '<li><i>' -}}
                  {{ i -}}: {{ state_attr(j,'friendly_name') }} at {{ states[j].last_updated|as_timestamp(0)|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
                  {{- '</i></li>' -}}
                  {%- if loop.last -%}{{- '</ul>' -}}{%- endif -%}
                  {%- if lo.last -%}{{- '</ul>' -}}{%- endif -%}
                {%- endfor -%}
              {%- endfor -%}
            {%- else -%}<h2>No {{ class }} unavailable; sensors: {{ state_attr('group.motion_device_' + class,'entity_id')|count }}</h2>{%- endfor -%}
          {%- elif state_attr('group.motion_device_class_unavailable','entity_id')|count > 0 -%}
             <h2>Nothing unavailable; sensors: {{ state_attr('group.motion_device_' + class,'entity_id')|count -}}</h2>
          {%- else -%}<h2>No unavailability</h2>{%- endif -%}
          <br><b>Alarms enabled</b>: <code>{{- state_attr('binary_sensor.motion_device_' + class + '_exist','unavailable')|lower == 'on' }}</code>
          <br><i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
        status: >-
          {{ state_attr('binary_sensor.motion_device_precipitation','unavailable') }}
        ids: >-
          {%- set class = 'precipitation' -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation','unavailable') -%}
          [{%- for i in s if i is iterable and 'entity_id' in i -%}
            {%- if not loop.first -%},{%- endif -%}
            "{{- state_attr(i.entity_id,'friendly_name') -}}"
          {%- endfor -%}]
        details: >-
          {%- set class = 'precipitation' -%}
          {%- set s = state_attr('binary_sensor.motion_device_precipitation','unavailable') -%}
          {%- for i in s if i is iterable and 'entity_id' in i -%}
            {%- if not loop.first -%},{%- else -%}{{- '{' -}}{%- endif -%}
            "{{- state_attr(i.entity_id,'friendly_name') -}}":"{{- states[i.entity_id].last_updated|relative_time -}}"
            {%- if loop.last -%}{{- '}' -}}{%- endif -%}
          {%- endfor -%}
        past: >-
          {%- set class = 'precipitation' -%}
          {%- set status = state_attr('binary_sensor.motion_device_precipitation','unavailable') -%}
          {%- if status|lower != 'none' and status is iterable and status|count > 0 -%}
            {{- state_attr('binary_sensor.motion_device_' + class + '_unavailable','status') -}}
          {%- else -%}{{- state_attr('binary_sensor.motion_device_' + class + '_unavailable','past') -}}{%- endif %}
        last: >-
          {%- set class = 'precipitation' -%}
          {%- set status = state_attr('binary_sensor.motion_device_precipitation','unavailable') -%}
          {% if status|lower != 'none' and status is iterable and status|count > 0 %}
            {{ utcnow().timestamp() }}
          {%- else -%}{{ state_attr('binary_sensor.motion_device_' + class + '_unavailable','last') }}{%- endif %}
        actions: >-
          {%- set actions = none -%}
          {%- set s = state_attr('binary_sensor.motion_device_class_unavailable_exist','actions') -%}
          {%- if s|lower != 'none' and 'actions' in s -%}
            {%- set actions = s.actions -%}
          {%- endif -%}
          {{- actions -}}
        responses: >-
          {%- set responses = none -%}
          {%- set s = state_attr('binary_sensor.motion_device_class_unavailable_exist','actions') -%}
          {%- if s|lower != 'none' and 'responses' in s -%}
            {%- set responses = s.responses -%}
          {%- endif -%}
          {{- responses -}}
        approve: >-
          {%- set actions = state_attr('binary_sensor.motion_device_class_unavailable_exist','actions') -%}
          {%- if actions|lower != 'none' and 'approve' in actions -%}
          {{ actions.approve }}
          {%- else -%}none{%- endif -%}
        deny: >-
          {%- set actions = state_attr('binary_sensor.motion_device_class_unavailable_exist','actions') -%}
          {%- if actions|lower != 'none' and 'deny' in actions -%}
          {{ actions.deny }}
          {%- else -%}none{%- endif -%}
        wait: >-
          {%- set actions = state_attr('binary_sensor.motion_device_class_unavailable_exist','actions') -%}
          {%- if actions|lower != 'none' and 'wait' in actions -%}
          {{ actions.wait }}
          {%- else -%}none{%- endif -%}
        help: >-
          {%- set actions = state_attr('binary_sensor.motion_device_class_unavailable_exist','actions') -%}
          {%- if actions|lower != 'none' and 'help' in actions -%}
          {{ actions.help }}
          {%- else -%}none{%- endif -%}
      state: >-
        {%- set s = state_attr('binary_sensor.motion_device_precipitation','unavailable') -%}
        {{- s|lower != 'none' and s is iterable and s|count > 0 -}}

- unique_id: motion_device_precipitation_activity
  trigger:
    - platform: state
      entity_id: 'group.motion_device_precipitation'
      attribute: 'entity_id'
    - platform: state
      entity_id: group.motion_device_precipitation
      to:
        - 'on'
        - 'off'
  binary_sensor:
    - name: 'motion_device_precipitation_activity'
      device_class: 'occupancy'
      attributes:
        friendly_name: 'Activity precipitation'
        markdown: >-
          {%- set class = 'precipitation' -%}
          {%- if is_state_attr('binary_sensor.motion_device_' + class + '_exist','activity','on') and states('group.motion_device_' + class)|lower == 'on' and state_attr('group.motion_device_' + class,'entity_id')|lower != 'none' -%}
            {%- set s = state_attr('group.motion_device_' + class,'entity_id') -%}
            {%- if s|lower != 'none' and s is iterable and s|count > 0 %}
              {%- set categorys = s|map('state_attr','device_class')|sort|unique|list %}
              {%- for i in categorys if is_state_attr('binary_sensor.motion_device_' + i + '_exist','activity','on') and states('group.motion_device_' + i)|lower == 'on' and state_attr('group.motion_device_' + i,'entity_id')|lower != 'none' -%}
                {%- if loop.first -%}{{- '<h2>Activity</h2>' -}}{%- endif -%}
                {%- set l = loop %}
                {%- for j in state_attr('group.motion_device_' + i,'entity_id') if states(j)|lower == 'on' -%}
                  {%- set lo = loop %}
                  {%- for k in state_attr('group.motion_device_' + i,'entity_id')|map('device_id')|reject('none')|sort|unique if device_id(j) == k -%}
                    {%- set did = device_id(j) -%}
                    {%- if lo.first -%}{{- '<ul>' -}}{%- endif -%}
                    {%- if loop.first -%}<li><a href="/config/devices/device/{{- did -}}">{{- device_attr(did,'name') -}}</a> in <a href="/config/areas/area/{{- area_id(j) -}}">{{- area_id(j) -}}</a></li>{%- endif -%}
                    {%- if loop.first -%}<ul>{%- endif -%}
                    {{- '<li><i>' -}}
                    {{ i -}}: {{ state_attr(j,'friendly_name') }} at {{ states[j].last_updated|as_timestamp(0)|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
                    {{- '</i></li>' -}}
                    {%- if loop.last -%}</ul>{%- endif -%}
                    {%- if lo.last -%}{{- '</ul>' -}}{%- endif -%}
                  {%- endfor -%}
                {%- endfor -%}
              {%- else -%}<h2>No {{ class }} activity; sensors: {{ state_attr('group.motion_device_' + class,'entity_id')|count }}</h2>{%- endfor -%}
            {%- else -%}
               <h2>Nothing active; sensors: {{ state_attr('group.motion_device_' + class,'entity_id')|count -}}</h2>
            {%- endif -%}
            <br><b>Alarms enabled</b>: <code>{{- state_attr('binary_sensor.motion_device_' + class + '_exist','activity')|lower == 'on' }}</code>
            <br><i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
          {%- else -%}<h2>No activity</h2>{%- endif -%}
        status: >-
          {%- set class = 'precipitation' -%}
          {%- set s = state_attr('binary_sensor.motion_device_' + class|string + '_exist','activity') -%}
          {%- if s|lower != 'none' -%}
            {%- set activity = s|string -%}
            {%- set s = state_attr('group.motion_device_' + class|string,'entity_id') -%}
            [{%- for i in s if is_state(i,activity) -%}
              {%- if not loop.first -%},{%- endif -%}
              {%- set did = device_id(i) -%}
              {%- set id = device_attr(did,'name_by_user') -%}{%- if id|lower == 'none' -%}{%- set id = device_attr(did,'name') -%}{%- endif -%}
              {%- set id = id|replace('&','_')|replace(' ','_')|replace('\'','')|replace('-','_')|lower -%}
              {"did":"{{- did -}}","id":"{{- id -}}","entity_id":"{{- i -}}","state":"{{- states(i) -}}","updated":{{- states[i].last_updated|as_timestamp(None) -}}}
            {%- endfor -%}]
          {%- else -%}none{%- endif -%}
        details: >-
          {%- set class = 'precipitation' -%}
          {%- set s = state_attr('binary_sensor.motion_device_' + class|string + '_exist','activity') -%}
          {%- if s|lower != 'none' -%}
            {%- set activity = s|string -%}
            {%- set s = state_attr('group.motion_device_' + class|string,'entity_id') -%}
            [{%- for i in s if is_state(i,activity) -%}
              {%- if not loop.first -%},{%- else -%}{{- '{' -}}{%- endif -%}
              "{{- state_attr(i,'friendly_name') -}}": "{{- states(i) -}}"
              {%- if loop.last -%}{{- '}' -}}{%- endif -%}
            {%- endfor -%}]
          {%- else -%}none{%- endif -%}
        past: >-
          {%- set class = 'precipitation' -%}
          {% if states('group.motion_device_' + class)|lower == 'on' %}
            {{ state_attr('binary_sensor.motion_device_' + class + '_activity','status') }}
          {%- else -%}{{ state_attr('binary_sensor.motion_device_' + class + '_activity','past') }}{%- endif %}
        last: >-
          {%- set class = 'precipitation' -%}
          {% if states('group.motion_device_' + class)|lower != 'on' %}
            {{ state_attr('binary_sensor.motion_device_' + class + '_activity','last') }}
          {%- else -%}{{ utcnow().timestamp() }}{%- endif %}
        actions: >-
          {%- set actions = none -%}
          {%- set s = state_attr('binary_sensor.motion_device_class_activity_exist','actions') -%}
          {%- if s|lower != 'none' and 'actions' in s -%}
            {%- set actions = s.actions -%}
          {%- endif -%}
          {{- actions -}}
        responses: >-
          {%- set responses = none -%}
          {%- set s = state_attr('binary_sensor.motion_device_class_activity_exist','actions') -%}
          {%- if s|lower != 'none' and 'responses' in s -%}
            {%- set responses = s.responses -%}
          {%- endif -%}
          {{- responses -}}
        approve: >-
          {%- set actions = state_attr('binary_sensor.motion_device_class_activity_exist','actions') -%}
          {%- if actions|lower != 'none' and 'approve' in actions -%}
          {{ actions.approve }}
          {%- else -%}none{%- endif -%}
        deny: >-
          {%- set actions = state_attr('binary_sensor.motion_device_class_activity_exist','actions') -%}
          {%- if actions|lower != 'none' and 'deny' in actions -%}
          {{ actions.deny }}
          {%- else -%}none{%- endif -%}
        wait: >-
          {%- set actions = state_attr('binary_sensor.motion_device_class_activity_exist','actions') -%}
          {%- if actions|lower != 'none' and 'wait' in actions -%}
          {{ actions.wait }}
          {%- else -%}none{%- endif -%}
        help: >-
          {%- set actions = state_attr('binary_sensor.motion_device_class_activity_exist','actions') -%}
          {%- if actions|lower != 'none' and 'help' in actions -%}
          {{ actions.help }}
          {%- else -%}none{%- endif -%}
      state: >-
        {%- set class = 'precipitation' -%}
        {% set s = state_attr('binary_sensor.motion_device_class','activity') -%}
        {%- if s|lower != 'none' and s is iterable and class in s -%}
          {%- set s = state_attr('binary_sensor.motion_device_' + class + '_exist','activity') -%}
          {%- if s|lower != 'none' -%}
            {{ states('group.motion_device_' + class)|lower == 'on' }}
          {%- else -%}unknown{%- endif -%}
        {%- else -%}unknown{%- endif -%}

- unique_id: motion_device_precipitation_high_spike_template
  trigger:
    - platform: state
      entity_id: sensor.motion_device_precipitation_1w_max
      for:
        seconds: 30
  sensor:
    - name: 'motion_device_precipitation_high_spike'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      attributes:
        friendly_name: 'High spike precipitation'
        limit: >-
          {% set mean = state_attr('sensor.motion_device_precipitation_max','mean') %}
          {% set stdev = state_attr('sensor.motion_device_precipitation_max','stdev') %}
          {%- if mean|lower != 'none' and mean is number and stdev|lower != 'none' and stdev is number -%}
            {% set max = state_attr('sensor.motion_device_precipitation_max','max') %}
            {% set s = mean|float(0) + stdev|float(0) * states('input_number.motion_device_precipitation_stdev')|float(1) %}
            {%- if s > max|float(s) -%}{{ max }}{%- else -%}{{ s }}{%- endif -%}
          {%- else -%}none{%- endif -%}
        factor: >-
          {% set mean = state_attr('sensor.motion_device_precipitation_max','mean') %}
          {% set stdev = state_attr('sensor.motion_device_precipitation_max','stdev') %}
          {%- if mean|lower != 'none' and mean is number and stdev|lower != 'none' and stdev is number and mean|float(0) > 0 -%}
            {{ (mean|float(0) + stdev|float(0)) / mean|float(1) * 100 }}
          {%- else -%}none{%- endif -%}
        spike: >-
         {{ states.sensor.motion_device_precipitation_max.attributes }}
      state: >-
        {{- state_attr('sensor.motion_device_precipitation','max') -}}

- unique_id: motion_device_precipitation_low_spike_template
  trigger:
    - platform: state
      entity_id: sensor.motion_device_precipitation_1w_min
      for:
        seconds: 30
  sensor:
    - name: 'motion_device_precipitation_low_spike'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      attributes:
        friendly_name: 'Low spike Temperature'
        limit: >-
          {% set mean = state_attr('sensor.motion_device_precipitation_min','mean') %}
          {% set stdev = state_attr('sensor.motion_device_precipitation_min','stdev') %}
          {%- if mean|lower != 'none' and mean is number and stdev|lower != 'none' and stdev is number -%}
            {% set min = state_attr('sensor.motion_device_precipitation_min','min') %}
            {% set s = mean|float(0) + stdev|float(0) * states('input_number.motion_device_precipitation_stdev')|float(1) %}
            {%- if s < min|float(s) -%}{{ min }}{%- else -%}{{ s }}{%- endif -%}
          {%- else -%}none{%- endif -%}
        factor: >-
          {% set mean = state_attr('sensor.motion_device_precipitation_min','mean') %}
          {% set stdev = state_attr('sensor.motion_device_precipitation_min','stdev') %}
          {%- if mean|lower != 'none' and mean is number and stdev|lower != 'none' and stdev is number and mean|float(0) > 0 -%}
            {{ (mean|float(0) - stdev|float(0)) / mean|float(1) * 100 }}
          {%- else -%}none{%- endif -%}
        spike: >-
         {{ states.sensor.motion_device_precipitation_min.attributes }}
      state: >-
        {{- state_attr('sensor.motion_device_precipitation','min') -}}

- unique_id: motion_device_precipitation_alarm_template
  trigger:
    - platform: state
      entity_id: group.motion_device_precipitation_alarm
    - platform: state
      entity_id: binary_sensor.motion_device_precipitation_exist
      attribute: 'alarm'
    - platform: state
      entity_id: binary_sensor.motion_device_class
      attribute: 'alarms'
  binary_sensor:
    - name: 'motion_device_precipitation_alarm'
      device_class: problem
      attributes:
        friendly_name: 'Alarm precipitation'
        status: >-
          {{ '{' -}}
          {%- for i in state_attr('binary_sensor.motion_device_class','alarms') -%}
            {%- if not loop.first -%},{%- endif -%}
            {{- '"' + i|string + '":"' ~ states('binary_sensor.motion_device_precipitation_' + i) ~ '"' -}}
          {%- endfor -%}
          {{- '}' }}
        markdown: >-
          {%- for i in state_attr('binary_sensor.motion_device_class','alarms') if is_state('binary_sensor.motion_device_precipitation_' + i|string,'on') -%}
            {%- if loop.first -%}<ul>{%- endif -%}
            {%- if states('binary_sensor.motion_device_precipitation_' + i|string) -%}
              {%- set s = state_attr('binary_sensor.motion_device_precipitation_' + i|string,'markdown') -%}
               <li>The precipitation alarm is: <b>{{- i|upper -}}</b>{%- if s|lower != 'none' -%}<br>{{- s -}}</br>{%- endif -%}</li>
            {%- endif -%}
            {%- if loop.last -%}</ul>{%- endif -%}
          {%- endfor -%}
      state: >-
        {%- set s = state_attr('binary_sensor.motion_device_class','alarms') -%}
        {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
          {%- for i in s if states('binary_sensor.motion_device_precipitation_' + i)|lower == 'on' -%}
            {%- if loop.first -%}on{%- endif -%}
          {% else %}off{%- endfor -%}
        {%- else -%}off{%- endif -%}

- unique_id: motion_device_precipitation_alarm_exist_template
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.motion_device_precipitation
        - binary_sensor.motion_device_precipitation_alarm
        - binary_sensor.motion_device_precipitation_exist
        - binary_sensor.motion_device_precipitation_good
        - binary_sensor.motion_device_precipitation_bad
        - binary_sensor.motion_device_precipitation_low
        - binary_sensor.motion_device_precipitation_high
        - binary_sensor.motion_device_precipitation_low_spike
        - binary_sensor.motion_device_precipitation_high_spike
        - binary_sensor.motion_device_precipitation_missing
        - binary_sensor.motion_device_precipitation_unavailable
  binary_sensor:
    - name: motion_device_precipitation_alarm_exist
      device_class: 'problem'
      attributes:
        friendly_name: 'Alarm exists: precipitation'
        actions: >-
          {%- set group = 'device-precipitation' -%}
          {%- set interval = 300 -%}
          {%- set all = [] -%}
          {#- bad -#}
          {%- set id = group|string + '-bad' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_bad','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_bad','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- good -#}
          {%- set id = group|string + '-good' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_good','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_good','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- high -#}
          {%- set id = group|string + '-high' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_high','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_high','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- low -#}
          {%- set id = group|string + '-low' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_low','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_low','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- high-spike -#}
          {%- set id = group|string + '-high_spike' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_high_spike','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_high_spike','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- low-spike -#}
          {%- set id = group|string + '-low_spike' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_low_spike','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_low_spike','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- missing -#}
          {%- set id = group|string + '-missing' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_missing','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_missing','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- unavailable -#}
          {%- set id = group|string + '-unavailable' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_unavailable','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_unavailable','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- activity -#}
          {%- set id = group|string + '-activity' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_activity','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_activity','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {#- found -#}
          {%- set id = group|string + '-found' -%}
          {%- set responses = state_attr('binary_sensor.motion_device_precipitation_found','responses') -%}
          {%- set actions = state_attr('binary_sensor.motion_device_precipitation_found','actions') -%}
          {%- set all = all + [{'id': id,'group': group,'interval': interval,'responses': responses,'actions': actions}] -%}
          {{- all -}}
        good: >-
          {{ not is_state_attr('binary_sensor.motion_device_precipitation_exist','good','none') and is_state('binary_sensor.motion_device_precipitation_good','on') }}
        bad: >-
          {{ not is_state_attr('binary_sensor.motion_device_precipitation_exist','bad','none') and is_state('binary_sensor.motion_device_precipitation_bad','on') }}
        activity: >-
          {{ not is_state_attr('binary_sensor.motion_device_precipitation_exist','activity','none') and is_state('binary_sensor.motion_device_precipitation_activity','on') }}
        low: >-
          {{ not is_state_attr('binary_sensor.motion_device_precipitation_exist','low','none') and is_state('binary_sensor.motion_device_precipitation_low','on') }}
        high: >-
          {{ not is_state_attr('binary_sensor.motion_device_precipitation_exist','high','none') and is_state('binary_sensor.motion_device_precipitation_high','on') }}
        low_spike: >-
          {{ not is_state_attr('binary_sensor.motion_device_precipitation_exist','low_spike','none') and is_state('binary_sensor.motion_device_precipitation_low_spike','on') }}
        high_spike: >-
          {{ not is_state_attr('binary_sensor.motion_device_precipitation_exist','high_spike','none') and is_state('binary_sensor.motion_device_precipitation_high_spike','on') }}
        missing: >-
          {{ not is_state_attr('binary_sensor.motion_device_precipitation_exist','required','none') and not is_state('binary_sensor.motion_device_precipitation_missing','off') }}
        unavailable: >-
          {{ is_state('binary_sensor.motion_device_precipitation_unavailable','on') }}
        found: >-
          {{ is_state('binary_sensor.motion_device_precipitation_exist','on') }}
        active: >-
          {%- set s = state_attr('binary_sensor.motion_device_precipitation_alarm','status') -%}
          {% if s|lower != 'none' and not s is string and s is iterable and s|count > 0 %}
            {%- if s.values()|reject('==','off')|list|count > 0 -%}on{%- else -%}off{%- endif -%}
          {% else %}unknown{% endif %}
        markdown: >-
          {%- set s = states('binary_sensor.motion_device_precipitation_alarm') -%}
          <h2>The <a href="/notify-devices/precipitation">precipitation</a> alarm is: <i>{{- s|upper -}}</i></h2>
          {%- if s|lower == 'on' -%}
            {{- state_attr('binary_sensor.motion_device_precipitation_alarm','markdown') -}}
          {%- endif -%}
      state: >-
        {{ is_state_attr('binary_sensor.motion_device_precipitation_exist','alarm','on') and is_state('binary_sensor.motion_device_precipitation_alarm','on') }}

- unique_id: motion_device_precipitation_status_template
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_device_precipitation'
      attribute: 'status'
  binary_sensor:
    - name: motion_device_precipitation_status
      attributes:
        friendly_name: 'Status precipitation'
        markdown: >-
          {%- set s = state_attr('binary_sensor.motion_device_precipitation','status') %}
          {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            {%- set s = s|selectattr('entity_id','search','binary_sensor\.')|list -%}
            {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            {{- '<h2>Status</h2><ul>' -}}
            {%- for i in s if 'entity_id' in  i -%}
              {%- set u = device_id(i.entity_id) -%}
              {{- '<li>' -}}
              {%- if u|lower != 'none' -%}
                <a href="/config/devices/device/{{- u -}}"><b>{{- state_attr(i.entity_id,'friendly_name') -}}</b></a>: {{ states(i.entity_id) }}
              {%- else -%}
                <b>{{- state_attr(i.entity_id,'friendly_name') -}}</b>: {{ states(i.entity_id) -}}
              {%- endif -%}
              {{- '</li>' -}}
            {%- endfor -%}
            {{- '</ul>' -}}
            {%- else -%}<h2>No status</h2>{%- endif -%}
          {%- else -%}<h2>No status</h2>{%- endif -%}
        found: >-
          {%- set s = state_attr('binary_sensor.motion_device_precipitation','status') %}
          {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            {%- set s = s|selectattr('entity_id','search','binary_sensor\.')|list -%}
            {{- s|lower != 'none' and not s is string and s is iterable and s|count > 0 -}}
          {% else %}false{% endif %}
      state: >-
        {% set s = state_attr('binary_sensor.motion_device_precipitation_exist','status') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s }}
        {% else %}unknown{% endif %}


- unique_id: motion_device_precipitation_measurement_template
  trigger:
    - platform: state
      entity_id: 'sensor.motion_device_precipitation'
      attribute: 'measurement'
  binary_sensor:
    - name: motion_device_precipitation_measurement
      attributes:
        friendly_name: 'Measurement precipitation'
        markdown: >-
          {%- set class = 'precipitation' %}
          {%- set s = state_attr('sensor.motion_device_' + class,'measurement') %}
          {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            {%- set s = s|rejectattr('entity_id','search','binary_sensor\.')|selectattr('entity_id','search','sensor\.')|list -%}
            {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
              {{- '<h2>Measurements</h2><ul>' -}}
              {%- for i in s if 'entity_id' in i -%}
                {%- set u = device_id(i.entity_id) -%}
                {%- set v = states(i.entity_id) -%}
                {%- if v|lower != 'none' and v|lower != 'unknown' and v|lower != 'unavailable' and v|lower != 'null' and v|string|count > 0 -%}
                  {%- set uom = state_attr(i.entity_id,'unit_of_measurement') -%}
                  {%- if uom|lower != 'none' and uom|lower != 'unknown' and uom|lower != 'unavailable' and uom|lower != 'null' and uom|string|count > 0 -%}
                    {%- set v = v|string + uom|string -%}
                  {%- endif -%}
                {%- endif -%}
                {{- '<li>' -}}
                {%- if u|lower != 'none' -%}
                  <a href="/config/devices/device/{{- u -}}"><b>{{- state_attr(i.entity_id,'friendly_name') -}}</b></a>: {{ v }}
                {%- else -%}
                  <b>{{- state_attr(i.entity_id,'friendly_name') -}}</b>: {{ v }}
                {%- endif -%}
                {{- '</li>' -}}
              {%- endfor -%}
              {{- '</ul>' -}}
            {%- else -%}<h2>No measurements</h2>{%- endif -%}
          {%- else -%}<h2>No measurements</h2>{%- endif -%}
        found: >-
          {%- set class = 'precipitation' %}
          {%- set s = state_attr('binary_sensor.motion_device_' + class,'status') %}
          {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            {%- set s = s|rejectattr('entity_id','search','binary_sensor\.')|selectattr('entity_id','search','sensor\.')|list -%}
            {{- s|lower != 'none' and not s is string and s is iterable and s|count > 0 -}}
          {% else %}false{% endif %}
      state: >-
        {%- set class = 'precipitation' %}
        {% set s = state_attr('binary_sensor.motion_device_' + class + '_exist','measurement') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s }}
        {% else %}unknown{% endif %}


- unique_id: motion_device_precipitation_statistics_template
  trigger:
    - platform: state
      entity_id: 'sensor.motion_device_precipitation'
      attribute: 'statistics'
  binary_sensor:
    - name: motion_device_precipitation_statistics
      attributes:
        friendly_name: 'Statistics precipitation'
        status: >-
          {%- set s = state_attr('sensor.motion_device_precipitation','statistics') %}
          {%- if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable and s|count > 0 -%}
            [{%- for i in s if 'entity_id' in i -%}
            {%- if not loop.first -%},{%- endif -%}
              {'{{- state_attr(i.entity_id,'friendly_name') -}}':['{{- states(i.entity_id) }} {{ state_attr(i.entity_id,'unit_of_measurement') -}}','{{- states[i.entity_id].last_updated|relative_time }}']}
            {%- endfor -%}]
          {%- else -%}none{%- endif -%}
        markdown: >-
          {%- set s = state_attr('sensor.motion_device_precipitation','statistics') %}
          {%- if s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            {{- '<h2>Statistics</h2><ul>' -}}
            {%- for i in s if 'entity_id' in i -%}
              {%- set u = device_id(i.entity_id) -%}
              {%- set v = states(i.entity_id) -%}
              {%- if v|lower != 'none' and v|lower != 'unknown' and v|lower != 'unavailable' and v|lower != 'null' and v|string|count > 0 -%}
                {%- set uom = state_attr(i.entity_id,'unit_of_measurement') -%}
                {%- if uom|lower != 'none' and uom|lower != 'unknown' and uom|lower != 'unavailable' and uom|lower != 'null' and uom|string|count > 0 -%}
                  {%- set v = v|string + uom|string -%}
                {%- endif -%}
              {%- endif -%}
              {{- '<li>' -}}
              {%- if u|lower != 'none' -%}
                <a href="/config/devices/device/{{- u -}}"><b>{{- state_attr(i.entity_id,'friendly_name') -}}</b></a>: {{ v }}
              {%- else -%}
                <b>{{- state_attr(i.entity_id,'friendly_name') -}}</b>: {{ v -}}
              {%- endif -%}
              {{- '</li>' -}}
            {%- endfor -%}
            {{- '</ul>' -}}
          {%- else -%}<h2>No statistics</h2>{%- endif -%}
      state: >-
        {% set s = state_attr('sensor.motion_device_precipitation','statistics') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable %}
          {{ s|count > 0 }}
        {% else %}off{% endif %}
