###
# homeassistant/template/motion/person_location.yaml
###

- unique_id: motion_person_location_previous_measurement
  trigger:
    - platform: state
      entity_id: 'sensor.motion_person_location_previous'
  sensor:
    - name: 'motion_person_location_velocity_measurement'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {% set s = state_attr('sensor.motion_person_location_previous','velocity') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ s }}
        {% else %}null{% endif %}
    - name: 'motion_person_location_movement_measurement'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {% set s = state_attr('sensor.motion_person_location_previous','movement') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|int(0) is number and s|int(0) < 40075 %}
          {{ s }}
        {% else %}null{% endif %}
    - name: 'motion_person_location_interval_measurement'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {% set s = state_attr('sensor.motion_person_location_previous','interval') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|int(0) is number and s|int(0) < 40075 %}
          {{ s }}
        {% else %}null{% endif %}

- unique_id: motion_person_location_measurement
  trigger:
    - platform: state
      entity_id: 'sensor.motion_person_location'
  sensor:
    - name: 'motion_person_location_distance_measurement'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {% set s = state_attr('sensor.motion_person_location','distance') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|int(0) is number and s|int(0) < 40075 %}
          {{ s }}
        {% else %}null{% endif %}
    - name: 'motion_person_location_accuracy_measurement'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {% set s = states('sensor.motion_person_location') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ state_attr('sensor.motion_person_location','gps_accuracy') }}
        {% else %}null{% endif %}

- unique_id: motion_person_location
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_person_location'
      attribute: probability
  sensor:
    - name: 'motion_person_location_probability_measurement'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {% set s = state_attr('binary_sensor.motion_person_location','probability') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ s }}
        {% else %}null{% endif %}
    - name: 'motion_person_location_probability_threshold'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {% set s = state_attr('binary_sensor.motion_person_location','probability_threshold') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ s }}
        {% else %}null{% endif %}

- unique_id: motion_person_location_ago_measurement
  trigger:
    - platform: state
      entity_id: 'sensor.motion_person_location'
      attribute: end
    - platform: state
      entity_id: 'sensor.motion_person_location'
      attribute: start
    - platform: time_pattern
      minutes: '/1'
  sensor:
    - name: 'motion_person_location_ago_measurement'
      state_class: 'measurement'
      device_class: 'power_factor'
      unit_of_measurement: '%'
      state: >-
        {% set s = state_attr('sensor.motion_person_location','end') %}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {% set end = s|float %}
          {% set s = state_attr('sensor.motion_person_location','start') %}
          {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
            {% set start = s|float %}
          {%- endif -%}
          {%- if start is defined and start > end %}
            {{ '%0.1f'|format(utcnow().timestamp() - start) }}
          {%- else %}
            {{ '%0.1f'|format(utcnow().timestamp() - end) }}
          {%- endif %}
        {%- else -%}null{%- endif -%}
