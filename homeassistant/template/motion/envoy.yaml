###
# homeassistant/template/envoy.yaml
###

## power

- unique_id: motion_envoy_power
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_envoy'
  sensor:
    - name: 'motion_envoy_power'
      state_class: 'measurement'
      device_class: 'power'
      unit_of_measurement: 'W'
      state: >-
        {% set n = 'current_power_production' %}
        {% set s = state_attr('binary_sensor.motion_envoy','ids') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
          {%- for i in s -%}
            {% set o = loop %}
            {%- for e in states.sensor if 'sensor.envoy_' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
              {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
        {%- else -%}null{%- endif %}

## energy

# today

- unique_id: motion_envoy_energy_today
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_envoy'
  sensor:
    - name: 'motion_envoy_energy_today'
      state_class: 'total_increasing'
      device_class: 'energy'
      unit_of_measurement: 'Wh'
      state: >-
          {% set n = 'today_s_energy_production' %}
          {% set s = state_attr('binary_sensor.motion_envoy','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}

- unique_id: motion_envoy_energy_week
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_envoy'
  sensor:
    - name: 'motion_envoy_energy_week'
      state_class: 'measurement'
      device_class: 'energy'
      unit_of_measurement: 'Wh'
      state: >-
          {% set n = 'last_seven_days_energy_production' %}
          {% set s = state_attr('binary_sensor.motion_envoy','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}

- unique_id: motion_envoy_energy_lifetime
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_envoy'
  sensor:
    - name: 'motion_envoy_energy_lifetime'
      state_class: 'measurement'
      device_class: 'energy'
      unit_of_measurement: 'Wh'
      state: >-
          {% set n = 'lifetime_energy_production' %}
          {% set s = state_attr('binary_sensor.motion_envoy','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}
