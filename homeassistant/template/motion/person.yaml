###
# homeassistant/template/person.yaml
###

- unique_id: motion_person_distance_measurement
  trigger:
    - platform: state
      entity_id: 'sensor.motion_person_location'
  sensor:
    - name: 'motion_person_velocity_measurement'
      state_class: 'measurement'
      device_class: 'pressure'
      unit_of_measurement: 'psi'
      state: >-
        {% set s = states('sensor.motion_person_location') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {% set s = states('sensor.motion_person_location_latitude') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {% set lat = s|float -%}
            {% set s = states('sensor.motion_person_location_longitude') -%}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
              {% set lng = s|float -%}
              {% set d = distance(lat, lng, state_attr('sensor.motion_person_location','latitude'), state_attr('sensor.motion_person_location','longitude') * 1000) %}
              {% set t = states('sensor.motion_person_location_timestamp') -%}
              {%- if t|lower != 'none' and t|lower != 'unknown' and t|lower != 'unavailable' and t|lower != 'null' -%}
                {% set t = utcnow().timestamp() - t|float %}
                {{- '%0.2f'|format(d/t|float) -}}
              {%- else -%}null{%- endif %}
            {%- else -%}null{%- endif %}
          {%- else -%}null{%- endif %}
        {%- else -%}null{%- endif %}
    - name: 'motion_person_distance_measurement'
      state_class: 'measurement'
      device_class: 'pressure'
      unit_of_measurement: 'psi'
      state: >-
        {% set s = states('sensor.motion_person_location') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {% set s = distance('zone.home', state_attr('sensor.motion_person_location','latitude'), state_attr('sensor.motion_person_location','longitude')) * 1000 %}
          {{- '%0.2f'|format(s|float) -}}
        {%- else -%}null{%- endif %}
    - name: 'motion_person_location_latitude'
      unit_of_measurement: 's'
      state: >-
        {% set s = states('sensor.motion_person_location') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ state_attr('sensor.motion_person_location','latitude') }}
        {%- else -%}null{%- endif %}
    - name: 'motion_person_location_longitude'
      unit_of_measurement: 's'
      state: >-
        {% set s = states('sensor.motion_person_location') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ state_attr('sensor.motion_person_location','longitude') }}
        {%- else -%}null{%- endif %}
    - name: 'motion_person_location_timestamp'
      unit_of_measurement: 's'
      state: >-
        {{ utcnow().timestamp() }}
