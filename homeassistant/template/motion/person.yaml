###
# homeassistant/template/person.yaml
###

- unique_id: motion_person_distance_measurement
  trigger:
    - platform: state
      entity_id: 'sensor.motion_person_location'
  sensor:
    - name: 'motion_person_velocity_measurement'
      state_class: 'measurement'
      device_class: 'pressure'
      unit_of_measurement: 'psi'
      state: >-
        {% set s = states('sensor.motion_person_location') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set s = states('sensor.motion_person_location_previous_latitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {% set plat = s|float %}
            {% set s = states('sensor.motion_person_location_previous_longitude') %}
            {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
              {% set plng = s|float %}
              {% set s = state_attr('sensor.motion_person_location','latitude') %}
              {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
                {% set clat = s|float %}
                {% set s = state_attr('sensor.motion_person_location','longitude') %}
                {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
                  {% set clng = s|float %}
                  {% set d = distance(plat, plng, clat, clng) * 1000 %}
                  {% set t = states('sensor.motion_person_location_previous_timestamp') %}
                  {% if t|lower != 'none' and t|lower != 'unknown' and t|lower != 'unavailable' and t|lower != 'null' %}
                    {% set t = utcnow().timestamp() - t|float %}
                    {{- '%0.2f'|format(d/t|float) -}}
                  {% else %}null{% endif %}
                {% else %}null{% endif %}
              {% else %}null{% endif %}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
    - name: 'motion_person_movement_measurement'
      state_class: 'measurement'
      device_class: 'pressure'
      unit_of_measurement: 'psi'
      state: >-
        {% set s = states('sensor.motion_person_location') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set s = states('sensor.motion_person_location_previous_latitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {% set plat = s|float %}
            {% set s = states('sensor.motion_person_location_previous_longitude') %}
            {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
              {% set plng = s|float %}
              {% set s = state_attr('sensor.motion_person_location','latitude') %}
              {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
                {% set clat = s|float %}
                {% set s = state_attr('sensor.motion_person_location','longitude') %}
                {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
                  {% set clng = s|float %}
                  {% set d = distance(plat, plng, clat, clng) * 1000 %}
                  {{- '%0.2f'|format(d) -}}
                {% else %}null{% endif %}
              {% else %}null{% endif %}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
    - name: 'motion_person_distance_measurement'
      state_class: 'measurement'
      device_class: 'pressure'
      unit_of_measurement: 'psi'
      state: >-
        {% set s = states('sensor.motion_person_location') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set s = state_attr('sensor.motion_person_location','latitude') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
            {% set clat = s|float %}
            {% set s = state_attr('sensor.motion_person_location','longitude') %}
            {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
              {% set clng = s|float %}
              {% set s = distance('zone.home', clat, clng) * 1000 %}
              {{- '%0.2f'|format(s|float) -}}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
    - name: 'motion_person_location_accuracy_measurement'
      state_class: 'measurement'
      device_class: 'pressure'
      unit_of_measurement: 'psi'
      state: >-
        {% set s = states('sensor.motion_person_location') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ state_attr('sensor.motion_person_location','gps_accuracy') }}
        {% else %}null{% endif %}
    - name: 'motion_person_location_previous_latitude'
      unit_of_measurement: 's'
      state: >-
        {% set s = states('sensor.motion_person_location') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ state_attr('sensor.motion_person_location','latitude') }}
        {% else %}null{% endif %}
    - name: 'motion_person_location_previous_longitude'
      unit_of_measurement: 's'
      state: >-
        {% set s = states('sensor.motion_person_location') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ state_attr('sensor.motion_person_location','longitude') }}
        {% else %}null{% endif %}
    - name: 'motion_person_location_previous_timestamp'
      unit_of_measurement: 's'
      state: >-
        {{ utcnow().timestamp() }}
