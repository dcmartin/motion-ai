###
# homeassistant/template/powerwall.yaml
###

## battery_charging

- unique_id: motion_powerwall_charging
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  binary_sensor:
    - name: 'motion_powerwall_charging'
      device_class: 'battery_charging'
      state: >-
        {% set n = 'charging' %}
        {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
          {%- for i in s -%}
            {% set o = loop %}
            {%- for e in states.binary_sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' %}
              {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
        {%- else -%}null{%- endif %}

## battery

- unique_id: motion_powerwall_charge
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_charge'
      state_class: 'measurement'
      device_class: 'battery'
      unit_of_measurement: '%'
      state: >-
        {% set n = 'charge' %}
        {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
          {%- for i in s -%}
            {% set o = loop %}
            {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
              {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
        {%- else -%}null{%- endif %}

## power

- unique_id: motion_powerwall_load_now
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_load_now'
      state_class: 'measurement'
      device_class: 'power'
      unit_of_measurement: 'kW'
      state: >-
        {% set n = 'load_now' %}
        {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
          {%- for i in s -%}
            {% set o = loop %}
            {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
              {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_site_now
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_site_now'
      state_class: 'measurement'
      device_class: 'power'
      unit_of_measurement: 'kW'
      state: >-
        {% set n = 'site_now' %}
        {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
          {%- for i in s -%}
            {% set o = loop %}
            {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
              {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_battery_now
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_battery_now'
      state_class: 'measurement'
      device_class: 'power'
      unit_of_measurement: 'kW'
      state: >-
          {% set n = 'battery_now' %}
          {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}

## energy

# export

- unique_id: motion_powerwall_load_export
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_load_export'
      state_class: 'total_increasing'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
          {% set n = 'load_export' %}
          {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_site_export
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_site_export'
      state_class: 'total_increasing'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
          {% set n = 'site_export' %}
          {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_battery_export
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_battery_export'
      state_class: 'total_increasing'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
          {% set n = 'battery_export' %}
          {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}

# import

- unique_id: motion_powerwall_load_import
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_load_import'
      state_class: 'total_increasing'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
          {% set n = 'load_import' %}
          {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_site_import
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_site_import'
      state_class: 'total_increasing'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
          {% set n = 'site_import' %}
          {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_battery_import
  trigger:
    - platform: state
      entity_id: 'binary_sensor.motion_powerwall'
  sensor:
    - name: 'motion_powerwall_battery_import'
      state_class: 'total_increasing'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
          {% set n = 'battery_import' %}
          {% set s = state_attr('binary_sensor.motion_powerwall','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {%- for i in s -%}
              {% set o = loop %}
              {%- for e in states.sensor if 'sensor.' + i + '_' + n in e.entity_id and e.state|lower != 'unknown' and e.attributes.device_class|lower != 'none' %}
                {%- if not o.first or not loop.first -%}{% else %}{{ e.state }}{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif %}
