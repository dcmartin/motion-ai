###
# homeassistant/template/powerwall.yaml
###

## power

- unique_id: motion_powerwall_load_now
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_load_now'
  sensor:
    - name: 'motion_powerwall_load_now'
      state_class: 'measurement'
      device_class: 'power'
      unit_of_measurement: 'kW'
      state: >-
        {% set s = states('sensor.powerwall_load_now') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- '%0.2f'|format(s|float) -}}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_site_now
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_site_now'
  sensor:
    - name: 'motion_powerwall_site_now'
      state_class: 'measurement'
      device_class: 'power'
      unit_of_measurement: 'kW'
      state: >-
        {% set s = states('sensor.powerwall_site_now') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- '%0.2f'|format(s|float) -}}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_battery_now
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_battery_now'
  sensor:
    - name: 'motion_powerwall_battery_now'
      state_class: 'measurement'
      device_class: 'power'
      unit_of_measurement: 'kW'
      state: >-
        {% set s = states('sensor.powerwall_battery_now') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- '%0.2f'|format(s|float) -}}
        {%- else -%}null{%- endif %}

## energy

- unique_id: motion_powerwall_load_export
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_load_export'
  sensor:
    - name: 'motion_powerwall_load_export'
      state_class: 'measurement'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
        {% set s = states('weather.forecast') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = state_attr('weather.forecast','humidity') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- '%0.2f'|format(s|float) -}}
          {%- else -%}null{%- endif %}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_site_export
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_site_export'
  sensor:
    - name: 'motion_powerwall_site_export'
      state_class: 'measurement'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
        {% set s = states('weather.forecast') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = state_attr('weather.forecast','humidity') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- '%0.2f'|format(s|float) -}}
          {%- else -%}null{%- endif %}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_battery_export
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_battery_export'
  sensor:
    - name: 'motion_powerwall_battery_export'
      state_class: 'measurement'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
        {% set s = states('weather.forecast') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = state_attr('weather.forecast','humidity') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- '%0.2f'|format(s|float) -}}
          {%- else -%}null{%- endif %}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_load_import
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_load_import'
  sensor:
    - name: 'motion_powerwall_load_import'
      state_class: 'measurement'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
        {% set s = states('weather.forecast') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = state_attr('weather.forecast','humidity') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- '%0.2f'|format(s|float) -}}
          {%- else -%}null{%- endif %}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_site_import
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_site_import'
  sensor:
    - name: 'motion_powerwall_site_import'
      state_class: 'measurement'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
        {% set s = states('weather.forecast') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = state_attr('weather.forecast','humidity') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- '%0.2f'|format(s|float) -}}
          {%- else -%}null{%- endif %}
        {%- else -%}null{%- endif %}

- unique_id: motion_powerwall_battery_import
  trigger:
    - platform: state
      entity_id: 'sensor.powerwall_battery_import'
  sensor:
    - name: 'motion_powerwall_battery_import'
      state_class: 'measurement'
      device_class: 'energy'
      unit_of_measurement: 'kWh'
      state: >-
        {% set s = states('weather.forecast') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = state_attr('weather.forecast','humidity') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- '%0.2f'|format(s|float) -}}
          {%- else -%}null{%- endif %}
        {%- else -%}null{%- endif %}
