###
# homeassistant/binary_sensor/motion/app.yaml
###

- platform: template
  sensors:
    motion_home_undefined:
      device_class: problem
      attribute_templates:
        home: >-
          {% set s = states('zone.home') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'null' and s|lower != 'unavailable' %}
            {{ states.zone.home.attributes }}
          {% else %}none{% endif %}
      value_template: >-
        {% set s = states('zone.home') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'null' and s|lower != 'unavailable' %}
          {{ state_attr('zone.home','latitude')|float('none') == 'none' or state_attr('zone.home','longitude')|float('none') == 'none' }}
        {% else %}{{- 'on' -}}{% endif %}
    motion_power_status:
      device_class: problem
      value_template: >-
        {% set s = states('binary_sensor.rpi_power_status') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' %}
          {{ s }}
        {% else %}unknown{% endif %}
    motion_devices_config:
      device_class: problem
      attribute_templates:
        entitys: >-
          {% set entitys = state_attr('group.motion_devices','entity_id') %}
          {{ entitys }}
        group: >-
          {% set group = states.group.motion_devices.last_updated %}
          {{ group }}
        automation: >-
          {% set automation = state_attr('automation.motion_devices_config','last_triggered') %}
          {{ automation }}
        current: >-
          {% set current = state_attr('automation.motion_devices_config','current') %}
          {{ current }}
        markdown: >-
          Devices were last updated {{ group|relative_time }} ago; currently {{ entitys|count -}}.
          Configuration of devices {% if current|int(0) > 0 -%}in process{%- else -%}attempted {{ automation|relative_time }} ago{%- endif -%}.
          {% for i in entitys if states(i)|lower == 'on' -%}{%- if not loop.first -%}, {% else -%}Complete: {% endif -%}<a href="/config/devices/device/{{- state_attr(i,'did') -}}">{{- state_attr(i,'name') -}}</a>{%- endfor -%}.
          {% for i in entitys if states(i)|lower != 'on' -%}{%- if not loop.first -%}, {% else -%}Pending: {% endif -%}<a href="/config/devices/device/{{- state_attr(i,'did') -}}">{{- state_attr(i,'name') -}}</a>: <b>{{- states(i) -}}</b>{%- endfor -%}.
      value_template: >-
        {{ 'unknown' }}
