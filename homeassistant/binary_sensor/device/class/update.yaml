###
# homeassistant/binary_sensor/device/update.yaml
###

- platform: template
  sensors:
    motion_device_update_exist:
      friendly_name: Existing update sensor(s)
      attribute_templates:
        good: >-
          {% set g = state_attr('binary_sensor.motion_device_class','good') -%}
          {%- set b = state_attr('binary_sensor.motion_device_class','bad') -%}
          {%- if g|lower != 'none' and b|lower != 'none' -%}
            {%- if 'update' in g -%}on{%- elif 'update' in b -%}off{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        bad: >-
          {% set g = state_attr('binary_sensor.motion_device_class','good') -%}
          {%- set b = state_attr('binary_sensor.motion_device_class','bad') -%}
          {%- if g|lower != 'none' and b|lower != 'none' -%}
            {%- if 'update' in b -%}on{%- elif 'update' in g -%}off{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        alarm: >-
          {% set s = state_attr('binary_sensor.motion_device_class','alarm') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        activity: >-
          {% set s = state_attr('binary_sensor.motion_device_class','activity') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        required: >-
          {% set s = state_attr('binary_sensor.motion_device_class','sensors') -%}
          {% set b = state_attr('binary_sensor.motion_device_class','binary_sensors') -%}
          {%- if s|lower != 'none' and b|lower != 'none' -%}
            {% set required = (s|list + b|list)|sort|unique %}
            {%- if 'update' in required -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        low: >-
          {% set s = state_attr('binary_sensor.motion_device_class','low') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}
              {{ states('input_number.motion_device_update_low') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        high: >-
          {% set s = state_attr('binary_sensor.motion_device_class','high') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}
              {{ states('input_number.motion_device_update_high') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        measurement: >-
          {% set s = state_attr('binary_sensor.motion_device_class','sensor_list') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        status: >-
          {% set s = state_attr('binary_sensor.motion_device_class','binary_sensor_list') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'update' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update','total') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s|int(0) > 0 }}
        {% else %}unknown{% endif %}

- platform: template
  sensors:
    motion_device_update_status:
      friendly_name: Status update
      attribute_templates:
        markdown: >-
          {%- set s = state_attr('binary_sensor.motion_device_update','status') %}
          {%- if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable and s|count > 0 -%}
            {{- '<ul>' -}}
            {%- for i in s if 'entity_id' in i and 'binary_sensor.' in i.entity_id -%}
              {%- set u = device_id(i.entity_id) -%}
              {{- '<li>' -}}
              {%- if u|lower != 'none' -%}
                <a href="/config/devices/device/{{- u -}}"><b>{{- i.name -}}</b></a>: {{ states(i.entity_id) }}<code>{{- states[i.entity_id].last_updated|relative_time }}</code>
              {%- else -%}
                <b>{{- i.name -}}</b>: {{ states(i.entity_id) -}} <code>{{- states[i.entity_id].last_updated|relative_time }}</code>
              {%- endif -%}
              {{- '</li>' -}}
            {%- endfor -%}
            {{- '</ul>' -}}
          {%- else -%}none{%- endif -%}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_exist','status') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s }}
        {% else %}unknown{% endif %}
    motion_device_update_measurement:
      friendly_name: Measurement update
      attribute_templates:
        markdown: >-
          {%- set s = state_attr('binary_sensor.motion_device_update','status') %}
          {%- if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable and s|count > 0 -%}
            {{- '<ul>' -}}
            {%- for i in s if 'entity_id' in i and not 'binary_sensor.' in i.entity_id -%}
              {%- set u = device_id(i.entity_id) -%}
              {%- set v = states(i.entity_id) -%}
              {%- if v|lower != 'none' and v|lower != 'unknown' and v|lower != 'unavailable' and v|lower != 'null' and v|string|count > 0 -%}
                {%- set uom = state_attr(i.entity_id,'unit_of_measurement') -%}
                {%- if uom|lower != 'none' and uom|lower != 'unknown' and uom|lower != 'unavailable' and uom|lower != 'null' and uom|string|count > 0 -%}
                  {%- set v = v|string + uom|string -%}
                {%- endif -%}
              {%- endif -%}
              {{- '<li>' -}}
              {%- if u|lower != 'none' -%}
                <a href="/config/devices/device/{{- u -}}"><b>{{- i.name -}}</b></a>: {{ v }}<code>{{- states[i.entity_id].last_updated|relative_time }}</code>
              {%- else -%}
                <b>{{- i.name -}}</b>: {{ v }}<code>{{- states[i.entity_id].last_updated|relative_time }}</code>
              {%- endif -%}
              {{- '</li>' -}}
            {%- endfor -%}
            {{- '</ul>' -}}
          {%- else -%}none{%- endif -%}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_exist','measurement') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s }}
        {% else %}unknown{% endif %}
    motion_device_update_statistics:
      friendly_name: Statistics update
      attribute_templates:
        status: >-
          {%- set s = state_attr('binary_sensor.motion_device_update','statistics') %}
          {%- if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable and s|count > 0 -%}
            [{%- for i in s if 'entity_id' in i -%}
            {%- if not loop.first -%},{%- endif -%}
              {"{{- i.name -}}":["{{- states(i.entity_id) }} {{ state_attr(i.entity_id,'unit_of_measurement') -}}","{{- states[i.entity_id].last_updated|relative_time }}"]}
            {%- endfor -%}]
          {%- else -%}none{%- endif -%}
        markdown: >-
          {%- set s = state_attr('binary_sensor.motion_device_update','statistics') %}
          {%- if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable and s|count > 0 -%}
            {{- '<ul>' -}}
            {%- for i in s -%}
              {%- set u = device_id(i.entity_id) -%}
              {%- set v = states(i.entity_id) -%}
              {%- if v|lower != 'none' and v|lower != 'unknown' and v|lower != 'unavailable' and v|lower != 'null' and v|string|count > 0 -%}
                {%- set uom = state_attr(i.entity_id,'unit_of_measurement') -%}
                {%- if uom|lower != 'none' and uom|lower != 'unknown' and uom|lower != 'unavailable' and uom|lower != 'null' and uom|string|count > 0 -%}
                  {%- set v = v|string + uom|string -%}
                {%- endif -%}
              {%- endif -%}
              {{- '<li>' -}}
              {%- if u|lower != 'none' -%}
                <a href="/config/devices/device/{{- u -}}"><b>{{- i.name -}}</b></a>: {{ v }}<code>{{- states[i.entity_id].last_updated|relative_time }}</code>
              {%- else -%}
                <b>{{- i.name -}}</b>: {{ v -}} <code>{{- states[i.entity_id].last_updated|relative_time }}</code>
              {%- endif -%}
              {{- '</li>' -}}
            {%- endfor -%}
            {{- '</ul>' -}}
          {%- else -%}none{%- endif -%}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_statistics','status') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable %}
          {{ s|count > 0 }}
        {% else %}unknown{% endif %}
    motion_device_update_controls:
      friendly_name: Control update
      attribute_templates:
        status: >-
          {%- set s = state_attr('binary_sensor.motion_device_update','controls') %}
          {%- if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable -%}
            [{%- for i in s if 'entity_id' in i and not 'button.' in i.entity_id -%}
              {%- if not loop.first -%},{%- endif -%}
              {"{{- i.name -}}":["{{ states(i.entity_id) -}}","{{- states[i.entity_id].last_updated|relative_time }}"]}
            {%- endfor -%}]
          {%- else -%}none{%- endif -%}
        markdown: >-
          {%- set s = state_attr('binary_sensor.motion_device_update','controls') %}
          {%- if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable -%}
            {{- '<ul>' -}}
            {%- for i in s if 'entity_id' in i and not 'button.' in i.entity_id -%}
              {%- set u = device_id(i.entity_id) -%}
              {{- '<li>' -}}
              {%- if u|lower != 'none' -%}
                <a href="/config/devices/device/{{- u -}}"><b>{{- i.name -}}</b></a>: {{ states(i.entity_id) -}} <code>{{- states[i.entity_id].last_updated|relative_time }}</code>
              {%- else -%}
                <b>{{- i.name -}}</b>: {{ states(i.entity_id) -}} <code>{{- states[i.entity_id].last_updated|relative_time }}</code>
              {%- endif -%}
              {{- '</li>' -}}
            {%- endfor -%}
            {{- '</ul>' -}}
          {%- else -%}none{%- endif -%}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_controls','status') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s is iterable %}
          {{ s|count > 0 }}
        {% else %}unknown{% endif %}
    motion_device_update_required:
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_exist','required') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s }}
        {% else %}unknown{% endif %}
    motion_device_update_self_test:
      icon_template: 'mdi:gesture-tap-button'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_update','controls') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            [{%- for i in s if '_self_test' in i.entity_id -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {%- else -%}none{%- endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_self_test','entity_ids') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_update_mute:
      icon_template: 'mdi:gesture-tap-button'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_update','controls') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            [{%- for i in s if '_mute' in i.entity_id -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {%- else -%}none{%- endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_mute','entity_ids') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_update_unmute:
      icon_template: 'mdi:gesture-tap-button'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_update','controls') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            [{%- for i in s if '_unmute' in i.entity_id -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {%- else -%}none{%- endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_unmute','entity_ids') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_update_update:
      icon_template: 'mdi:update'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_update','update') %}
          {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable and s|count > 0 %}
            [{%- for i in s -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {% else %}none{% endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update','update') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_update_restart:
      icon_template: 'mdi:restart'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_update','restart') %}
          {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable and s|count > 0 %}
            [{%- for i in s -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {% else %}none{% endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update','restart') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_update_test:
      device_class: 'problem'
      icon_template: 'mdi:alert-circle'
      attribute_templates:
        values: >-
          {% set s = state_attr('binary_sensor.motion_device_update','test') %}
          {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable and s|count > 0 %}
            [{%- for i in s  -%}
              {%- if not loop.first -%},{%- endif -%}
              {% if i.state|lower == 'normal' %}0{% else %}1{% endif %}
            {%- endfor -%}]
          {% else %}none{% endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_update_test','values') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable and s|count > 0 %}
          {{- s|sum|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_update:
      friendly_name: Status update sensor(s)
      attribute_templates:
        last: >-
          {{- none -}}
        ids: >-
          {{- 'unknown' -}}
        total: >-
          {{- 'unknown' -}}
        update: >-
          {{- 'unknown' -}}
        restart: >-
          {{- 'unknown' -}}
        controls: >-
          {{- 'unknown' -}}
        test: >-
          {{- 'unknown' -}}
        status: >-
          {{- 'unknown' -}}
        high: >-
          {{- 'unknown' -}}
        low: >-
          {{- 'unknown' -}}
        good: >-
          {{- 'unknown' -}}
        bad: >-
          {{- 'unknown' -}}
        activity: >-
          {{- 'unknown' -}}
        unavailable: >-
          {{- 'unknown' -}}
      value_template: >-
        {# set through automation #}
        {{- 'unknown' -}}

###

- platform: template
  sensors:
    motion_device_update_bad:
      friendly_name: Bad update
      attribute_templates:
        last: >-
          {{ 'unknown' }}
        details: >-
          {{ 'unknown' }}
      value_template: >-
        {{ 'unknown' }}
    motion_device_update_good:
      friendly_name: Good update
      attribute_templates:
        last: >-
          {{ 'unknown' }}
        details: >-
          {{ 'unknown' }}
      value_template: >-
        {{ 'unknown' }}
    motion_device_update_low:
      friendly_name: Low update
      attribute_templates:
        last: >-
          {{ 'unknown' }}
        details: >-
          {{ 'unknown' }}
      value_template: >-
        {{ 'unknown' }}
    motion_device_update_high:
      friendly_name: High update
      attribute_templates:
        last: >-
          {{ 'unknown' }}
        details: >-
          {{ 'unknown' }}
      value_template: >-
        {{ 'unknown' }}
    motion_device_update_activity:
      friendly_name: Activity update
      attribute_templates:
        last: >-
          {{ 'unknown' }}
        ids: >-
          {{ 'unknown' }}
        details: >-
          {{ 'unknown' }}
      value_template: >-
        {{ 'unknown' }}
    motion_device_update_unavailable:
      friendly_name: Unavailable update
      device_class: 'connectivity'
      attribute_templates:
        last: >-
          {{ 'unknown' }}
        ids: >-
          {{ 'unknown' }}
        details: >-
          {{ 'unknown' }}
      value_template: >-
        {{ 'unknown' }}
    motion_device_update_missing:
      attribute_templates:
        last: >-
          {{ 'unknown' }}
        ids: >-
          {{ 'unknown' }}
      value_template: >-
        {{ 'unknown' }}
