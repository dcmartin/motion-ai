###
# homeassistant/binary_sensor/device/class_unavailable.yaml
###

- platform: template
  sensors:
    motion_device_class_unavailable_exist:
      friendly_name: 'Unavailable devices'
      attribute_templates:
        id: >-
          {%- set id = 'device-unavailable' -%}
          {{ id }}
        interval: >-
          {%- set interval = 5 -%}
          {{ interval }}
        group: >-
          {{ 'device-notify' }}
        approve: >-
          {%- set approve = {'title':'Rescan','icon':'sfsymbols:house.circle','trigger':'automation.motion_device_class_rescan_all'} -%}
          {{ approve }}
        deny: >-
          {%- set deny = {'title':'Ignore it','icon':'sfsymbols:hand.thumbsdown.fill','trigger':'automation.motion_device_class_unavailable_dismiss'} -%}
          {{ deny }}
        wait: >-
          {%- set wait = {'title':'Ask later','icon':'sfsymbols:timer','trigger':'automation.motion_device_class_unavailable_dismiss'} -%}
          {{ wait }}
        help: >-
          {%- set p = state_attr('sensor.motion_role_primary','friendly_name') -%}
          {%- set help = {'title':'Notify ' + p,'icon':'sfsymbols:message','trigger':'none'} -%}
          {{ help }}
        responses: >-
          {%- set responses = ['approve','deny','wait','help'] -%}
          {{ responses }}
        actions: >-
          {%- set id = 'device-class-unavailable' -%}
          {%- set approve = state_attr('binary_sensor.motion_device_class_unavailable_exist','approve') -%}
          {%- set deny = state_attr('binary_sensor.motion_device_class_unavailable_exist','deny') -%}
          {%- set wait = state_attr('binary_sensor.motion_device_class_unavailable_exist','wait') -%}
          {%- set help = state_attr('binary_sensor.motion_device_class_unavailable_exist','help') -%}
          {%- set group = state_attr('binary_sensor.motion_device_class_unavailable_exist','group') -%}
          {%- set interval = state_attr('binary_sensor.motion_device_class_unavailable_exist','interval') -%}
          {%- set responses = state_attr('binary_sensor.motion_device_class_unavailable_exist','responses') -%}
          {%- set p = state_attr('sensor.motion_role_primary','friendly_name') -%}
          {%- set a = [
                  {'id':'approve','action': id|string + '-approve','icon': approve.icon|default('')|string,'title': approve.title|default('')|string,'destructive':false,'trigger': approve.trigger|default('none')},
            {'id':'deny','action': id|string + '-deny','icon': deny.icon|default('')|string,'title': deny.title|default('')|string,'destructive':true,'trigger': deny.trigger|default('none')},
            {'id':'wait','action': id|string + '-wait','icon': wait.icon|default('')|string,'title': wait.title|default('')|string,'destructive':false,'trigger': wait.trigger|default('none')},
            {'id':'help','action': id|string + '-help','icon': help.icon|default('')|string,'title': help.title|default('')|string,'destructive':false,'trigger': help.trigger|default('none')}
            ] -%}
          {"id":"{{- id -}}","group":"{{- group -}}","interval":{{- interval -}},"responses":{{- responses -}},"primary":"{{- p -}}","actions":{{ a }}}
      value_template: >-
        {{ is_state('binary_sensor.motion_device_class_unavailable','on') }}

- platform: template
  sensors:
    motion_device_class_unavailable:
      friendly_name: 'No unavailable devices'
      icon_template: 'mdi:home-minus'
      device_class: 'problem'
      attribute_templates:
        last: >-
          {{- 'null' -}}
        count: >-
          {{- 'null' -}}
        timestamp: >-
          {{ 'unknown' }}
        when: >-
          {{ 'unknown' }}
        response: >-
          {{ 'unknown' }}
        ids: >-
          {{- none -}}
        details: >-
          {{- none -}}
        markdown: >-
          <h2><a href="/notify-unavailable">Unavailable</a> pending</h2>
      value_template: >-
          {{- 'unknown' -}}
