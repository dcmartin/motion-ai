###
# homeassistant/binary_sensor/device/class_missing.yaml
###

- platform: template
  sensors:
    motion_device_class_missing:
      friendly_name: 'No missing devices'
      device_class: 'problem'
      icon_template: 'mdi:cancel'
      attribute_templates:
        approve: >-
          Ignore
        deny: >-
          Unrequire 
        wait: >-
          Remind me
        help: >-
          Help me
        ids: >-
          {% set s = state_attr('binary_sensor.motion_device_class','missing') %}
          {% if s|lower != 'none' and not s is string and s is iterable %}
            {{ s|list }}
          {% else %}none{% endif %}
        count: >-
          {% set s = state_attr('binary_sensor.motion_device_class','missing') %}
          {% if s|lower != 'none' and not s is string and s is iterable %}
            {{ s|count }}
          {% else %}none{% endif %}
        markdown: >-
          {% set s = state_attr('binary_sensor.motion_device_class','missing') %}
          {% if s|lower != 'none' and not s is string and s is iterable and s|count > 0 %}
            <h2><a href="/notify-missing/">Missing</a> devices</h2>
            {%- for i in s %}
              {%- if loop.first -%}<ol>{%- endif -%}
              <li><a href="/notify-devices/{{- i -}}">{{- i|upper -}}</a></li>
              {%- if loop.last -%}</ol>{%- endif -%}
            {%- endfor -%}
          {%- else -%}
            <h2>No missing devices</h2>
          {%- endif %}
          <i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_class','missing') %}
        {% if s|lower != 'none' and not s is string and s is iterable %}
          {{ s|list|count > 0 }}
        {% else %}unknown{% endif %}
    motion_device_mobile_exist:
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_class','mobiles') %}
        {% if s|lower != 'none' and not s is string and s is iterable %}
          {{ s|list|count > 0 }}
        {% else %}off{% endif %}
