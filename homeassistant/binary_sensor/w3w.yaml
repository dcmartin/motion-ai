###
# homeassistant/binary_sensor/motion/w3w.yaml
###

- platform: template
  sensors:
    what3words_location:
      friendly_name: 'What3Words location'
      device_class: connectivity
      icon_template: >-
        {% if is_state('binary_sensor.what3words_location','on') %}
          {{- 'mdi:home-map-marker' -}}
        {% else %}{{- 'mdi:home-search' -}}{% endif %}
      attribute_templates:
        entity_picture: >-
          {{- '/local/images/icons/w3w.png' -}}
        markdown: >-
          <ul>
          <li><b>Words</b>: "{{- state_attr('sensor.what3words_location','words')|string -}}"</li>
          <li><b>APIKEY</b>: "{{- state_attr('sensor.what3words_location','apikey')|string -}}"</li>
          {%- if is_state('binary_sensor.what3words_location','on') -%}
            <li><a href="https://what3words.com/{{- state_attr('binary_sensor.what3words_location','words')|string -}}">Map</a></li>
          {%- endif -%}
          <li><b>Ago</b>: {{ state_attr('binary_sensor.what3words_location','relative')|string }}
          </ul>
          <i>Last updated</i>: {{ utcnow().timestamp()|timestamp_custom("%a %b %d %I:%M %p %Z",true,'unknown') }}
        words: >-
          {% set s = states('sensor.what3words_location_rest') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% set s = state_attr('sensor.what3words_location_rest','words') %}
            {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
              {{ s }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        latitude: >-
          {% set s = states('sensor.what3words_location_rest') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% set s = state_attr('sensor.what3words_location_rest','coordinates') %}
            {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
              {{ s.lat|float(0.0) }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        longitude: >-
          {% set s = states('sensor.what3words_location_rest') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% set s = state_attr('sensor.what3words_location_rest','coordinates') %}
            {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
              {{ s.lng|float(0.0) }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        nearest: >-
          {% set s = states('sensor.what3words_location_rest') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% set s = state_attr('sensor.what3words_location_rest','nearestPlace') %}
            {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
              {{ s }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        map: >-
          {% set s = states('sensor.what3words_location_rest') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% set s = state_attr('sensor.what3words_location_rest','map') %}
            {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
              {{ s }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        relative: >-
          {% set s = states.sensor.what3words_location_rest.last_updated|default('unknown') %}
          {% if s|lower != 'unknown' %}
            {{ s|relative_time }}
          {% else %}none{% endif %}
        ago: >-
          {% set s = states.sensor.what3words_location_rest.last_updated|default('unknown') %}
          {% if s|lower != 'unknown' %}
            {% set s = as_timestamp(s,0) %}
            {% if s|float(0.0) > 0.0 %}
              {{ (utcnow().timestamp() - s|float(0))|int }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        connect: 5
        timeout: 30
      value_template: >-
        {{ states('sensor.what3words_location_rest')|lower == 'true' }}
