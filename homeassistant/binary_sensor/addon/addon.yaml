###
# homeassistant/binary_sensor/motion/addon.yaml
###

- platform: template
  sensors:
    motion_addon_status:
      friendly_name: 'Status: Add-on'
      device_class: connectivity
      icon_template: >-
        {%- set e = states('sensor.motion_addon_status') -%}
        {%- if e|lower != 'unknown' and e|lower != 'unavailable' and e|lower != 'none' and e|lower != 'null' -%}
          {%- if e|lower == 'true' -%}
            {{- 'mdi:video-check' -}}
          {% else %}
            {{- 'mdi:video-outline' -}}
          {% endif %}
        {%- else -%}{{- 'mdi:video' -}}{%- endif -%}
      value_template: >-
        {% set e = states('sensor.motion_addon_status') %}
        {% if e|lower != 'unknown' and e|lower != 'unavailable' and e|lower != 'none' and e|lower != 'null' %}
          {% set a = states('sensor.motion_addon_status_ago') %}
          {% if a|lower != 'unknown' and a|lower != 'unavailable' and a|lower != 'none' and a|lower != 'null' %}
            {{- e|lower == 'true' and a|int(0) <= states('input_number.motion_addon_status_ago')|int(0) -}}
          {% else %}null{% endif %}
        {% else %}null{% endif %}

#{
#  "auto_update": true,
#  "installed_version": "0.2.10",
#  "in_progress": false,
#  "latest_version": "0.2.10",
#  "release_summary": "No changelog found for add-on edf7ba55_ageathome!",
#  "release_url": null,
#  "skipped_version": null,
#  "title": "Age@Home",
#  "entity_picture": "/api/hassio/addons/edf7ba55_ageathome/icon",
#  "friendly_name": "Age@Home: Update",
#  "supported_features": 25
#}

- platform: template
  sensors:
    motion_addon_update:
      friendly_name: Add-on update
      icon_template: 'mdi:refresh'
      attribute_templates:
        addons: >-
          {% set addons = ['age_home','motion_classic'] -%}
          {{ addons }}
        addon: >-
          {% set s = state_attr('binary_sensor.motion_addon_update','addons') -%}
          {%- if s|lower != 'none' -%}
            {%- set addons = s -%}
            {%- for i in addons if state_attr('update.' + i + '_update','installed_version')|lower != 'none' -%}
              {%- set t = state_attr('update.' + i + '_update','installed_version') -%}
              {%- if loop.first -%}{{ i }}{%- endif -%}
            {%- endfor -%}
          {%- else -%}none{%- endif %}
        id: >-
          {% set s = state_attr('binary_sensor.motion_addon_update','addon') -%}
          {%- if s|lower != 'none' -%}
            {%- set s = state_attr('update.' + s + '_update','entity_picture') -%}
            {%- if s|lower == 'none' -%}
              {%- set s = state_attr('update.motion_classic_update','entity_picture') -%}
            {%- endif -%}
            {%- if s|lower != 'none' -%}
              {%- set s = s|replace('/icon','')|regex_replace('.*/','') -%}
              {{ s }}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        update: >-
          {% set s = state_attr('binary_sensor.motion_addon_update','addon') -%}
          {%- if s|lower != 'none' -%}
            {{ states.update[s + '_update'].attributes }}
          {%- else -%}none{%- endif %}
        title: >-
          {% set s = state_attr('binary_sensor.motion_addon_update','update') -%}
          {%- if s|lower != 'none' -%}
            {{ s.title }}
          {%- else -%}none{%- endif %}
      value_template: >-
          {% set s = state_attr('binary_sensor.motion_addon_update','addon') -%}
          {%- if s|lower != 'none' -%}
            {% set s = state_attr('update.' + s + '_update','installed_version') -%}
            {%- if s|lower != 'none' -%}
              {%- set installed = s|string -%}
              {% set s = state_attr('update.' + s + '_update','latest_version') -%}
              {%- if s|lower != 'none' -%}
                {%- set latest = s|string -%}
                {{ latest != installed }}
              {%- else -%}unknown{%- endif %}
            {%- else -%}unknown{%- endif %}
          {%- else -%}unknown{%- endif %}
