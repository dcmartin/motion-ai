###
# homeassistant/binary_sensor/motion/addon.yaml
###

- platform: template
  sensors:
    motion_addon_update:
      friendly_name: Add-on update
      icon_template: >-
        {{- 'mdi:storefront' -}}
      attribute_templates:
        addons: >-
          {% set addons = ['age_home','motion_classic'] -%}
          {{ addons }}
        addon: >-
          {{- 'unknown' -}}
        id: >-
          {{- 'unknown' -}}
        update: >-
          {{- 'unknown' -}}
        title: >-
          {{- 'unknown' -}}
        version: >-
          {{- 'unknown' -}}
        latest: >-
          {{- 'unknown' -}}
        sensor: >-
          {{- 'unknown' -}}
      value_template: >-
          {{- 'unknown' -}}

- platform: template
  sensors:
    motion_addon_auto_update:
      friendly_name: 'Add-on auto-update enabled'
      icon_template: 'mdi:cloud-refresh'
      attribute_templates:
        markdown: >-
          <h2>No markdown (yet)</h2>
      value_template: >-
        {{ is_state_attr('binary_sensor.motion_addon_status','auto_update','on') }}

- platform: template
  sensors:
    motion_addon_config:
      friendly_name: Add-on configuration
      icon_template: 'mdi:cog'
      device_class: connectivity
      attribute_templates:
        resource: >-
          {% set s = states('sensor.motion_addon_config_api') %}
          {% if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {{- s -}}
          {% else %}
            {{ 'http://' + states('input_text.motion_addon_apache_host') + ':7999/cgi-bin/config' }}
          {% endif %}
        interval: 120
        timeout: 10
        markdown: >-
          <h2>Add-on configuration</h2>
          {%- if is_state('binary_sensor.motion_addon_config','on') -%}
          Add-on configuration is <b>defined</b>.
          {%- else -%}
          Add-on configuration is <b>unavailable</b>.
          {%- endif -%}
  value_template: >-
    {% set s = states('sensor.motion_addon_config') %}
    {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
      {% if s|lower == 'true' %}on{% elif s|lower == 'false' %}off{% endif %}
    {% else %}unknown{% endif %}

- platform: template
  sensors:
    motion_addon_status:
      friendly_name: 'Add-on status'
      device_class: connectivity
      icon_template: >-
        {%- set e = states('sensor.motion_addon_status') -%}
        {%- if e|lower != 'unknown' and e|lower != 'unavailable' and e|lower != 'none' and e|lower != 'null' -%}
          {%- if e|lower == 'true' -%}
            {{- 'mdi:video-check' -}}
          {% else %}
            {{- 'mdi:video-outline' -}}
          {% endif %}
        {%- else -%}{{- 'mdi:video' -}}{%- endif -%}
      attribute_templates:
        sensor: >-
          {% set s = state_attr('group.motion_addons','entity_id') -%}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' and s is iterable and s|count > 0 %}
            {{ s|first }}
          {% else %}none{% endif %}
        ago: >-
          {% set s = state_attr('binary_sensor.motion_addon_status','sensor') -%}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
            {% set s = state_attr(s,'timestamp') -%}
            {% if s|lower != 'none' and s|int(0) > 0 %}
              {{ utcnow().timestamp()|int - s|int }}
            {% else %}none{% endif %}
          {% else %}none{% endif %}
        relative: >-
          {% set s = state_attr('binary_sensor.motion_addon_status','sensor') -%}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
            {% set s = state_attr(s,'timestamp') -%}
            {% if s|lower != 'none' and s|int(0) > 0 %}
              {{ s|as_datetime|relative_time }}
            {% else %}none{% endif %}
          {% else %}none{% endif %}
        restart: >-
          {% set s = state_attr('binary_sensor.motion_addon_status','sensor') -%}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
            {% set s = state_attr(s,'timestamp') -%}
            {% if s|lower != 'none' and s|int(0) > 0 %}
              {% set u = states('sensor.motion_uptime') %}
              {% if u|as_timestamp(0) > 0 %}
                {{ s|int(0) > u|as_timestamp|int }}
              {% else %}unknown{% endif %}
            {% else %}unknown{% endif %}
          {% else %}unknown{% endif %}
        auto_update: >-
          {%- set s = state_attr('binary_sensor.motion_addon_update','update') -%}
          {%- if s|lower != 'none' and 'auto_update' in s -%}
            {%- if s.auto_update|lower == 'true' -%}
              {{- 'on' -}}
            {% else %}
              {{- 'off' -}}
            {% endif %}
          {% else %}
            {{- 'unknown' -}}
          {% endif %}
      value_template: >-
        {% set e = states('sensor.motion_addon_status') %}
        {% if e|lower != 'unknown' and e|lower != 'unavailable' and e|lower != 'none' and e|lower != 'null' %}
          {% set a = states('sensor.motion_addon_status_ago') %}
          {% if a|lower != 'unknown' and a|lower != 'unavailable' and a|lower != 'none' and a|lower != 'null' %}
            {{- e|lower == 'true' and a|int(0) <= states('input_number.motion_addon_status_ago')|int(0) -}}
          {% else %}null{% endif %}
        {% else %}null{% endif %}

- platform: template
  sensors:
    motion_addon_installed:
      friendly_name: 'Add-on installed'
      attribute_templates:
        config: >-
          {% set s = state_attr('binary_sensor.motion_addon_update','id') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- set s = s|replace('.','_')|replace('-','_')|replace(' ','_')|replace('$','_') -%}
            {{ states['binary_sensor.motion_addon_' + s + '_start'].attributes|default(none) }}
          {% else %}null{% endif %}
        restart: >-
          {% set s = state_attr('binary_sensor.motion_addon_update','id') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {% set s = state_attr('binary_sensor.motion_addon_' + s + '_start','timestamp') %}
            {%- if s|lower != 'none' and s|int(0) > 0 -%}
              {%- set u = states('sensor.motion_uptime') -%}
              {%- if u|as_timestamp(0) > 0 -%}
                {{ s|int(0) > u|as_timestamp|int }}
              {%- else -%}unknown{%- endif -%}
            {%- else -%}unknown{%- endif %}
          {%- else -%}unknown{%- endif %}
        reload: >-
          {% set s = state_attr('binary_sensor.motion_addon_update','id') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {% set s = state_attr('binary_sensor.motion_addon_' + s + '_start','timestamp') %}
            {%- if s|lower != 'none' and s|int(0) > 0 -%}
              {%- set u = states('sensor.motion_uptime') -%}
              {%- if u|as_timestamp(0) > 0 -%}
                {{ s|int(0) > u|as_timestamp|int }}
              {% else %}
                {% set u = state_attr('automation.motion_reload','last_triggered') %}
                {% if u|as_timestamp(0) > 0 %}
                  {{ s|int(0) > u|as_timestamp|int }}
                {%- else -%}unknown{%- endif %}
              {%- endif %}
            {%- else -%}unknown{%- endif %}
          {%- else -%}unknown{%- endif %}
      icon_template: >-
        {%- if is_state_attr('binary_sensor.motion_addon_update','addon','age_home') -%}
          {{- 'mdi:home-heart' -}}
        {%- elif is_state_attr('binary_sensor.motion_addon_update','addon','motion_classic') -%}
           {{- 'mdi:eye-plus' -}}
        {%- else -%}
           {{- 'mdi:cancel' -}}
        {%- endif %}
      value_template: >-
        {%- set s = state_attr('binary_sensor.motion_addon_update','addon') -%}
        {{- s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -}}

- platform: template
  sensors:
    motion_addon_restart:
      value_template: >-
        {%- set s = state_attr('binary_sensor.motion_addon_installed','restart') -%}
        {%- if s|lower == 'true' or s|lower == 'on' -%}
          {{- 'on' -}}
        {%- elif s|lower == 'false' or s|lower == 'off' -%}
          {{- 'off' -}}
        {% else %}unknown{% endif %}
    motion_addon_reload:
      value_template: >-
        {%- set s = state_attr('binary_sensor.motion_addon_installed','reload') -%}
        {%- if s|lower == 'true' or s|lower == 'on' -%}
          {{- 'on' -}}
        {%- elif s|lower == 'false' or s|lower == 'off' -%}
          {{- 'off' -}}
        {% else %}unknown{% endif %}
