###
# homeassistant/binary_sensor/motion/w3w.yaml
###

- platform: template
  sensors:
    motion_w3w_location:
      friendly_name: 'What3Words location'
      icon_template: >-
        {% if is_state('binary_sensor.motion_w3w_location','on') %}
          {{- 'mdi:home-heart' -}}
        {% else %}{{- 'mdi:home-searcj' -}}{% endif %}
      attribute_templates:
        apikey: >-
          {% set s = states('input_text.motion_w3w_apikey') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
            {{ s }}
          {% else %}null{% endif %}
        words: >-
          {% set s = states('input_text.motion_w3w_location') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|length > 0 %}
            {{ ('[' + s|string|replace('///','"')|replace('.','","') + '"]')|from_json|default(null) }}
          {% else %}null{% endif %}
        latitude: >-
          {% set s = states('sensor.motion_w3w_location_rest') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% set s = state_attr('sensor.motion_w3w_location_rest','coordinates') %}
            {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
              {{ s.lat|float(0.0) }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        longitude: >-
          {% set s = states('sensor.motion_w3w_location_rest') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% set s = state_attr('sensor.motion_w3w_location_rest','coordinates') %}
            {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
              {{ s.lng|float(0.0) }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        ago: >-
          {% set s = states.sensor.motion_w3w_location_rest.last_updated|default('unknown') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
            {{ (utcnow().timestamp()|int(0) - as_timestamp(s)|int(0))|int(0) }}
          {% else %}null{% endif %}
        connect: 5
        timeout: 30
      value_template: >-
        {{ states('sensor.motion_w3w_location_rest')|lower == 'true' }}
