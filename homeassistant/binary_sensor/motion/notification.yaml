###
# homeassistant/sensor/motion/notification.yaml
###

- platform: template
  sensors:
    motion_notification:
      unique_id: motion_notification
      friendly_name: Notifications
      device_class: 'problem'
      attribute_templates:
        total: >-
          {{ states.persistent_notification|length }}
        unread: >-
          [{%- for state in states.persistent_notification -%}
            {%- if not loop.first -%},{%- endif -%}
            {%- set s = state.state_with_unit|lower -%}
            {%- if s == 'unread' -%}1{%- else -%}0{%- endif -%}
          {%- endfor -%}]
        read: >-
          [{%- for state in states.persistent_notification -%}
            {%- if not loop.first -%},{%- endif -%}
            {%- set s = state.state_with_unit|lower -%}
            {%- if s == 'read' -%}1{%- else -%}0{%- endif -%}
          {%- endfor -%}]
        notifying: >-
          [{%- for state in states.persistent_notification -%}
            {%- if not loop.first -%},{%- endif -%}
            {%- set s = state.state_with_unit|lower -%}
            {%- set t = state.attributes.title -%}
            {%- if s == 'notifying' and t != 'unknown' and t|lower != 'none' and t|lower != 'null' and t|length > 0 -%}1{%- else -%}0{%- endif -%}
          {%- endfor -%}]
        critical: >-
          {%- for state in states.persistent_notification if state.state_with_unit|lower == 'notifying' and 'CRITICAL' in state.attributes.title -%}
            {%- if not loop.first -%},{% else %}[{%- endif -%}
            {%- set t = state.attributes.title -%}
            {%- set m = state.attributes.message -%}
            ["{{- t -}}","{{- m -}}"]
            {%- if loop.last -%}]{%- endif -%}
          {%- endfor -%}
        alert: >-
          {%- for state in states.persistent_notification if state.state_with_unit|lower == 'notifying' and 'ALERT' in state.attributes.title -%}
            {%- if not loop.first -%},{% else %}[{%- endif -%}
            {%- set t = state.attributes.title -%}
            {%- set m = state.attributes.message -%}
            ["{{- t -}}","{{- m -}}"]
            {%- if loop.last -%}]{%- endif -%}
          {%- endfor -%}
        warn: >-
          {%- for state in states.persistent_notification if state.state_with_unit|lower == 'notifying' and 'WARN' in state.attributes.title -%}
            {%- if not loop.first -%},{% else %}[{%- endif -%}
            {%- set t = state.attributes.title -%}
            {%- set m = state.attributes.message -%}
            ["{{- t -}}","{{- m -}}"]
            {%- if loop.last -%}]{%- endif -%}
          {%- endfor -%}
        notice: >-
          {%- for state in states.persistent_notification if state.state_with_unit|lower == 'notifying' and 'NOTICE' in state.attributes.title -%}
            {%- if not loop.first -%},{% else %}[{%- endif -%}
            {%- set t = state.attributes.title -%}
            {%- set m = state.attributes.message -%}
            ["{{- t -}}","{{- m -}}"]
            {%- if loop.last -%}]{%- endif -%}
          {%- endfor -%}
        info: >-
          {%- for state in states.persistent_notification if state.state_with_unit|lower == 'notifying' and 'INFO' in state.attributes.title -%}
            {%- if not loop.first -%},{% else %}[{%- endif -%}
            {%- set t = state.attributes.title -%}
            {%- set m = state.attributes.message -%}
            ["{{- t -}}","{{- m -}}"]
            {%- if loop.last -%}]{%- endif -%}
          {%- endfor -%}
        count: >-
          {% set s = state_attr('binary_sensor.motion_notification','notifying') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' %}
            {% if s is string %}{% set s = s|from_json %}{% endif %}
            {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' %}
              {% set s = s|sum|int %}
              {% set n = states.persistent_notification|list|length|int %}
              {% if s > 0 and s <= n %}{{ s }}{% else %}{{ n }}{% endif %}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        all: >-
          {% set s = state_attr('binary_sensor.motion_notification','count') %}
          {% if s|int > 0 %}
            {{ '(' + s|string + '): ' }}
            {%- for state in states.persistent_notification if state.state_with_unit|lower == 'notifying' -%}
              {%- if loop.first -%}{%- else -%}{{- '; ' -}}{%- endif -%}
              {{ state.attributes.title }}
            {%- endfor -%}
          {%- else -%}None{%- endif -%} 
        title: >-
          {% if state_attr('binary_sensor.motion_notification','critical')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','critical')|length > 0
            and state_attr('binary_sensor.motion_notification','critical')|reject('none')|list|count > 0 -%}
            {{- state_attr('binary_sensor.motion_notification','critical')|last|first -}}
          {%- elif state_attr('binary_sensor.motion_notification','alert')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','alert')|length > 0
            and state_attr('binary_sensor.motion_notification','alert')|reject('none')|list|count > 0 -%}
            {{- state_attr('binary_sensor.motion_notification','alert')|last|first -}}
          {%- elif state_attr('binary_sensor.motion_notification','warn')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','warn')|length > 0
            and state_attr('binary_sensor.motion_notification','warn')|reject('none')|list|count > 0 -%}
            {{- state_attr('binary_sensor.motion_notification','notice')|last|first -}}
          {%- elif state_attr('binary_sensor.motion_notification','notice')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','notice')|length > 0
            and state_attr('binary_sensor.motion_notification','notice')|reject('none')|list|count > 0 -%}
            {{- state_attr('binary_sensor.motion_notification','notice')|last|first -}}
          {%- elif state_attr('binary_sensor.motion_notification','info')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','info')|length > 0
            and state_attr('binary_sensor.motion_notification','info')|reject('none')|list|count > 0 -%}
            {{- state_attr('binary_sensor.motion_notification','info')|last|first -}}
          {%- else -%}None{%- endif %} 
        message: >-
          {% if state_attr('binary_sensor.motion_notification','critical')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','critical')|length > 0
            and state_attr('binary_sensor.motion_notification','critical')|reject('none')|list|count > 0 -%}
            {{ state_attr('binary_sensor.motion_notification','critical')|last|last }}
          {%- elif state_attr('binary_sensor.motion_notification','alert')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','alert')|length > 0
            and state_attr('binary_sensor.motion_notification','alert')|reject('none')|list|count > 0 -%}
            {{ state_attr('binary_sensor.motion_notification','alert')|last|last }}
          {%- elif state_attr('binary_sensor.motion_notification','warn')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','warn')|length > 0
            and state_attr('binary_sensor.motion_notification','warn')|reject('none')|list|count > 0 -%}
            {{ state_attr('binary_sensor.motion_notification','warn')|last|last }}
          {%- elif state_attr('binary_sensor.motion_notification','notice')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','notice')|length > 0
            and state_attr('binary_sensor.motion_notification','notice')|reject('none')|list|count > 0 -%}
            {{ state_attr('binary_sensor.motion_notification','notice')|last|last }}
          {%- elif state_attr('binary_sensor.motion_notification','info')|lower != 'none'
            and state_attr('binary_sensor.motion_notification','info')|length > 0
            and state_attr('binary_sensor.motion_notification','info')|reject('none')|list|count > 0 -%}
            {{ state_attr('binary_sensor.motion_notification','info')|last|last }}
          {%- else -%}None{%- endif %} 
      icon_template: >-
        {% set s = state_attr('binary_sensor.motion_notification','count') %}
        {% if s is number and s|int > 0 %}{{ 'mdi:book' }}{% else %}{{ 'mdi:book-outline' }}{% endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_notification','title') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' %}
          {{ s|length > 0 }}
        {% else %}null{% endif %}
