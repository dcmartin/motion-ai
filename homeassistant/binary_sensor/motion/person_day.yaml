###
# binary_sensor/motion/person_day.yaml
###

- platform: template
  sensors:
    motion_person_day:
      friendly_name: 'Person day'
      icon_template: 'mdi:clock'
      attribute_templates:
        begin: >-
          {% if is_state('binary_sensor.motion_schedule_wakeup_detected','on') %}
            {{ state_attr('sensor.motion_schedule_wakeup_detected','timestamp') }}
          {% else %}
            {% set s = state_attr('input_datetime.motion_schedule_wakeup_end','timestamp') %}
            {{ s|float(0) + utcnow().replace(hour=0).replace(minute=0).replace(second=0)|as_timestamp }}
          {% endif %}
        end: >-
          {% if is_state('binary_sensor.motion_schedule_bedtime_detected','on') %}
            {{ state_attr('sensor.motion_schedule_bedtime_detected','timestamp') }}
          {% else %}
            {% set s = state_attr('input_datetime.motion_schedule_bedtime_end','timestamp') %}
            {{ s|float(0) + utcnow().replace(hour=0).replace(minute=0).replace(second=0)|as_timestamp + 86400 }}
          {% endif %}
        count: >-
          {{ states('sensor.motion_person_day_active_count') }}
        time: >-
          {{ states('sensor.motion_person_day_active_time') }}
      value_template: >-
        {% set end = state_attr('binary_sensor.motion_person_day','end')|float(0) %}
        {% set begin = state_attr('binary_sensor.motion_person_day','begin')|float(0) %}
        {% set now = utcnow().timestamp() %}
        {{ end > now > begin }}
