###
# homeassistant/binary_sensor/motion/person_activity.yaml
###

- platform: template
  sensors:
    motion_person_stationary:
      unique_id: motion_person_stationary
      friendly_name: 'Stationary'
      icon_template: >-
          {{- 'mdi:sofa-single' -}}
      value_template: >-
        {{ is_state('sensor.motion_person_device_activity','Stationary')
          and utcnow().timestamp() - states.sensor.motion_person_device_activity.last_updated|as_timestamp > states('input_number.motion_person_activity_expired') * 60 }}
    motion_person_cycling:
      unique_id: motion_person_cycling
      friendly_name: 'Cycling'
      icon_template: >-
          {{- 'mdi:bike' -}}
      value_template: >-
        {{ is_state('sensor.motion_person_device_activity','Cycling')
          and utcnow().timestamp() - states.sensor.motion_person_device_activity.last_updated|as_timestamp > states('input_number.motion_person_activity_expired') * 60 }}
    motion_person_walking:
      unique_id: motion_person_walking
      friendly_name: 'Walking'
      icon_template: >-
          {{- 'mdi:walk' -}}
      value_template: >-
        {{ is_state('sensor.motion_person_device_activity','Walking')
          and utcnow().timestamp() - states.sensor.motion_person_device_activity.last_updated|as_timestamp > states('input_number.motion_person_activity_expired') * 60 }}
    motion_person_automotive:
      unique_id: motion_person_automotive
      friendly_name: 'Automotive'
      icon_template: >-
          {{- 'mdi:car' -}}
      value_template: >-
        {{ is_state('sensor.motion_person_device_activity','Automotive')
          and utcnow().timestamp() - states.sensor.motion_person_device_activity.last_updated|as_timestamp > states('input_number.motion_person_activity_expired') * 60 }}
    motion_person_running:
      unique_id: motion_person_running
      friendly_name: 'Running'
      icon_template: >-
          {{- 'mdi:run' -}}
      value_template: >-
        {{ is_state('sensor.motion_person_device_activity','Running')
          and utcnow().timestamp() - states.sensor.motion_person_device_activity.last_updated|as_timestamp > states('input_number.motion_person_activity_expired') * 60 }}

- platform: template
  sensors:
    motion_person_stationary_today:
      unique_id: motion_person_stationary_today
      friendly_name: 'Stationary today'
      value_template: >-
        {% set today = states('sensor.motion_person_stationary_ratio_1d') %}
        {% set mean_1w = state_attr('sensor.motion_person_stationary_ratio_statistics_1w','mean') %}
        {% set count_1w = state_attr('sensor.motion_person_stationary_ratio_statistics_1w','count') %}
        {% set min_1w = state_attr('sensor.motion_person_stationary_ratio_statistics_1w','min_value') %}
        {% set stdev_1w = state_attr('sensor.motion_person_stationary_ratio_statistics_1w','standard_deviation') %}
        {{- today|float > (mean_1w|float - stdev_1w|float) -}}

## BAYESIAN

- platform: bayesian
  name: motion_person_detected_active
  prior: 0.5
  probability_threshold: 0.6
  observations:
    - platform: state
      entity_id: sensor.motion_person_detected_status
      prob_given_true: 0.7
      prob_given_false: 0.3
      to_state: 'on'
    - platform: state
      entity_id: sensor.motion_person_detected_status
      prob_given_true: 0.2
      prob_given_false: 0.5
      to_state: 'off'
    - platform: state
      entity_id: sensor.motion_person_detected_status
      prob_given_true: 0.6
      prob_given_false: 0.5
      to_state: 'expired'
    - platform: state
      entity_id: sensor.motion_person_detected_status
      prob_given_true: 0.0
      prob_given_false: 0.5
      to_state: 'unknown'
    - platform: state
      entity_id: binary_sensor.motion_detected_person_ago_high
      prob_given_true: 0.1
      prob_given_false: 0.8
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_detected_person_ago_low
      prob_given_true: 0.8
      prob_given_false: 0.1
      to_state: 'on'

- platform: bayesian
  name: motion_person_location_estimated_active
  prior: 0.5
  probability_threshold: 0.6
  observations:
    - platform: state
      entity_id: sensor.motion_person_location_estimated_status
      prob_given_true: 0.8
      prob_given_false: 0.2
      to_state: 'on'
    - platform: state
      entity_id: sensor.motion_person_location_estimated_status
      prob_given_true: 0.2
      prob_given_false: 0.5
      to_state: 'off'
    - platform: state
      entity_id: sensor.motion_person_location_estimated_status
      prob_given_true: 0.0
      prob_given_false: 0.5
      to_state: 'unknown'
    - platform: state
      entity_id: sensor.motion_person_location_estimated_status
      prob_given_true: 0.6
      prob_given_false: 0.5
      to_state: 'expired'
    - platform: state
      entity_id: binary_sensor.motion_person_location_estimated_movement_low_1d
      prob_given_true: 0.4
      prob_given_false: 0.6
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_location_estimated_velocity_low_1d
      prob_given_true: 0.4
      prob_given_false: 0.6
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_location_estimated_movement_high_1d
      prob_given_true: 0.8
      prob_given_false: 0.1
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_location_estimated_velocity_high_1d
      prob_given_true: 0.8
      prob_given_false: 0.1
      to_state: 'on'

- platform: bayesian
  name: motion_person_location_active
  prior: 0.5
  probability_threshold: 0.6
  observations:
    - platform: state
      entity_id: sensor.motion_person_location_status
      prob_given_true: 0.5
      prob_given_false: 0.1
      to_state: 'on'
    - platform: state
      entity_id: sensor.motion_person_location_status
      prob_given_true: 0.1
      prob_given_false: 0.5
      to_state: 'off'
    - platform: state
      entity_id: sensor.motion_person_location_status
      prob_given_true: 0.0
      prob_given_false: 0.5
      to_state: 'unknown'
    - platform: state
      entity_id: sensor.motion_person_location_status
      prob_given_true: 0.6
      prob_given_false: 0.5
      to_state: 'expired'
    - platform: state
      entity_id: binary_sensor.motion_person_location_movement_low_1d
      prob_given_true: 0.2
      prob_given_false: 0.7
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_location_velocity_low_1d
      prob_given_true: 0.2
      prob_given_false: 0.7
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_location_movement_high_1d
      prob_given_true: 0.7
      prob_given_false: 0.1
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_location_velocity_high_1d
      prob_given_true: 0.7
      prob_given_false: 0.1
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_stationary
      prob_given_true: 0.1
      prob_given_false: 0.5
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_cycling
      prob_given_true: 0.8
      prob_given_false: 0.1
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_walking
      prob_given_true: 0.8
      prob_given_false: 0.1
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_automotive
      prob_given_true: 0.8
      prob_given_false: 0.1
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_running
      prob_given_true: 0.8
      prob_given_false: 0.1
      to_state: 'on'

- platform: bayesian
  name: motion_person_active
  prior: 0.5
  probability_threshold: 0.7
  observations:
    - platform: state
      entity_id: binary_sensor.motion_person_detected_active
      prob_given_true: 0.8
      prob_given_false: 0.2
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_location_estimated_active
      prob_given_true: 0.7
      prob_given_false: 0.3
      to_state: 'on'
    - platform: state
      entity_id: binary_sensor.motion_person_location_active
      prob_given_true: 0.6
      prob_given_false: 0.4
      to_state: 'on'

## TREND - over 0.1 m/s over 3600 seconds (0.0000277777)

- platform: trend
  sensors:
    motion_person_active_trend_1h:
      entity_id: binary_sensor.motion_person_active
      attribute: probability
      sample_duration: 3600
      max_samples: 60
      min_gradient: 0.000028
      device_class: occupancy

- platform: template
  sensors:
    motion_person_active_trend_high_1h:
      friendly_name: Activity trending higher (1h)
      value_template: >-
        {{ state_attr('binary_sensor.motion_person_active_trend_1h','gradient')|float > state_attr('binary_sensor.motion_person_active_trend_1h','min_gradient')|float }}
    motion_person_active_trend_low_1h:
      friendly_name: Activity trending lower (1h)
      value_template: >-
        {{ state_attr('binary_sensor.motion_person_active_trend_1h','gradient')|float < 0 - state_attr('binary_sensor.motion_person_active_trend_1h','min_gradient')|float }}

## ACTIVITY

- platform: template
  sensors:
    motion_person_location_estimated_activity_low_1d:
      friendly_name: Activity low
      icon_template: 'mdi:priority-low'
      value_template: >-
        {{ is_state('binary_sensor.motion_person_location_estimated_movement_low_1d','on')
             and is_state('binary_sensor.motion_person_location_estimated_velocity_low_1d','on') }}
    motion_person_location_estimated_activity_high_1d:
      friendly_name: Activity high
      icon_template: 'mdi:priority-high'
      value_template: >-
        {{ is_state('binary_sensor.motion_person_location_estimated_movement_high_1d','on')
             and is_state('binary_sensor.motion_person_location_estimated_velocity_high_1d','on') }}

