###
# homeassistant/binary_sensor/occupancy.yaml
###

- platform: template
  sensors:
    motion_device_occupancy_required:
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_class','binary_sensors') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ 'occupancy' in s }}
        {% else %}unknown{% endif %}
    motion_device_occupancy_exist:
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_occupancy','total') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s|int(0) > 0 }}
        {% else %}unknown{% endif %}
    motion_device_occupancy_self_test:
      icon_template: 'mdi:gesture-tap-button'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_occupancy','controls') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            [{%- for i in s if '_self_test' in i.entity_id -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {%- else -%}none{%- endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_occupancy_self_test','entity_ids') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_occupancy_mute:
      icon_template: 'mdi:gesture-tap-button'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_occupancy','controls') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            [{%- for i in s if '_mute' in i.entity_id -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {%- else -%}none{%- endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_occupancy_mute','entity_ids') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_occupancy_unmute:
      icon_template: 'mdi:gesture-tap-button'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_occupancy','controls') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string and s is iterable and s|count > 0 -%}
            [{%- for i in s if '_unmute' in i.entity_id -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {%- else -%}none{%- endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_occupancy_unmute','entity_ids') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_occupancy_update:
      icon_template: 'mdi:update'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_occupancy','update') %}
          {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable and s|count > 0 %}
            [{%- for i in s -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {% else %}none{% endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_occupancy','update') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_occupancy_restart:
      icon_template: 'mdi:restart'
      attribute_templates:
        entity_ids: >-
          {% set s = state_attr('binary_sensor.motion_device_occupancy','restart') %}
          {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable and s|count > 0 %}
            [{%- for i in s -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- i.entity_id -}}"
            {%- endfor -%}]
          {% else %}none{% endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_occupancy','restart') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable %}
          {{- s|count|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_occupancy_test:
      device_class: 'problem'
      icon_template: 'mdi:alert-circle'
      attribute_templates:
        values: >-
          {% set s = state_attr('binary_sensor.motion_device_occupancy','test') %}
          {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable and s|count > 0 %}
            [{%- for i in s  -%}
              {%- if not loop.first -%},{%- endif -%}
              {% if i.state|lower == 'normal' %}0{% else %}1{% endif %}
            {%- endfor -%}]
          {% else %}none{% endif %}
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_occupancy_test','values') %}
        {% if s|lower != 'none' and  s|lower != 'unknown' and not s is string and s is iterable and s|count > 0 %}
          {{- s|sum|int(0) > 0 -}}
        {% else %}unknown{% endif %}
    motion_device_occupancy:
      friendly_name: Gas status
      device_class: 'occupancy'
      attribute_templates:
        last: >-
          {{- none -}}
        good: >-
          {% set g = state_attr('binary_sensor.motion_device_class','good') -%}
          {%- set b = state_attr('binary_sensor.motion_device_class','bad') -%}
          {%- if g|lower != 'none' and b|lower != 'none' -%}
            {%- if 'occupancy' in g -%}on{%- elif 'occupancy' in b -%}off{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        bad: >-
          {% set g = state_attr('binary_sensor.motion_device_class','good') -%}
          {%- set b = state_attr('binary_sensor.motion_device_class','bad') -%}
          {%- if g|lower != 'none' and b|lower != 'none' -%}
            {%- if 'occupancy' in b -%}on{%- elif 'occupancy' in g -%}off{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        alarm: >-
          {% set s = state_attr('binary_sensor.motion_device_class','alarm') -%}
          {%- if s|lower != 'none' -%}
            {%- if 'occupancy' in s -%}on{%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif %}
        ids: >-
          {{- 'unknown' -}}
        total: >-
          {{- 'unknown' -}}
        update: >-
          {{- 'unknown' -}}
        restart: >-
          {{- 'unknown' -}}
        controls: >-
          {{- 'unknown' -}}
        test: >-
          {{- 'unknown' -}}
        status: >-
          {{- 'unknown' -}}
        positive: >-
          {{- 'unknown' -}}
        negative: >-
          {{- 'unknown' -}}
      value_template: >-
        {# set through automation #}
        {{- 'unknown' -}}
