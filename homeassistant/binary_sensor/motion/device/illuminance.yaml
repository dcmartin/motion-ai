###
# homeassistant/binary_sensor/device/illuminance.yaml
###

- platform: template
  sensors:
    motion_device_illuminance_exist:
      attribute_templates:
        high: >-
          {% set s = state_attr('sensor.motion_device_illuminance','measurement') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and not s is string -%}
            {% set n = states('input_number.motion_device_illuminance_high')|float(0) %}
            [{% for i in s if 'entity_id' in i and states(i.entity_id)|float(n) > n -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- state_attr(i.entity_id,'friendly_name') }} at {{ states(i.entity_id)|int('unknown') -}}lx"
            {%- endfor -%}]
          {%- else -%}none{%- endif %}
        low: >-
          {% set s = state_attr('sensor.motion_device_illuminance','measurement') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and not s is string -%}
            {% set n = states('input_number.motion_device_illuminance_low')|float(0) %}
            [{% for i in s if 'entity_id' in i and states(i.entity_id)|float(n) < n -%}
              {%- if not loop.first -%},{%- endif -%}
              "{{- state_attr(i.entity_id,'friendly_name') }} at {{ states(i.entity_id)|int('unknown') -}}lx"
            {%- endfor -%}]
          {%- else -%}none{%- endif %}
      value_template: >-
        {% set s = state_attr('sensor.motion_device_illuminance','total') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ s|int(0) > 0 }}
        {% else %}unknown{% endif %}
    motion_device_illuminance_low:
      friendly_name: Low
      device_class: 'cold'
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_illuminance_exist','low') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
          {{ s|count > 0 }}
        {% else %}unknown{% endif %}
    motion_device_illuminance_high:
      friendly_name: High
      device_class: 'heat'
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_device_illuminance_exist','high') %}
        {% if s|lower != 'null' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and not s is string and s is iterable %}
          {{ s|count > 0 }}
        {% else %}unknown{% endif %}
