###
# homeassistant/sensor/omada.yaml
###

# {
#   "errorCode": 0,
#   "result": {
#     "apiVer": "2",
#     "configured": true,
#     "controllerVer": "4.1.5",
#     "supportApp": true,
#     "type": 1
#   }
# }

- platform: rest
  name: omada_info_rest
  scan_interval: 86400
  force_update: true
  json_attributes:
    - errorCode 
    - result
  resource_template: >-
    {% set s = state_attr('sensor.omada','url') %}
    {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|length > 0 %}
      {{- s + '/api/info' -}}
    {% else %}null{% endif %}
  value_template: >-
    {% if value_json is defined and 'errorCode' in value_json and 'result' in value_json %}
      {% if value_json.errorCode|int == 0 %}True{% else %}False{% endif %}
    {% else %}False{% endif %}

- platform: template
  sensors:
    omada:
      friendly_name: 'Omada controller'
      icon_template: 'mdi:lan'
      attribute_templates:
        url: >-
          {{ states('input_text.omada_url') }}
        username: >-
          {{ states('input_text.omada_username') }}
        password: >-
          {{ states('input_text.omada_password') }}
        api_version: >-
          {% set s = states('sensor.omada_info_rest') %}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' %}
            {{ state_attr('sensor.omada_info_rest','result').apiVer }}
          {% else %}null{% endif %}
        configured: >-
          {% set s = states('sensor.omada_info_rest') %}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' %}
            {{ state_attr('sensor.omada_info_rest','result').configured }}
          {% else %}null{% endif %}
        controller_version: >-
          {% set s = states('sensor.omada_info_rest') %}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' %}
            {{ state_attr('sensor.omada_info_rest','result').controllerVer }}
          {% else %}null{% endif %}
        support_app: >-
          {% set s = states('sensor.omada_info_rest') %}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' %}
            {{ state_attr('sensor.omada_info_rest','result').supportApp }}
          {% else %}null{% endif %}
        type: >-
          {% set s = states('sensor.omada_info_rest') %}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' %}
            {{ state_attr('sensor.omada_info_rest','result').type }}
          {% else %}null{% endif %}
      value_template: >-
        {{ states('sensor.omada_info_rest')|lower == 'true' %}

# {
#   "errorCode": 0,
#   "result": {
#     "currentPage": 1,
#     "currentSize": 10,
#     "data": [
#       {
#         "alertNum": 3,
#         "country": "United States",
#         "key": "Default",
#         "lan": false,
#         "lanDeviceConnectedNum": 0,
#         "lanDeviceDisconnectedNum": 0,
#         "lanGuestNum": 0,
#         "lanUserNum": 0,
#         "name": "CABIN",
#         "primary": true,
#         "wan": false,
#         "wlan": true,
#         "wlanDeviceConnectedNum": 10,
#         "wlanDeviceDisconnectedNum": 0,
#         "wlanDeviceIsolatedNum": 0,
#         "wlanGuestNum": 0,
#         "wlanUserNum": 58
#       }
#     ],
#     "totalRows": 1
#   }
# }

# - platform: rest
#   name: omada_sites_rest
#   scan_interval: 86400
#   force_update: true
#   json_attributes:
#   resource_template: >-
#     {% set s = states('sensor.omada_url') %}
#     {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|length > 0 %}
#       {{- s + '/api/info' -}}
#     {% else %}null{% endif %}
#   headers:
#     Cookie: >-
#       {{ 'TPEAP_SESSIONID=' + states('sensor.omada_cookie')|string }}
