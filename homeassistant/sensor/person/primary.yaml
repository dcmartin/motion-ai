###
# homeassistant/sensor/motion/person.yaml
###

# person

- platform: template
  sensors:
    motion_primary:
      unique_id: motion_primary
      friendly_name: 'Primary (ðŸ‘¸)'
      icon_template: 'mdi:account'
      attribute_templates:
        entity_picture: >-
          {% set s = state_attr('person.' + states('sensor.motion_primary'),'entity_picture') -%}
          {%- if s|lower != 'none' and s|lower != 'null' and s|lower != 'unavailable' and s|lower != 'unknown' -%}
            {{- s -}}
          {%- else -%}{{- '/local/images/icons/person.png' -}}{%- endif %}
        sensor: >-
          {% set sensor = 'none' %}
          {%- set s = states('sensor.motion_primary') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- set a = states.person|selectattr('attributes.id','search',s)|first -%}
            {%- set s = states.person[a.attributes.id] -%}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
              {%- set sensor = a.entity_id -%}
            {%- endif -%}
          {%- endif -%}
          {{- sensor }}
        name: >-
          {% set s = state_attr('sensor.motion_primary','sensor') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'friendly_name') }}
          {%- else -%}none{%- endif -%}
        device: >-
          {%- set s = states('sensor.motion_primary_device') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {{- 'device_tracker.' + s|string -}}
          {%- else -%}none{%- endif -%}
        status: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ states(s) }}
          {%- else -%}null{%- endif -%}
        latitude: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'latitude') }}
          {%- else -%}null{%- endif -%}
        longitude: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'longitude') }}
          {%- else -%}null{%- endif -%}
        gps_accuracy: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'gps_accuracy') }}
          {%- else -%}null{%- endif -%}
        altitude: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'altitude') }}
          {%- else -%}null{%- endif -%}
        vertical_accuracy: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'vertical_accuracy') }}
          {%- else -%}null{%- endif -%}
        summary: >-
          {% set s = states('sensor.motion_primary') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {%- set user = s|string -%}
            {%- set name = state_attr('sensor.motion_primary','name') -%}
            {%- set location = state_attr('sensor.motion_primary','location') -%}
            {%- if location|lower != 'none' -%}
              {{- name }} is at {{ location  -}}.
            {%- else -%}
              {{- name }} ({{- user -}}) location is unknown.
            {%- endif -%}
          {%- else -%}No primary{%- endif -%}
        location: >-
          {% set s = state_attr('sensor.motion_primary','device') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- if states(s)|lower == 'home' -%}
              {{ states(s)|upper }}
            {%- else -%}
              {%- set dt = s -%}
              {%- set dn = dt|replace('device_tracker.','') -%}
              {%- set s = states('sensor.' + dn + '_geocoded_location') -%}
              {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
                {{- s|string|replace('\n',' ') -}}
              {%- else -%}
                {%- set s = state_attr('device_tracker.' + dn,'latitude') -%}
                {%- if s|float(-1) > 0 -%}
                  {{- state_attr('device_tracker.' + dn,'source_type')|upper -}}: {{ '%0.4f'|format(state_attr('device_tracker.' + dn,'latitude')|float(0.0)) -}},{{- '%0.4f'|format(state_attr('device_tracker.' + dn,'longitude')|float(0.0)) -}}{{- ' Â±' -}}{{- state_attr('device_tracker.' + dn,'gps_accuracy') -}}m; {{ state_attr('device_tracker.' + dn,'altitude')|int(0) -}}{{- 'Â±' -}}{{- state_attr('device_tracker.' + dn,'vertical_accuracy')|int(0) -}}m
                {%- else -%}none{%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- else -%}none{%- endif -%}
      value_template: >-
        {{ states('sensor.motion_primary_calculator') }}

- platform: template
  sensors:
    motion_primary_calculator:
      value_template: >-
        {# test input_text #}
        {%- set s = states('input_text.motion_primary') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set a = states.person|selectattr('attributes.id','search',s)|first -%}
          {%- set s = states.person[a.attributes.id] -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- set p = a.entity_id -%}
          {%- endif -%}
        {%- endif -%}
        {# test input_select #}
        {%- if not p is defined %}
          {%- set s = states('input_select.motion_primary') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- set a = states.person|selectattr('attributes.id','search',s)|first -%}
            {%- set s = states.person[a.attributes.id] -%}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
              {%- set p = a.entity_id -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}
        {%- if p is defined %}
          {{- p|replace('person.','') -}}
        {%- else -%}none{%- endif -%}

- platform: template
  sensors:
    motion_primary_selected:
      value_template: >-
        {%- set s = states('input_select.motion_primary') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- s -}}
        {%- else -%}
          {%- set s = states.sensor.motion_primary_selected.state -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}none{%- endif -%}
        {%- endif -%}

# ago

- platform: template
  sensors:
    motion_primary_ago:
      unique_id: motion_primary_ago
      friendly_name: 'ðŸ‘¸ ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% set s = states('sensor.motion_primary') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
          {% set persons = states.person %}
          {%- if persons|list|count > 0 -%}
            {% set s = persons[s] %}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
              {% set s = s.last_updated %}
              {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
                {% set s = s|as_timestamp(0) %}
                {%- if s|int > 0 -%}
                  {% set p = '%0.1f'|format(utcnow().timestamp() - s) %}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif %}
        {%- if p is defined -%}
          {{- p -}}
        {%- else -%}null{%- endif %}
    motion_primary_ago_relative:
      unique_id: motion_primary_ago_relative
      friendly_name: 'Smartphone ago'
      icon_template: 'mdi:update'
      value_template: >-
        {% set s = states('sensor.motion_primary_ago') -%}
        {%- if s|float(0) > 0 -%}
          {{ (utcnow().timestamp() - s|float(0))|as_datetime|relative_time }}
        {% else -%}Pending{% endif %}
