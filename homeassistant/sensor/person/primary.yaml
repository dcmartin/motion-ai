###
# homeassistant/sensor/motion/person.yaml
###

# person

- platform: template
  sensors:
    motion_primary:
      unique_id: motion_primary
      friendly_name: 'Primary (ðŸ‘±)'
      icon_template: 'mdi:account'
      attribute_templates:
        entity_picture: >-
          {% set s = state_attr('person.' + states('sensor.motion_primary'),'entity_picture') -%}
          {%- if s|lower != 'none' and s|lower != 'null' and s|lower != 'unavailable' and s|lower != 'unknown' -%}
            {{- s -}}
          {%- else -%}{{- '/local/images/icons/person.png' -}}{%- endif %}
        sensor: >-
          {% set sensor = 'none' %}
          {%- set s = states('sensor.motion_primary_calculator') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {%- set sensor = 'person.' + s|string -%}
          {%- endif -%}
          {{- sensor }}
        name: >-
          {% set s = state_attr('sensor.motion_primary','sensor') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'friendly_name') }}
          {%- else -%}null{%- endif -%}
        device: >-
          {%- set s = states('sensor.motion_primary_device_calculator') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {{- s -}}
          {%- else -%}none{%- endif -%}
        status: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ states(s) }}
          {%- else -%}null{%- endif -%}
        latitude: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'latitude') }}
          {%- else -%}null{%- endif -%}
        longitude: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'longitude') }}
          {%- else -%}null{%- endif -%}
        gps_accuracy: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'gps_accuracy') }}
          {%- else -%}null{%- endif -%}
        altitude: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'altitude') }}
          {%- else -%}null{%- endif -%}
        vertical_accuracy: >-
          {% set s = state_attr('sensor.motion_primary','device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ state_attr(s,'vertical_accuracy') }}
          {%- else -%}null{%- endif -%}
      value_template: >-
        {%- set s = states('sensor.motion_primary_calculator') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
          {{- s -}}
        {%- else -%}none{%- endif -%}

# person

- platform: template
  sensors:
    motion_primary_selected:
      value_template: >-
        {%- set s = states('input_select.motion_primary') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- s -}}
        {%- else -%}
          {%- set s = states.sensor.motion_primary_selected.state -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}none{%- endif -%}
        {%- endif -%}

- platform: template
  sensors:
    motion_primary_calculator:
      value_template: >-
        {%- set s = states('input_text.motion_primary') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
         {%- set a = states.person|selectattr('attributes.id','search',s)|first -%}
         {%- set s = states.person[a.attributes.id] -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
           {%- set p = a.entity_id|replace('person.','') -%}
          {%- endif -%}
        {%- endif -%}
        {%- if p is defined %}
          {{- p -}}
        {%- else -%}
         {% set s = state_attr('sensor.motion_domain_person_status','ids') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s is iterable and s|length > 0 -%}
            {{- s|first -}}
          {%- else -%}none{%- endif -%}
        {%- endif -%}

# person_device

- platform: template
  sensors:
    motion_primary_device_selected:
      value_template: >-
        {%- set s = states('input_select.motion_primary_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- s -}}
        {%- else -%}
          {%- set s = states.sensor.motion_primary_device_selected.state -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}none{%- endif -%}
        {%- endif -%}

- platform: template
  sensors:
    motion_primary_device_calculator:
      value_template: >-
        {%- set s = states('input_text.motion_primary_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set a = 'device_tracker.' + s -%}
          {%- set s = states(a|string) -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- set p = a -%}
          {%- endif -%}
        {%- endif -%}
        {%- if not p is defined -%}
          {%- set s = states('sensor.motion_primary_device_selected') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- set a = 'device_tracker.' + s -%}
            {%- set s = states(a|string) -%}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
              {%- set p = a -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}
        {%- if p is defined %}
          {{- p -}}
        {%- else -%}
          {% set s = states('sensor.motion_primary') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {% set s = state_attr('person.' + s|string,'source') -%}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
              {{ s }}
            {%- else -%}none{%- endif -%}
          {%- else -%}none{%- endif -%}
        {%- endif -%}

# ago

- platform: template
  sensors:
    motion_primary_ago:
      unique_id: motion_primary_ago
      friendly_name: 'ðŸ‘± primary ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% set s = states('sensor.motion_primary') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
          {% set persons = states.person %}
          {%- if persons|list|count > 0 -%}
            {% set s = persons[s] %}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
              {% set s = s.last_updated %}
              {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
                {% set s = s|as_timestamp(0) %}
                {%- if s|int > 0 -%}
                  {% set p = '%0.1f'|format(utcnow().timestamp() - s) %}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif %}
        {%- if p is defined -%}
          {{- p -}}
        {%- else -%}null{%- endif %}
    motion_primary_ago_relative:
      unique_id: motion_primary_ago_relative
      friendly_name: 'Smartphone ago'
      icon_template: 'mdi:update'
      value_template: >-
        {% set s = states('sensor.motion_primary_ago') -%}
        {%- if s|float(0) > 0 -%}
          {{ (utcnow().timestamp() - s|float(0))|as_datetime|relative_time }}
        {% else -%}Pending{% endif %}
