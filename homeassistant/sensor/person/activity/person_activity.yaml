###
## sensor/motion/person_activity.yaml
###

- platform: template
  sensors:
    motion_person_active:
      friendly_name: 'Person active'
      icon_template: >-
        {{- 'mdi:tune-vertical' -}}
      attribute_templates:
        entity_picture: >-
          {{ '/local/images/icons/mixture.png' }}
        start: >-
          {# set through automation motion_person_active_on #}
          {{ None }}
        end: >-
          {# set through automation motion_person_active_off #}
          {{ None }}
        duration: >-
          {# set through automation motion_person_active_off #}
          {{ None }}
        level: >-
          {# set through automation motion_person_active_level #}
          {{ None }}
        rank: >-
          {# set through automation motion_person_active_rank #}
          {{ None }}
        last_night: >-
          {# set through automation motion_person_active_last_night #}
          {{ None }}
        last_day: >-
          {# set through automation motion_person_active_last_day #}
          {{ None }}
        probability: >-
          {# set through automation motion_person_active_on #}
          {{ None }}
        threshold: >-
          {# set through automation motion_person_active_on #}
          {{ None }}
        evidence: >-
          {# set through automation motion_person_active_on #}
          {{ None }}
        observations: >-
          {# set through automation motion_person_active_on #}
          {{ None }}
      value_template: >-
        {# set through automation #}
        {{ 'unknown' }}

- platform: template
  sensors:
    motion_person_activity_status:
      friendly_name: 'Person activity status'
      icon_template: >-
        {% set s = states('sensor.motion_person_active') %}
        {% if s|lower == 'off' or s|lower == 'none' or s|lower == 'none' or s|string|length == 0 %}{{- 'mdi:account-remove' -}}
        {% elif s|lower == 'on' and is_state('binary_sensor.motion_person_activity_expired','on') %}{{- 'mdi:account-arrow-down' -}}
        {% elif s|lower == 'on' %}{{- 'mdi:account-plus' -}}
        {% else %}{{- 'mdi:account-question-outline' -}}{% endif %}
      attribute_templates:
        evidence: >-
          {{ state_attr('sensor.motion_person_active','evidence') }}
      value_template: >-
        {% set s = states('sensor.motion_person_active') %}
        {% if s|lower == 'off' or s|lower == 'none' or s|lower == 'none' or s|string|length == 0 %}off
        {% elif s|lower == 'on' and is_state('binary_sensor.motion_person_activity_expired','on') %}expired
        {% elif s|lower == 'on' %}on
        {% else %}unknown{% endif %}
    motion_person_active_where:
      friendly_name: 'Person active where'
      icon_template: 'mdi:map-marker'
      value_template: >
        {% set s = state_attr('sensor.motion_person_active','id') %}
        {%- if s|lower != 'none' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|length > 0 -%}
          {{- s -}}
        {%- else -%}Pending{%- endif -%}
    motion_person_active_confidence:
      friendly_name: 'Person active confidence'
      unit_of_measurement: 'Î²'
      icon_template: 'mdi:beta'
      value_template: >-
        {{- None -}}
    motion_person_active_previous:
      friendly_name: 'Person active previous'
      icon_template: >-
        {{- 'mdi:tune-vertical' -}}
      attribute_templates:
        entity_picture: >-
          {{- '/local/images/icons/mixture.png' -}}
        velocity: 0.0
        movement: >-
          {{ 'unknown' }}
        interval: >-
          {{ 'unknown' }}
        timestamp: >-
          {{ 'unknown' }}
        latitude: >-
          {{ 'unknown' }}
        longitude: >-
          {{ 'unknown' }}
        confidence: >-
          {{ 'unknown' }}
        distance: >-
          {{ 'unknown' }}
        sensor: >-
          {{ 'unknown' }}
        zone: >-
          {{ 'unknown' }}
      value_template: >-
        {{ 'unknown' }}
    motion_person_active_level:
      friendly_name: 'Person active level'
      icon_template: >-
        {%- set s = state_attr('sensor.motion_person_active','rank') -%}
        {%- if s|lower == 'none' or s|lower == 'none' or s|lower == 'unknown' or s|lower == 'unavailable' -%}
          {{- 'mdi:account-question' -}}
        {%- elif s|lower == 'veryhigh' -%}
          {{- 'mdi:account-multiple-plus' -}}
        {%- elif s|lower == 'high' -%}
          {{- 'mdi:account-plus' -}}
        {%- elif s|lower == 'nominal' -%}
            {{- 'mdi:account-box' -}}
        {%- elif s|lower == 'low' -%}
          {{- 'mdi:account-minus' -}}
        {%- elif s|lower == 'verylow' -%}
          {{- 'mdi:account-multiple-minus' -}}
        {%- else -%}
          {{- 'mdi:account-clock' -}}
        {%- endif -%}
      value_template: >
        {% set s = state_attr('sensor.motion_person_active','level') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' -%}
          {{- s -}}
        {%- else -%}Pending{%- endif -%}

## person active_average

#- platform: template
#  sensors:
#    motion_person_active_average:
#      friendly_name: 'Active average'
#      icon_template: 'mdi:percent'
#      unit_of_measurement: '%'
#      value_template: >-
#        {# set through automation.motion_person_active_average_state #}
#        {{- None -}}

# active_average statistics

#- platform: statistics
#  name: motion_person_active_average_5m
#  entity_id: binary_sensor.motion_person_activity
#  state_characteristic: average_step
#  sampling_size: 60
#  max_age:
#    minutes: 5

#- platform: statistics
#  name: motion_person_active_average_15m
#  entity_id: binary_sensor.motion_person_activity
#  state_characteristic: average_step
#  sampling_size: 180
#  max_age:
#    minutes: 15

#- platform: statistics
#  name: motion_person_active_average_1h
#  entity_id: binary_sensor.motion_person_activity
#  state_characteristic: average_step
#  sampling_size: 720
#  max_age:
#    hours: 1

#- platform: statistics
#  name: motion_person_active_average_1d
#  entity_id: binary_sensor.motion_person_activity
#  state_characteristic: average_step
#  sampling_size: 2880
#  max_age:
#    days: 1

#- platform: statistics
#  name: motion_person_active_average_1w
#  entity_id: binary_sensor.motion_person_activity
#  state_characteristic: average_step
#  sampling_size: 20160
#  max_age:
#    days: 7

# quartiles

#- platform: statistics
#  name: motion_person_active_average_quartiles_1w
#  entity_id: sensor.motion_person_active_average
#  state_characteristic: quantiles
#  quantile_intervals: 4
#  quantile_method: exclusive
#  sampling_size: 10000
#  max_age:
#    days: 7

#- platform: statistics
#  name: motion_person_active_ago_quartiles_1w
#  entity_id: sensor.motion_person_active_ago
#  state_characteristic: quantiles
#  quantile_intervals: 4
#  quantile_method: inclusive
#  sampling_size: 10000
#  max_age:
#    days: 7

# history

- platform: history_stats
  name: motion_person_active_history_1w
  entity_id: binary_sensor.motion_person_activity
  state: 'on'
  type: ratio
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) - timedelta(days=7) }}'
  end: '{{ now() }}'

## ago

- platform: template
  sensors:
    motion_person_active_ago:
      unique_id: motion_person_active_ago
      friendly_name: 'ðŸ‘± active ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      attribute_templates:
        age: >-
          {%- set age = timedelta(days=30) -%}
          {{- age -}}
        min: >-
          {{ states('sensor.motion_person_active_ago_min') }}
        max: >-
          {{ states('sensor.motion_person_active_ago_max') }}
        mean: >-
          {{ states('sensor.motion_person_active_ago_mean') }}
        stdev: >-
          {{ states('sensor.motion_person_active_ago_stdev') }}
#        quartiles: >-
#          {{ states('sensor.motion_person_active_ago_quartiles_1w') }}
        oldest: >-
          {{ states('sensor.motion_person_active_ago_oldest') }}
        count: >-
          {{ states('sensor.motion_person_active_ago_count') }}
        coverage: >-
         {{ state_attr('sensor.motion_person_active_ago_oldest','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_person_active_ago_oldest','buffer_usage_ratio')|float(0) * 100 }}
        online: >-
          {{ states('sensor.motion_person_active_history_1w') }}
        relative: >-
          {% set s = states('sensor.motion_person_active_ago_measurement') %}
          {%- if s|float(-1) > 0 -%}
            {% set s = utcnow().timestamp() - s|float(0) %}
            {{ s|as_datetime|relative_time }}
          {% else -%}Pending{% endif %}
        markdown: >-
          {%- set coverage = state_attr('sensor.motion_person_active_ago','coverage') -%}
          {%- set oldest = state_attr('sensor.motion_person_active_ago','oldest') -%}
          {%- set age = state_attr('sensor.motion_person_active_ago','age') -%}
          {%- set online = state_attr('sensor.motion_person_active_ago','online') -%}
          {%- set current = state_attr('sensor.motion_person_active_ago','relative') -%}
          {%- if coverage|lower != 'none' and age|lower != 'none' and oldest|lower != 'none' -%}
            {%- set age = age|as_datetime -%}
            {%- set oldest = oldest|as_datetime -%}
            {%- set relative = oldest|relative_time -%}
            {%- set coverage = state_attr('sensor.motion_person_active_ago','coverage') -%}
            {%- set complete = age|lower != 'none' and oldest|lower != 'none' and oldest <= utcnow() - age %}
            Activity last updated {{ current }} ago; on-line {{ online -}}% over the past {{ relative -}}
            {%- if not complete -%}
              {{- ' (<i>statistics at ' + '%0.1f'|format(coverage) + '% of target</i>)' -}}
            {%- else -%}
              <ul>
              <li>Mean: {{ state_attr('sensor.motion_person_active_ago','mean') -}}</li>
              <li>Maximum: {{ state_attr('sensor.motion_person_active_ago','max') -}}</li>
              <li>Minimum: {{ state_attr('sensor.motion_person_active_ago','min') -}}</li>
              <li>Stdev: {{ state_attr('sensor.motion_person_active_ago','stdev') -}}</li>
              </ul>
            {%- endif -%}
          {%- elif current|lower != 'none' -%}
            Activity last updated {{ current -}} ago (warning: no statistics)
          {%- else -%}
            <h2>No activity statistics.</h2>
          {%- endif -%}
      value_template: >-
        {% set s = states('sensor.motion_person_active_ago_measurement') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' -%}
          {{ '%0.1f'|format(s|float(0.0)) }}
        {%- else -%}{{ None }}{%- endif -%}

# statistics

- platform: statistics
  name: motion_person_active_ago_oldest
  entity_id: sensor.motion_person_active_ago_count
  state_characteristic: datetime_oldest
  sampling_size: 14400
  max_age:
    days: 30

- platform: statistics
  name: motion_person_active_ago_count
  entity_id: sensor.motion_person_active_ago_measurement
  state_characteristic: count
  sampling_size: 14400
  max_age:
    days: 30

- platform: statistics
  name: motion_person_active_ago_mean
  entity_id: sensor.motion_person_active_ago_measurement
  state_characteristic: mean
  sampling_size: 14400
  max_age:
    days: 30

- platform: statistics
  name: motion_person_active_ago_min
  entity_id: sensor.motion_person_active_ago_measurement
  state_characteristic: value_min
  sampling_size: 14400
  max_age:
    days: 30

- platform: statistics
  name: motion_person_active_ago_max
  entity_id: sensor.motion_person_active_ago_measurement
  state_characteristic: value_max
  sampling_size: 14400
  max_age:
    days: 30

- platform: statistics
  name: motion_person_active_ago_stdev
  entity_id: sensor.motion_person_active_ago_measurement
  state_characteristic: standard_deviation
  sampling_size: 14400
  max_age:
    days: 30

- platform: statistics
  name: motion_person_active_ago_stdev_mean
  entity_id: sensor.motion_person_active_ago_stdev
  state_characteristic: mean
  sampling_size: 14400
  max_age:
    days: 30

## active_duration (on/off)

- platform: template
  sensors:
    motion_person_active_duration:
      friendly_name: 'Active duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% set s = states('sensor.motion_person_active_duration_measurement') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' -%}
          {{ '%0.1f'|format(s|float(0.0)) }}
        {%- else -%}None{%- endif -%}
    motion_person_active_duration_relative:
      friendly_name: 'Active duration'
      icon_template: 'mdi:clock'
      value_template: >-
        {% set s = states('sensor.motion_person_active_duration') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' -%}
          {%- set r = as_datetime(utcnow().timestamp() - s|float(0.0)) -%}
          {{- relative_time(r) -}}
        {%- else -%}None{%- endif -%}
    motion_person_active_duration_on:
      friendly_name: 'Active duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% if is_state('binary_sensor.motion_person_activity','on') %}
          {{ states('sensor.motion_person_active_duration')|float(none) }}
        {%- else -%}None{%- endif -%}
    motion_person_active_duration_off:
      friendly_name: 'Inactive duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% if is_state('binary_sensor.motion_person_activity','off') %}
          {{ states('sensor.motion_person_active_duration')|float(none) }}
        {%- else -%}None{%- endif -%}

- platform: statistics
  name: motion_person_active_duration_on_mean_1d
  entity_id: sensor.motion_person_active_duration_on
  state_characteristic: mean
  sampling_size: 720
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_duration_on_mean_1w
  entity_id: sensor.motion_person_active_duration_on
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_duration_off_mean_1d
  entity_id: sensor.motion_person_active_duration_off
  state_characteristic: mean
  sampling_size: 720
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_duration_off_mean_1w
  entity_id: sensor.motion_person_active_duration_off
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

### active_probability

#- platform: template
#  sensors:
#    motion_person_active_probability:
#      friendly_name: 'Active probability'
#      icon_template: 'mdi:percent'
#      unit_of_measurement: '%'
#      value_template: >
#        {# set through automation.motion_person_active_probability_state #}
#        {{- None -}}

# quartiles

#- platform: statistics
#  name: motion_person_active_probability_quartiles_1w
#  entity_id: sensor.motion_person_active_probability
#  state_characteristic: quantiles
#  quantile_intervals: 4
#  quantile_method: exclusive
#  sampling_size: 10000
#  max_age:
#    days: 7

# mean

#- platform: statistics
#  name: motion_person_active_probability_mean_5m
#  entity_id: sensor.motion_person_active_probability
#  state_characteristic: mean
#  sampling_size: 60
#  max_age:
#    minutes: 5

- platform: statistics
  name: motion_person_active_probability_mean_15m
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_active_probability_mean_1h
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_active_probability_mean_1d
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_probability_mean_1w
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 20160
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_probability_stdev_1w
  entity_id: sensor.motion_person_active_probability
  state_characteristic: standard_deviation
  sampling_size: 20160
  max_age:
    days: 7

### active_count

# 1 day

- platform: history_stats
  name: motion_person_active_count_history_stats_1d
  entity_id: binary_sensor.motion_person_activity
  state: 'on'
  type: count
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

- platform: history_stats
  name: motion_person_notactive_count_history_stats_1d
  entity_id: binary_sensor.motion_person_activity
  state: 'off'
  type: count
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

# statistics on history

- platform: statistics
  name: motion_person_active_count_mean_1d
  entity_id: sensor.motion_person_active_count_history_stats_1d
  state_characteristic: mean
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_count_max_1d
  entity_id: sensor.motion_person_active_count_history_stats_1d
  state_characteristic: value_max
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_count_stdev_1d
  entity_id: sensor.motion_person_active_count_1d
  state_characteristic: standard_deviation
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_count_oldest_1d
  entity_id: sensor.motion_person_active_count_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_count_mean_1d
  entity_id: sensor.motion_person_notactive_count_history_stats_1d
  state_characteristic: mean
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_count_max_1d
  entity_id: sensor.motion_person_notactive_count_history_stats_1d
  state_characteristic: value_max
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_count_stdev_1d
  entity_id: sensor.motion_person_notactive_count_1d
  state_characteristic: standard_deviation
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_count_oldest_1d
  entity_id: sensor.motion_person_notactive_count_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 1440
  max_age:
    days: 1

- platform: template
  sensors:
    motion_person_active_count_today:
      friendly_name: 'Active count today'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: 'h'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_active_count_history_stats_1d') }}
        coverage: >-
         {{ state_attr('sensor.motion_person_active_count_oldest_1d','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_person_active_count_oldest_1d','buffer_usage_ratio')|float(0) * 100 }}
        duration: >-
          {% set s = states('sensor.motion_person_active_count_oldest_1d') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}None{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_active_count_oldest_1d') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
        status: >-
          {%- set s = states('sensor.motion_person_active_count_oldest_1d') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {%- set s = utcnow().timestamp() - s|as_timestamp -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {{- ' (' + states('sensor.motion_person_active_count_history_stats_1d') + ')' -}}
          {%- else -%}Pending{%- endif -%}
        not: >-
          {%- set s = states('sensor.motion_person_notactive_count_history_stats_1d') -%}
          {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
            {{- s|float(0.0) -}}
          {%- else -%}None{%- endif -%}
      value_template: >
        {%- set s = states('sensor.motion_person_active_count_history_stats_1d') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
          {{- s|float(0.0) -}}
        {%- else -%}None{%- endif -%}

# 1 week

- platform: statistics
  name: motion_person_active_count_mean_1w
  entity_id: sensor.motion_person_active_count_history_stats_1d
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_count_count_1w
  entity_id: sensor.motion_person_active_count_history_stats_1d
  state_characteristic: count
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_count_max_1w
  entity_id: sensor.motion_person_active_count_history_stats_1d
  state_characteristic: value_max
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_count_oldest_1w
  entity_id: sensor.motion_person_active_count_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_count_stdev_1w
  entity_id: sensor.motion_person_active_count_history_stats_1d
  state_characteristic: standard_deviation
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_count_mean_1w
  entity_id: sensor.motion_person_notactive_count_history_stats_1d
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_count_count_1w
  entity_id: sensor.motion_person_notactive_count_history_stats_1d
  state_characteristic: count
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_count_max_1w
  entity_id: sensor.motion_person_notactive_count_history_stats_1d
  state_characteristic: value_max
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_count_oldest_1w
  entity_id: sensor.motion_person_notactive_count_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_count_stdev_1w
  entity_id: sensor.motion_person_notactive_count_history_stats_1d
  state_characteristic: standard_deviation
  sampling_size: 5040
  max_age:
    days: 7

- platform: template
  sensors:
    motion_person_active_count_week:
      friendly_name: 'Active count (1w)'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: 'h'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_active_count_count_1w') }}
        coverage: >-
         {{ state_attr('sensor.motion_person_active_count_oldest_1w','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_person_active_count_oldest_1w','buffer_usage_ratio')|float(0) * 100 }}
        duration: >-
          {% set s = states('sensor.motion_person_active_count_oldest_1w') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}None{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_active_count_oldest_1w') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
        status: >-
          {%- set s = states('sensor.motion_person_active_count_oldest_1w') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {%- set s = utcnow().timestamp() - s|as_timestamp -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {{- ' (' + states('sensor.motion_person_active_count_count_1w') + ')' -}}
          {%- else -%}Pending{%- endif -%}
        not: >
          {%- set s = states('sensor.motion_person_notactive_count_count_1w') -%}
          {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
            {{- s|float(0.0) -}}
          {%- else -%}None{%- endif -%}
      value_template: >
        {%- set s = states('sensor.motion_person_active_count_mean_1w') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
          {{- s|float(0.0) -}}
        {%- else -%}None{%- endif -%}

### active_time

# 1 day

- platform: history_stats
  name: motion_person_active_time_history_stats_1d
  entity_id: binary_sensor.motion_person_activity
  state: 'on'
  type: time
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

- platform: history_stats
  name: motion_person_notactive_time_history_stats_1d
  entity_id: binary_sensor.motion_person_activity
  state: 'off'
  type: time
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

# statistics on history

- platform: statistics
  name: motion_person_active_time_mean_1d
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_time_count_1d
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: count
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_time_max_1d
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_time_stdev_1d
  entity_id: sensor.motion_person_active_time_1d
  state_characteristic: standard_deviation
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_time_oldest_1d
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_mean_1d
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_count_1d
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: count
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_max_1d
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_stdev_1d
  entity_id: sensor.motion_person_notactive_time_1d
  state_characteristic: standard_deviation
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_oldest_1d
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 1440
  max_age:
    days: 1

- platform: template
  sensors:
    motion_person_active_time_today:
      friendly_name: 'Active time today'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: 'h'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_active_time_count_1d') }}
        coverage: >-
         {{ state_attr('sensor.motion_person_active_time_oldest_1d','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_person_active_time_oldest_1d','buffer_usage_ratio')|float(0) * 100 }}
        duration: >-
          {% set s = states('sensor.motion_person_active_time_oldest_1d') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}None{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_active_time_oldest_1d') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
        status: >-
          {%- set s = states('sensor.motion_person_active_time_oldest_1d') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {%- set s = utcnow().timestamp() - s|as_timestamp -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {{- ' (' + states('sensor.motion_person_active_time_history_stats_1d') + ')' -}}
          {%- else -%}Pending{%- endif -%}
        not: >
          {%- set s = states('sensor.motion_person_notactive_time_history_stats_1d') -%}
          {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
            {{- s|float(0.0) -}}
          {%- else -%}None{%- endif -%}
      value_template: >
        {%- set s = states('sensor.motion_person_active_time_history_stats_1d') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
          {{- s|float(0.0) -}}
        {%- else -%}None{%- endif -%}

# 1 week

- platform: statistics
  name: motion_person_active_time_mean_1w
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_time_count_1w
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: count
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_time_max_1w
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_time_oldest_1w
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_time_stdev_1w
  entity_id: sensor.motion_person_active_time_history_stats_1d
  state_characteristic: standard_deviation
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_mean_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_count_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: count
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_max_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_oldest_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_stdev_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: standard_deviation
  sampling_size: 5040
  max_age:
    days: 7

- platform: template
  sensors:
    motion_person_active_time_week:
      friendly_name: 'Active time (1w)'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: 'h'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_active_time_count_1w') }}
        coverage: >-
         {{ state_attr('sensor.motion_person_active_time_oldest_1w','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_person_active_time_oldest_1w','buffer_usage_ratio')|float(0) * 100 }}
        duration: >-
          {% set s = states('sensor.motion_person_active_time_oldest_1w') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}None{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_active_time_oldest_1w') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
        status: >-
          {%- set s = states('sensor.motion_person_active_time_oldest_1w') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {%- set s = utcnow().timestamp() - s|as_timestamp -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {{- ' (' + states('sensor.motion_person_active_time_history_stats_1w') + ')' -}}
          {%- else -%}Pending{%- endif -%}
        not: >-
          {%- set s = states('sensor.motion_person_notactive_time_mean_1w') -%}
          {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
            {{- s|float(0.0) -}}
          {%- else -%}None{%- endif -%}
      value_template: >
        {%- set s = states('sensor.motion_person_active_time_mean_1w') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
          {{- s|float(0.0) -}}
        {%- else -%}None{%- endif -%}

### active_15m

# 1 day

- platform: history_stats
  name: motion_person_active_15m_time_history_stats_1d
  entity_id: binary_sensor.motion_person_active_15m
  state: 'on'
  type: time
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

- platform: history_stats
  name: motion_person_notactive_time_history_stats_1d
  entity_id: binary_sensor.motion_person_active_15m
  state: 'off'
  type: time
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

# statistics on history

- platform: statistics
  name: motion_person_active_15m_time_mean_1d
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_15m_time_count_1d
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: count
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_15m_time_max_1d
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_15m_time_stdev_1d
  entity_id: sensor.motion_person_active_15m_time_1d
  state_characteristic: standard_deviation
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_15m_time_oldest_1d
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_mean_1d
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_count_1d
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: count
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_max_1d
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_stdev_1d
  entity_id: sensor.motion_person_notactive_time_1d
  state_characteristic: standard_deviation
  sampling_size: 1440
  max_age:
    days: 1

- platform: statistics
  name: motion_person_notactive_time_oldest_1d
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 1440
  max_age:
    days: 1

- platform: template
  sensors:
    motion_person_active_15m_time_today:
      friendly_name: 'Active_15m time today'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: 'h'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_active_15m_time_count_1d') }}
        coverage: >-
         {{ state_attr('sensor.motion_person_active_15m_time_oldest_1d','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_person_active_15m_time_oldest_1d','buffer_usage_ratio')|float(0) * 100 }}
        duration: >-
          {% set s = states('sensor.motion_person_active_15m_time_oldest_1d') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}None{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_active_15m_time_oldest_1d') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
        status: >-
          {%- set s = states('sensor.motion_person_active_15m_time_oldest_1d') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {%- set s = utcnow().timestamp() - s|as_timestamp -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {{- ' (' + states('sensor.motion_person_active_15m_time_history_stats_1d') + ')' -}}
          {%- else -%}Pending{%- endif -%}
        not: >-
          {%- set s = states('sensor.motion_person_notactive_time_history_stats_1d') -%}
          {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
            {{- s|float(0.0) -}}
          {%- else -%}None{%- endif -%}
      value_template: >
        {%- set s = states('sensor.motion_person_active_15m_time_history_stats_1d') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
          {{- s|float(0.0) -}}
        {%- else -%}None{%- endif -%}

# 1 week

- platform: statistics
  name: motion_person_active_15m_time_mean_1w
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_15m_time_count_1w
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: count
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_15m_time_max_1w
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_15m_time_oldest_1w
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_15m_time_stdev_1w
  entity_id: sensor.motion_person_active_15m_time_history_stats_1d
  state_characteristic: standard_deviation
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_mean_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_max_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_oldest_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_notactive_time_stdev_1w
  entity_id: sensor.motion_person_notactive_time_history_stats_1d
  state_characteristic: standard_deviation
  sampling_size: 5040
  max_age:
    days: 7

- platform: template
  sensors:
    motion_person_active_15m_time_week:
      friendly_name: 'Active_15m time (1w)'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: 'h'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_active_15m_time_count_1w') }}
        coverage: >-
         {{ state_attr('sensor.motion_person_active_15m_time_oldest_1w','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
         {{ state_attr('sensor.motion_person_active_15m_time_oldest_1w','buffer_usage_ratio')|float(0) * 100 }}
        duration: >-
          {% set s = states('sensor.motion_person_active_15m_time_oldest_1w') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}None{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_active_15m_time_oldest_1w') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
        status: >-
          {%- set s = states('sensor.motion_person_active_15m_time_oldest_1w') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'none' and s|string|length > 0 -%}
            {%- set s = utcnow().timestamp() - s|as_timestamp -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {{- ' (' + states('sensor.motion_person_active_15m_time_history_stats_1w') + ')' -}}
          {%- else -%}Pending{%- endif -%}
        not: >-
          {%- set s = states('sensor.motion_person_notactive_time_mean_1w') -%}
          {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
            {{- s|float(0.0) -}}
          {%- else -%}None{%- endif -%}
      value_template: >
        {%- set s = states('sensor.motion_person_active_15m_time_mean_1w') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'none' -%}
          {{- s|float(0.0) -}}
        {%- else -%}None{%- endif -%}
