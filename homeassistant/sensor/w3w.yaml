###
## sensor/motion/w3w.yaml
###

# {
#   "coordinates": {
#     "lat": 37.174981,
#     "lng": -121.816223
#   },
#   "country": "US",
#   "language": "en",
#   "map": "https://w3w.co/gangs.lovely.gossip",
#   "nearestPlace": "Seven Trees, California",
#   "square": {
#     "northeast": {
#       "lat": 37.174995,
#       "lng": -121.816206
#     },
#     "southwest": {
#       "lat": 37.174968,
#       "lng": -121.81624
#     }
#   },
#   "words": "gangs.lovely.gossip"
# }

- platform: template
  sensors:
    what3words_location:
      friendly_name: 'What3Words location'
      icon_template: >-
        {% if is_state('binary_sensor.what3words_location','on') %}
          {{- 'mdi:home-map-marker' -}}
        {% else %}{{- 'mdi:home-search' -}}{% endif %}
      attribute_templates:
        apikey: >-
          {% set s = states('input_text.what3words_apikey') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {{ s }}
          {% else %}null{% endif %}
        words: >-
          {% set s = states('input_text.what3words_location') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|length > 0 %}
            {{ ('[' + s|string|replace('///','"')|replace('.','","') + '"]')|from_json|default(null) }}
          {% else %}null{% endif %}
      value_template: >-
        {{ states('sensor.what3words_location_rest') }}

                
- platform: rest
  name: what3words_location_rest
  method: GET
  timeout: 30
  verify_ssl: false
  force_update: true
  scan_interval: 86400
  json_attributes:
    - coordinates
    - country
    - language
    - map
    - nearestPlace
    - square
    - words
    - error
  resource_template: >-
    {% set s = state_attr('binary_sensor.what3words_location','resource') %}
    {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|length == 3 %}
      {{ s }}
    {% else %}{{ 'https://api.what3words.com/v3/convert-to-coordinates' -}}{% endif %}
  value_template: >-
    {%- if value_json is defined and 'error' in value_json -%}
      {{- value_json.error.message -}}
    {%- else -%}
      {{ value_json is defined and 'coordinates' in value_json }}
    {%- endif -%}
