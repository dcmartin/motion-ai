###
# homeassistant/sensor/motion/person_location.yaml
###

- platform: template
  sensors:
    motion_person_location:
      unique_id: motion_person_location
      friendly_name: 'ðŸ‘± location'
      attribute_templates:
        entity_picture: >-
          {{ state_attr('person.' + states('sensor.motion_person'),'entity_picture')|default('/local/images/genie.png',true)  }}
        id: >-
          {{ state_attr('person.' + states('sensor.motion_person'),'id') }}
        user_id: >-
          {{ state_attr('person.' + states('sensor.motion_person'),'user_id') }}
        zone: >-
          {% if is_state('binary_sensor.motion_person_zones','on') %}
            {% set zones = state_attr('binary_sensor.motion_person_zones','zones') %}
            {% if zones|lower != 'unknown' and zones|lower != 'none' and zones|lower != 'unavailable' and zones is iterable and zones|length > 0 %}
              {% set clat = state_attr('person.' + states('sensor.motion_person'),'latitude') %}
              {% set clng = state_attr('person.' + states('sensor.motion_person'),'longitude') %}
              {% set s = closest(clat,clng,zones) %}
              {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' %}
                {% set d = distance(clat, clng, s) %}
                {% if d|lower != 'none' and d|lower != 'null' and d|lower != 'unknown' and d|lower != 'unavailable' and d|int is number and d|int < 40075 %}
                  {% set d = '%0.2f'|format(d|float * 1000) %}
                {% else %}{% set d = null %}{% endif %}
                {% set r = s.attributes.radius %}
                {{ '{"name":"' + s.attributes.friendly_name + '","radius":' + r|string + ',"entity_id":"' + s.entity_id + '","inside":' + (d|int < r|int)|lower + ',"distance":' + d|string + '}' }}
              {%- else -%}null{%- endif -%}
            {%- else -%}none{%- endif -%}
          {%- else -%}unknown{%- endif -%}
        latitude: >-
          {% set s = states('person.' + states('sensor.motion_person')) %}
          {% if s|lower != 'null' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
            {{ state_attr('person.' + states('sensor.motion_person'),'latitude') }}
          {% else %}
            {% set s = state_attr('sensor.motion_person_location','latitude') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
              {{ s }}
            {% else %}null{% endif %}
          {% endif %}
        longitude: >-
          {% set s = states('person.' + states('sensor.motion_person')) %}
          {% if s|lower != 'null' and s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
            {{ state_attr('person.' + states('sensor.motion_person'),'longitude') }}
          {% else %}
            {% set s = state_attr('sensor.motion_person_location','longitude') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
              {{ s }}
            {% else %}null{% endif %}
          {% endif %}
        distance: >-
          {% set s = states('person.' + states('sensor.motion_person')) %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' %}
            {% set clat = state_attr('person.' + states('sensor.motion_person'),'latitude') %}
            {% set clng = state_attr('person.' + states('sensor.motion_person'),'longitude') %}
            {% set s = distance('zone.home', clat, clng) %}
            {% if s|lower != 'none' and s|lower != 'null' and s|lower != 'unknown' and s|lower != 'unavailable' and s|int is number and s|int < 40075 %}
              {{- '%0.2f'|format(s|float * 1000) -}}
            {% else %}null{% endif %}
          {% else %}
            {% set s = states('sensor.motion_person_location') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' %}
              {% set clat = state_attr('sensor.motion_person_location','latitude') %}
              {% set clng = state_attr('sensor.motion_person_location','longitude') %}
              {% set s = distance('zone.home', clat, clng) %}
              {% if s|lower != 'none' and s|lower != 'null' and s|lower != 'unknown' and s|lower != 'unavailable' and s|int is number and s|int < 40075 %}
                {{- '%0.2f'|format(s|float * 1000) -}}
              {% else %}null{% endif %}
            {% else %}null{% endif %}
          {% endif %}
        gps_accuracy: >-
          {% set s = states('person.' + states('sensor.motion_person')) %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
            {{ state_attr('person.' + states('sensor.motion_person'),'gps_accuracy') }}
          {% else %}
            {% set s = state_attr('sensor.motion_person_location','gps_accuracy') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
              {{ s }}
            {% else %}null{% endif %}
          {% endif %}
        source: >-
          {% set s = states('person.' + states('sensor.motion_person')) %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
            {{ state_attr('person.' + states('sensor.motion_person'),'source') }}
          {% else %}
            {% set s = state_attr('sensor.motion_person_location','source') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
              {{ s }}
            {% else %}null{% endif %}
          {% endif %}
        confidence: >-
          {% set s = states('person.' + states('sensor.motion_person')) %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
            {% set a = state_attr('person.' + s|string,'gps_accuracy')|float %}
            {% set am = states('sensor.motion_person_location_accuracy_statistics_1d')|float %}
            {% set as = state_attr('sensor.motion_person_location_accuracy_statistics_1d','standard_deviation')|float %}
            {% set v = state_attr('sensor.motion_person_location_previous','velocity')|float %}
            {% set vm = states('sensor.motion_person_location_velocity_statistics_1d')|float %}
            {% set vs = state_attr('sensor.motion_person_location_velocity_statistics_1d','standard_deviation')|float %}
            {{ a, am, as, v, vm, vs }}
          {% else %}null{% endif %}
      icon_template: >-
        {{- 'mdi:map-marker' -}}
      value_template: >-
        {% set s = states('person.' + states('sensor.motion_person')) %}
        {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
          {{ s }}
        {% else %}
          {% set s = states('sensor.motion_person_location') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' %}
            {{ s }}
          {% else %}
           {{ 'unknown' }}
          {% endif %}
        {% endif %}
    motion_person_location_previous:
      unique_id: motion_person_location_previous
      friendly_name: 'ðŸ‘± previous location'
      attribute_templates:
        entity_picture: >-
          {{ state_attr('person.' + states('sensor.motion_person'),'entity_picture')|default('/local/images/map-marker.png',true)  }}
        velocity: 0.0
        movement: >-
          {{ 'unknown' }}
        interval: >-
          {{ 'unknown' }}
        timestamp: >-
          {{ 'unknown' }}
        latitude: >-
          {{ 'unknown' }}
        longitude: >-
          {{ 'unknown' }}
        confidence: >-
          {{ 'unknown' }}
        distance: >-
          {{ 'unknown' }}
        source: >-
          {{ 'unknown' }}
        zone: >-
          {{ 'unknown' }}
      icon_template: >-
        {{- 'mdi:map-marker' -}}
      value_template: >-
        {{ 'unknown' }}

## movement statistics

- platform: statistics
  name: motion_person_location_movement_statistics_1h
  entity_id: sensor.motion_person_movement_measurement
  sampling_size: 30
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_location_movement_statistics_2h
  entity_id: sensor.motion_person_movement_measurement
  sampling_size: 60
  max_age:
    hours: 2

- platform: statistics
  name: motion_person_location_movement_statistics_4h
  entity_id: sensor.motion_person_movement_measurement
  sampling_size: 120
  max_age:
    hours: 4

- platform: statistics
  name: motion_person_location_movement_statistics_8h
  entity_id: sensor.motion_person_movement_measurement
  sampling_size: 240
  max_age:
    hours: 8

- platform: statistics
  name: motion_person_location_movement_statistics_12h
  entity_id: sensor.motion_person_movement_measurement
  sampling_size: 360
  max_age:
    hours: 12 

- platform: statistics
  name: motion_person_location_movement_statistics_1d
  entity_id: sensor.motion_person_movement_measurement
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_location_movement_statistics_1w
  entity_id: sensor.motion_person_movement_measurement
  sampling_size: 5040
  max_age:
    hours: 168

# movement stdev

- platform: template
  sensors:
    motion_person_location_movement_stdev_1d:
      unit_of_measurement: m
      value_template: >-
        {{ state_attr('sensor.motion_person_location_movement_statistics_1d','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_movement_stdev_1d_statistics
  entity_id: sensor.motion_person_location_movement_stdev_1d
  sampling_size: 100
  max_age:
    hours: 24

- platform: template
  sensors:
    motion_person_location_movement_stdev_1w:
      unit_of_measurement: m
      value_template: >-
        {{ state_attr('sensor.motion_person_location_movement_statistics_1w','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_movement_stdev_1w_statistics
  entity_id: sensor.motion_person_location_movement_stdev_1w
  sampling_size: 1000
  max_age:
    hours: 168

## velocity statistics

- platform: statistics
  name: motion_person_location_velocity_statistics_1h
  entity_id: sensor.motion_person_velocity_measurement
  sampling_size: 30
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_location_velocity_statistics_2h
  entity_id: sensor.motion_person_velocity_measurement
  sampling_size: 60
  max_age:
    hours: 2

- platform: statistics
  name: motion_person_location_velocity_statistics_4h
  entity_id: sensor.motion_person_velocity_measurement
  sampling_size: 120
  max_age:
    hours: 4

- platform: statistics
  name: motion_person_location_velocity_statistics_8h
  entity_id: sensor.motion_person_velocity_measurement
  sampling_size: 240
  max_age:
    hours: 8

- platform: statistics
  name: motion_person_location_velocity_statistics_12h
  entity_id: sensor.motion_person_velocity_measurement
  sampling_size: 360
  max_age:
    hours: 12 

- platform: statistics
  name: motion_person_location_velocity_statistics_1d
  entity_id: sensor.motion_person_velocity_measurement
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_location_velocity_statistics_1w
  entity_id: sensor.motion_person_velocity_measurement
  sampling_size: 5040
  max_age:
    hours: 168

# velocity standard_deviation

- platform: template
  sensors:
    motion_person_location_velocity_stdev_1h:
      unit_of_measurement: 'm/s'
      value_template: >-
        {{ state_attr('sensor.motion_person_location_velocity_statistics_1h','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_velocity_stdev_1h_statistics
  entity_id: sensor.motion_person_location_velocity_stdev_1h
  sampling_size: 30
  max_age:
    hours: 1

- platform: template
  sensors:
    motion_person_location_velocity_stdev_2h:
      unit_of_measurement: 'm/s'
      value_template: >-
        {{ state_attr('sensor.motion_person_location_velocity_statistics_2h','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_velocity_stdev_2h_statistics
  entity_id: sensor.motion_person_location_velocity_stdev_2h
  sampling_size: 60
  max_age:
    hours: 2

- platform: template
  sensors:
    motion_person_location_velocity_stdev_4h:
      unit_of_measurement: 'm/s'
      value_template: >-
        {{ state_attr('sensor.motion_person_location_velocity_statistics_4h','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_velocity_stdev_4h_statistics
  entity_id: sensor.motion_person_location_velocity_stdev_4h
  sampling_size: 120
  max_age:
    hours: 4

- platform: template
  sensors:
    motion_person_location_velocity_stdev_8h:
      unit_of_measurement: 'm/s'
      value_template: >-
        {{ state_attr('sensor.motion_person_location_velocity_statistics_8h','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_velocity_stdev_8h_statistics
  entity_id: sensor.motion_person_location_velocity_stdev_8h
  sampling_size: 240
  max_age:
    hours: 8

- platform: template
  sensors:
    motion_person_location_velocity_stdev_12h:
      unit_of_measurement: 'm/s'
      value_template: >-
        {{ state_attr('sensor.motion_person_location_velocity_statistics_12h','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_velocity_stdev_12h_statistics
  entity_id: sensor.motion_person_location_velocity_stdev_12h
  sampling_size: 360
  max_age:
    hours: 12

- platform: template
  sensors:
    motion_person_location_velocity_stdev_1d:
      unit_of_measurement: 'm/s'
      value_template: >-
        {{ state_attr('sensor.motion_person_location_velocity_statistics_1d','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_velocity_stdev_1d_statistics
  entity_id: sensor.motion_person_location_velocity_stdev_1d
  sampling_size: 720
  max_age:
    hours: 24

- platform: template
  sensors:
    motion_person_location_velocity_stdev_1w:
      unit_of_measurement: 'm/s'
      value_template: >-
        {{ state_attr('sensor.motion_person_location_velocity_statistics_1w','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_velocity_stdev_1w_statistics
  entity_id: sensor.motion_person_location_velocity_stdev_1w
  sampling_size: 5040
  max_age:
    hours: 168

## accuracy statistics

- platform: statistics
  name: motion_person_location_accuracy_statistics_1h
  entity_id: sensor.motion_person_accuracy_measurement
  sampling_size: 30
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_location_accuracy_statistics_2h
  entity_id: sensor.motion_person_accuracy_measurement
  sampling_size: 60
  max_age:
    hours: 2

- platform: statistics
  name: motion_person_location_accuracy_statistics_4h
  entity_id: sensor.motion_person_accuracy_measurement
  sampling_size: 120
  max_age:
    hours: 4

- platform: statistics
  name: motion_person_location_accuracy_statistics_8h
  entity_id: sensor.motion_person_accuracy_measurement
  sampling_size: 240
  max_age:
    hours: 8

- platform: statistics
  name: motion_person_location_accuracy_statistics_12h
  entity_id: sensor.motion_person_accuracy_measurement
  sampling_size: 360
  max_age:
    hours: 12 

- platform: statistics
  name: motion_person_location_accuracy_statistics_1d
  entity_id: sensor.motion_person_accuracy_measurement
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_location_accuracy_statistics_1w
  entity_id: sensor.motion_person_accuracy_measurement
  sampling_size: 5040
  max_age:
    hours: 168

# accuracy stdev

- platform: template
  sensors:
    motion_person_location_accuracy_stdev_1d:
      unit_of_measurement: m
      value_template: >-
        {{ state_attr('sensor.motion_person_location_accuracy_statistics_1d','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_accuracy_stdev_1d_statistics
  entity_id: sensor.motion_person_location_accuracy_stdev_1d
  sampling_size: 100
  max_age:
    hours: 24

- platform: template
  sensors:
    motion_person_location_accuracy_stdev_1w:
      unit_of_measurement: m
      value_template: >-
        {{ state_attr('sensor.motion_person_location_accuracy_statistics_1w','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_accuracy_stdev_1w_statistics
  entity_id: sensor.motion_person_location_accuracy_stdev_1w
  sampling_size: 1000
  max_age:
    hours: 168

## distance statistics

- platform: statistics
  name: motion_person_location_distance_statistics_1h
  entity_id: sensor.motion_person_distance_measurement
  sampling_size: 30
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_location_distance_statistics_2h
  entity_id: sensor.motion_person_distance_measurement
  sampling_size: 60
  max_age:
    hours: 2

- platform: statistics
  name: motion_person_location_distance_statistics_4h
  entity_id: sensor.motion_person_distance_measurement
  sampling_size: 120
  max_age:
    hours: 4

- platform: statistics
  name: motion_person_location_distance_statistics_8h
  entity_id: sensor.motion_person_distance_measurement
  sampling_size: 240
  max_age:
    hours: 8

- platform: statistics
  name: motion_person_location_distance_statistics_12h
  entity_id: sensor.motion_person_distance_measurement
  sampling_size: 360
  max_age:
    hours: 12 

- platform: statistics
  name: motion_person_location_distance_statistics_1d
  entity_id: sensor.motion_person_distance_measurement
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_location_distance_statistics_1w
  entity_id: sensor.motion_person_distance_measurement
  sampling_size: 5040
  max_age:
    hours: 168

# distance stdev

- platform: template
  sensors:
    motion_person_location_distance_stdev_1d:
      unit_of_measurement: m
      value_template: >-
        {{ state_attr('sensor.motion_person_location_distance_statistics_1d','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_distance_stdev_1d_statistics
  entity_id: sensor.motion_person_location_distance_stdev_1d
  sampling_size: 100
  max_age:
    hours: 24

- platform: template
  sensors:
    motion_person_location_distance_stdev_1w:
      unit_of_measurement: m
      value_template: >-
        {{ state_attr('sensor.motion_person_location_distance_statistics_1w','standard_deviation')|float }}

- platform: statistics
  name: motion_person_location_distance_stdev_1w_statistics
  entity_id: sensor.motion_person_location_distance_stdev_1w
  sampling_size: 1000
  max_age:
    hours: 168
