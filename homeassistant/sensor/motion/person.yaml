###
# homeassistant/sensor/motion/person.yaml
###

# person

- platform: template
  sensors:
    motion_person:
      unique_id: motion_person
      friendly_name: 'Person (ðŸ‘±)'
      icon_template: 'mdi:account'
      attribute_templates:
        entity_picture: >-
          {% set s = state_attr('person.' + states('sensor.motion_person'),'entity_picture') -%}
          {%- if s|lower != 'none' and s|lower != 'null' and s|lower != 'unavailable' and s|lower != 'unknown' -%}
            {{- s -}}
          {%- else -%}{{- '/local/images/icons/person.png' -}}{%- endif %}
        sun: >-
          {{ states('sensor.motion_sun') }}
        wakeup: >-
          {{ states('sensor.motion_person_wakeup') }}
        bedtime: >-
          {{ states('sensor.motion_person_bedtime') }}
        sensor: >-
          {%- set s = states('sensor.motion_person_calculator') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {{- 'person.' + s|string -}}
          {%- else -%}none{%- endif -%}
        device: >-
          {% set s = states('sensor.motion_person_device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {% set s = states.device_tracker|list|selectattr("entity_id","==","device_tracker." + s)|list -%}
            {% if s is iterable and s|count > 0 %}
              {% set s = s|first %}
              {{ s.entity_id }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        status: >-
          {% set s = states('sensor.motion_person_device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {% set s = states.device_tracker|list|selectattr("entity_id","==","device_tracker." + s)|list -%}
            {% if s is iterable and s|count > 0 %}
              {% set s = s|first %}
              {{ states(s.entity_id) }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        latitude: >-
          {% set s = states('sensor.motion_person_device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {% set s = states.device_tracker|list|selectattr("entity_id","==","device_tracker." + s)|list -%}
            {% if s is iterable and s|count > 0 %}
              {% set s = s|first %}
              {{ state_attr(s.entity_id,'latitude') }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        longitude: >-
          {% set s = states('sensor.motion_person_device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {% set s = states.device_tracker|list|selectattr("entity_id","==","device_tracker." + s)|list -%}
            {% if s is iterable and s|count > 0 %}
              {% set s = s|first %}
              {{ state_attr(s.entity_id,'longitude') }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        gps_accuracy: >-
          {% set s = states('sensor.motion_person_device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {% set s = states.device_tracker|list|selectattr("entity_id","==","device_tracker." + s)|list -%}
            {% if s is iterable and s|count > 0 %}
              {% set s = s|first %}
              {{ state_attr(s.entity_id,'gps_accuracy') }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        altitude: >-
          {% set s = states('sensor.motion_person_device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {% set s = states.device_tracker|list|selectattr("entity_id","==","device_tracker." + s)|list -%}
            {% if s is iterable and s|count > 0 %}
              {% set s = s|first %}
              {{ state_attr(s.entity_id,'altitude') }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        vertical_accuracy: >-
          {% set s = states('sensor.motion_person_device') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {% set s = states.device_tracker|list|selectattr("entity_id","==","device_tracker." + s)|list -%}
            {% if s is iterable and s|count > 0 %}
              {% set s = s|first %}
              {{ state_attr(s.entity_id,'vertical_accuracy') }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      value_template: >-
        {%- set s = states('sensor.motion_person_calculator') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
          {{- s -}}
        {%- else -%}none{%- endif -%}
    motion_person_calculator:
      value_template: >-
        {%- set s = states('input_text.motion_person') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set p = s -%}
        {%- endif -%}
        {%- set s = states('input_select.motion_person') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'auto' -%}
          {%- set p = s -%}
        {%- endif -%}
        {%- set s = states('sensor.motion_person_selected') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'auto' -%}
          {%- set p = s -%}
        {%- endif -%}
        {%- if p is defined %}
          {{- p -}}
        {%- else -%}
          {% set s = state_attr('sensor.motion_domain_person_status','list') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s is iterable and s|length > 0 -%}
            {{- s|first -}}
          {%- else -%}none{%- endif -%}
        {%- endif -%}
    motion_persons:
      value_template: >-
        {% set s = state_attr('sensor.motion_domain_person_status','list') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s is iterable and s|count > 0 %}
          {%- for r in s if r|lower != 'null' -%}
            {%- if not loop.first -%},{%- endif -%}
            {{- r -}}
          {%- endfor -%}
        {% else %}Pending{% endif %}

# device

- platform: template
  sensors:
    motion_person_device:
      unique_id: motion_person_device
      friendly_name: 'Device (Smartphone)'
      icon_template: 'mdi:cellphone'
      attribute_templates:
        entity_picture: >-
          {% set s = state_attr('device_tracker.' + states('sensor.motion_person_device_calculator'),'entity_picture') -%}
          {%- if s|lower != 'none' and s|lower != 'null' and s|lower != 'unavailable' and s|lower != 'unknown' -%}
            {{- s -}}
          {%- else -%}{{- '/local/images/icons/smartphone.png' -}}{%- endif %}
        device_id: >-
          {{ device_id('device_tracker.' + states('sensor.motion_person_device_calculator')|string) 
        zone: >-
          {% set lat = state_attr('device_tracker.' + states('sensor.motion_person_device_calculator'),'latitude') -%}
          {% set lng = state_attr('device_tracker.' + states('sensor.motion_person_device_calculator'),'longitude') -%}
          {%- if lat|lower != 'null' and lng|lower != 'null' and lat|lower != 'none' and lng|lower != 'none' and is_state('binary_sensor.motion_person_zones','on') -%}
            {%- set zones = state_attr('binary_sensor.motion_person_zones','zones') -%}
            {%- if zones|lower != 'unknown' and zones|lower != 'none' and zones|lower != 'unavailable' and zones is iterable and zones|length > 0 -%}
              {%- set s = closest(lat,lng,zones) %}
              {%- if s|lower != 'none' and s.entity_id|lower != 'none' and s.entity_id|string in zones -%}
                {%- set d = distance(lat, lng, s) -%}
                {%- if d|lower != 'none' and d|lower != 'null' and d|lower != 'unknown' and d|lower != 'unavailable' and d|int(0) is number and d|int(0) < 40075 -%}
                  {%- set d = '%0.2f'|format(d|float(0.0) * 1000) -%}
                {%- else -%}{%- set d = null -%}{%- endif -%}
                {%- set r = s.attributes.radius|default(None) -%}
                {{- '{"name":"' + s.attributes.friendly_name + '","radius":' + r|string + ',"entity_id":"' + s.entity_id + '","inside":' + (d|int(0) < r|int(0))|string + ',"distance":' + d|string + '}' -}}
              {%- else -%}unknown{%- endif -%}
            {%- else -%}none{%- endif -%}
          {%- else -%}null{%- endif -%}
      value_template: >-
        {%- set s = states('sensor.motion_person_device_calculator') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
          {{- s -}}
        {%- else -%}none{%- endif -%}
    motion_person_device_calculator:
      value_template: >-
        {%- set s = states('sensor.motion_person_device_calculator_match') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% if s|string|length > 0 -%}
            {{- s -}}
          {%- else -%}
            {%- for state in states.device_tracker if states(state.entity_id)|lower != 'unavailable' and state_attr(state.entity_id,'source_type')|lower == 'gps' %}
              {% if loop.first %}{{- state.entity_id|replace ('device_tracker.','') -}}{% endif %}
            {%- endfor -%}
          {%- endif -%}
        {%- else -%}none{%- endif -%}
    motion_person_device_calculator_match:
      value_template: >-
        {%- set s = states('input_text.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
          {%- set p = s -%}
        {%- endif -%}
        {%- set s = states('input_select.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'auto' and s|string|length > 0 -%}
          {%- set p = s -%}
        {%- endif -%}
        {%- set s = states.sensor.motion_person_device.state -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'auto' and s|string|length > 0 -%}
          {%- set p = s -%}
        {%- endif -%}
        {%- set s = states('sensor.motion_person_device_selected') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'auto' and s|string|length > 0 -%}
          {%- set p = s -%}
        {%- endif -%}
        {%- if p is defined %}
          {{- p -}}
        {%- else -%}
          {%- set s = states('sensor.motion_person') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {%- for state in states.device_tracker if s in state.entity_id and states(state.entity_id)|lower != 'unavailable' and state_attr(state.entity_id,'source_type')|lower == 'gps' %}
              {% if loop.first %}{{- state.entity_id|replace ('device_tracker.','') -}}{% endif %}
            {%- endfor -%}
          {%- else -%}none{%- endif -%}
        {%- endif -%}

# selected

- platform: template
  sensors:
    motion_person_selected:
      value_template: >-
        {%- set s = states('input_select.motion_person') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'auto' -%}
          {{- s -}}
        {%- else -%}
          {%- set s = states.sensor.motion_person_selected.state -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}none{%- endif -%}
        {%- endif -%}
    motion_person_device_selected:
      value_template: >-
        {%- set s = states('input_select.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|lower != 'auto' -%}
          {{- s -}}
        {%- else -%}
          {%- set s = states.sensor.motion_person_device_selected.state -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}none{%- endif -%}
        {%- endif -%}

# zone calculator

- platform: template
  sensors:
    motion_person_zone:
      friendly_name: 'ðŸ‘± zone'
      icon_template: >-
        {{- 'mdi:map-marker-radius' -}}
      attribute_templates:
        entity_picture: >-
          {% if is_state('binary_sensor.motion_person_zones','on') -%}
            {% set s = state_attr('sensor.motion_person_device','zone') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and 'entity_id' in s %}
              {% set s = state_attr(s.entity_id,'entity_picture') %}
              {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' %}
                {% set p = s %}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}
          {{- p|default('/local/images/map-marker-radius.png',true) -}}
        entity_id: >-
          {% if is_state('binary_sensor.motion_person_zones','on') -%}
            {% set s = state_attr('sensor.motion_person_device','zone') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and 'entity_id' in s %}
              {{ s.entity_id }}
            {%- else -%}none{%- endif -%}
          {%- else -%}unknown{%- endif -%}
        name: >-
          {% if is_state('binary_sensor.motion_person_zones','on') -%}
            {% set s = state_attr('sensor.motion_person_device','zone') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and 'entity_id' in s %}
              {{ state_attr(s.entity_id,'friendly_name') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}unknown{%- endif -%}
        radius: >-
          {% if is_state('binary_sensor.motion_person_zones','on') -%}
            {% set s = state_attr('sensor.motion_person_device','zone') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and 'entity_id' in s %}
              {{ state_attr(s.entity_id,'radius') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}unknown{%- endif -%}
        latitude: >-
          {% if is_state('binary_sensor.motion_person_zones','on') -%}
            {% set s = state_attr('sensor.motion_person_device','zone') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and 'entity_id' in s %}
              {{ state_attr(s.entity_id,'latitude') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}unknown{%- endif -%}
        longitude: >-
          {% if is_state('binary_sensor.motion_person_zones','on') -%}
            {% set s = state_attr('sensor.motion_person_device','zone') %}
            {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and 'entity_id' in s %}
              {{ state_attr(s.entity_id,'longitude') }}
            {%- else -%}none{%- endif -%}
          {%- else -%}unknown{%- endif -%}
        status: >-
          {% if is_state('binary_sensor.motion_person_zones','on') -%}
            {%- set zone = state_attr('sensor.motion_person_device','zone') -%}
            {%- if zone|lower != 'unknown' and zone|lower != 'none' and zone|lower != 'unavailable' and zone|lower != 'null' and zone|length > 0 -%}
              {{ state_attr('person.' + states('sensor.motion_person'),'friendly_name')|string + ' is ' }}
              {%- if zone|lower != 'unknown' and zone|lower != 'none' and zone|lower != 'unavailable' and zone|lower != 'null' and zone|length > 0 -%}
                {%- if 'inside' in zone and zone.inside|lower == 'true' -%}
                  {{- 'at ' -}}
                {%- elif 'distance' in zone -%}
                  {%- set m = zone.distance -%}
                  {%- set unit = 'm' -%}
                  {%- if m|int(0) > 1000 -%}
                    {%- set m = '%0.2f'|format(m|float(0.0) / 1000) -%}
                    {%- set unit = 'km' -%}
                  {%- else -%}
                    {%- set m = '%0.f'|format(m) -%}
                  {%- endif -%}
                  {{- 'closest (' + m|string + unit + ') to ' -}}
                {%- else -%}
                  {{- 'not found for ' -}}
                {%- endif -%}
                {%- if 'entity_id' in zone -%}
                  {{- state_attr(zone.entity_id,'friendly_name') -}}
                {%- else -%}null{%- endif -%}
              {%- else -%}
                {{- 'not available' -}}
              {%- endif -%}
            {%- else -%}none{%- endif -%}
          {%- else -%}unknown{%- endif %}
      value_template: >-
        {% if is_state('binary_sensor.motion_person_zones','on') -%}
          {% set s = state_attr('sensor.motion_person_device','zone') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and 'entity_id' in s %}
            {{ s.entity_id|replace('zone.','') }}
          {%- else -%}none{%- endif -%}
        {%- else -%}unknown{%- endif -%}

# activity

- platform: template
  sensors:
    motion_person_device_activity:
      unique_id: motion_person_device_activity
      friendly_name: 'Smartphone activity'
      icon_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {% set s = states('sensor.' + s + '_activity')|lower %}
          {% if s == 'stationary' %}{{- 'mdi:sofa-single' -}}
          {% elif s == 'walking' %}{{- 'mdi:walk' -}}
          {% elif s == 'running' %}{{- 'mdi:run' -}}
          {% elif s == 'automotive' %}{{- 'mdi:car' -}}
          {% elif s == 'cycling' %}{{- 'mdi:bike' -}}
          {% else %}{{- 'mdi:crosshairs-question' -}}{% endif %}
        {% else %}{{- 'mdi:crosshairs-question' -}}{% endif %}
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_activity') }}
        {%- else -%}null{%- endif -%}

# battery

- platform: template
  sensors:
    motion_person_device_battery:
      unique_id: motion_person_device_battery
      friendly_name: 'Smartphone battery'
      icon_template: >-
        {%- if states('sensor.motion_person_device_battery_state')|lower == 'charging' %}
          {{- 'mdi:battery-charging' -}}
        {%- else %}
          {%- set s = states('sensor.motion_person_device_battery_level') %}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- if s|int(0) >= 75 %}
              {{- 'mdi:battery-high' -}}
            {%- elif s|int(0) >= 50 %}
              {{- 'mdi:battery-medium' -}}
            {%- elif s|int(0) >= 25 %}
              {{- 'mdi:battery-low' -}}
            {%- else %}
              {{- 'mdi:battery-outline' -}}
            {% endif %}
          {%- else %}
            {{- 'mdi:battery' -}}
          {% endif %}
        {% endif %}
      value_template: >-
        {%- if is_state('binary_sensor.motion_smartphone_powersave','on') -%}
            {{- 'Power-save mode' -}}
        {%- else -%}
          {%- set s = states('sensor.motion_person_device_battery_state') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}
            {{- 'Pending' -}}
          {%- endif -%}
        {%- endif -%}
        {%- set s = states('sensor.motion_person_device_battery_level') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- '; ' + s + '%' -}}
        {%- endif -%}

# human-reable location

- platform: template
  sensors:
    motion_person_device_location:
      unique_id: motion_person_device_location
      friendly_name: 'Smartphone location'
      icon_template: 'mdi:map'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ '%0.4f' | format(state_attr('device_tracker.' + s,'latitude')|float(0.0)) -}},
          {{- '%0.4f' | format(state_attr('device_tracker.' + s,'longitude')|float(0.0)) -}}
          {{- ' Â±' -}}
          {{- state_attr('device_tracker.' + s,'gps_accuracy') -}}m
          ({{- state_attr('device_tracker.' + s,'source_type')|upper -}});
          {{ state_attr('device_tracker.' + s,'altitude')|int(0) -}}
          {{- 'Â±' -}}
          {{- state_attr('device_tracker.' + s,'vertical_accuracy') -}}m
        {%- else -%}Pending{%- endif -%}

# device characteristics

- platform: template
  sensors:
    motion_person_device_focus:
      unique_id: motion_person_device_focus
      friendly_name: 'Smartphone focus'
      icon_template: 'mdi:minus-circle'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_focus') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_bssid:
      unique_id: motion_person_device_bssid
      friendly_name: 'Smartphone BSSID'
      icon_template: 'mdi:signal-cellular-outline'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_bssid') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_battery_state:
      unique_id: motion_person_device_battery_state
      friendly_name: 'Smartphone battery'
      icon_template: 'mdi:battery-outline'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_battery_state') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_connection_type:
      unique_id: motion_person_device_connection_type
      friendly_name: 'Smartphone connection'
      icon_template: 'mdi:cellphone-wireless'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_connection_type') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_geocoded_location:
      unique_id: motion_person_device_geocoded_location
      friendly_name: 'Smartphone geo-location'
      icon_template: 'mdi:map-marker'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_geocoded_location') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_last_update_trigger:
      unique_id: motion_person_device_last_update_trigger
      friendly_name: 'Smartphone last update'
      icon_template: 'mdi:alarm-check'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_last_update_trigger') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_ssid:
      unique_id: motion_person_device_ssid
      friendly_name: 'WiFi SSID'
      icon_template: 'mdi:wifi'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_ssid') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_storage:
      unique_id: motion_person_device_storage
      friendly_name: 'Smartphone storage available'
      icon_template: 'mdi:database'
      unit_of_measurement: 'â„€'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + s + '_storage') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_status:
      unique_id: motion_person_device_status
      friendly_name: 'Smartphone status'
      icon_template: 'mdi:cellphone'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- states('device_tracker.' + s) -}}
        {%- else -%}Pending{%- endif -%}
    motion_person_device_battery_level:
      unique_id: motion_person_device_battery_level
      friendly_name: 'Battery level'
      icon_template: 'mdi:battery'
      unit_of_measurement: 'ðŸ”‹'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'battery_level') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_source_type:
      unique_id: motion_person_device_source_type
      friendly_name: 'Smartphone source'
      icon_template: 'mdi:map'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'source_type') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_latitude:
      unique_id: motion_person_device_latitude
      friendly_name: 'Smartphone latitude'
      icon_template: 'mdi:latitude'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'latitude') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_longitude:
      unique_id: motion_person_device_longitude
      friendly_name: 'Smartphone longitude'
      icon_template: 'mdi:longitude'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'longitude') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_gps_accuracy:
      unique_id: motion_person_device_gps_accuracy
      friendly_name: 'Smartphone GPS accuracy (x,y)'
      icon_template: 'mdi:human'
      unit_of_measurement: 'm'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'gps_accuracy') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_altitude:
      unique_id: motion_person_device_altitude
      friendly_name: 'Smartphone altitude'
      icon_template: 'mdi:altimeter'
      unit_of_measurement: 'm'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'altitude') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_vertical_accuracy:
      unique_id: motion_person_device_vertical_accuracy
      friendly_name: 'Smartphone vertical accuracy (z)'
      icon_template: 'mdi:human'
      unit_of_measurement: 'm'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'vertical_accuracy') -}}
        {%- else -%}null{%- endif -%}
    motion_person_steps:
      unique_id: motion_person_steps
      friendly_name: 'Smartphone Steps'
      icon_template: 'mdi:foot-print'
      unit_of_measurement: 'ðŸ¦¶'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_steps') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}
    motion_person_pedometer_pace:
      unique_id: motion_person_pedometer_pace
      friendly_name: 'Pedometer pace'
      unit_of_measurement: 'm/s'
      icon_template: 'mdi:shoe-print'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + s + '_average_active_pace') }}
        {%- else -%}null{%- endif -%}
    motion_person_floors:
      unique_id: motion_person_floors
      friendly_name: 'Floors total'
      unit_of_measurement: 'â¬†â¬‡'
      icon_template: 'mdi:stairs'
      value_template: >-
        {{ states('sensor.motion_person_floors_ascended')|int(0) + states('sensor.motion_person_floors_descended')|int(0) }}
    motion_person_floors_ascended:
      unique_id: motion_person_floors_ascended
      friendly_name: 'Floors up'
      icon_template: 'mdi:stairs'
      unit_of_measurement: 'â¬†'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_floors_ascended') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}
    motion_person_floors_descended:
      unique_id: motion_person_floors_descended
      friendly_name: 'Floors down'
      unit_of_measurement: 'â¬‡'
      icon_template: 'mdi:stairs'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_floors_descended') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}
    motion_person_frontmost_app:
      unique_id: motion_person_frontmost_app
      friendly_name: 'Current app'
      icon_template: 'mdi:cellphone-play'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_frontmost_app') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}

# duration

- platform: template
  sensors:
    motion_person_weeks:
      value_template: >
        {%- set s = states('input_number.motion_person_weeks') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {{ s|int(0) -}}
        {%- else -%}{{- 1 -}}{%- endif -%}
    motion_person_weeks_timestamp:
      value_template: >
        {%- set s = states('sensor.motion_person_weeks') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {{ s|int(0) * 7 * 24 * 60 * 60 -}}
        {%- else -%}{{- 604800 -}}{%- endif -%}

# ago

- platform: template
  sensors:
    motion_person_ago:
      unique_id: motion_person_ago
      friendly_name: 'ðŸ‘± ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% set s = states('sensor.motion_person') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
          {% set persons = states.person %}
          {%- if persons|list|count > 0 -%}
            {% set s = persons[s] %}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
              {% set s = s.last_updated %}
              {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
                {% set s = s|as_timestamp(0) %}
                {%- if s|int > 0 -%}
                  {% set p = '%0.1f'|format(utcnow().timestamp() - s) %}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif %}
        {%- if p is defined -%}
          {{- p -}}
        {%- else -%}null{%- endif %}
    motion_person_ago_relative:
      unique_id: motion_person_ago_relative
      friendly_name: 'Smartphone ago'
      icon_template: 'mdi:update'
      value_template: >-
        {% set s = states('sensor.motion_person_ago') -%}
        {%- if s|float > 0 -%}
          {{ (utcnow().timestamp() - s|float)|as_datetime|relative_time }}
        {% else -%}Pending{% endif %}
    motion_person_device_ago_relative:
      unique_id: motion_person_device_ago_relative
      friendly_name: 'Smartphone ago'
      icon_template: 'mdi:update'
      value_template: >-
        {% set s = states('sensor.motion_person_device_ago') -%}
        {%- if s|float > 0 -%}
          {{ (utcnow().timestamp() - s|float)|as_datetime|relative_time }}
        {% else -%}Pending{% endif %}
    motion_person_device_ago:
      unique_id: motion_person_device_ago
      friendly_name: 'Smartphone ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {% set s = states('sensor.motion_person') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
          {%- set s = state_attr('sensor.motion_person','device') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {%- set s = states[s] -%}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
               {{ utcnow().timestamp() - s.last_updated|as_timestamp }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}
    motion_persons_ago:
      value_template: >-
        {% set s = state_attr('sensor.motion_domain_person_status','agos') -%}
        {% set s = states('sensor.motion_person_agos') -%}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s is iterable and s|count > 0 -%}
          {%- for r in s -%}
            {%- if not loop.first -%},{%- endif -%}
            {{- r -}}
          {%- endfor -%}
        {% else -%}Pending{% endif %}
 
# 1d

- platform: statistics
  name: motion_person_device_ago_mean_1d
  entity_id: sensor.motion_person_device_ago
  state_characteristic: mean
  sampling_size: 100
  max_age:
    days: 1

- platform: statistics
  name: motion_person_device_ago_min_1d
  entity_id: sensor.motion_person_device_ago
  state_characteristic: value_min
  sampling_size: 100
  max_age:
    days: 1

- platform: statistics
  name: motion_person_device_ago_max_1d
  entity_id: sensor.motion_person_device_ago
  state_characteristic: value_max
  sampling_size: 100
  max_age:
    days: 1

- platform: statistics
  name: motion_person_device_ago_stdev_1d
  entity_id: sensor.motion_person_device_ago
  state_characteristic: standard_deviation
  sampling_size: 100
  max_age:
    days: 1

# 1w

- platform: statistics
  name: motion_person_device_ago_mean_1w
  entity_id: sensor.motion_person_device_ago
  state_characteristic: mean
  sampling_size: 500
  max_age:
    days: 7

- platform: statistics
  name: motion_person_device_ago_min_1w
  entity_id: sensor.motion_person_device_ago
  state_characteristic: value_min
  sampling_size: 500
  max_age:
    days: 7

- platform: statistics
  name: motion_person_device_ago_max_1w
  entity_id: sensor.motion_person_device_ago
  state_characteristic: value_max
  sampling_size: 500
  max_age:
    days: 7

- platform: statistics
  name: motion_person_device_ago_stdev_1w
  entity_id: sensor.motion_person_device_ago
  state_characteristic: standard_deviation
  sampling_size: 500
  max_age:
    days: 7
