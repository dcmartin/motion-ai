###
# homeassistant/sensor/motion/person.yaml
###

- platform: template
  sensors:
    motion_person_online_array:
      value_template: >-
        [{%- for state in states.person -%}
          {%- if loop.first -%}{%- else -%},{%- endif -%}
          {%- set s = state.state_with_unit|lower -%}
          {%- if s != 'unknown' and s != 'unavailable' and s != 'null' and s != 'none' -%}1{%- else -%}0{%- endif -%}
        {%- endfor -%}]

- platform: template
  sensors:
    motion_person_list:
      value_template: >-
        [{%- for state in states.person -%}
          {%- if loop.first -%}{%- else -%},{%- endif -%}
          {%- set s = state.entity_id|replace ('person.','') -%}
          "{{- s -}}"
        {%- endfor -%}]

- platform: template
  sensors:
    motion_person_agos:
      value_template: >-
        [{%- for state in states.person -%}
          {%- if loop.first -%}{%- else -%},{%- endif -%}
          {%- set s = state.entity_id|replace ('person.','') -%}
          {{- (utcnow().timestamp() - as_timestamp(states.person[s].last_updated))|int -}}
        {%- endfor -%}]

- platform: template
  sensors:
    motion_persons:
      friendly_name: 'Persons (ðŸ‘±)'
      icon_template: 'mdi:folder-account'
      value_template: >-
        {% set s = states('sensor.motion_person_list') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set s = s|from_json %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s is iterable and s|count > 0 %}
            {%- for r in s -%}
              {%- if loop.first -%}{%- else -%},{%- endif -%}
              {{- r -}}
            {%- endfor -%}
          {% else %}None{% endif %}
        {% else %}Pending{% endif %}

- platform: template
  sensors:
    motion_persons_ago:
      friendly_name: 'ðŸ‘± ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {% set s = states('sensor.motion_person_agos') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set s = s|from_json %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s is iterable and s|count > 0 %}
            {%- for r in s -%}
              {%- if loop.first -%}{%- else -%},{%- endif -%}
              {{- r -}}
            {%- endfor -%}
          {% else %}None{% endif %}
        {% else %}Pending{% endif %}

- platform: template
  sensors:
    motion_person:
      friendly_name: 'Person (ðŸ‘±)'
      icon_template: 'mdi:csrd-account-details'
      value_template: >-
        {%- set s = states('input_text.motion_person') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s }}
        {% else %}
          {%- set s = states('sensor.motion_person_list') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {%- set s = s|from_json -%}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s is iterable and s|length > 0 -%}
              {{- s|first -}}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        {%- endif -%}
    motion_person_ago:
      friendly_name: 'ðŸ‘± ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {%- for state in states.person if state.entity_id|replace('person.','') == states('sensor.motion_person')|string -%}
          {%- if loop.first -%}{%- else -%},{%- endif -%}
          {%- set s = state.entity_id|replace ('person.','') -%}
          {{- (utcnow().timestamp() - as_timestamp(states.person[s].last_updated))|int -}}
        {%- endfor -%}
    motion_person_device:
      friendly_name: 'Device (ðŸ“±)'
      icon_template: 'mdi:card-account-phone'
      value_template: >-
        {%- set s = states('input_text.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s }}
        {% else %}
          {%- set s = states('input_select.motion_person_device') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{ s }}
          {% else %}
            {%- set s = states('sensor.motion_device_tracker_list') -%}
            {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
              {%- set s = s|from_json -%}
              {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s is iterable and s|length > 0 -%}
                {{- s|first -}}
              {%- else -%}null{%- endif -%}
            {%- else -%}null{%- endif -%}
          {%- endif -%}
        {%- endif -%}
    motion_person_device_activity:
      friendly_name: 'ðŸ‘± activity'
      icon_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {% set s = states('sensor.' + s + '_activity')|lower %}
          {% if s == 'stationary' %}{{- 'mdi:sofa-single' -}}
          {% elif s == 'walking' %}{{- 'mdi:walk' -}}
          {% elif s == 'running' %}{{- 'mdi:run' -}}
          {% elif s == 'automotive' %}{{- 'mdi:car' -}}
          {% elif s == 'cycling' %}{{- 'mdi:bike' -}}
          {% else %}{{- 'mdi:crosshairs-question' -}}{% endif %}
        {% else %}{{- 'mdi:crosshairs-question' -}}{% endif %}
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_activity') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_bssid:
      friendly_name: 'ðŸ“± BSSID'
      icon_template: 'mdi:signal-cellular-outline'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_basid') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_battery_state:
      friendly_name: 'ðŸ”‹ state'
      icon_template: 'mdi:battery'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_battery_state') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_connection_type:
      friendly_name: 'ðŸ“± connection'
      icon_template: 'mdi:cellphone-wireless'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_connection_type') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_geocoded_location:
      friendly_name: 'ðŸ“± location'
      icon_template: 'mdi:map-marker'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_geocoded_location') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_last_update_trigger:
      friendly_name: 'ðŸ“± trigger'
      icon_template: 'mdi:alarm-check'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_last_update_trigger') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_ssid:
      friendly_name: 'ðŸ“± SSID'
      icon_template: 'mdi:wifi'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + states('sensor.motion_person_device') + '_ssid') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_storage:
      friendly_name: 'ðŸ“± storage'
      icon_template: 'mdi:percent'
      unit_of_measurement: '%'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ states('sensor.' + s + '_storage') }}
        {%- else -%}null{%- endif -%}
    motion_person_device_status:
      friendly_name: 'ðŸ“± status'
      icon_template: 'mdi:account'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- states('device_tracker.' + s) -}}
        {%- else -%}Pending{%- endif -%}
    motion_person_device_battery_level:
      friendly_name: 'ðŸ”‹ level'
      icon_template: 'mdi:battery'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'battery_level') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_location:
      friendly_name: 'ðŸ“± location (ðŸ—º)'
      icon_template: 'mdi:map'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'source_type')|upper -}};
          [{{ '%0.4f' | format(state_attr('device_tracker.' + s,'latitude')|float) -}},
          {{- '%0.4f' | format(state_attr('device_tracker.' + s,'longitude')|float) -}}]
          {{- 'Â±' -}}
          {{- state_attr('device_tracker.' + s,'gps_accuracy') -}}m;
          at {{ state_attr('device_tracker.' + s,'altitude')|int -}}
          {{- 'Â±' -}}
          {{- state_attr('device_tracker.' + s,'vertical_accuracy') -}}m
        {%- else -%}Pending{%- endif -%}
    motion_person_device_source_type:
      friendly_name: 'ðŸ—º source'
      icon_template: 'mdi:map'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'source_type') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_latitude:
      friendly_name: 'ðŸ—º latitude'
      icon_template: 'mdi:latitude'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'latitude') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_longitude:
      friendly_name: 'ðŸ—º longitude'
      icon_template: 'mdi:longitude'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'longitude') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_gps_accuracy:
      friendly_name: 'ðŸ—º accuracy (x,y)'
      icon_template: 'mdi:human'
      unit_of_measurement: 'm'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'gps_accuracy') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_altitude:
      friendly_name: 'ðŸ—º altitude'
      icon_template: 'mdi:altimeter'
      unit_of_measurement: 'm'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'altitude') -}}
        {%- else -%}null{%- endif -%}
    motion_person_device_vertical_accuracy:
      friendly_name: 'ðŸ—º accuracy (z)'
      icon_template: 'mdi:human'
      unit_of_measurement: 'm'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{- state_attr('device_tracker.' + s,'vertical_accuracy') -}}
        {%- else -%}null{%- endif -%}
    motion_person_steps:
      friendly_name: 'ðŸ‘± steps'
      icon_template: 'mdi:walk'
      unit_of_measurement: 'steps'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_steps') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}
    motion_person_floors_ascended:
      friendly_name: 'ðŸ‘± floors up'
      icon_template: 'mdi:stairs'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_floors_ascended') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}
    motion_person_floors_descended:
      friendly_name: 'ðŸ‘± floors down'
      icon_template: 'mdi:stairs'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_floors_descended') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}
    motion_person_distance:
      friendly_name: 'ðŸ‘± distance'
      icon_template: 'mdi:walk'
      unit_of_measurement: 'm'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_distance') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}
    motion_person_frontmost_app:
      friendly_name: 'ðŸ‘± app'
      icon_template: 'mdi:cellphone-play'
      value_template: >-
        {%- set s = states('sensor.motion_person_device') -%}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {%- set s = states('sensor.' + s + '_frontmost_app') -%}
          {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
            {{- s -}}
          {%- else -%}null{%- endif -%}
        {%- else -%}null{%- endif -%}

- platform: template
  sensors:
    motion_person_ids:
      value_template: >-
        [{%- for state in states.person -%}
          {%- if loop.first -%}{%- else -%},{%- endif -%}
          {%- set s = state.entity_id|replace ('person.','') -%}
          {{- states.person[s].attributes.id -}}
        {%- endfor -%}]

- platform: template
  sensors:
    motion_person_count:
      friendly_name: Person count
      icon_template: 'mdi:counter'
      unit_of_measurement: 'ðŸ‘±'
      value_template: >-
        {{ states('sensor.motion_person_online_array')|from_json|length }}

- platform: template
  sensors:
    motion_person_count_online:
      friendly_name: Person on-line count
      icon_template: 'mdi:counter'
      unit_of_measurement: 'ðŸ‘±'
      value_template: >-
        {{ states('sensor.motion_person_online_array')|from_json|sum }}

- platform: template
  sensors:
    motion_person_count_offline:
      friendly_name: Person off-line count
      icon_template: 'mdi:counter'
      unit_of_measurement: 'ðŸ‘±'
      value_template: >-
        {{ states('sensor.motion_person_count')|int - states('sensor.motion_person_count_online')|int  }}

- platform: template
  sensors:
    motion_person_online_percent:
      friendly_name: Person on-line percent
      icon_template: 'mdi:account'
      unit_of_measurement: '%'
      value_template: >-
        {% set c = states('sensor.motion_person_count')|int %}
        {% if c > 0 %}
          {% set o = states('sensor.motion_person_count_online')|int %}
          {{ (o / c * 100)|int }}
        {% else %}null{% endif %}

- platform: template
  sensors:
    motion_person_online_status:
      friendly_name: Person on-line status 
      icon_template: 'mdi:account'
      value_template: >-
        {{ states('sensor.motion_person_count_online') -}}/{{- states('sensor.motion_person_count') }}ðŸ‘±;
        {{ states('sensor.motion_person_online_percent') -}}%

# percent statistics

- platform: statistics
  name: motion_person_online_percent_statistics
  entity_id: sensor.motion_person_online_percent
  sampling_size: 100
  max_age:
    hours: 72

- platform: template
  sensors:
    motion_person_online_percent_mean:
      friendly_name: Person confidence mean
      unit_of_measurement: '%'
      icon_template: 'mdi:account'
      value_template: >-
        {% if states('sensor.motion_person_online_percent_statistics') != 'unknown' %}
          {{ states.sensor.motion_person_online_percent_statistics.state|float }}
        {%- else -%}null{%- endif -%}
    motion_person_online_percent_min:
      friendly_name: Person confidence min
      unit_of_measurement: '%'
      icon_template: 'mdi:account'
      value_template: >-
        {% if states('sensor.motion_person_online_percent_statistics') != 'unknown' %}
          {{ states.sensor.motion_person_online_percent_statistics.attributes.min_value|int }}
        {%- else -%}null{%- endif -%}
    motion_person_online_percent_max:
      friendly_name: Person confidence max
      unit_of_measurement: '%'
      icon_template: 'mdi:account'
      value_template: >-
        {% if states('sensor.motion_person_online_percent_statistics') != 'unknown' %}
          {{ states.sensor.motion_person_online_percent_statistics.attributes.max_value|int }}
        {%- else -%}null{%- endif -%}
    motion_person_online_percent_stdev:
      friendly_name: Person confidence stdev
      unit_of_measurement: '%'
      icon_template: 'mdi:account'
      value_template: >
        {% if states('sensor.motion_person_online_percent_statistics') != 'unknown' %}
          {{ states.sensor.motion_person_online_percent_statistics.attributes.standard_deviation|float }}
        {%- else -%}null{%- endif -%}
    motion_person_online_percent_change:
      friendly_name: Person confidence change
      unit_of_measurement: 'Î”'
      icon_template: 'mdi:account'
      value_template: >
        {% if states('sensor.motion_person_online_percent_statistics') != 'unknown' %}
          {{ states.sensor.motion_person_online_percent_statistics.attributes.change|float }}
        {%- else -%}null{%- endif -%}
