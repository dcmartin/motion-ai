###
## sensor/motion/w3w.yaml
###

# {
#   "coordinates": {
#     "lat": 37.174981,
#     "lng": -121.816223
#   },
#   "country": "US",
#   "language": "en",
#   "map": "https://w3w.co/gangs.lovely.gossip",
#   "nearestPlace": "Seven Trees, California",
#   "square": {
#     "northeast": {
#       "lat": 37.174995,
#       "lng": -121.816206
#     },
#     "southwest": {
#       "lat": 37.174968,
#       "lng": -121.81624
#     }
#   },
#   "words": "gangs.lovely.gossip"
# }

- platform: rest
  name: motion_w3w_location_rest
  method: GET
  timeout: 30
  verify_ssl: false
  force_update: true
  scan_interval: 86400
  json_attributes:
    - coordinates
    - country
    - language
    - map
    - nearestPlace
    - square
    - words
  resource_template: >-
    {% set s = state_attr('binary_sensor.motion_w3w_location','words') %}
    {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|length == 3 %}
      {% set s = s[0]|string + '.' + s[1]|string + '.' + s[2]|string %}
      {% set url = 'https://api.what3words.com/v3/convert-to-coordinates?words=' + s %}
      {% set s = state_attr('binary_sensor..motion_w3w_location','apikey') %}
      {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|length > 0 %}
        {{ url + '&key=' + s }}
      {% else %}null{% endif %}
    {% else %}null{% endif %}
  value_template: >-
    {{ value_json is defined and 'coordinates' in value_json }}
