###
# homeassistant/sensor/motion/alarm.yaml
###

- platform: template
  sensors:
    motion_schedule_wake_undetected_alert_smartphone:
      value_template: >-
        {{ 'null' }}

- platform: history_stats
  name: motion_alarm_wake_interval_detect
  entity_id: binary_sensor.motion_alarm_wake_interval_detect
  #unit_of_measurement: 'ğŸ‘±'
  state: 'on'
  type: count
  start: >-
    {{ state_attr('input_datetime.motion_alarm_wake_begin','timestamp')|int }}
  end: >-
    {{ state_attr('input_datetime.motion_alarm_wake_end','timestamp')|int }}

- platform: statistics
  name: motion_alarm_wake_interval_detect_min
  entity_id: sensor.motion_alarm_wake_interval_detect
  state_characteristic: value_min
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_alarm_wake_interval_detect_mean
  entity_id: sensor.motion_alarm_wake_interval_detect
  state_characteristic: mean
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_alarm_wake_interval_detect_median
  entity_id: sensor.motion_alarm_wake_interval_detect
  state_characteristic: median
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_alarm_wake_interval_detect_max
  entity_id: sensor.motion_alarm_wake_interval_detect
  state_characteristic: value_mac
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_alarm_wake_interval_detect_oldest
  entity_id: sensor.motion_alarm_wake_interval_detect
  state_characteristic: datetime_oldest
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_alarm_wake_interval_detect_stdev
  entity_id: sensor.motion_alarm_wake_interval_detect
  state_characteristic: standard_deviation
  sampling_size: 100
  max_age:
    hours: 720

# days
- platform: template
  sensors:
    motion_schedule_wake_detected_days:
      friendly_name: 'Wake history'
      unit_of_measurement: days
      icon_template: 'mdi:calendar-account'
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected_oldest') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != null %}
          {{ (( utcnow().timestamp() - s|as_timestamp) / 86400)|int }}
        {%- else -%}null{%- endif -%}

# interval
- platform: template
  sensors:
    motion_alarm_wake_interval:
      friendly_name: 'Wake interval'
      icon_template: 'mdi:chart-timeline'
      value_template: >-
        {{- states('input_datetime.motion_alarm_wake_begin')|string|trim('00')|trim(':') + ' - ' + states('input_datetime.motion_alarm_wake_end')|string|string|trim('00')|trim(':') -}}

# begin
- platform: template
  sensors:
    motion_alarm_wake_begin:
      friendly_name: 'Wake time begin'
      icon_template: 'mdi:av-timer'
      value_template: >-
        {{ states('input_number.motion_alarm_wake_begin')|int }}

- platform: template
  sensors:
    motion_alarm_wake_begin_datetime:
      friendly_name: 'Wake datetime begin'
      icon_template: 'mdi:alarm'
      value_template: >-
        {% set s = states('input_number.motion_alarm_wake_begin')|int %}
        {% if s > 0 %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {{- '00:00:' + '%02d' % s -}}
            {% else %}
            {{- '00:' + '%02d' % m + ':' + '%02d' % s -}}
            {% endif %}
          {% else %}
            {{- '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -}}
          {% endif %}
        {%- else -%}{{- '00:00:00' -}}{%- endif -%}

# end
- platform: template
  sensors:
    motion_alarm_wake_end:
      friendly_name: 'Wake time end'
      icon_template: 'mdi:av-timer'
      value_template: >-
        {{ states('input_number.motion_alarm_wake_end')|int }}

- platform: template
  sensors:
    motion_alarm_wake_end_datetime:
      friendly_name: 'Wake datetime end'
      icon_template: 'mdi:alarm-check'
      value_template: >-
        {% set b = states('input_number.motion_alarm_wake_begin')|int %}
        {% set s = states('input_number.motion_alarm_wake_end')|int %}
        {% if s > 0 %}
          {% if s < b %}{% set s = b + state_attr('input_number.motion_alarm_wake_end','step')|int %}{% endif %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {{- '00:00:' + '%02d' % s -}}
            {% else %}
            {{- '00:' + '%02d' % m + ':' + '%02d' % s -}}
            {% endif %}
          {% else %}
            {{- '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -}}
          {% endif %}
        {%- else -%}{{- '00:00:00' -}}{%- endif -%}

## wake detected

- platform: template
  sensors:
    motion_schedule_wake_detected:
      friendly_name: 'Wake person detected'
      unit_of_measurement: 's'
      icon_template: 'mdi:av-timer'
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s != null and s|int > 0 %}
          {{ s|int }}
        {%- else -%}null{%- endif -%}

- platform: statistics
  name: motion_schedule_wake_detected_oldest
  entity_id: sensor.motion_schedule_wake_detected
  state_characteristic: datetime_oldest
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_schedule_wake_detected_mean
  entity_id: sensor.motion_schedule_wake_detected
  state_characteristic: mean
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_schedule_wake_detected_median
  entity_id: sensor.motion_schedule_wake_detected
  state_characteristic: median
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_schedule_wake_detected_stdev
  entity_id: sensor.motion_schedule_wake_detected
  state_characteristic: standard_deviation
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_schedule_wake_detected_min
  entity_id: sensor.motion_schedule_wake_detected
  state_characteristic: value_min
  sampling_size: 100
  max_age:
    hours: 720

- platform: statistics
  name: motion_schedule_wake_detected_max
  entity_id: sensor.motion_schedule_wake_detected
  state_characteristic: value_max
  sampling_size: 100
  max_age:
    hours: 720

# human readable
- platform: template
  sensors:
    motion_person_awake_ago_relative:
      value_template: >-
        {% set s = states('sensor.motion_person_awake_ago') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s != null and s|int > 0 %}
          {% set s = s|int %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {{- '00:00:' + '%02d' % s -}}
            {% else %}
            {{- '00:' + '%02d' % m + ':' + '%02d' % s -}}
            {% endif %}
          {% else %}
            {{- '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -}}
          {% endif %}
        {%- else -%}Pending{%- endif -%}
    motion_person_awake_ago:
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s != null and s|int > 0 %}
          {%- set s = now().replace(hour=0).replace(minute=0).replace(second=0).timestamp()|int + s|int %}
          {%- set s = now().timestamp()|int - s|int -%}
          {{ s|int }}
        {%- else -%}null{%- endif -%}
    motion_schedule_wake_detected_time:
      unique_id: motion_schedule_wake_detected_time
      friendly_name: 'Wake detected'
      icon_template: 'mdi:account-clock'
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s != null and s|int > 0 %}
          {% set s = s|int %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {%- set p = '00:00:' + '%02d' % s -%}
            {% else %}
              {%- set p = '00:' + '%02d' % m + ':' + '%02d' % s -%}
            {% endif %}
          {% else %}
            {%- set p = '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -%}
          {% endif %}
        {% else %}
          {% set s = states('sensor.motion_schedule_wake_detected_time') %}
          {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s != null and s|int > 0 %}
            {% set p = s %}
          {% endif %}
        {% endif %}
        {%- if p is defined -%}{{- p -}}{%- else -%}Pending{%- endif -%}

- platform: template
  sensors:
    motion_schedule_wake_detected_mean_time:
      friendly_name: 'Wake detected mean (Î¼)'
      icon_template: 'mdi:account-clock-outline'
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected_mean')|int %}
        {% if s > 0 %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {{- '00:00:' + '%02d' % s -}}
            {% else %}
            {{- '00:' + '%02d' % m + ':' + '%02d' % s -}}
            {% endif %}
          {% else %}
            {{- '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -}}
          {% endif %}
        {%- else -%}Pending{%- endif -%}
    motion_schedule_wake_detected_min_time:
      friendly_name: 'Wake detected min'
      icon_template: 'mdi:account-clock-outline'
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected_min')|int %}
        {% if s > 0 %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {{- '00:00:' + '%02d' % s -}}
            {% else %}
            {{- '00:' + '%02d' % m + ':' + '%02d' % s -}}
            {% endif %}
          {% else %}
            {{- '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -}}
          {% endif %}
        {%- else -%}Pending{%- endif -%}
    motion_schedule_wake_detected_max_time:
      friendly_name: 'Wake detected max'
      icon_template: 'mdi:account-clock-outline'
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected_max')|int %}
        {% if s > 0 %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {{- '00:00:' + '%02d' % s -}}
            {% else %}
            {{- '00:' + '%02d' % m + ':' + '%02d' % s -}}
            {% endif %}
          {% else %}
            {{- '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -}}
          {% endif %}
        {%- else -%}Pending{%- endif -%}
    motion_schedule_wake_detected_median_time:
      friendly_name: 'Wake detected median'
      icon_template: 'mdi:circle-half-full'
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected_median')|int %}
        {% if s > 0 %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {{- '00:00:' + '%02d' % s -}}
            {% else %}
            {{- '00:' + '%02d' % m + ':' + '%02d' % s -}}
            {% endif %}
          {% else %}
            {{- '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -}}
          {% endif %}
        {%- else -%}Pending{%- endif -%}
    motion_schedule_wake_detected_stdev_time:
      friendly_name: 'Wake detected stdev'
      icon_template: 'mdi:sigma-lower'
      value_template: >-
        {% set s = states('sensor.motion_schedule_wake_detected_stdev')|int %}
        {% if s > 0 %}
          {% set h = (s/3600)|int %}
          {% set m = ((s-(h*3600))/60)|int %}
          {% set s = (s % 60)|int %}
          {% if h < 1 %}
            {% if m < 1 %}
              {{- '00:00:' + '%02d' % s -}}
            {% else %}
            {{- '00:' + '%02d' % m + ':' + '%02d' % s -}}
            {% endif %}
          {% else %}
            {{- '%02d' % h + ':' + '%02d' % m + ':' + '%02d' % s -}}
          {% endif %}
        {%- else -%}Pending{%- endif -%}
