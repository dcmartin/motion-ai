###
# homeassistant/sensor/motion/person_home.yaml
###

- platform: template
  sensors:
    motion_person_home:
      unique_id: motion_person_home_status
      friendly_name: 'ðŸ‘± home'
      icon_template: >-
        {% if is_state('binary_sensor.motion_person_home','on') %}
          {{- 'mdi:home-variant' -}}
        {%- else %}
          {{- 'mdi:home-variant-outline' -}}
        {%- endif %}
      attribute_templates:
        age: >-
          {{ states('sensor.motion_person_weeks_timestamp')|float(None) }}
        count: >-
          [{{ states('sensor.motion_person_home_count_day') }},{{ states('sensor.motion_person_home_count_week') }}]
        time: >-
          [{{ states('sensor.motion_person_home_time_day') }},{{ states('sensor.motion_person_home_time_week') }}]
        total: >-
          [{{ state_attr('sensor.motion_person_home_count_week','total') }},{{ state_attr('sensor.motion_person_home_time_week','total') }}]
        history: >-
          {%- set d = utcnow().timestamp() -%}
          {%- set s = min(state_attr('sensor.motion_person_home_count_week','history')|as_timestamp(d),state_attr('sensor.motion_person_home_time_week','history')|as_timestamp(d)) -%}
          {%- if s|float(d) < d -%}
            {%- set s = utcnow().timestamp() - s|float(0.0) -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {%- set s = max(state_attr('sensor.motion_person_home_count_week','total')|int(0),state_attr('sensor.motion_person_home_time_week','total')|int(0)) -%}
            {{ '(' + s|string + ')' }}
          {%- else -%}Pending{%- endif -%}
        oldest: >-
          {% set d = utcnow().timestamp() %}
          {% set s = min(state_attr('sensor.motion_person_home_count_week','history')|as_timestamp(d),state_attr('sensor.motion_person_home_time_week','history')|as_timestamp(d)) %}
          {%- if s|float(d) < d -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
      value_template: >-
        {%- if is_state('binary_sensor.motion_person_home','on') -%}Home{%- else -%}Not home{%- endif -%}

## home_count

- platform: template
  sensors:
    motion_person_home_count_day:
      friendly_name: 'Home count (today)'
      icon_template: 'mdi:map'
      attribute_templates:
        start: >-
          {{ now().replace(hour=0).replace(minute=0).replace(second=0) }}
      value_template: >
        {%- set s = states('sensor.motion_person_home_count_history_stats_1d') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {{- s|int(0) -}}
        {%- else -%}null{%- endif -%}
    motion_person_home_count_week:
      friendly_name: 'Home count (1w)'
      icon_template: 'mdi:map'
      attribute_templates:
        start: >-
          {{ now().replace(hour=0).replace(minute=0).replace(second=0).timestamp()|int(0) - state_attr('sensor.motion_person_home','age')|int(0) }}
        min: >-
          {{ states('sensor.motion_person_home_count_min_1w') }}
        max: >-
          {{ states('sensor.motion_person_home_count_max_1w') }}
        mean: >-
          {{ states('sensor.motion_person_home_count_mean_1w') }}
        total: >-
          {{ states('sensor.motion_person_home_count_total_1w') }}
        stdev: >-
          {{ states('sensor.motion_person_home_count_stdev_1w') }}
        coverage: >-
          {{ state_attr('sensor.motion_person_home_count_oldest_1w','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
          {{ state_attr('sensor.motion_person_home_count_oldest_1w','buffer_usage_ratio')|float(0) * 100 }}
        history: >-
          {% set s = states('sensor.motion_person_home_count_oldest_1w') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}null{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_home_count_oldest_1w') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
      value_template: >-
        {% set s = states('sensor.motion_person_home_count_total_1w')|float(-1) %}
        {%- if s > 0 -%}{{ s }}{% else %}null{% endif %}

- platform: history_stats
  name: motion_person_home_count_history_stats_1d
  entity_id: binary_sensor.motion_person_home
  state: 'on'
  type: count
  start: >-
    {{ state_attr('sensor.motion_person_home_count_day','start')|float(None) }}
  end: '{{ now() }}'

- platform: history_stats
  name: motion_person_home_count_history_stats_1w
  entity_id: binary_sensor.motion_person_home
  state: 'on'
  type: count
  start: >-
    {{ state_attr('sensor.motion_person_home_count_week','start')|float(None) }}
  end: '{{ now() }}'

- platform: statistics
  name: motion_person_home_count_oldest_1w
  entity_id: sensor.motion_person_home_count_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_count_total_1w
  entity_id: sensor.motion_person_home_count_history_stats_1d
  state_characteristic: total
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_count_mean_1w
  entity_id: sensor.motion_person_home_count_history_stats_1d
  state_characteristic: mean
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_count_min_1w
  entity_id: sensor.motion_person_home_count_history_stats_1d
  state_characteristic: value_min
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_count_max_1w
  entity_id: sensor.motion_person_home_count_history_stats_1d
  state_characteristic: value_max
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_count_stdev_1w
  entity_id: sensor.motion_person_home_count_history_stats_1d
  state_characteristic: standard_deviation
  sampling_size: 10
  max_age:
    days: 7

## home_time

- platform: template
  sensors:
    motion_person_home_time_day:
      friendly_name: 'Home time (today)'
      icon_template: 'mdi:map'
      unit_of_measurement: 's'
      attribute_templates:
        start: >-
          {{ now().replace(hour=0).replace(minute=0).replace(second=0) }}
      value_template: >
        {%- set s = states('sensor.motion_person_home_time_history_stats_1d') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {{- s|int(0) -}}
        {%- else -%}null{%- endif -%}
    motion_person_home_time_week:
      friendly_name: 'Home time (1w)'
      icon_template: 'mdi:map'
      unit_of_measurement: 's'
      attribute_templates:
        start: >-
          {{ now().replace(hour=0).replace(minute=0).replace(second=0).timestamp()|int(0) - state_attr('sensor.motion_person_home','age')|int(0) }}
        min: >-
          {{ states('sensor.motion_person_home_time_min_1w') }}
        max: >-
          {{ states('sensor.motion_person_home_time_max_1w') }}
        mean: >-
          {{ states('sensor.motion_person_home_time_mean_1w') }}
        stdev: >-
          {{ states('sensor.motion_person_home_time_stdev_1w') }}
        coverage: >-
          {{ state_attr('sensor.motion_person_home_time_oldest_1w','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
          {{ state_attr('sensor.motion_person_home_time_oldest_1w','buffer_usage_ratio')|float(0) * 100 }}
        history: >-
          {% set s = states('sensor.motion_person_home_time_oldest_1w') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}null{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_home_time_oldest_1w') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
      value_template: >-
        {% set s = states('sensor.motion_person_home_time_total_1w')|float(-1) %}
        {%- if s > 0 -%}{{ s }}{% else %}null{% endif %}

- platform: history_stats
  name: motion_person_home_time_history_stats_1d
  entity_id: binary_sensor.motion_person_home
  state: 'on'
  type: time
  start: >-
    {{ state_attr('sensor.motion_person_home_time_day','start')|float(None) }}
  end: '{{ now() }}'

- platform: history_stats
  name: motion_person_home_time_history_stats_1w
  entity_id: binary_sensor.motion_person_home
  state: 'on'
  type: time
  start: >-
    {{ state_attr('sensor.motion_person_home_time_week','start')|float(None) }}
  end: '{{ now() }}'

- platform: statistics
  name: motion_person_home_time_oldest_1w
  entity_id: sensor.motion_person_home_time_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_time_total_1w
  entity_id: sensor.motion_person_home_time_history_stats_1d
  state_characteristic: total
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_time_mean_1w
  entity_id: sensor.motion_person_home_time_history_stats_1d
  state_characteristic: mean
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_time_min_1w
  entity_id: sensor.motion_person_home_time_history_stats_1d
  state_characteristic: value_min
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_time_max_1w
  entity_id: sensor.motion_person_home_time_history_stats_1d
  state_characteristic: value_max
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_home_time_stdev_1w
  entity_id: sensor.motion_person_home_time_history_stats_1d
  state_characteristic: standard_deviation
  sampling_size: 10
  max_age:
    days: 7

