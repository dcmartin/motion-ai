###
## homeassistant/sensor/motion/area.yaml
###

- platform: template
  sensors:
    motion_areas:
      unique_id: motion_areas
      friendly_name: 'Motion Area(s)'
      unit_of_measurement: count
      icon_template: >-
        {%- set s = states('sensor.motion_areas') -%}
        {%- if s|lower != 'none' and s|lower != 'null' and s|lower != 'unknown' and s|lower != 'unavailable' and s|int > 0 -%}
          {{- 'mdi:home-map-marker' -}}
        {%- else -%}
          {{- 'mdi:home-search' -}}
        {%- endif -%}
      attribute_templates:
        binary: >-
          [{%- for state in states.binary_sensor if 'binary_sensor.area_' in state.entity_id -%}
           {%- if not loop.first -%},{%- endif -%}
            "{{- state.entity_id -}}"
          {%- endfor -%}]
        switch: >-
          [{%- for state in states.switch if 'switch.area_' in state.entity_id -%}
           {%- if not loop.first -%},{%- endif -%}
            "{{- state.entity_id -}}"
          {%- endfor -%}]
        all: >-
          {%- set s = state_attr('sensor.motion_areas','binary') -%}
          {%- if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' -%}
            [{%- for state in s -%}
             {%- if not loop.first -%},{%- endif -%}
              "{{- state|string|replace('binary_sensor.area_','') -}}"
            {%- endfor -%}]
          {%- else -%}null{%- endif -%}
        areas: >-
          {%- set s = state_attr('sensor.motion_areas','switch') -%}
          {%- if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' -%}
            [{%- for state in s -%}
             {%- if not loop.first -%},{%- endif -%}
              "{{- state|string|replace('switch.area_presence_hold_','') -}}"
            {%- endfor -%}]
          {%- else -%}null{%- endif -%}
        groups: >-
          {%- set s = state_attr('sensor.motion_areas','all') -%}
          {%- if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' -%}
            {%- set all = s -%}
            {%- set s = state_attr('sensor.motion_areas','areas') -%}
            {%- if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' -%}
              {%- set areas = s -%}
              [{%- for i in all if not i in areas -%}
                {%- if not loop.first -%},{%- endif -%}
                "{{- i -}}"
              {%- endfor -%}]
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
        status: >-
          {%- set s = state_attr('sensor.motion_areas','binary') -%}
          {%- if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' -%}
            [{%- for i in s -%}
              {%- if not loop.first -%},{%- endif -%}
              {%- if is_state(i,'on') -%}1{%- else -%}0{%- endif -%}
            {%- endfor -%}]
          {%- else -%}null{%- endif -%}
      value_template: >-
        {%- set s = state_attr('sensor.motion_areas','all') -%}
        {%- if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s is iterable -%}
          {{ s|count }}
        {%- else -%}null{%- endif -%}
