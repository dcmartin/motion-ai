###
## sensor/motion/person_bedtime.yaml
###

- platform: template
  sensors:
    motion_person_bedtime:
      friendly_name: 'Person bedtime'
      icon_template: 'mdi:bed'
      unit_of_measurement: 'hours'
      attribute_templates:
        begin: >-
          {# default bedtime begin specified in seconds from midnight #}
          {{ states('input_number.motion_schedule_bedtime_begin') }}
        end: >-
          {# default bedtime end specified in seconds from midnight #}
          {{ states('input_number.motion_schedule_bedtime_end') }}
      value_template: >-
        {{ states('sensor.motion_person_bedtime_measurement') }}
    motion_person_night:
      friendly_name: 'Person night'
      icon_template: 'mdi:alarm'
      unit_of_measurement: 'hours'
      attribute_templates:
        start: >-
          {# calculated history_stats night start timestamp #}
          {% set s = state_attr('binary_sensor.motion_person_bedtime','begin') %}
          {% if not (s|lower != 'none' and s|float(0.0) > 0) %}
            {# default history_stats night start timestamp #}
            {% set s = state_attr('sensor.motion_schedule_bedtime','begin') %}
          {% endif %}
          {% if s|lower != 'none' %}
            {% set s = s|int + now().replace(hour=0).replace(minute=0).replace(second=0) %}
          {% endif %}
          {{ s }}
        end: >-
          {# calculated history_stats night end timestamp #} 
          {% set s = state_attr('binary_sensor.motion_person_bedtime','end') %}
          {% if not (s|lower != 'none' and s|float(0.0) > 0) %}
            {# default history_stats night end timestamp #} 
            {% set s = state_attr('sensor.motion_schedule_wakeup','end') %}
          {% endif %}
          {% if s|lower != 'none' %}
            {% set s = s|int + now().replace(hour=0).replace(minute=0).replace(second=0) %}
          {% endif %}
          {{ s }}
      value_template: >-
        {{ states('binary_sensor.motion_person_night') }}
    motion_person_bedtime_begin:
      value_template: >-
        {{ state_attr('sensor.motion_person_bedtime','begin') }}
    motion_person_bedtime_end:
      value_template: >-
        {{ state_attr('sensor.motion_person_bedtime','end') }}
    motion_person_bedtime_week:
      friendly_name: 'Person bedtime (1w)'
      icon_template: 'mdi:calendar-week'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_bedtime_count_1w') }}
        coverage: >-
          {{ state_attr('sensor.motion_person_bedtime_oldest_1w','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
          {{ state_attr('sensor.motion_person_bedtime_oldest_1w','buffer_usage_ratio')|float(0) * 100 }}
        duration: >-
          {% set s = states('sensor.motion_person_bedtime_oldest_1w') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}null{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_bedtime_oldest_1w') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
      value_template: >-
        {% set s = states('sensor.motion_person_bedtime_mean_1w')|float(-1) %}
        {%- if s > 0 -%}{{ s }}{% else %}null{% endif %}
    motion_person_bedtime_month:
      friendly_name: 'Person bedtime (1m)'
      icon_template: 'mdi:calendar-month'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_bedtime_count_1m') }}
        coverage: >-
          {{ state_attr('sensor.motion_person_bedtime_oldest_1m','age_coverage_ratio')|float(0) * 100 }}
        usage: >-
          {{ state_attr('sensor.motion_person_bedtime_oldest_1m','buffer_usage_ratio')|float(0) * 100 }}
        duration: >-
          {% set s = states('sensor.motion_person_bedtime_oldest_1m') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}null{%- endif -%}
        oldest: >-
          {% set s = states('sensor.motion_person_bedtime_oldest_1m') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {{ s|as_datetime|relative_time }}
          {%- else -%}Pending{%- endif -%}
      value_template: >-
        {% set s = states('sensor.motion_person_bedtime_mean_1m')|float(-1) %}
        {%- if s > 0 -%}{{ s }}{% else %}null{% endif %}

## history_stats

- platform: history_stats
  name: motion_person_active_count_night
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: count
  start: >-
    {{ state_attr('sensor.motion_person_night','start') }}
  end: >-
    {{ state_attr('sensor.motion_person_night','end') }}

- platform: history_stats
  name: motion_person_active_time_night
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: time
  start: >-
    {{ state_attr('sensor.motion_person_night','start') }}
  end: >-
    {{ state_attr('sensor.motion_person_night','end') }}

## statistics

# 1w

- platform: statistics
  name: motion_person_bedtime_mean_1w
  entity_id: sensor.motion_person_bedtime
  state_characteristic: mean
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_bedtime_count_1w
  entity_id: sensor.motion_person_bedtime
  state_characteristic: count
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_bedtime_oldest_1w
  entity_id: sensor.motion_person_bedtime
  state_characteristic: datetime_oldest
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_bedtime_min_1w
  entity_id: sensor.motion_person_bedtime
  state_characteristic: value_min
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_bedtime_max_1w
  entity_id: sensor.motion_person_bedtime
  state_characteristic: value_max
  sampling_size: 10
  max_age:
    days: 7

- platform: statistics
  name: motion_person_bedtime_stdev_1w
  entity_id: sensor.motion_person_bedtime
  state_characteristic: standard_deviation
  sampling_size: 10
  max_age:
    days: 7

# 1m

- platform: statistics
  name: motion_person_bedtime_mean_1m
  entity_id: sensor.motion_person_bedtime
  state_characteristic: mean
  sampling_size: 40
  max_age:
    days: 30

- platform: statistics
  name: motion_person_bedtime_count_1m
  entity_id: sensor.motion_person_bedtime
  state_characteristic: count
  sampling_size: 40
  max_age:
    days: 30

- platform: statistics
  name: motion_person_bedtime_oldest_1m
  entity_id: sensor.motion_person_bedtime
  state_characteristic: datetime_oldest
  sampling_size: 40
  max_age:
    days: 30

- platform: statistics
  name: motion_person_bedtime_min_1m
  entity_id: sensor.motion_person_bedtime
  state_characteristic: value_min
  sampling_size: 40
  max_age:
    days: 30

- platform: statistics
  name: motion_person_bedtime_max_1m
  entity_id: sensor.motion_person_bedtime
  state_characteristic: value_max
  sampling_size: 40
  max_age:
    days: 30

- platform: statistics
  name: motion_person_bedtime_stdev_1m
  entity_id: sensor.motion_person_bedtime
  state_characteristic: standard_deviation
  sampling_size: 40
  max_age:
    days: 30
