###
# homeassistant/sensor/current.yaml
###

- platform: template
  sensors:
    motion_current:
      unique_id: motion_current
      friendly_name: Current status
      device_class: 'current'
      unit_of_measurement: 'A'
      attribute_templates:
        ids: >-
          [{%- for state in states if 'device_class' in state.attributes and state.attributes.device_class=='current' and not '.motion_' in state.entity_id -%}
            {%- if not loop.first -%},{% endif -%}
            "{{- state.entity_id|replace('sensor.','')|regex_replace('_current$','') -}}"
          {%- endfor -%}]
        total: >-
          {% set s = state_attr('sensor.motion_current','ids') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and not s is string %}
            {{ s|count }}
          {%- else -%}0{%- endif %}
        sensors: >-
          {% set s = state_attr('sensor.motion_current','ids') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
            [{%- for i in s -%}
              {%- set o = loop -%}
              {%- for state in states if '.' + i + '_' in state.entity_id -%}
                {%- if not o.first or not loop.first -%},{%- endif -%}
                {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}"}
              {%- else -%}{% if o.first %}None{% endif %}{%- endfor -%}
            {%- endfor -%}]
          {%- else -%}null{%- endif %}
        measurement: >-
          {% set s = state_attr('sensor.motion_current','ids') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
            [{%- for i in s -%}
              {% set o = loop %}
              {%- for state in states.sensor if '.' + i + '_' in state.entity_id and state.attributes.device_class|default('null')|string == 'current' -%}
                {%- if not o.first or not loop.first -%},{%- endif -%}
                {%- set v = state.state -%}
                {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}"}
              {%- else -%}{% if o.first %}None{% endif %}{%- endfor -%}
            {%- endfor -%}]
          {%- else -%}null{%- endif %}
        update: >-
          {% set s = state_attr('sensor.motion_current','ids') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
            [{%- for i in s -%}
              {% set o = loop %}
              {%- for state in (states.button|list + states.switch|list) if '.' + i + '_' in state.entity_id and state.attributes.device_class|default('null')|string == 'update' -%}
                {%- if not o.first or not loop.first -%},{%- endif -%}
                {%- set v = state.state -%}
                {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}"}
              {%- endfor -%}
            {%- endfor -%}]
          {%- else -%}null{%- endif %}
        restart: >-
          {% set s = state_attr('sensor.motion_current','ids') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
            [{%- for i in s -%}
              {% set o = loop %}
              {%- for state in (states.button|list + states.switch|list) if '.' + i + '_' in state.entity_id and state.attributes.device_class|default('null')|string == 'restart' -%}
                {%- if not o.first or not loop.first -%},{%- endif -%}
                {%- set v = state.state -%}
                {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}"}
              {%- endfor -%}
            {%- endfor -%}]
          {%- else -%}null{%- endif %}
        controls: >-
          {% set s = state_attr('sensor.motion_current','ids') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and not s is string -%}
            [{%- for i in s -%}
              {% set o = loop %}
              {%- for state in (states.button|list + states.switch|list) if '.' + i + '_' in state.entity_id and state.attributes.device_class|default('null')|string == 'null' -%}
                {%- if not o.first or not loop.first -%},{%- endif -%}
                {%- set v = state.state -%}
                {%- set ctl = state.entity_id|regex_replace('^.*\.'+i+'_','') -%}
                {"id":"{{- i -}}","entity_id":"{{- state.entity_id -}}","control":"{{- ctl -}}"}
              {%- endfor -%}
            {%- endfor -%}]
          {%- else -%}null{%- endif %}
        areas: >-
          {% set s = state_attr('sensor.motion_current','measurement') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and not s is string -%}
            [{% for i in s if 'entity_id' in i and not i.entity_id is none -%}
              {%- if not loop.first -%},{%- endif -%}
              {"area":"{{- area_id(i.entity_id) -}}","value":{{- states(i.entity_id)|float(none) -}}}
            {%- endfor -%}]
          {%- else -%}null{%- endif %}
        values: >-
          {% set s = state_attr('sensor.motion_current','measurement') %}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and not s is string -%}
            [{% for i in s -%}
              {%- if not loop.first -%},{%- endif -%}
              {{- states(i.entity_id)|float(None) -}}
            {%- endfor -%}]
          {%- else -%}null{%- endif %}
        min: >-
          {% set s = state_attr('sensor.motion_current','values') %}
          {% if s|lower != 'none' and not s is string %}
            {% set s = s|select('number')|default('null') %}
            {% if s|lower != 'null' %}
              {{ s|min }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
        max: >-
          {% set s = state_attr('sensor.motion_current','values') %}
          {% if s|lower != 'none' and not s is string %}
            {% set s = s|select('number')|default('null') %}
            {% if s|lower != 'null' %}
              {{ s|max }}
            {% else %}null{% endif %}
          {% else %}null{% endif %}
      value_template: >-
        {% set s = state_attr('sensor.motion_current','values') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' %}
          {% set s = s|select('number')|default('null') %}
          {% if s|lower != 'null' %}
            {{ s|average }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
