###
## sensor/motion/sun.yaml
###

- platform: template
  sensors:
    motion_sun:
      unique_id: motion_sun
      friendly_name: Sun status
      icon_template: 'mdi:sun'
      attribute_templates:
        dawn: >-
          {{ 'null' }}
        rising: >-
          {{ 'null' }}
        setting: >-
          {{ 'null' }}
        dusk: >-
          {{ 'null' }}
        night: >-
          {{ 'null' }}
        day: >-
          {{ 'null' }}
      value_template: >-
        {{ 'Pending' }}

## history_stats

# day

- platform: history_stats
  name: motion_person_active_count_day
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: count
  start: >-
    {% set s = state_attr('sensor.motion.sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion.sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}

- platform: history_stats
  name: motion_person_active_time_day
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: time
  start: >-
    {% set s = state_attr('sensor.motion.sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion.sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}

- platform: history_stats
  name: motion_person_active_ratio_day
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: >-
    {% set s = state_attr('sensor.motion.sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion.sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}

# night

- platform: history_stats
  name: motion_person_active_count_night
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: count
  start: >-
    {% set s = state_attr('sensor.motion.sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion.sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0).timestamp() + 86400 }}
    {% endif %}

- platform: history_stats
  name: motion_person_active_time_night
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: time
  start: >-
    {% set s = state_attr('sensor.motion.sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion.sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0).timestamp() + 86400 }}
    {% endif %}

- platform: history_stats
  name: motion_person_active_ratio_night
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: >-
    {% set s = state_attr('sensor.motion.sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion.sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0).timestamp() + 86400 }}
    {% endif %}

## statistics

# mean

- platform: statistics
  name: motion_person_active_ratio_mean_day
  entity_id: sensor.motion_person_active_ratio_day
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_time_mean_day
  entity_id: sensor.motion_person_active_time_day
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_count_mean_day
  entity_id: sensor.motion_person_active_count_day
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 24

# min

- platform: statistics
  name: motion_person_active_ratio_min_day
  entity_id: sensor.motion_person_active_ratio_day
  state_characteristic: value_min
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_time_min_day
  entity_id: sensor.motion_person_active_time_day
  state_characteristic: value_min
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_count_min_day
  entity_id: sensor.motion_person_active_count_day
  state_characteristic: value_min
  sampling_size: 720
  max_age:
    hours: 24

# max

- platform: statistics
  name: motion_person_active_ratio_max_day
  entity_id: sensor.motion_person_active_ratio_day
  state_characteristic: value_max
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_time_max_day
  entity_id: sensor.motion_person_active_time_day
  state_characteristic: value_max
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_count_max_day
  entity_id: sensor.motion_person_active_count_day
  state_characteristic: value_max
  sampling_size: 720
  max_age:
    hours: 24
