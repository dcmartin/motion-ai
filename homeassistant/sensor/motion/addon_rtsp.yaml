###
# homeassistant/sensor/motion/addon.yaml
###

###
# config
###

- platform: template
  sensors:
    motion_addon_rtsp_api:
      friendly_name: Motion RTSP API
      icon_template: 'mdi:web'
      value_template: >-
        {% set s = states('sensor.motion_addon_api') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {{ s + '/cgi-bin/rtsp' }}
        {% else %}null{% endif %}

- platform: rest
  name: motion_addon_rtsp
  json_attributes:
    - timestamp
    - rtsp
  force_update: true
  resource_template: >-
    {% set s = states('sensor.motion_addon_rtsp_api') %}
    {% if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
      {{- s -}}
    {% else %}http://127.0.0.1:7999/cgi-bin/rtsp{% endif %}
  value_template: >-
    {% if value_json is defined %}True{% else %}False{% endif %}

# group & device & client
- platform: template
  sensors:
    motion_addon_nmap_ipaddr:
      friendly_name: Add-on nmap IP
      icon_template: 'mdi:web'
      value_template: >-
        {% set s = state_attr('sensor.motion_addon_rtsp','rtsp') %}
        {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {% set s = s.nmap.ipaddr %}
          {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s|list is iterable %}
            {{ s }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
    motion_addon_nmap_net:
      friendly_name: Add-on nmap network
      icon_template: 'mdi:switch'
      value_template: >-
        {% set s = state_attr('sensor.motion_addon_rtsp','rtsp') %}
        {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {% set s = s.nmap.net %}
          {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s|list is iterable %}
            {{ s }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
    motion_addon_nmap_timeout:
      friendly_name: Add-on nmap timeout
      icon_template: 'mdi:timer'
      value_template: >-
        {% set s = state_attr('sensor.motion_addon_rtsp','rtsp') %}
        {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {% set s = s.nmap.timeout %}
          {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s|list is iterable %}
            {{ s }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
    motion_addon_rtsp_max:
      friendly_name: Add-on rtsp max
      icon_template: 'mdi:timer'
      value_template: >-
        {% set s = state_attr('sensor.motion_addon_rtsp','rtsp') %}
        {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {% set s = s.max %}
          {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s|list is iterable %}
            {{ s }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
    motion_addon_rtsp_connect:
      friendly_name: Add-on rtsp connect
      icon_template: 'mdi:timer'
      value_template: >-
        {% set s = state_attr('sensor.motion_addon_rtsp','rtsp') %}
        {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {% set s = s.connect %}
          {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s|list is iterable %}
            {{ s }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}

# count
- platform: template
  sensors:
    motion_addon_rtsp_camera_count:
      friendly_name: Add-on rtsp camera count
      icon_template: 'mdi:counter'
      unit_of_measurement: '📷'
      value_template: >-
        {% set s = state_attr('sensor.motion_addon_rtsp','rtsp') %}
        {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {% set s = s.devices %}
          {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s|list is iterable %}
            {{ s|selectattr('code','==','200')|list|length }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
    motion_addon_rtsp_device_count:
      friendly_name: Add-on rtsp device count
      icon_template: 'mdi:counter'
      unit_of_measurement: '⌁'
      value_template: >-
        {% set s = state_attr('sensor.motion_addon_rtsp','rtsp') %}
        {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {% set s = s.devices %}
          {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s|list is iterable %}
            {{ s|list|length }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}

# list
- platform: template
  sensors:
    motion_addon_rtsp_camera_list:
      friendly_name: Add-on rtsp camera IP address(s)
      icon_template: 'mdi:cctv'
      value_template: >-
        {% set s = state_attr('sensor.motion_addon_rtsp','rtsp') %}
        {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s != null %}
          {% set s = s.devices %}
          {% if s is not none and s|lower != 'unavailable' and s|lower != 'unknown' and s|list is iterable %}
            {{ s|selectattr('code','==','200')|map(attribute='ip')|list|string|replace('\'','"')|to_json }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
