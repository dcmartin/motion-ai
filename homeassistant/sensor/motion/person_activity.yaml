###
## sensor/motion/person_activity.yaml
###

- platform: template
  sensors:
    motion_person_active:
      friendly_name: 'Person active'
      icon_template: >-
        {{- 'mdi:tune-vertical' -}}
      attribute_templates:
        entity_picture: >-
          {{ '/local/images/mixture.png' }}
      value_template: >
        {{ 'Pending' }}
    motion_person_active_level:
      friendly_name: 'Person active level'
      icon_template: >-
        {%- set s = state_attr('sensor.motion_person_active','rank') -%}
        {%- if s|lower == 'none' or s|lower == 'null' or s|lower == 'unknown' or s|lower == 'unavailable' -%}
          {{- 'mdi:account-question' -}}
        {%- elif s|lower == 'veryhigh' -%}
          {{- 'mdi:account-multiple-plus' -}}
        {%- elif s|lower == 'high' -%}
          {{- 'mdi:account-plus' -}}
        {%- elif s|lower == 'nominal' -%}
            {{- 'mdi:account-box' -}}
        {%- elif s|lower == 'low' -%}
          {{- 'mdi:account-minus' -}}
        {%- elif s|lower == 'verylow' -%}
          {{- 'mdi:account-multiple-minus' -}}
        {%- else -%}
          {{- 'mdi:account-clock' -}}
        {%- endif -%}
      value_template: >
        {% set s = state_attr('sensor.motion_person_active','level') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' -%}
          {{- s -}}
        {%- else -%}Pending{%- endif -%}
    motion_person_active_duration:
      friendly_name: 'Active duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% set s = states('sensor.motion_person_active_duration_measurement') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' -%}
          {{ '%0.1f'|format(s|float(0.0)) }}
        {%- else -%}null{%- endif -%}
    motion_person_active_duration_relative:
      friendly_name: 'Active duration'
      icon_template: 'mdi:clock'
      value_template: >-
        {% set s = states('sensor.motion_person_active_duration') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' -%}
          {%- set r = as_datetime(utcnow().timestamp() - s|float(0.0)) -%}
          {{- relative_time(r) -}}
        {%- else -%}null{%- endif -%}
    motion_person_active_probability:
      friendly_name: 'Active probability'
      icon_template: 'mdi:percent'
      unit_of_measurement: '%'
      value_template: >
        {{- 'null' -}}
    motion_person_active_ago:
      friendly_name: 'Active ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {{- 'null' -}}
    motion_person_active_ago_relative:
      friendly_name: 'Active ago'
      icon_template: 'mdi:clock'
      value_template: >-
        {% set s = states('sensor.motion_person_active_ago') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' -%}
          {%- set r = as_datetime(utcnow().timestamp() - s|float(0.0)) -%}
          {{- relative_time(r) -}}
        {%- else -%}Pending{%- endif -%}
    motion_person_active_history_duration:
      friendly_name: 'Active history'
      unit_of_measurement: days
      icon_template: 'mdi:calendar-account'
      value_template: >-
        {% set s = states('sensor.motion_person_active_ago_oldest') %}
        {% if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != null %}
          {{ (( utcnow().timestamp() - s|as_timestamp) / 86400)|int(0) }}
        {%- else -%}null{%- endif -%}
    motion_person_active_on_duration:
      friendly_name: 'Active duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% if is_state('binary_sensor.motion_person_active','on') %}
          {{ states('sensor.motion_person_active_duration') }}
        {%- else -%}null{%- endif -%}
    motion_person_active_off_duration:
      friendly_name: 'Inactive duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% if is_state('binary_sensor.motion_person_active','off') %}
          {{ states('sensor.motion_person_active_duration') }}
        {%- else -%}null{%- endif -%}
    motion_person_active_ratio_1d:
      friendly_name: 'Active ratio (1d)'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: '%'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_active_ratio_count_1d') }}
        duration: >-
          {% set s = states('sensor.motion_person_active_ratio_oldest_1d') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}null{%- endif -%}
        status: >-
          {%- set s = states('sensor.motion_person_active_ratio_oldest_1d') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {%- set s = utcnow().timestamp() - s|as_timestamp -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {{- ' (' + states('sensor.motion_person_active_ratio_count_1d') + ')' -}}
          {%- else -%}Pending{%- endif -%}
      value_template: >
        {%- set s = states('sensor.motion_person_active_ratio_history_stats_1d') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {{- s|float(0.0) -}}
        {%- else -%}null{%- endif -%}
    motion_person_active_ratio_1w:
      friendly_name: 'Active ratio (1w)'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: '%'
      attribute_templates:
        count: >-
          {{ states('sensor.motion_person_active_ratio_count_1w') }}
        duration: >-
          {% set s = states('sensor.motion_person_active_ratio_oldest_1w') %}
          {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
            {{ utcnow().timestamp() - s|as_timestamp }}
          {%- else -%}null{%- endif -%}
        status: >-
          {%- set s = states('sensor.motion_person_active_ratio_oldest_1w') -%}
          {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 -%}
            {%- set s = utcnow().timestamp() - s|as_timestamp -%}
            {%- set d = (s/86400)|int(0) -%}
            {%- set h = ((s-(d*86400))/3600)|int(0) -%}
            {%- if d < 1 -%}
              {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
              {%- set s = (s % 60)|int(0) -%}
              {%- if h < 1 -%}
                {%- if m < 1 -%}
                  {{ s -}}s
                {%- else -%}
                  {{ m -}}m; {{ s -}}s
                {%- endif -%}
              {%- else -%}
                {{ h -}}h; {{ m -}}m
              {%- endif -%}
            {%- else -%}
              {{ d -}}d; {{ h -}}h
            {%- endif -%}
            {{- ' (' + states('sensor.motion_person_active_ratio_count_1w') + ')' -}}
          {%- else -%}Pending{%- endif -%}
      value_template: >
        {%- set s = states('sensor.motion_person_active_ratio_history_stats_1w') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {{- s|float(0.0) -}}
        {%- else -%}null{%- endif -%}
    motion_person_active_ratio_history_count:
      unit_of_measurement: 'Σ'
      value_template: >-
        {{ states('sensor.motion_person_active_ratio_count_1w') }}
    motion_person_active_ratio_history_duration:
      friendly_name: 'Active analysis duration (s)'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {% set s = states('sensor.motion_person_active_ratio_oldest_1w') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
          {{ utcnow().timestamp() - s|as_timestamp }}
        {%- else -%}null{%- endif -%}
    motion_person_active_ratio_history:
      unique_id: motion_person_active_ratio_history
      friendly_name: 'Active analysis duration (Σ)'
      icon_template: 'mdi:calendar-range'
      value_template: >-
        {%- set s = states('sensor.motion_person_active_ratio_history_duration') -%}
        {%- if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|float(0.0) is number and s|float(0.0) > 0.0 -%}
          {%- set s = s|float(0.0) -%}
          {%- set d = (s/86400)|int(0) -%}
          {%- set h = ((s-(d*86400))/3600)|int(0) -%}
          {%- if d < 1 -%}
            {%- set m = ((s-(d*86400)-(h*3600))/60)|int(0) -%}
            {%- set s = (s % 60)|int(0) -%}
            {%- if h < 1 -%}
              {%- if m < 1 -%}
                {{ s -}}s
              {%- else -%}
                {{ m -}}m; {{ s -}}s
              {%- endif -%}
            {%- else -%}
              {{ h -}}h; {{ m -}}m
            {%- endif -%}
          {%- else -%}
            {{ d -}}d; {{ h -}}h
          {%- endif -%}
          {{- ' (' + states('sensor.motion_person_active_ratio_history_count') + ')' -}}
        {%- else -%}Pending{%- endif -%}

# quartiles

- platform: statistics
  name: motion_person_active_probability_quartiles_1w
  entity_id: sensor.motion_person_active_probability
  state_characteristic: quantiles
  quantile_intervals: 4
  quantile_method: exclusive
  sampling_size: 10000
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_ago_quartiles_1w
  entity_id: sensor.motion_person_active_ago
  state_characteristic: quantiles
  quantile_intervals: 4
  quantile_method: inclusive
  sampling_size: 10000
  max_age:
    days: 7

# today

- platform: history_stats
  name: motion_person_active_count_today
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: count
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

- platform: history_stats
  name: motion_person_active_time_today
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: time
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

- platform: history_stats
  name: motion_person_active_ratio_today
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

# ago

- platform: statistics
  name: motion_person_active_ago_oldest
  entity_id: sensor.motion_person_active_ago
  state_characteristic: datetime_oldest
  sampling_size: 100000
  max_age:
    days: 30

- platform: statistics
  name: motion_person_active_ago_min
  entity_id: sensor.motion_person_active_ago
  state_characteristic: value_min
  sampling_size: 100
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_ago_max
  entity_id: sensor.motion_person_active_ago
  state_characteristic: value_max
  sampling_size: 100
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_ago_mean
  entity_id: sensor.motion_person_active_ago
  state_characteristic: mean
  sampling_size: 100
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_ago_stdev
  entity_id: sensor.motion_person_active_ago
  state_characteristic: standard_deviation
  sampling_size: 100
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_ago_stdev_mean
  entity_id: sensor.motion_person_active_ago_stdev
  state_characteristic: mean
  sampling_size: 100
  max_age:
    days: 1

# active

- platform: statistics
  name: motion_person_active_on_duration_mean_1d
  entity_id: sensor.motion_person_active_on_duration
  state_characteristic: mean
  sampling_size: 720
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_on_duration_mean_1w
  entity_id: sensor.motion_person_active_on_duration
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_off_duration_mean_1d
  entity_id: sensor.motion_person_active_off_duration
  state_characteristic: mean
  sampling_size: 720
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_off_duration_mean_1w
  entity_id: sensor.motion_person_active_off_duration
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

# probability

- platform: statistics
  name: motion_person_active_probability_mean_5m
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_active_probability_mean_15m
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_active_probability_mean_1h
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_active_probability_mean_1d
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_probability_mean_1w
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 20160
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_average_5m
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_active_average_15m
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_active_average_1h
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_active_average_1d
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_average_1w
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 20160
  max_age:
    days: 7

##
# active ratio
##

# 1d

- platform: history_stats
  name: motion_person_active_ratio_history_stats_1d
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

- platform: statistics
  name: motion_person_active_ratio_mean_1d
  entity_id: sensor.motion_person_active_ratio_history_stats_1d
  state_characteristic: mean
  sampling_size: 720
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_ratio_oldest_1d
  entity_id: sensor.motion_person_active_ratio_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 720
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_ratio_count_1d
  entity_id: sensor.motion_person_active_ratio_history_stats_1d
  state_characteristic: count
  sampling_size: 720
  max_age:
    days: 1

# 1w

- platform: history_stats
  name: motion_person_active_ratio_history_stats_1w
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: >-
    {{ now().replace(hour=0).replace(minute=0).replace(second=0).timestamp()|int(0) - states('sensor.motion_person_weeks_timestamp')|int(0) }}
  end: '{{ now() }}'

- platform: statistics
  name: motion_person_active_ratio_mean_1w
  entity_id: sensor.motion_person_active_ratio_history_stats_1w
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_ratio_oldest_1w
  entity_id: sensor.motion_person_active_ratio_history_stats_1w
  state_characteristic: datetime_oldest
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_ratio_count_1w
  entity_id: sensor.motion_person_active_ratio_history_stats_1w
  state_characteristic: count
  sampling_size: 5040
  max_age:
    days: 7

## history_stats

# day

- platform: history_stats
  name: motion_person_active_count_day
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: count
  start: >-
    {% set s = state_attr('sensor.motion_sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion_sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}

- platform: history_stats
  name: motion_person_active_time_day
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: time
  start: >-
    {% set s = state_attr('sensor.motion_sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion_sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}

- platform: history_stats
  name: motion_person_active_ratio_day
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: >-
    {% set s = state_attr('sensor.motion_sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion_sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}

# night

- platform: history_stats
  name: motion_person_active_count_night
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: count
  start: >-
    {% set s = state_attr('sensor.motion_sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion_sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0).timestamp() + 86400 }}
    {% endif %}

- platform: history_stats
  name: motion_person_active_time_night
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: time
  start: >-
    {% set s = state_attr('sensor.motion_sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion_sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0).timestamp() + 86400 }}
    {% endif %}

- platform: history_stats
  name: motion_person_active_ratio_night
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: >-
    {% set s = state_attr('sensor.motion_sun','night') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=18).replace(minute=0).replace(second=0) }}
    {% endif %}
  end: >-
    {% set s = state_attr('sensor.motion_sun','day') %}
    {% if s|lower != 'none' and s|lower != 'null' and s|float(0.0) > 0 %}
      {{ s }}
    {% else %}
      {{ now().replace(hour=6).replace(minute=0).replace(second=0).timestamp() + 86400 }}
    {% endif %}

## statistics

# mean

- platform: statistics
  name: motion_person_active_ratio_mean_day
  entity_id: sensor.motion_person_active_ratio_day
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_time_mean_day
  entity_id: sensor.motion_person_active_time_day
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_count_mean_day
  entity_id: sensor.motion_person_active_count_day
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 24

# min

- platform: statistics
  name: motion_person_active_ratio_min_day
  entity_id: sensor.motion_person_active_ratio_day
  state_characteristic: value_min
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_time_min_day
  entity_id: sensor.motion_person_active_time_day
  state_characteristic: value_min
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_count_min_day
  entity_id: sensor.motion_person_active_count_day
  state_characteristic: value_min
  sampling_size: 720
  max_age:
    hours: 24

# max

- platform: statistics
  name: motion_person_active_ratio_max_day
  entity_id: sensor.motion_person_active_ratio_day
  state_characteristic: value_max
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_time_max_day
  entity_id: sensor.motion_person_active_time_day
  state_characteristic: value_max
  sampling_size: 720
  max_age:
    hours: 24

- platform: statistics
  name: motion_person_active_count_max_day
  entity_id: sensor.motion_person_active_count_day
  state_characteristic: value_max
  sampling_size: 720
  max_age:
    hours: 24
