###
# homeassistant/sensor/motion/person_active.yaml
###

- platform: template
  sensors:
    motion_person_active_duration:
      friendly_name: 'Active duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% set s = states('sensor.motion_person_active_duration_measurement') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' -%}
          {{ '%0.1f'|format(s) }}
        {%- else -%}null{%- endif -%}
    motion_person_active_duration_relative:
      friendly_name: 'Active duration'
      icon_template: 'mdi:clock'
      value_template: >-
        {% set s = states('sensor.motion_person_active_duration') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' -%}
          {%- set r = strptime(utcnow().timestamp() - s|float, '%Y-%m-%dT%H:%M:%S.%f%z') -%}
          {{- relative_time(r|as_datetime) -}}
        {%- else -%}null{%- endif -%}
    motion_person_active_ago:
      friendly_name: 'Active ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {% set s = states('sensor.motion_person_active_ago_measurement') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' -%}
          {{ '%0.1f'|format(s) }}
        {%- else -%}null{%- endif -%}
    motion_person_active_ago_relative:
      friendly_name: 'Active ago'
      icon_template: 'mdi:clock'
      value_template: >-
        {% set s = states('sensor.motion_person_active_ago') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'null' and s|lower != 'unavailable' -%}
          {%- set r = strptime(utcnow().timestamp() - s|float, '%Y-%m-%dT%H:%M:%S.%f%z') -%}
          {{- relative_time(r|as_datetime) -}}
        {%- else -%}null{%- endif -%}

# active

- platform: template
  sensors:
    motion_person_active_on_duration:
      friendly_name: 'Active duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% if is_state('binary_sensor.motion_person_active','on') %}
          {{ states('sensor.motion_person_active_duration') }}
        {%- else -%}null{%- endif -%}

- platform: statistics
  name: motion_person_active_on_duration_mean_1d
  entity_id: sensor.motion_person_active_on_duration
  state_characteristic: mean
  sampling_size: 720
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_on_duration_mean_1w
  entity_id: sensor.motion_person_active_on_duration
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

# inactive

- platform: template
  sensors:
    motion_person_active_off_duration:
      friendly_name: 'Inactive duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >
        {% if is_state('binary_sensor.motion_person_active','off') %}
          {{ states('sensor.motion_person_active_duration') }}
        {%- else -%}null{%- endif -%}

- platform: statistics
  name: motion_person_active_off_duration_mean_1d
  entity_id: sensor.motion_person_active_off_duration
  state_characteristic: mean
  sampling_size: 720
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_off_duration_mean_1w
  entity_id: sensor.motion_person_active_off_duration
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

## PROBABILITY from bayesian

# location_active

- platform: template
  sensors:
    motion_person_location_active_probability:
      friendly_name: 'Active probability'
      icon_template: 'mdi:percent'
      unit_of_measurement: '%'
      value_template: >
        {{ state_attr('binary_sensor.motion_person_location_active','probability') }}

- platform: statistics
  name: motion_person_location_active_probability_mean_5m
  entity_id: sensor.motion_person_location_active_probability
  state_characteristic: mean
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_location_active_probability_mean_15m
  entity_id: sensor.motion_person_location_active_probability
  state_characteristic: mean
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_location_active_probability_mean_1h
  entity_id: sensor.motion_person_location_active_probability
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_location_active_probability_mean_1d
  entity_id: sensor.motion_person_location_active_probability
  state_characteristic: mean
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_location_active_probability_mean_1w
  entity_id: sensor.motion_person_location_active_probability
  state_characteristic: mean
  sampling_size: 20160
  max_age:
    days: 7

- platform: statistics
  name: motion_person_location_active_average_5m
  entity_id: binary_sensor.motion_person_location_active
  state_characteristic: average_step
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_location_active_average_15m
  entity_id: binary_sensor.motion_person_location_active
  state_characteristic: average_step
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_location_active_average_1h
  entity_id: binary_sensor.motion_person_location_active
  state_characteristic: average_step
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_location_active_average_1d
  entity_id: binary_sensor.motion_person_location_active
  state_characteristic: average_step
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_location_active_average_1w
  entity_id: binary_sensor.motion_person_location_active
  state_characteristic: average_step
  sampling_size: 20160
  max_age:
    days: 7

# occupancy_active

- platform: template
  sensors:
    motion_person_occupancy_active_probability:
      friendly_name: 'Active probability'
      icon_template: 'mdi:percent'
      unit_of_measurement: '%'
      value_template: >
        {{ state_attr('binary_sensor.motion_person_occupancy_active','probability') }}

- platform: statistics
  name: motion_person_occupancy_active_probability_mean_5m
  entity_id: sensor.motion_person_occupancy_active_probability
  state_characteristic: mean
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_occupancy_active_probability_mean_15m
  entity_id: sensor.motion_person_occupancy_active_probability
  state_characteristic: mean
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_occupancy_active_probability_mean_1h
  entity_id: sensor.motion_person_occupancy_active_probability
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_occupancy_active_probability_mean_1d
  entity_id: sensor.motion_person_occupancy_active_probability
  state_characteristic: mean
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_occupancy_active_probability_mean_1w
  entity_id: sensor.motion_person_occupancy_active_probability
  state_characteristic: mean
  sampling_size: 20160
  max_age:
    days: 7

- platform: statistics
  name: motion_person_occupancy_active_average_5m
  entity_id: binary_sensor.motion_person_occupancy_active
  state_characteristic: average_step
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_occupancy_active_average_15m
  entity_id: binary_sensor.motion_person_occupancy_active
  state_characteristic: average_step
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_occupancy_active_average_1h
  entity_id: binary_sensor.motion_person_occupancy_active
  state_characteristic: average_step
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_occupancy_active_average_1d
  entity_id: binary_sensor.motion_person_occupancy_active
  state_characteristic: average_step
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_occupancy_active_average_1w
  entity_id: binary_sensor.motion_person_occupancy_active
  state_characteristic: average_step
  sampling_size: 20160
  max_age:
    days: 7

# detected_active

- platform: template
  sensors:
    motion_person_detected_active_probability:
      friendly_name: 'Active probability'
      icon_template: 'mdi:percent'
      unit_of_measurement: '%'
      value_template: >
        {{ state_attr('binary_sensor.motion_person_detected_active','probability') }}

- platform: statistics
  name: motion_person_detected_active_probability_mean_5m
  entity_id: sensor.motion_person_detected_active_probability
  state_characteristic: mean
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_detected_active_probability_mean_15m
  entity_id: sensor.motion_person_detected_active_probability
  state_characteristic: mean
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_detected_active_probability_mean_1h
  entity_id: sensor.motion_person_detected_active_probability
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_detected_active_probability_mean_1d
  entity_id: sensor.motion_person_detected_active_probability
  state_characteristic: mean
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_detected_active_probability_mean_1w
  entity_id: sensor.motion_person_detected_active_probability
  state_characteristic: mean
  sampling_size: 20160
  max_age:
    days: 7

- platform: statistics
  name: motion_person_detected_active_average_5m
  entity_id: binary_sensor.motion_person_detected_active
  state_characteristic: average_step
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_detected_active_average_15m
  entity_id: binary_sensor.motion_person_detected_active
  state_characteristic: average_step
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_detected_active_average_1h
  entity_id: binary_sensor.motion_person_detected_active
  state_characteristic: average_step
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_detected_active_average_1d
  entity_id: binary_sensor.motion_person_detected_active
  state_characteristic: average_step
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_detected_active_average_1w
  entity_id: binary_sensor.motion_person_detected_active
  state_characteristic: average_step
  sampling_size: 20160
  max_age:
    days: 7

# active

- platform: template
  sensors:
    motion_person_active_probability:
      friendly_name: 'Active probability'
      icon_template: 'mdi:percent'
      unit_of_measurement: '%'
      value_template: >
        {{ state_attr('binary_sensor.motion_person_active','probability') }}

- platform: statistics
  name: motion_person_active_probability_mean_5m
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_active_probability_mean_15m
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_active_probability_mean_1h
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_active_probability_mean_1d
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_probability_mean_1w
  entity_id: sensor.motion_person_active_probability
  state_characteristic: mean
  sampling_size: 20160
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_average_5m
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 60
  max_age:
    minutes: 5

- platform: statistics
  name: motion_person_active_average_15m
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 180
  max_age:
    minutes: 15

- platform: statistics
  name: motion_person_active_average_1h
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 720
  max_age:
    hours: 1

- platform: statistics
  name: motion_person_active_average_1d
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 2880
  max_age:
    days: 1

- platform: statistics
  name: motion_person_active_average_1w
  entity_id: binary_sensor.motion_person_active
  state_characteristic: average_step
  sampling_size: 20160
  max_age:
    days: 7

##
# active ratio
##

- platform: history_stats
  name: motion_person_active_ratio_history_stats_1d
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
  end: '{{ now() }}'

- platform: history_stats
  name: motion_person_active_ratio_history_stats_1w
  entity_id: binary_sensor.motion_person_active
  state: 'on'
  type: ratio
  start: >-
    {{ now().replace(hour=0).replace(minute=0).replace(second=0).timestamp()|int - states('sensor.motion_person_weeks_timestamp')|int }}
  end: '{{ now() }}'

- platform: template
  sensors:
    motion_person_active_ratio_1d:
      friendly_name: 'Active ratio (1d)'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: '%'
      value_template: >
        {%- set s = states('sensor.motion_person_active_ratio_history_stats_1d') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {{- s|float -}}
        {%- else -%}null{%- endif -%}
    motion_person_active_ratio_1w:
      friendly_name: 'Active ratio (1w)'
      icon_template: 'mdi:home-variant'
      unit_of_measurement: '%'
      value_template: >
        {%- set s = states('sensor.motion_person_active_ratio_history_stats_1w') -%}
        {%- if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' -%}
          {{- s|float -}}
        {%- else -%}null{%- endif -%}

- platform: statistics
  name: motion_person_active_ratio_mean_1w
  entity_id: sensor.motion_person_active_ratio_history_stats_1d
  state_characteristic: mean
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_ratio_oldest_1w
  entity_id: sensor.motion_person_active_ratio_history_stats_1d
  state_characteristic: datetime_oldest
  sampling_size: 5040
  max_age:
    days: 7

- platform: statistics
  name: motion_person_active_ratio_count_1w
  entity_id: sensor.motion_person_active_ratio_history_stats_1d
  state_characteristic: count
  sampling_size: 5040
  max_age:
    days: 7

- platform: template
  sensors:
    motion_person_active_period_count:
      unit_of_measurement: 'Σ'
      value_template: >-
        {{ states('sensor.motion_person_active_ratio_count_1w') }}
    motion_person_active_period_duration:
      friendly_name: 'Active analysis duration (s)'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {% set s = states('sensor.motion_person_active_ratio_oldest_1w') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|string|length > 0 %}
          {{ utcnow().timestamp() - s|as_timestamp }}
        {%- else -%}null{%- endif -%}
    motion_person_active_period:
      unique_id: motion_person_active_period
      friendly_name: 'Active analysis duration (Σ)'
      icon_template: 'mdi:calendar-range'
      value_template: >-
        {% set s = states('sensor.motion_person_active_period_duration') %}
        {% if s|lower != 'unknown' and s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'null' and s|float is number and s|float > 0.0 %}
          {% set s = s|float %}
          {% set d = (s/86400)|int %}
          {% set h = ((s-(d*86400))/3600)|int %}
          {% if d < 1 %}
            {% set m = ((s-(d*86400)-(h*3600))/60)|int %}
            {% set s = (s % 60)|int %}
            {% if h < 1 %}
              {% if m < 1 %}
                {{ s -}}s
              {% else %}
                {{ m -}}m; {{ s -}}s
              {% endif %}
            {% else %}
              {{ h -}}h; {{ m -}}m
            {% endif %}
          {% else %}
            {{ d -}}d; {{ h -}}h
          {% endif %}
          {{ '(' + states('sensor.motion_person_active_period_count') + ')' }}
        {%- else -%}Pending{%- endif -%}
