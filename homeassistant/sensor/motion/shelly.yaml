#
## homeassistant/motion/sensor/shelly.yaml
###

## status (MQTT)

# shellies/pir-bathroom/status
# {
#   "active": true,
#   "bat": 99,
#   "lux": 438,
#   "motion": false,
#   "timestamp": 1622456177,
#   "vibration": false
# }

#- platform: mqtt
#  name: motion_detector_shelly_status
#  state_topic: shellies/+/status
#  expire_after: 60
#  force_update: true
#  json_attributes_topic: shellies/+/status
#  qos: 2
#  value_template: >
#    {% if value_json is defined %}True{% else %}False{% endif %}

## announce (MQTT)

# shellies/shellymotionsensor-60A423D3F280/announce
# {
#   "fw_ver": "20210226-072307/v1.1.0@f31e1d2b",
#   "id": "shellymotionsensor-60A423D3F280",
#   "ip": "192.168.1.210",
#   "mac": "60A423D3F280",
#   "model": "SHMOS-01",
#   "new_fw": false
# }

- platform: mqtt
  name: motion_detector_shelly_announce
  state_topic: shellies/+/announce
  json_attributes_topic: shellies/+/announce
  expire_after: 1800
  force_update: true
  qos: 2
  value_template: >
    {% if value_json is defined %}True{% else %}False{% endif %}

## info (MQTT)

# shellies/shellymotionsensor-60A423D3F280/info
# {
#   "bat": {
#     "value": 100,
#     "voltage": 4.171
#   },
#   "cfg_changed_cnt": 0,
#   "charger": true,
#   "cloud": {
#     "connected": false,
#     "enabled": false
#   },
#   "has_update": false,
#   "lux": {
#     "illumination": "bright",
#     "is_valid": true,
#     "value": 1027
#   },
#   "mac": "60A423D3F280",
#   "mqtt": {
#     "connected": true,
#     "enabled": true
#   },
#   "sensor": {
#     "active": true,
#     "is_valid": true,
#     "motion": false,
#     "timestamp": 1622451089,
#     "vibration": false
#   },
#   "serial": 212,
#   "time": "09:09",
#   "timestamp": -1815024272,
#   "unixtime": 1622452158,
#   "update": {
#     "beta_version": "",
#     "has_update": false,
#     "new_version": "20210226-072307/v1.1.0@f31e1d2b",
#     "old_version": "20210226-072307/v1.1.0@f31e1d2b",
#     "status": "idle"
#   },
#   "uptime": 75681,
#   "wifi_sta": {
#     "connected": true,
#     "ip": "192.168.1.210",
#     "rssi": -48,
#     "ssid": "CABIN"
#   }
# }

- platform: mqtt
  name: motion_detector_shelly_info
  state_topic: shellies/+/info
  json_attributes_topic: shellies/+/info
  expire_after: 30
  force_update: true
  qos: 2
  value_template: >
    {% if value_json is defined %}True{% else %}False{% endif %}

## settings (REST)

# curl -sSL -u 'username:password' "192.168.1.210/settings"
# {
#   "build_info": {
#     "build_id": "20210226-072307/v1.1.0@f31e1d2b",
#     "build_timestamp": "2021-02-26T07:23:07Z",
#     "build_version": "2021022607"
#   },
#   "cloud": {
#     "enabled": false
#   },
#   "coiot": {
#     "enabled": false,
#     "peer": "",
#     "update_period": 3600
#   },
#   "dark_threshold": 100,
#   "device": {
#     "hostname": "shellymotionsensor-60A423D3F280",
#     "mac": "60A423D3F280",
#     "num_outputs": 0,
#     "type": "SHMOS-01"
#   },
#   "discoverable": true,
#   "fw": "20210226-072307/v1.1.0@f31e1d2b",
#   "hwinfo": {
#     "batch_id": 0,
#     "hw_revision": "dev-prototype"
#   },
#   "lat": 37.9577,
#   "led_status_disable": true,
#   "lng": -121.29078,
#   "login": {
#     "auth_type": "basic",
#     "default_username": "admin",
#     "enabled": true,
#     "unprotected": false,
#     "username": "username"
#   },
#   "motion": {
#     "blind_time_minutes": 1,
#     "enabled": true,
#     "operating_mode": 0,
#     "pulse_count": 1,
#     "sensitivity": 50
#   },
#   "mqtt": {
#     "clean_session": true,
#     "enable": true,
#     "id": "pir-bathroom",
#     "max_qos": 0,
#     "retain": false,
#     "server": "192.168.1.40:1883",
#     "update_period": 3600,
#     "user": "username"
#   },
#   "name": "pir-bathroom",
#   "pin_code": "B-X0)>",
#   "schedule": false,
#   "schedule_rules": [],
#   "sleep_mode": {
#     "period": 60,
#     "unit": "m"
#   },
#   "sleep_time": 0,
#   "sntp": {
#     "enabled": true,
#     "server": "time.google.com"
#   },
#   "tamper_sensitivity": 2,
#   "time": "11:58",
#   "timezone": "America/Los_Angeles",
#   "twilight_threshold": 500,
#   "tz_dst": false,
#   "tz_dst_auto": true,
#   "tz_utc_offset": -25200,
#   "tzautodetect": true,
#   "wifi_ap": {
#     "enabled": false,
#     "ssid": "shellymotionsensor-60A423D3F280"
#   },
#   "wifi_sta": {
#     "dns": null,
#     "enabled": true,
#     "gw": null,
#     "ip": null,
#     "ipv4_method": "dhcp",
#     "mask": null,
#     "ssid": "CABIN"
#   }
# }

- platform: rest
  name: motion_detector_shelly_settings
  authentication: basic
  username: !secret shelly-username
  password: !secret shelly-password
  scan_interval: 1800
  json_attributes:
    - build_info
    - cloud
    - coiot
    - lat
    - lng
    - led_status_disable
    - mqtt
    - name
    - motion
    - login
    - device 
    - timezone
    - wifi_ap
    - wifi_sta
  force_update: true
  resource_template: >-
    {% set s = state_attr('sensor.motion_detector_shelly_announce','ip') %}
    {% if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
      {{- 'http://' + s + '/settings' -}}
    {% else %}null{% endif %}
  value_template: >-
    {% if value_json is defined %}True{% else %}False{% endif %}

## status (REST)

# curl -sSL -u 'username:password' "192.168.1.210/status"
# {
#   "actions_stats": {
#     "skipped": 0
#   },
#   "active/sleep_ratio": 0,
#   "bat": {
#     "value": 96,
#     "voltage": 4.125
#   },
#   "cfg_changed_cnt": 0,
#   "charger": true,
#   "cloud": {
#     "connected": false,
#     "enabled": false
#   },
#   "dbg_flags": 0,
#   "fs_free": 59676,
#   "fs_size": 65536,
#   "has_update": false,
#   "lux": {
#     "illumination": "bright",
#     "is_valid": true,
#     "value": 585
#   },
#   "mac": "60A423D3F280",
#   "mqtt": {
#     "connected": true
#   },
#   "ps_mode": 1,
#   "ram_free": 59296,
#   "ram_total": 65536,
#   "sensor": {
#     "active": true,
#     "is_valid": true,
#     "motion": false,
#     "timestamp": 1622825745,
#     "vibration": false
#   },
#   "serial": 0,
#   "sleep_time": 0,
#   "time": "17:17",
#   "unixtime": 1622827046,
#   "update": {
#     "beta_version": null,
#     "has_update": false,
#     "new_version": "20210531-091017/v1.1.2@aeceaa55",
#     "old_version": "20210531-091017/v1.1.2@aeceaa55",
#     "status": "unknown"
#   },
#   "uptime": 183482,
#   "wifi_sta": {
#     "connected": true,
#     "ip": "192.168.1.210",
#     "rssi": -56,
#     "ssid": "CABIN"
#   }
# }

- platform: rest
  name: motion_detector_shelly_update
  authentication: basic
  username: !secret shelly-username
  password: !secret shelly-password
  scan_interval: 300
  force_update: true
  json_attributes:
    - actions_stats
    - bat
    - cloud
    - has_update
    - lux
    - mac
    - mqtt
    - sensor
    - unixtime
    - update
    - uptime
    - wifi_sta
  resource_template: >-
    {% set s = state_attr('sensor.motion_detector_shelly_announce','ip') %}
    {% if s|lower !='none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
      {{- 'http://' + s + '/status' -}}
    {% else %}null{% endif %}
  value_template: >-
    {% if value_json is defined %}True{% else %}False{% endif %}

## TEMPLATES

- platform: template
  sensors:
    motion_detector_shelly_mac:
      friendly_name: 'Shelly mac'
      icon_template: 'mdi:lan'
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_detector_shelly','mac') %}
        {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' %}
          {{ s }}
        {% else %}Pending{% endif %}
    motion_detector_shelly_id:
      friendly_name: 'Where'
      icon_template: 'mdi:map-marker'
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_detector_shelly','id') %}
        {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' %}
          {{ s }}
        {% else %}
          {% set s = states.sensor.motion_detector_shelly_id.state %}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' %}
            {{ s }}
          {% else %}Pending{% endif %}
        {% endif %}
    motion_detector_shelly_duration:
      friendly_name: 'Shelly duration'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_detector_shelly','duration') %}
        {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' %}
          {{ s }}
        {% else %}null{% endif %}
    motion_detector_shelly_ago:
      friendly_name: 'Shelly motion ago'
      icon_template: 'mdi:av-timer'
      unit_of_measurement: 's'
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_detector_shelly','last') %}
        {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' and s|int > 0 %}
          {{ utcnow().timestamp()|int - s|int }}
        {% else %}null{% endif %}
    motion_detector_shelly_lux:
      friendly_name: 'Shelly luminosity'
      icon_template: 'mdi:brightness-auto'
      unit_of_measurement: 'lux'
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_detector_shelly','lux') %}
        {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' and s|int > 0 %}
            {{ s }}
        {% else %}null{% endif %}
    motion_detector_shelly_battery:
      friendly_name: 'Shelly battery'
      icon_template: 'mdi:battery'
      unit_of_measurement: '%'
      value_template: >-
        {% set s = state_attr('binary_sensor.motion_detector_shelly','bat') %}
        {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' and s|int > 0 %}
            {{ s }}
        {% else %}null{% endif %}
    motion_detector_shelly_entity_ids:
      value_template: >-
        [{% for eid in states.binary_sensor|map(attribute='entity_id')|list if 'motion_detector_shelly_' in eid  -%}
        {%- if not loop.first -%},{%- endif -%}
        "{{- eid -}}"
        {%- endfor %}]

## HISTORY

- platform: history_stats
  name: motion_detector_shelly_history_ratio_today
  entity_id: binary_sensor.motion_detector_shelly
  state: 'on'
  type: ratio
  start: >-
    {{ now().replace(hour=0).replace(minute=0).replace(second=0) }}
  end: '{{ now() }}'

- platform: history_stats
  name: motion_detector_shelly_history_count_today
  entity_id: binary_sensor.motion_detector_shelly
  state: 'on'
  type: count
  start: >-
    {{ now().replace(hour=0).replace(minute=0).replace(second=0) }}
  end: '{{ now() }}'

## STATISTICS

- platform: statistics
  name: motion_detector_shelly_battery_statistics
  entity_id: sensor.motion_detector_shelly_battery
  sampling_size: 1000
  max_age:
    hours: 168

- platform: statistics
  name: motion_detector_shelly_ago_statistics
  entity_id: sensor.motion_detector_shelly_ago
  sampling_size: 1000
  max_age:
    hours: 168

- platform: statistics
  name: motion_detector_shelly_lux_statistics
  entity_id: sensor.motion_detector_shelly_lux
  sampling_size: 1000
  max_age:
    hours: 168

- platform: statistics
  name: motion_detector_shelly_duration_statistics
  entity_id: sensor.motion_detector_shelly_duration
  sampling_size: 1000
  max_age:
    hours: 168
