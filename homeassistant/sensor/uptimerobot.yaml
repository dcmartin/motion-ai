###
# homeassistant/sensor/feedparser.yaml
###

- platform: feedparser
  name: uptimerobot_feed
  feed_url: '!secret uptimerobot-rssurl'
  date_format: '%a, %b %d %I:%M %p'
  inclusions:
    - title
    - link
    - description
    - image
    - language
    - pubDate
  exclusions:
    - language

- platform: template
  sensors:
    uptimerobot_feed_count:
      friendly_name: 'Feed update (#)'
      icon_template: 'mdi:counter'
      value_template: >-
        {{ states('sensor.uptimerobot_feed')|int }}
    uptimerobot_link_down:
      value_template: >-
        {% set s = state_attr('sensor.uptimerobot_feed','entries') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != null and s|length > 0 %}
          {%- for i in s if 'DOWN' in i.title -%} 
            {%- if not loop.first -%},{%- endif -%}
            {{- i.link -}}
          {%- endfor -%}
        {% endif %}
    uptimerobot_link_down_count:
      friendly_name: 'Link down (#)'
      icon_template: 'mdi:counter'
      value_template: >-
        {% set s = states('sensor.uptimerobot_link_down') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != null and s|length > 0 %}
          {{ s.split(',')|list|length }} 
        {% else %}null{% endif %}
    uptimerobot_link_up:
      value_template: >-
        {% set s = state_attr('sensor.uptimerobot_feed','entries') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != null and s|length > 0 %}
          {%- for i in s if 'UP' in i.title -%} 
            {%- if not loop.first -%},{%- endif -%}
            {{- i.link -}}
          {%- endfor -%}
        {% endif %}
    uptimerobot_link_up_count:
      friendly_name: 'Link up (#)'
      icon_template: 'mdi:counter'
      value_template: >-
        {%- set s = states('sensor.uptimerobot_link_up') -%} 
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != null and s|length > 0 %}
          {{ s.split(',')|list|length }}
        {% else %}null{% endif %}
    uptimerobot_link_down_nabucasa:
      friendly_name: 'NabuCasa link (down)'
      icon_template: 'mdi:lan-disconnect'
      value_template: >-
        {% set s = state_attr('sensor.uptimerobot_feed','entries') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != null and s|length > 0 %}
          {%- for i in s if 'DOWN' in i.title and 'nabu.casa' in i.link -%} 
            {%- if not loop.first -%},{%- endif -%}
            {{- i.link -}}
          {%- endfor -%}
        {% endif %}
    uptimerobot_link_up_nabucasa:
      friendly_name: 'NabuCasa link (up)'
      icon_template: 'mdi:lan-connect'
      value_template: >-
        {% set s = state_attr('sensor.uptimerobot_feed','entries') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != null and s|length > 0 %}
          {%- for i in s if 'UP' in i.title and 'nabu.casa' in i.link -%} 
            {%- if not loop.first -%},{%- endif -%}
            {{- i.link -}}
          {%- endfor -%}
        {% endif %}
