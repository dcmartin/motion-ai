###
## sensor/intranet.yaml
###

- platform: template
  sensors:
    intranet_metrics:
      friendly_name: 'Intranet metrics'
      icon_template: 'mdi:check-network-outline'
      value_template: >-
        {%- if states.sensor.intranet_test|lower != 'none'
               and states.sensor.intranet_test.state|lower != 'unknown'
               and states.sensor.intranet_receive.state|lower != 'unknown'
               and states.sensor.intranet_receive_mean.state|lower != 'unknown'
               and states.sensor.intranet_receive_mean.state|lower != 'null'
               and states.sensor.intranet_receive.state|lower != 'null'
               and states('sensor.intranet_test')|lower == 'true' -%}
          {{- states.sensor.intranet_receive.state }} Mbps; {{ states.sensor.intranet_receive_mean.state }} μ;
        {%- endif %}
        Σ: {{ states('counter.intranet_counter')|int -}};
        Δ: {{ states('input_number.intranet_scan_interval')|int -}}s

- platform: template
  sensors:
    intranet_good:
      friendly_name: 'Intranet status'
      icon_template: 'mdi:check-network-outline'
      value_template: >-
        {%- if states.sensor.intranet_test|lower != 'none'
               and states.sensor.intranet_test.state|lower != 'unknown'
               and states.sensor.intranet_receive.state|lower != 'unknown'
               and states.sensor.intranet_receive_mean.state|lower != 'unknown'
               and states.sensor.intranet_receive_mean.state|lower != 'null'
               and states.sensor.intranet_receive.state|lower != 'null'
               and states('sensor.intranet_test')|lower == 'true' -%}
          {%- if is_state('binary_sensor.intranet_slow_persistent','on') -%}
            Slow
          {%- elif is_state('binary_sensor.intranet_slow','on') -%}
            Slowing 
          {%- elif is_state('binary_sensor.intranet_fast_persistent','on') -%}
            Fast 
          {%- elif is_state('binary_sensor.intranet_fast','on') -%}
            Increasing
          {%- else -%}
            Normal
          {%- endif -%}
        {%- else -%}
          Pending
        {%- endif -%}

# send

- platform: statistics
  name: intranet_send_mean
  entity_id: sensor.intranet_send
  state_characteristic: mean
  sampling_size: 20
  max_age:
    hours: 24

- platform: statistics
  name: intranet_send_max
  entity_id: sensor.intranet_send
  state_characteristic: value_max
  sampling_size: 20
  max_age:
    hours: 24

- platform: statistics
  name: intranet_send_min
  entity_id: sensor.intranet_send
  state_characteristic: value_min
  sampling_size: 20
  max_age:
    hours: 24

- platform: statistics
  name: intranet_send_stdev
  entity_id: sensor.intranet_send_stdev
  state_characteristic: standard_deviation
  sampling_size: 20
  max_age:
    hours: 24

- platform: statistics
  name: intranet_send_stdev_mean
  entity_id: sensor.intranet_send_stdev
  state_characteristic: mean
  sampling_size: 120
  max_age:
    hours: 24

# receive

- platform: statistics
  name: intranet_receive_mean
  entity_id: sensor.intranet_receive
  state_characteristic: mean
  sampling_size: 20
  max_age:
    hours: 24

- platform: statistics
  name: intranet_receive_max
  entity_id: sensor.intranet_receive
  state_characteristic: value_max
  sampling_size: 20
  max_age:
    hours: 24

- platform: statistics
  name: intranet_receive_min
  entity_id: sensor.intranet_receive
  state_characteristic: value_min
  sampling_size: 20
  max_age:
    hours: 24

- platform: statistics
  name: intranet_receive_stdev
  entity_id: sensor.intranet_receive_stdev
  state_characteristic: standard_deviation
  sampling_size: 20
  max_age:
    hours: 24

- platform: statistics
  name: intranet_receive_stdev_mean
  entity_id: sensor.intranet_receive_stdev
  state_characteristic: mean
  sampling_size: 120
  max_age:
    hours: 24

# count

- platform: template
  sensors:
    intranet_ago:
      unit_of_measurement: 's'
      value_template: >-
        {% set t = states('sensor.time') %}
        {% set d = state_attr('sensor.intranet_test','date') %}
        {% if d|lower != 'none' and d|lower != 'unknown' and d != 'null' %}
          {{ utcnow().timestamp()|int - d|int }}
        {%- else -%}null{%- endif -%}

- platform: template
  sensors:
    intranet_counter:
      friendly_name: 'Intranet test count'
      icon_template: 'mdi:check-network-outline'
      unit_of_measurement: tests
      value_template: >
        {% if states('counter.intranet_counter')|lower != 'unavailable' %}
          {{ states('counter.intranet_counter')|int }}
        {%- else -%}null{%- endif -%}

- platform: template
  sensors:
    intranet_slow_counter:
      friendly_name: 'Intranet slow counter'
      icon_template: 'mdi:minus-network-outline'
      unit_of_measurement: tests
      value_template: >
        {% if states('counter.intranet_slow_counter')|lower != 'unavailable' %}
          {{ states('counter.intranet_slow_counter')|int }}
        {%- else -%}null{%- endif -%}

- platform: template
  sensors:
    intranet_slow_percent:
      friendly_name: 'Intranet slow percent'
      icon_template: 'mdi:minus-network-outline'
      unit_of_measurement: '%'
      value_template: >
        {% set c = states('counter.intranet_slow_counter') %}
        {% set ic = states('counter.intranet_counter') %}
        {% if ic|int > 0 %}
          {{ c|float / ic|float * 100.0 }}
        {%- else -%}null{%- endif -%}

- platform: template
  sensors:
    intranet_fast_counter:
      friendly_name: 'Intranet fast counter'
      icon_template: 'mdi:plus-network-outline'
      unit_of_measurement: tests
      value_template: >
        {% if states('counter.intranet_fast_counter')|lower != 'unavailable' %}
          {{ states('counter.intranet_fast_counter')|int }}
        {%- else -%}null{%- endif -%}

- platform: template
  sensors:
    intranet_fast_percent:
      friendly_name: 'Intranet fast percent'
      icon_template: 'mdi:plus-network-outline'
      unit_of_measurement: '%'
      value_template: >
        {% set c = states('counter.intranet_fast_counter') %}
        {% set ic = states('counter.intranet_counter') %}
        {% if ic|int > 0 %}
          {{ c|float / ic|float * 100.0 }}
        {%- else -%}null{%- endif -%}
